<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v2 ‚Ä¢ GOD MODE)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.08);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#ff4d4f;
      --btn:#1e5eff;
      --btn2:#1a3fa8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 10% -20%, rgba(30,94,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(50,213,131,.18), transparent 55%),
        linear-gradient(180deg, #06101f, #050b16 45%, #050a13);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:920px;margin:0 auto}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      margin-bottom:14px;
    }
    h1{margin:0 0 8px;font-size:22px;letter-spacing:.2px}
    .pillrow{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}
    .pill{
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{display:inline-block;width:8px;height:8px;border-radius:99px;margin-right:6px;vertical-align:middle}
    .g{background:var(--good)} .y{background:var(--warn)} .r{background:var(--bad)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px}
    .btn{
      appearance:none;border:0;cursor:pointer;
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:white;font-weight:700;
      padding:12px 14px;border-radius:14px;
      box-shadow:0 10px 18px rgba(30,94,255,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;
      color:var(--text);
    }
    .btn.danger{
      background:linear-gradient(180deg,#ff4d4f,#b42318);
      box-shadow:0 10px 18px rgba(255,77,79,.18);
    }
    .hint{color:var(--muted);line-height:1.4;font-size:13px;margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(min-width:860px){
      .grid{grid-template-columns:1.2fr .8fr}
    }
    .preview{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      background:#060b13;
      overflow:hidden;
    }
    canvas, img{display:block;width:100%;height:auto}
    .status{
      display:flex;flex-wrap:wrap;gap:8px;margin-top:10px
    }
    .badge{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:700;font-size:12px
    }
    .badge.ok{color:var(--good)}
    .badge.fail{color:var(--bad)}
    .badge.warn{color:var(--warn)}
    .sectionTitle{
      font-size:18px;margin:0 0 6px;
    }
    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      color:#d7e2ff;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .inputs{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:700px){
      .inputs{grid-template-columns:1fr 1fr}
    }
    .field{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input, .field textarea, .field select{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      padding:6px 0;
    }
    textarea{min-height:150px;resize:vertical}
    .split{
      display:flex;gap:10px;flex-wrap:wrap
    }
    .split .field{flex:1;min-width:180px}
    .kpi{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:700px){
      .kpi{grid-template-columns:repeat(4,minmax(0,1fr))}
    }
    .kpi .box{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      padding:10px;
    }
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:16px;font-weight:800;margin-top:4px}

    /* GOD MODE small chips */
    .chiprow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:700;font-size:12px;
    }
    .chip.on{outline:2px solid rgba(50,213,131,.35)}
    .chip.off{opacity:.85}
    .warnBox{
      border:1px solid rgba(255,77,79,.25);
      background:rgba(255,77,79,.08);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
    .okBox{
      border:1px solid rgba(50,213,131,.25);
      background:rgba(50,213,131,.08);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- =========================
       1) SCAN/OCR/GATE (GI·ªÆ NGUY√äN)
       ========================= -->
  <div class="card">
    <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v2)</h1>
    <div class="pillrow">
      <div class="pill"><span class="dot g"></span>OpenCV</div>
      <div class="pill"><span class="dot g"></span>Tesseract OCR</div>
      <div class="pill"><span class="dot y"></span>Gate c·ª©ng</div>
      <div class="pill"><span class="dot y"></span>Batch nhi·ªÅu ·∫£nh</div>
      <div class="pill"><span class="dot y"></span>DB theo nh√£n ‚ÄúƒêB/DB‚Äù + 5 s·ªë</div>
      <div class="pill"><span class="dot y"></span>G7/G6 theo pattern (kh√¥ng c·∫ßn s·ªë 6/7)</div>
    </div>

    <div class="hint">
      Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí tool t·ª± c·∫Øt v√πng b·∫£ng ‚Üí <b>DB: t√¨m nh√£n ƒêB/DB + 5 s·ªë</b> ‚Üí
      <b>G7: d√≤ng g·∫ßn cu·ªëi c√≥ 4 s·ªë 2 ch·ªØ s·ªë</b> ‚Üí <b>G6: d√≤ng ph√≠a tr√™n c√≥ 3 s·ªë 3 ch·ªØ s·ªë</b> ‚Üí
      <b>Gate pass</b> m·ªõi ƒë·ªï v√†o d·ªØ li·ªáu ‚Üí ch·∫°y FULL. <br/>
      (*Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.)
    </div>

    <div class="row">
      <button class="btn" id="btnMulti">üì∏ Upload nhi·ªÅu ·∫£nh</button>
      <button class="btn ghost" id="btnCam">üì∑ Camera</button>
      <button class="btn ghost" id="btnSample">D√°n m·∫´u</button>
      <button class="btn danger" id="btnClear">X√≥a</button>
      <input id="fileMulti" type="file" accept="image/*" multiple hidden />
      <input id="fileCam" type="file" accept="image/*" capture="environment" hidden />
    </div>

    <div class="status">
      <div class="badge ok" id="stCv">‚óè OpenCV: loading‚Ä¶</div>
      <div class="badge ok" id="stOcr">‚óè OCR: idle</div>
      <div class="badge warn" id="stGate">‚óè Gate: waiting</div>
      <div class="badge warn" id="stBatch">‚óè Batch: 0</div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <h2 class="sectionTitle">·∫¢nh ‚Üí OCR ‚Üí Gate</h2>
        <div class="hint">
          M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) v√† header qu·∫£ng c√°o.
        </div>

        <div class="preview" style="margin-top:10px">
          <img id="imgPreview" alt="preview" />
          <canvas id="cvCanvas" style="display:none"></canvas>
        </div>

        <div class="kpi">
          <div class="box"><div class="t">DB (2 s·ªë)</div><div class="v" id="kDB">--</div></div>
          <div class="box"><div class="t">G6 (3 s·ªë)</div><div class="v" id="kG6">--</div></div>
          <div class="box"><div class="t">G7 (4 s·ªë)</div><div class="v" id="kG7">--</div></div>
          <div class="box"><div class="t">Gate</div><div class="v" id="kGate">--</div></div>
        </div>

        <div class="inputs">
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî DB (2 s·ªë)</label>
            <input id="manualDB" placeholder="VD: 45" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G6 (3 s·ªë 3 ch·ªØ s·ªë)</label>
            <input id="manualG6" placeholder="VD: 392 255 854" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G7 (4 s·ªë 2 ch·ªØ s·ªë)</label>
            <input id="manualG7" placeholder="VD: 03 82 85 81" />
          </div>
          <div class="field">
            <label>H√†nh ƒë·ªông</label>
            <div class="split">
              <button class="btn ghost" id="btnApplyManual">√Åp manual ‚Üí th√™m d√≤ng</button>
              <button class="btn ghost" id="btnRetryLast">Th·ª≠ OCR l·∫°i ·∫£nh cu·ªëi</button>
            </div>
          </div>
        </div>

      </div>

      <div>
        <h2 class="sectionTitle">Debug OCR</h2>
        <div class="mono" id="dbg">Ch∆∞a c√≥ OCR.</div>
      </div>
    </div>
  </div>

  <!-- =========================
       INPUT DATA
       ========================= -->
  <div class="card">
    <h2 class="sectionTitle">D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h2>
    <div class="hint">Format chu·∫©n auto: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b></div>
    <div class="field" style="margin-top:10px">
      <textarea id="inputData" placeholder="Sau batch scan, tool t·ª± ƒë·ªï v√†o ƒë√¢y..."></textarea>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="field">
        <label>C·ª≠a s·ªï ng√†y (Engine)</label>
        <input id="winDays" type="number" value="20" min="8" />
      </div>
      <div class="field">
        <label>C·ª≠a s·ªï pha (K = 9‚Äì12 khuy·∫øn ngh·ªã)</label>
        <input id="phaseK" type="number" value="9" min="7" max="15" />
      </div>
      <div class="field">
        <label>Top hi·ªÉn th·ªã</label>
        <input id="topN" type="number" value="15" min="5" />
      </div>
      <div class="field">
        <label>Top ch·ªët (GOD MODE)</label>
        <input id="topChot" type="number" value="4" min="2" max="8" />
      </div>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="field">
        <label>Tr·ªçng s·ªë Hot</label>
        <input id="wHot" type="number" value="2" step="0.1" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Gan</label>
        <input id="wGan" type="number" value="1.5" step="0.1" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Pascal</label>
        <input id="wPas" type="number" value="2" step="0.1" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Tr·ª•c</label>
        <input id="wTruc" type="number" value="1.2" step="0.1" />
      </div>
    </div>

    <div class="chiprow">
      <div class="chip on" id="chipGod">GOD MODE: ON</div>
      <div class="chip on" id="chipSupervisor">AI gi√°m s√°t: ON</div>
      <div class="chip on" id="chipBacktest">Backtest: 9 v√≤ng</div>
    </div>

    <div class="row">
      <button class="btn" id="btnFull">üöÄ Ch·∫°y FULL (Pha ‚Üí H∆∞·ªõng ‚Üí 4 s·ªë + % + C·∫£nh b√°o)</button>
      <button class="btn ghost" id="btnTune">üß† AI gi√°m s√°t: T·ªëi ∆∞u weight theo pha (backtest)</button>
    </div>

    <div class="hint">
      Quy tr√¨nh MASTER+++ ƒë√∫ng √Ω H√†o: <b>ƒê·ªçc PHA ‚Üí ch·ªët H∆Ø·ªöNG (tr·ª•c hay G6/G7) ‚Üí m·ªõi t√≠nh ƒëi·ªÉm ‚Üí ra 4 s·ªë + %</b>.
      PP ch·ªâ d√πng ƒë·ªÉ x√°c nh·∫≠n/gi·∫£i th√≠ch, kh√¥ng d·∫´n d·∫Øt b·ª´a.
    </div>
  </div>

  <!-- =========================
       OUTPUT
       ========================= -->
  <div class="card">
    <h2 class="sectionTitle">K·∫æT QU·∫¢ FULL</h2>
    <div class="mono" id="out">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

    <!-- 2 ph·∫ßn m·ªõi: PHA + AI gi√°m s√°t / c·∫£nh b√°o -->
    <div class="okBox" id="phaBox" style="display:none">
      <div style="font-weight:900;margin-bottom:6px">ƒê·ªåC PHA (MASTER+++)</div>
      <div class="mono" id="phaOut">--</div>
    </div>

    <div class="warnBox" id="warnBox" style="display:none">
      <div style="font-weight:900;margin-bottom:6px">C·∫¢NH B√ÅO M·∫†NH (ANTI-B·∫™Y)</div>
      <div class="mono" id="warnOut">--</div>
    </div>

    <div class="okBox" id="supBox" style="display:none">
      <div style="font-weight:900;margin-bottom:6px">AI GI√ÅM S√ÅT (Backtest & ch·ªçn weight)</div>
      <div class="mono" id="supOut">--</div>
    </div>
  </div>

  <div class="card">
    <div class="small">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
  </div>

</div>

<!-- Load libs -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>

<script>
/* =========================================================
   1) SCAN/OCR/GATE ‚Äî GI·ªÆ NGUY√äN (KH√îNG PH√Å SCAN/SCALE)
   ========================================================= */
let cvReady = false;
let lastImageBlob = null;
let batchOK = 0, batchFail = 0;

const el = (id)=>document.getElementById(id);

function setBadge(id, text, cls){
  const e = el(id);
  e.textContent = text;
  e.classList.remove("ok","warn","fail");
  e.classList.add(cls);
}

function setStatus(){
  setBadge("stCv", `‚óè OpenCV: ${cvReady ? "OK" : "loading‚Ä¶"}`, cvReady ? "ok" : "warn");
  setBadge("stBatch", `‚óè Batch: OK ${batchOK} | FAIL ${batchFail}`, (batchFail>0) ? "warn" : "ok");
}

function showKPI(db2, g6, g7, gate){
  el("kDB").textContent = db2 || "--";
  el("kG6").textContent = g6?.length ? g6.join(" ") : "--";
  el("kG7").textContent = g7?.length ? g7.join(" ") : "--";
  el("kGate").textContent = gate;
}

function onOpenCvReady(){
  cvReady = true;
  setStatus();
}
setStatus();

function pad2(n){ return String(n).padStart(2,"0"); }

function canvasFromMat(mat){
  const canvas = document.createElement("canvas");
  canvas.width = mat.cols;
  canvas.height = mat.rows;
  cv.imshow(canvas, mat);
  return canvas;
}

function preprocess(mat){
  const gray = new cv.Mat();
  cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY, 0);
  const blur = new cv.Mat();
  cv.GaussianBlur(gray, blur, new cv.Size(3,3), 0, 0, cv.BORDER_DEFAULT);

  const thr = new cv.Mat();
  cv.adaptiveThreshold(
    blur, thr, 255,
    cv.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv.THRESH_BINARY, 31, 8
  );
  gray.delete(); blur.delete();
  return thr;
}

async function ocrText(canvas){
  const res = await Tesseract.recognize(canvas, "eng", {
    logger: ()=>{},
    tessedit_char_whitelist: "0123456789",
    preserve_interword_spaces: "1",
  });
  return (res.data.text || "");
}

function cleanOCRDigits(txt){
  return String(txt)
    .replace(/[Oo]/g,"0")
    .replace(/[Il|]/g,"1")
    .replace(/S/g,"5")
    .replace(/B/g,"8")
    .replace(/[^\d\s\n]/g," ")
    .replace(/\s+\n/g,"\n")
    .replace(/\n\s+/g,"\n")
    .replace(/[ \t]+/g," ")
    .trim();
}

function extractDB5_fromLabel(text){
  const t = text.replace(/\s+/g," ");
  let m = t.match(/(?:ƒê\s*B|D\s*B)\s*(\d{5})/);
  if(m) return m[1];
  m = t.match(/\b\d{5}\b/);
  return m ? m[0] : "";
}

function findG7Line(lines){
  for(let i=lines.length-1;i>=0;i--){
    const nums2 = (lines[i].match(/\b\d{2}\b/g) || []);
    if(nums2.length >= 4){
      return {arr: nums2.slice(0,4), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}

function findG6Line(lines, g7Index){
  for(let i=g7Index-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  for(let i=lines.length-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}

function gateCheck(db5, g6_3, g7_4){
  if(!/^\d{5}$/.test(db5)) return {ok:false, reason:"DB kh√¥ng ƒë·ªß 5 s·ªë"};
  if(!g7_4 || g7_4.length!==4 || !g7_4.every(x=>/^\d{2}$/.test(x))) return {ok:false, reason:"G7 ph·∫£i ƒë√∫ng 4 s·ªë (2 ch·ªØ s·ªë)"};
  if(!g6_3 || g6_3.length!==3 || !g6_3.every(x=>/^\d{3}$/.test(x))) return {ok:false, reason:"G6 ph·∫£i ƒë√∫ng 3 s·ªë (3 ch·ªØ s·ªë)"};
  return {ok:true, reason:"OK"};
}

function addLineToInput(db5, g7, g6){
  const db2 = db5.slice(-2);
  const line = `DB ${db2} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`;
  const cur = el("inputData").value.trim();
  el("inputData").value = (cur ? cur + "\n" : "") + line;
}

async function runOCRFromBlob(blob){
  if(!cvReady){
    alert("OpenCV ch∆∞a load xong. ƒê·ª£i 2‚Äì3 gi√¢y r·ªìi th·ª≠ l·∫°i.");
    return;
  }
  lastImageBlob = blob;

  setBadge("stOcr", "‚óè OCR: running‚Ä¶", "warn");
  setBadge("stGate", "‚óè Gate: checking‚Ä¶", "warn");
  showKPI("", [], [], "--");

  const url = URL.createObjectURL(blob);
  el("imgPreview").src = url;

  await new Promise(r=>{
    el("imgPreview").onload = ()=>r();
  });

  const img = el("imgPreview");
  const canvas = el("cvCanvas");
  canvas.style.display = "none";
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0);

  let src = cv.imread(canvas);
  const W = src.cols, H = src.rows;
  const crop = src.roi(new cv.Rect(
    Math.floor(W*0.02),
    Math.floor(H*0.02),
    Math.floor(W*0.96),
    Math.floor(H*0.96)
  ));
  src.delete(); src = crop;

  const upH = Math.floor(src.rows * 0.55);
  const upper = src.roi(new cv.Rect(0,0, src.cols, upH));
  const body  = src.roi(new cv.Rect(0, Math.floor(src.rows*0.35), src.cols, Math.floor(src.rows*0.65)));

  const upperBin = preprocess(upper);
  const upperCanvas = canvasFromMat(upperBin);
  const upperTxt1 = await ocrText(upperCanvas);

  const upperInv = new cv.Mat(); cv.bitwise_not(upperBin, upperInv);
  const upperCanvas2 = canvasFromMat(upperInv);
  const upperTxt2 = await ocrText(upperCanvas2);

  const upperTxt = cleanOCRDigits((upperTxt1||"") + "\n" + (upperTxt2||""));
  const db5 = extractDB5_fromLabel(upperTxt);

  upper.delete(); upperBin.delete(); upperInv.delete();

  const bodyBin = preprocess(body);
  const bodyCanvas = canvasFromMat(bodyBin);
  const bodyTxt1 = await ocrText(bodyCanvas);

  const bodyInv = new cv.Mat(); cv.bitwise_not(bodyBin, bodyInv);
  const bodyCanvas2 = canvasFromMat(bodyInv);
  const bodyTxt2 = await ocrText(bodyCanvas2);

  const bodyTxt = cleanOCRDigits((bodyTxt1||"") + "\n" + (bodyTxt2||""));
  const lines = bodyTxt.split("\n").map(s=>s.trim()).filter(Boolean);

  const g7Found = findG7Line(lines);
  const g6Found = findG6Line(lines, g7Found.idx);

  const g7 = g7Found.arr;
  const g6 = g6Found.arr;

  body.delete(); bodyBin.delete(); bodyInv.delete();
  src.delete();
  URL.revokeObjectURL(url);

  const gate = gateCheck(db5, g6, g7);
  const db2 = (/^\d{5}$/.test(db5)) ? db5.slice(-2) : "";

  el("dbg").textContent =
`[UPPER_OCR]
${upperTxt || "(empty)"}

[DB_5DIG]
${db5 || "(none)"}

[LOWER_OCR]
${bodyTxt || "(empty)"}

[G7_LINE]
${g7Found.line || "(none)"}

[G6_LINE]
${g6Found.line || "(none)"}
`;

  showKPI(db2, g6, g7, gate.ok ? "PASS" : "FAIL");
  setBadge("stOcr", "‚óè OCR: done", "ok");
  if(gate.ok){
    setBadge("stGate", "‚óè Gate: PASS", "ok");
    addLineToInput(db5, g7, g6);
    batchOK++;
  }else{
    setBadge("stGate", `‚óè Gate: FAIL ‚Äî ${gate.reason}`, "fail");
    batchFail++;
    el("manualDB").value = db2 || "";
    el("manualG6").value = g6.length ? g6.join(" ") : "";
    el("manualG7").value = g7.length ? g7.join(" ") : "";
  }
  setStatus();
}

function parseManual(){
  const db2 = (el("manualDB").value || "").replace(/\D/g,"").slice(-2);
  const g6 = (el("manualG6").value || "").match(/\b\d{3}\b/g) || [];
  const g7 = (el("manualG7").value || "").match(/\b\d{2}\b/g) || [];
  if(db2.length!==2) return {ok:false, msg:"DB manual ph·∫£i ƒë√∫ng 2 s·ªë"};
  if(g6.length<3) return {ok:false, msg:"G6 manual ph·∫£i ƒë·ªß 3 s·ªë (3 ch·ªØ s·ªë)"};
  if(g7.length<4) return {ok:false, msg:"G7 manual ph·∫£i ƒë·ªß 4 s·ªë (2 ch·ªØ s·ªë)"};
  const fakeDB5 = "000" + db2;
  return {ok:true, fakeDB5, g6:g6.slice(0,3), g7:g7.slice(0,4)};
}

el("btnApplyManual").onclick = ()=>{
  const r = parseManual();
  if(!r.ok){ alert(r.msg); return; }
  addLineToInput(r.fakeDB5, r.g7, r.g6);
  setBadge("stGate","‚óè Gate: MANUAL OK","ok");
};

el("btnMulti").onclick = ()=> el("fileMulti").click();
el("btnCam").onclick   = ()=> el("fileCam").click();

el("fileMulti").addEventListener("change", async (e)=>{
  const files = [...(e.target.files || [])];
  if(!files.length) return;

  setBadge("stOcr","‚óè OCR: batch running‚Ä¶","warn");
  batchOK = 0; batchFail = 0;
  setStatus();

  for(const f of files){
    await runOCRFromBlob(f);
    await new Promise(r=>setTimeout(r, 120));
  }
  setBadge("stOcr","‚óè OCR: batch done","ok");
});

el("fileCam").addEventListener("change", async (e)=>{
  const f = (e.target.files || [])[0];
  if(!f) return;
  await runOCRFromBlob(f);
});

el("btnRetryLast").onclick = async ()=>{
  if(!lastImageBlob){ alert("Ch∆∞a c√≥ ·∫£nh n√†o ƒë·ªÉ retry."); return; }
  await runOCRFromBlob(lastImageBlob);
};

el("btnClear").onclick = ()=>{
  el("inputData").value = "";
  el("out").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
  el("dbg").textContent = "Ch∆∞a c√≥ OCR.";
  batchOK=0; batchFail=0;
  setBadge("stOcr","‚óè OCR: idle","ok");
  setBadge("stGate","‚óè Gate: waiting","warn");
  setStatus();
  showKPI("", [], [], "--");
  // clear new boxes too
  el("phaBox").style.display="none";
  el("warnBox").style.display="none";
  el("supBox").style.display="none";
};

el("btnSample").onclick = ()=>{
  el("inputData").value =
`DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 21 | G7: 76 47 21 77 | G6: 801 295 993
DB 14 | G7: 81 87 60 32 | G6: 206 200 971
DB 13 | G7: 77 19 86 10 | G6: 484 417 202
DB 59 | G7: 21 41 02 14 | G6: 803 363 887`;
};

/* =========================================================
   2) ENGINE FULL PRO (LOTO 2 S·ªê) ‚Äî PHA TR∆Ø·ªöC, SAU ƒê√ì M·ªöI CH·ªêT
   + 2 PH·∫¶N M·ªöI:
     (A) ƒê·ªçc pha MASTER+++
     (B) AI gi√°m s√°t + backtest ch·ªçn weight + 4 s·ªë + % + 3 c·∫£nh b√°o m·∫°nh
   ========================================================= */

/* ---------- Parse input lines ---------- */
function parseLines(){
  const raw = el("inputData").value.trim().split("\n").map(s=>s.trim()).filter(Boolean);

  const win = Math.max(8, parseInt(el("winDays").value||"20",10));
  const slice = raw.slice(0, win); // gi·∫£ ƒë·ªãnh newest ·ªü tr√™n
  const days = [];

  for(const line of slice){
    const dbm = line.match(/DB\s+(\d{2})/);
    const g7m = line.match(/G7:\s*([0-9 ]+)/);
    const g6m = line.match(/G6:\s*([0-9 ]+)/);

    if(!dbm || !g7m || !g6m) continue;

    const db2 = dbm[1];
    const g7 = (g7m[1].match(/\b\d{2}\b/g)||[]).slice(0,4);
    const g6 = (g6m[1].match(/\b\d{3}\b/g)||[]).slice(0,3);

    const g6_2 = g6.map(x=>x.slice(-2));
    const pool = [db2, ...g7, ...g6_2].map(x=>pad2(x));
    days.push({db2:pad2(db2), g7:g7.map(pad2), g6_2:g6_2.map(pad2), pool});
  }
  return days;
}

/* ---------- Helpers / Features ---------- */
function entropy(counts){
  const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
  let e = 0;
  for(const k in counts){
    const p = counts[k]/total;
    if(p>0) e -= p*Math.log2(p);
  }
  return e;
}
function topKeys(obj, n){
  return Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]);
}
function buildHeadTail(days, K){
  const h={}, t={};
  const slice = days.slice(0, K);
  slice.forEach(d=>{
    d.pool.forEach(n=>{
      const a=n[0], b=n[1];
      h[a]=(h[a]||0)+1;
      t[b]=(t[b]||0)+1;
    });
  });
  return {h,t};
}
function makeTrucSet(topH, topT){
  const set = new Set();
  for(const a of topH){
    for(const b of topT){
      set.add(`${a}${b}`);
    }
  }
  return set;
}
function hitRateTruc(days, trucSet, K){
  const slice = days.slice(0, K);
  let hit=0, total=0;
  slice.forEach(d=>{
    total++;
    const ok = d.pool.some(n=>trucSet.has(n));
    if(ok) hit++;
  });
  return total? hit/total : 0;
}
function bong(n){
  const a = parseInt(n[0],10), b=parseInt(n[1],10);
  const map = [5,6,7,8,9,0,1,2,3,4];
  return `${map[a]}${map[b]}`.padStart(2,"0");
}
function keSet(n){
  const x = parseInt(n,10);
  const s = new Set([n]);
  s.add(String((x+1)%100).padStart(2,"0"));
  s.add(String((x+99)%100).padStart(2,"0"));
  s.add(bong(n));
  return s;
}
function g7LeadScore(days, K){
  const slice = days.slice(0, K);
  let total=0, hit=0;

  for(let i=0;i<slice.length-1;i++){
    const today = slice[i];
    const prev  = slice[i+1];
    const lead = new Set();
    prev.g7.forEach(x=>keSet(x).forEach(v=>lead.add(v)));

    total++;
    const ok = today.pool.some(n=>lead.has(n));
    if(ok) hit++;
  }
  return total? hit/total : 0;
}
function ganMap(days, K){
  const slice = days.slice(0, K);
  const seen = {};
  slice.forEach((d, idx)=>{
    d.pool.forEach(n=>{
      if(seen[n]===undefined) seen[n]=idx;
    });
  });
  const g={};
  for(let i=0;i<100;i++){
    const n=String(i).padStart(2,"0");
    g[n] = (seen[n]===undefined)? 999 : seen[n];
  }
  return g;
}
function nowRepeatScore(days){
  if(days.length<2) return 0;
  const a = new Set(days[0].pool);
  const b = new Set(days[1].pool);
  let inter=0;
  a.forEach(x=>{ if(b.has(x)) inter++; });
  return inter / Math.max(1, a.size);
}

/* ---------- Pascal (nh·∫π, kh√¥ng l√†m m√†u) ----------
   Pascal ·ªü ƒë√¢y d√πng nh∆∞ "nh·ªãp s·ªë" (kh√¥ng ph·∫£i th·∫ßn th√°nh):
   L·∫•y 2 ng√†y g·∫ßn nh·∫•t: (DB2 + 4 G7 + 3 G6_2) => t·∫°o list 8 s·ªë.
   Pascal-2 t·∫ßng: digit-wise sum mod10 gi·ªØa ng√†y0 v√† ng√†y1 -> t·∫°o "seed" 8 s·ªë.
   N s·ªë tr√πng seed -> + ƒëi·ªÉm Pascal.
*/
function pascalSeed(days){
  if(days.length<2) return new Set();
  const A = days[0].pool.slice(0,8);
  const B = days[1].pool.slice(0,8);
  const seed = new Set();
  for(let i=0;i<8;i++){
    const a=A[i], b=B[i];
    const d1 = (parseInt(a[0],10)+parseInt(b[0],10))%10;
    const d2 = (parseInt(a[1],10)+parseInt(b[1],10))%10;
    seed.add(`${d1}${d2}`);
  }
  return seed;
}

/* =========================================================
   (A) ƒê·ªåC PHA MASTER+++ (tr·∫£: pha + h∆∞·ªõng + tin c·∫≠y + l√Ω do)
   ========================================================= */
function readPhase(days, K=9){
  const k = Math.min(K, days.length);
  const ht = buildHeadTail(days, k);

  const hEnt = entropy(ht.h);
  const tEnt = entropy(ht.t);

  const topH = topKeys(ht.h, 3);
  const topT = topKeys(ht.t, 3);
  const trucSet = makeTrucSet(topH, topT);

  const trucHit = hitRateTruc(days, trucSet, k);
  const g7Lead  = g7LeadScore(days, k);
  const repNow  = nowRepeatScore(days);

  const gMap = ganMap(days, k);
  const candidates = Array.from(trucSet);
  let ganGood=0;
  candidates.slice(0,20).forEach(n=>{
    const g = gMap[n];
    if(g>=2 && g<=9) ganGood++;
  });
  const ganGoodRate = ganGood / Math.max(1, Math.min(20, candidates.length));

  const isTrucStrong = (trucHit>=0.62) || (trucHit>=0.55 && ganGoodRate>=0.35 && (hEnt+tEnt)<=6.2);
  const isG7Lead = (g7Lead>=0.60) && (trucHit<=0.56);
  const isNoise = (trucHit<=0.48) && (g7Lead<=0.50) && ((hEnt+tEnt)>=6.8);
  const isXa = (repNow>=0.22) && (trucHit>=0.50) && (g7Lead<=0.58);

  const prev = days.slice(1, k);
  let prevTruc = 0;
  if(prev.length>=6){
    const prevHt = buildHeadTail(prev, Math.min(prev.length, k-1));
    const prevTrucSet = makeTrucSet(topKeys(prevHt.h,3), topKeys(prevHt.t,3));
    prevTruc = hitRateTruc(prev, prevTrucSet, Math.min(prev.length, k-1));
  }
  const isMo = (prev.length>=6) && (prevTruc<=0.50) && (trucHit>=0.58) && (ganGoodRate>=0.35);

  let pha="P3", dir="GIAO THOA", conf=0.58, why=[];
  if(isNoise){
    pha="P4"; dir="NE"; conf=0.72;
    why.push(`Nhi·ªÖu: tr·ª•cHit ${(trucHit*100).toFixed(0)}% th·∫•p, g7Lead ${(g7Lead*100).toFixed(0)}% th·∫•p, entropy cao`);
  }else if(isG7Lead){
    pha="P1"; dir="THEO_G7"; conf=0.74;
    why.push(`G7 Lead: ${(g7Lead*100).toFixed(0)}% chuy·ªÉn ti·∫øp (k·ªÅ/b√≥ng/ch·∫°m)`);
  }else if(isXa){
    pha="P5"; dir="TRUC_GAN"; conf=0.70;
    why.push(`X·∫£/l·∫∑p: overlap h√¥m nay ${(repNow*100).toFixed(0)}% + tr·ª•c c√≤n gi·ªØ`);
  }else if(isMo){
    pha="P6"; dir="TRUC_MO"; conf=0.76;
    why.push(`M·ªü: tr·ª•c h·ªìi m·∫°nh (prev ${(prevTruc*100).toFixed(0)}% ‚Üí now ${(trucHit*100).toFixed(0)}%) + gan ƒë·∫πp`);
  }else if(isTrucStrong){
    pha="P2"; dir="TRUC_GAN"; conf=0.78;
    why.push(`Tr·ª•c Lead: tr·ª•cHit ${(trucHit*100).toFixed(0)}% + t·∫≠p trung ƒë·∫ßu/ƒëu√¥i`);
  }else{
    pha="P3"; dir="GIAO THOA"; conf=0.60;
    why.push(`Giao thoa: tr·ª•c ${(trucHit*100).toFixed(0)}% | g7Lead ${(g7Lead*100).toFixed(0)}%`);
  }

  return {
    pha, dir, conf,
    metrics:{trucHit, g7Lead, repNow, ganGoodRate, hEnt, tEnt, topH, topT},
    why
  };
}

/* =========================================================
   (B) AI GI√ÅM S√ÅT: backtest 9‚Äì12 v√≤ng ƒë·ªÉ ch·ªçn weight theo pha
   - nh·∫π, ch·∫°y ·ªïn Android
   ========================================================= */
function scoreCandidates(days, weights, phaseObj){
  const win = days.length;

  // freq hot
  const freq = {};
  days.forEach(d=>d.pool.forEach(n=>freq[n]=(freq[n]||0)+1));

  // gan
  const g = ganMap(days, win);

  // head/tail + truc set
  const ht = buildHeadTail(days, Math.min(win, parseInt(el("phaseK").value||"9",10)));
  const topH = topKeys(ht.h, 3);
  const topT = topKeys(ht.t, 3);
  const trucSet = makeTrucSet(topH, topT);

  // pascal seed
  const ps = pascalSeed(days);

  // g7 lead sets (t·ª´ ng√†y g·∫ßn nh·∫•t)
  const lead = new Set();
  if(days.length>=2){
    const prev = days[0]; // newest in window
    prev.g7.forEach(x=>keSet(x).forEach(v=>lead.add(v)));
  }

  const score = {};
  for(let i=0;i<100;i++){
    const n = pad2(i);

    const hot = freq[n]||0;
    const gan = g[n];

    // ganScore: ∆∞u ti√™n 2..9, ph·∫°t gan=0 v√† gan qu√° d√†i
    let ganScore = 0;
    if(gan===999) ganScore = -2;
    else if(gan===0) ganScore = -1.0;
    else if(gan>=2 && gan<=9) ganScore = 2.0;
    else ganScore = 0;

    // trucScore
    const trucScore = trucSet.has(n) ? 1.0 : 0.0;

    // pascalScore
    const pasScore = ps.has(n) ? 1.0 : 0.0;

    // g7LeadScore (k·ªÅ/b√≥ng)
    const g7Lead = lead.has(n) ? 1.0 : 0.0;

    // anti-b·∫´y: n·∫øu pha l√† P4 (nhi·ªÖu) th√¨ gi·∫£m m·∫°nh m·ªçi ƒëi·ªÉm ‚Äúƒë·∫πp‚Äù
    const noisePenalty = (phaseObj && phaseObj.pha==="P4") ? 0.85 : 1.0;

    score[n] =
      (hot * weights.wHot) +
      (ganScore * weights.wGan) +
      (pasScore * weights.wPas) +
      (trucScore * weights.wTruc) +
      (g7Lead * weights.wG7) ;

    score[n] *= noisePenalty;
  }
  return score;
}

function pickTop(scoreMap, topChot){
  return Object.entries(scoreMap)
    .sort((a,b)=>b[1]-a[1])
    .slice(0, topChot);
}

function probsFromScores(topEntries){
  // softmax nh·∫π ƒë·ªÉ ra %
  const vals = topEntries.map(x=>x[1]);
  const max = Math.max(...vals);
  const exps = vals.map(v=>Math.exp((v-max)/2.2));
  const sum = exps.reduce((a,b)=>a+b,0) || 1;
  return exps.map(e=>e/sum);
}

function backtestTune(allDays, windowN, phaseK, rounds=9){
  // newest-first allDays (parseLines already newest-first)
  // backtest: d·ª± ƒëo√°n ng√†y i d·ª±a tr√™n window tr∆∞·ªõc ƒë√≥ (i+1 ... i+windowN)
  // hit n·∫øu 1 trong top4 n·∫±m trong pool c·ªßa ng√†y i (ng√†y m·ª•c ti√™u)
  const topChot = Math.max(2, parseInt(el("topChot").value||"4",10));
  const maxRounds = Math.min(rounds, allDays.length - windowN - 1);
  if(maxRounds < 5){
    return {ok:false, msg:"Thi·∫øu d·ªØ li·ªáu ƒë·ªÉ backtest (c·∫ßn nhi·ªÅu h∆°n)."};
  }

  // preset weights candidates (nh·∫π, ƒë·ªß d√πng)
  const presets = [
    {name:"TRUC_GAN", wHot:1.1, wGan:2.2, wPas:1.0, wTruc:2.4, wG7:0.6},
    {name:"TRUC_MO",  wHot:1.6, wGan:1.8, wPas:1.0, wTruc:2.2, wG7:0.8},
    {name:"G7_LEAD",  wHot:1.6, wGan:1.2, wPas:1.3, wTruc:1.0, wG7:2.0},
    {name:"MIX",      wHot:1.7, wGan:1.6, wPas:1.2, wTruc:1.6, wG7:1.0},
    {name:"SAFE",     wHot:1.2, wGan:1.4, wPas:1.0, wTruc:1.2, wG7:0.8},
  ];

  const results = presets.map(p=>({preset:p, hit:0, total:0, detail:[]}));

  for(let r=0;r<maxRounds;r++){
    const targetIdx = r; // ng√†y m·ª•c ti√™u
    const windowStart = r+1;
    const windowEnd = r+1+windowN;

    const winDays = allDays.slice(windowStart, windowEnd);
    const target = allDays[targetIdx];

    const pha = readPhase(winDays, phaseK);

    results.forEach(res=>{
      const score = scoreCandidates(winDays, res.preset, pha);
      const top = pickTop(score, topChot).map(x=>x[0]);
      const ok = top.some(n=>target.pool.includes(n));
      res.total++;
      if(ok) res.hit++;
      res.detail.push({r, pha:pha.pha, top:top.join(" "), ok});
    });
  }

  // ch·ªçn preset c√≥ hit rate cao nh·∫•t
  results.sort((a,b)=>(b.hit/b.total)-(a.hit/a.total));
  const best = results[0];
  return {ok:true, best, all:results, rounds:maxRounds};
}

/* =========================================================
   Anti-b·∫´y: 3 c·∫£nh b√°o m·∫°nh (ƒë√∫ng y√™u c·∫ßu)
   ========================================================= */
function buildStrongWarnings(phaObj){
  const w = [];
  const m = phaObj.metrics;

  if(phaObj.pha==="P4"){
    w.push("‚õî Ng√†y NHI·ªÑU (P4): tr·ª•c y·∫øu + g7 lead y·∫øu + entropy cao ‚Üí Khuy·∫øn ngh·ªã: N√â / gi·∫£m m·∫°nh v·ªën.");
  }
  if(m.repNow>=0.22){
    w.push(`‚ö†Ô∏è D·∫•u X·∫¢/L·∫∂P: overlap h√¥m nay ${(m.repNow*100).toFixed(0)}% ‚Üí tr√°nh b√°m HOT/c·ª•m, ∆∞u ti√™n GAN ƒë·∫πp + tr·ª•c.`);
  }
  if(m.trucHit<=0.50 && m.g7Lead<=0.52){
    w.push(`‚ö†Ô∏è B·∫™Y C·ª§M: tr·ª•cHit ${(m.trucHit*100).toFixed(0)}% & g7Lead ${(m.g7Lead*100).toFixed(0)}% ƒë·ªÅu th·∫•p ‚Üí d·ªÖ ra s·ªë l·∫ª b·∫•t quy t·∫Øc.`);
  }

  // ƒë·∫£m b·∫£o ƒë√∫ng 3 c·∫£nh b√°o (n·∫øu thi·∫øu th√¨ b·ªï sung)
  while(w.length<3){
    if(w.length===0) w.push("‚ö†Ô∏è C·∫£nh b√°o: d·ªØ li·ªáu c·ª≠a s·ªï nh·ªè ho·∫∑c l·ªách th·ª© t·ª± (newest ph·∫£i ·ªü tr√™n) s·∫Ω l√†m l·ªách pha.");
    else if(w.length===1) w.push("‚ö†Ô∏è C·∫£nh b√°o: n·∫øu h√¥m qua/ h√¥m nay ƒë·ªïi pha ƒë·ªôt ng·ªôt, ∆∞u ti√™n ƒë√°nh nh·ªè & ch·ªù x√°c nh·∫≠n.");
    else w.push("‚ö†Ô∏è C·∫£nh b√°o: ƒë·ª´ng d·ªìn 1 h∆∞·ªõng; n·∫øu pha P3 giao thoa, ph·∫£i l·ªçc s·ªë c√≥ 2/3 ti√™u ch√≠ tr√πng nhau.");
  }
  return w.slice(0,3);
}

/* =========================================================
   RUN FULL: Pha -> set weight -> score -> 4 s·ªë + % + output
   ========================================================= */
function runFULL(withSupervisor=false){
  const days = parseLines();
  if(days.length < 8){
    el("out").textContent = "‚ùå Thi·∫øu d·ªØ li·ªáu: c·∫ßn √≠t nh·∫•t 8 d√≤ng (8 ng√†y).";
    el("phaBox").style.display="none";
    el("warnBox").style.display="none";
    el("supBox").style.display="none";
    return;
  }

  const topN = Math.max(5, parseInt(el("topN").value||"15",10));
  const topChot = Math.max(2, parseInt(el("topChot").value||"4",10));
  const phaseK = Math.max(7, parseInt(el("phaseK").value||"9",10));

  // 1) ƒê·ªçc pha tr√™n window pha
  const phaWin = Math.min(days.length, Math.max(9, phaseK));
  const phaObj = readPhase(days.slice(0, phaWin), phaseK);

  // show pha
  el("phaBox").style.display="block";
  el("phaOut").textContent =
`Pha: ${phaObj.pha} | H∆∞·ªõng: ${phaObj.dir} | Tin c·∫≠y: ${(phaObj.conf*100).toFixed(0)}%
L√Ω do: ${phaObj.why.join(" | ")}

Ch·ªâ s·ªë:
- Tr·ª•c hit: ${(phaObj.metrics.trucHit*100).toFixed(0)}%
- G7 lead: ${(phaObj.metrics.g7Lead*100).toFixed(0)}%
- Overlap (x·∫£): ${(phaObj.metrics.repNow*100).toFixed(0)}%
- Gan ƒë·∫πp (2..9): ${(phaObj.metrics.ganGoodRate*100).toFixed(0)}%
- Top ƒë·∫ßu: ${phaObj.metrics.topH.join(", ")} | Top ƒëu√¥i: ${phaObj.metrics.topT.join(", ")}
`;

  // 2) Weight base (UI)
  let weights = {
    wHot: parseFloat(el("wHot").value||"2"),
    wGan: parseFloat(el("wGan").value||"1.5"),
    wPas: parseFloat(el("wPas").value||"2"),
    wTruc: parseFloat(el("wTruc").value||"1.2"),
    wG7: 1.0
  };

  // 3) Kh√≥a weight theo pha (MASTER+++)
  // (ƒë√¢y l√† ‚Äúc√°i quy·∫øt ƒë·ªãnh‚Äù, kh√¥ng cho PP d·∫´n d·∫Øt)
  if(phaObj.pha==="P2"){ weights = {wHot:1.1,wGan:2.2,wPas:1.0,wTruc:2.4,wG7:0.6}; }
  if(phaObj.pha==="P6"){ weights = {wHot:1.6,wGan:1.8,wPas:1.0,wTruc:2.2,wG7:0.8}; }
  if(phaObj.pha==="P1"){ weights = {wHot:1.6,wGan:1.2,wPas:1.3,wTruc:1.0,wG7:2.0}; }
  if(phaObj.pha==="P5"){ weights = {wHot:0.9,wGan:2.2,wPas:1.0,wTruc:2.0,wG7:0.7}; }
  if(phaObj.pha==="P4"){ weights = {wHot:1.0,wGan:1.0,wPas:1.0,wTruc:0.8,wG7:0.8}; }
  if(phaObj.pha==="P3"){ weights = {wHot:1.7,wGan:1.6,wPas:1.2,wTruc:1.6,wG7:1.0}; }

  // 4) AI gi√°m s√°t (optional): backtest ƒë·ªÉ ch·ªçn preset t·ªët nh·∫•t
  let supText = "";
  if(withSupervisor){
    const btRounds = Math.max(9, Math.min(12, parseInt((el("chipBacktest").textContent.match(/\d+/)||["9"])[0],10)));
    const winEngine = Math.max(8, parseInt(el("winDays").value||"20",10));
    const bt = backtestTune(days, winEngine, phaseK, btRounds);

    el("supBox").style.display="block";
    if(bt.ok){
      weights = bt.best.preset;
      const rate = (bt.best.hit/bt.best.total*100).toFixed(0);
      supText =
`Backtest: ${bt.rounds} v√≤ng | Preset t·ªët nh·∫•t: ${bt.best.preset.name}
Hit-rate: ${bt.best.hit}/${bt.best.total}  (~${rate}%)

Weights √°p d·ª•ng:
- wHot=${weights.wHot} | wGan=${weights.wGan} | wPas=${weights.wPas} | wTruc=${weights.wTruc} | wG7=${weights.wG7}

Ghi ch√∫:
- AI gi√°m s√°t ch·ªâ t·ªëi ∆∞u theo d·ªØ li·ªáu b·∫°n d√°n (newest ·ªü tr√™n).
- N·∫øu ng√†y P4 (nhi·ªÖu) th√¨ d√π t·ªëi ∆∞u v·∫´n c√≥ th·ªÉ c·∫£nh b√°o ‚ÄúN√â‚Äù.
`;
    }else{
      supText = `‚ùå ${bt.msg}`;
    }
    el("supOut").textContent = supText;
  }else{
    el("supBox").style.display="none";
  }

  // 5) T√≠nh freq hot ƒë·ªÉ show top hot
  const freq = {};
  days.forEach(d=>d.pool.forEach(n=>freq[n]=(freq[n]||0)+1));
  const hotSorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,topN);

  // 6) Score (pha ƒë√£ kh√≥a) + pick topChot
  const score = scoreCandidates(days, weights, phaObj);
  const scoreSorted = Object.entries(score).sort((a,b)=>b[1]-a[1]).slice(0, Math.max(topN, topChot));
  const topPick = scoreSorted.slice(0, topChot);

  const p = probsFromScores(topPick);
  const pickLines = topPick.map(([n,s],i)=>`${n} ‚Üí ${s.toFixed(2)}  |  ${(p[i]*100).toFixed(0)}%`);

  // 7) 3 c·∫£nh b√°o m·∫°nh
  const warns = buildStrongWarnings(phaObj);
  el("warnBox").style.display="block";
  el("warnOut").textContent = warns.map((x,i)=>`${i+1}) ${x}`).join("\n");

  // 8) Output FULL (t·∫≠p trung LOTO 2 s·ªë)
  // ‚Äî gi·ªØ format d·ªÖ nh√¨n nh∆∞ H√†o ƒëang d√πng
  const main = topPick[0]?.[0] || "--";
  const sub  = topPick[1]?.[0] || "--";

  let out =
`T·ªïng ng√†y (Engine): ${days.length}

TOP HOT:
${hotSorted.map(([n,c])=>`${n} ‚Üí ${c}`).join("\n")}

TOP SCORE (pha-locked ‚Ä¢ hot+gan+pascal+truc+g7):
${scoreSorted.slice(0,topN).map(([n,s])=>`${n} ‚Üí ${s.toFixed(2)}`).join("\n")}

=== CH·ªêT GOD MODE (4 s·ªë + %) ===
${pickLines.join("\n")}

G·ª£i √Ω nhanh:
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•:  ${sub}

* Tool h·ªó tr·ª£ th·ªëng k√™/pha, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng.
`;

  // N·∫øu P4 -> nh·∫•n m·∫°nh "NE"
  if(phaObj.pha==="P4"){
    out += `\n‚õî K·∫æT LU·∫¨N: P4 NHI·ªÑU ‚Üí ∆Øu ti√™n N√â (ho·∫∑c ƒë√°nh r·∫•t nh·ªè, ch·ªù pha ƒë·ªïi).\n`;
  }else{
    out += `\n‚úÖ K·∫æT LU·∫¨N: ${phaObj.dir} (theo pha ${phaObj.pha}) ‚Üí Engine ƒë√£ kh√≥a h∆∞·ªõng tr∆∞·ªõc khi ch·ªët.\n`;
  }

  el("out").textContent = out;
}

/* =========================================================
   Buttons
   ========================================================= */
el("btnFull").onclick = ()=>runFULL(false);
el("btnTune").onclick = ()=>runFULL(true);

/* small chips toggles (UI only) */
el("chipGod").onclick = ()=>{
  el("chipGod").classList.toggle("on");
  el("chipGod").classList.toggle("off");
};
el("chipSupervisor").onclick = ()=>{
  el("chipSupervisor").classList.toggle("on");
  el("chipSupervisor").classList.toggle("off");
  // toggle affects btnTune intention (nh∆∞ng v·∫´n cho d√πng)
};
el("chipBacktest").onclick = ()=>{
  const cur = parseInt((el("chipBacktest").textContent.match(/\d+/)||["9"])[0],10);
  const next = (cur===9?10:(cur===10?11:(cur===11?12:9)));
  el("chipBacktest").textContent = `Backtest: ${next} v√≤ng`;
};
</script>
</body>
</html>
