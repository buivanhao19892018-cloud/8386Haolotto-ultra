<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3 - PP L√¥ 2 s·ªë)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.08);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#ff4d4f;
      --btn:#1e5eff;
      --btn2:#1a3fa8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 10% -20%, rgba(30,94,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(50,213,131,.18), transparent 55%),
        linear-gradient(180deg, #06101f, #050b16 45%, #050a13);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:920px;margin:0 auto}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      margin-bottom:14px;
    }
    h1{margin:0 0 8px;font-size:22px;letter-spacing:.2px}
    .pillrow{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}
    .pill{
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{display:inline-block;width:8px;height:8px;border-radius:99px;margin-right:6px;vertical-align:middle}
    .g{background:var(--good)} .y{background:var(--warn)} .r{background:var(--bad)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px}
    .btn{
      appearance:none;border:0;cursor:pointer;
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:white;font-weight:700;
      padding:12px 14px;border-radius:14px;
      box-shadow:0 10px 18px rgba(30,94,255,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;
      color:var(--text);
    }
    .btn.danger{
      background:linear-gradient(180deg,#ff4d4f,#b42318);
      box-shadow:0 10px 18px rgba(255,77,79,.18);
    }
    .hint{color:var(--muted);line-height:1.4;font-size:13px;margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(min-width:860px){
      .grid{grid-template-columns:1.2fr .8fr}
    }
    .preview{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      background:#060b13;
      overflow:hidden;
    }
    canvas, img{display:block;width:100%;height:auto}
    .status{
      display:flex;flex-wrap:wrap;gap:8px;margin-top:10px
    }
    .badge{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:700;font-size:12px
    }
    .badge.ok{color:var(--good)}
    .badge.fail{color:var(--bad)}
    .badge.warn{color:var(--warn)}
    .sectionTitle{
      font-size:18px;margin:0 0 6px;
    }
    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      color:#d7e2ff;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .inputs{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:700px){
      .inputs{grid-template-columns:1fr 1fr}
    }
    .field{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input, .field textarea, .field select{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      padding:6px 0;
    }
    textarea{min-height:150px;resize:vertical}
    .split{
      display:flex;gap:10px;flex-wrap:wrap
    }
    .split .field{flex:1;min-width:180px}
    .kpi{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:700px){
      .kpi{grid-template-columns:repeat(4,minmax(0,1fr))}
    }
    .kpi .box{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      padding:10px;
    }
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:16px;font-weight:800;margin-top:4px}

    /* tab active nh·∫π */
    .btn.ghost.active{
      border-color:rgba(255,255,255,.22);
      box-shadow:0 10px 18px rgba(255,255,255,.05);
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3)</h1>
    <div class="pillrow">
      <div class="pill"><span class="dot g"></span>OpenCV</div>
      <div class="pill"><span class="dot g"></span>Tesseract OCR</div>
      <div class="pill"><span class="dot y"></span>Gate c·ª©ng</div>
      <div class="pill"><span class="dot y"></span>Batch nhi·ªÅu ·∫£nh</div>
      <div class="pill"><span class="dot y"></span>DB theo nh√£n ‚ÄúƒêB/DB‚Äù + 5 s·ªë</div>
      <div class="pill"><span class="dot y"></span>G7/G6 theo pattern (kh√¥ng c·∫ßn s·ªë 6/7)</div>
      <div class="pill"><span class="dot g"></span>PP L√¥ 2 s·ªë (x·ªãn)</div>
    </div>

    <div class="hint">
      Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí tool t·ª± c·∫Øt v√πng b·∫£ng ‚Üí <b>DB: t√¨m nh√£n ƒêB/DB + 5 s·ªë</b> ‚Üí
      <b>G7: d√≤ng g·∫ßn cu·ªëi c√≥ 4 s·ªë 2 ch·ªØ s·ªë</b> ‚Üí <b>G6: d√≤ng ph√≠a tr√™n c√≥ 3 s·ªë 3 ch·ªØ s·ªë</b> ‚Üí
      <b>Gate pass</b> m·ªõi ƒë·ªï v√†o d·ªØ li·ªáu ‚Üí ch·∫°y FULL ‚Üí soi PP l√¥ 2 s·ªë.
      <br/>
      (*Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.)
    </div>

    <div class="row">
      <button class="btn" id="btnMulti">üì∏ Upload nhi·ªÅu ·∫£nh</button>
      <button class="btn ghost" id="btnCam">üì∑ Camera</button>
      <button class="btn ghost" id="btnSample">D√°n m·∫´u</button>
      <button class="btn danger" id="btnClear">X√≥a</button>
      <input id="fileMulti" type="file" accept="image/*" multiple hidden />
      <input id="fileCam" type="file" accept="image/*" capture="environment" hidden />
    </div>

    <div class="status">
      <div class="badge ok" id="stCv">‚óè OpenCV: loading‚Ä¶</div>
      <div class="badge ok" id="stOcr">‚óè OCR: idle</div>
      <div class="badge warn" id="stGate">‚óè Gate: waiting</div>
      <div class="badge warn" id="stBatch">‚óè Batch: 0</div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <h2 class="sectionTitle">·∫¢nh ‚Üí OCR ‚Üí Gate</h2>
        <div class="hint">
          M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) v√† header qu·∫£ng c√°o.
        </div>

        <div class="preview" style="margin-top:10px">
          <img id="imgPreview" alt="preview" />
          <canvas id="cvCanvas" style="display:none"></canvas>
        </div>

        <div class="kpi">
          <div class="box"><div class="t">DB (2 s·ªë)</div><div class="v" id="kDB">--</div></div>
          <div class="box"><div class="t">G6 (3 s·ªë)</div><div class="v" id="kG6">--</div></div>
          <div class="box"><div class="t">G7 (4 s·ªë)</div><div class="v" id="kG7">--</div></div>
          <div class="box"><div class="t">Gate</div><div class="v" id="kGate">--</div></div>
        </div>

        <div class="inputs">
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî DB (2 s·ªë)</label>
            <input id="manualDB" placeholder="VD: 45" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G6 (3 s·ªë 3 ch·ªØ s·ªë)</label>
            <input id="manualG6" placeholder="VD: 392 255 854" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G7 (4 s·ªë 2 ch·ªØ s·ªë)</label>
            <input id="manualG7" placeholder="VD: 03 82 85 81" />
          </div>
          <div class="field">
            <label>H√†nh ƒë·ªông</label>
            <div class="split">
              <button class="btn ghost" id="btnApplyManual">√Åp manual ‚Üí th√™m d√≤ng</button>
              <button class="btn ghost" id="btnRetryLast">Th·ª≠ OCR l·∫°i ·∫£nh cu·ªëi</button>
            </div>
          </div>
        </div>

      </div>

      <div>
        <h2 class="sectionTitle">Debug OCR</h2>
        <div class="mono" id="dbg">Ch∆∞a c√≥ OCR.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 class="sectionTitle">D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h2>
    <div class="hint">Format chu·∫©n auto: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b></div>
    <div class="field" style="margin-top:10px">
      <textarea id="inputData" placeholder="Sau batch scan, tool t·ª± ƒë·ªï v√†o ƒë√¢y..."></textarea>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="field">
        <label>C·ª≠a s·ªï ng√†y</label>
        <input id="winDays" type="number" value="30" min="5" />
      </div>
      <div class="field">
        <label>Top hi·ªÉn th·ªã</label>
        <input id="topN" type="number" value="15" min="5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Hot</label>
        <input id="wHot" type="number" value="2" step="0.5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Gan</label>
        <input id="wGan" type="number" value="1.5" step="0.5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Pascal</label>
        <input id="wPas" type="number" value="2" step="0.5" />
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btnFull">üöÄ Ch·∫°y FULL</button>
    </div>
  </div>

  <div class="card">
    <h2 class="sectionTitle">K·∫æT QU·∫¢ FULL</h2>
    <div class="mono" id="out">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
  </div>

  <!-- NEW: PP SOI C·∫¶U -->
  <div class="card">
    <h2 class="sectionTitle">SOI C·∫¶U L√î 2 S·ªê ‚Äî ULTRA</h2>
    <div class="hint">
      T·ªïng h·ª£p theo: <b>Hot/Gan</b> ‚Ä¢ <b>ƒê·∫ßu/ƒêu√¥i</b> ‚Ä¢ <b>Ch·∫°m</b> ‚Ä¢ <b>K·ªÅ</b> ‚Ä¢ <b>B√≥ng</b> ‚Ä¢ <b>Tr·ª•c</b> ‚Ä¢ <b>Anti-b·∫´y</b>.
      (Ch·∫°y sau khi b·∫•m <b>Ch·∫°y FULL</b>.)
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn ghost" id="tabHot">Hot/Gan</button>
      <button class="btn ghost" id="tabHeadTail">ƒê·∫ßu/ƒêu√¥i</button>
      <button class="btn ghost" id="tabTouch">Ch·∫°m/K·ªÅ/B√≥ng</button>
      <button class="btn ghost" id="tabTruc">Tr·ª•c</button>
      <button class="btn" id="tabAll">T·ªïng h·ª£p</button>
    </div>

    <div class="mono" id="ppOut" style="margin-top:10px">Ch∆∞a ch·∫°y FULL.</div>
  </div>

  <div class="card">
    <div class="small">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
  </div>

</div>

<!-- Load libs -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>

<script>
/* ---------------------------
   STATE
---------------------------- */
let cvReady = false;
let lastImageBlob = null;
let batchOK = 0, batchFail = 0;

const el = (id)=>document.getElementById(id);

function setBadge(id, text, cls){
  const e = el(id);
  e.textContent = text;
  e.classList.remove("ok","warn","fail");
  e.classList.add(cls);
}

function setStatus(){
  setBadge("stCv", `‚óè OpenCV: ${cvReady ? "OK" : "loading‚Ä¶"}`, cvReady ? "ok" : "warn");
  setBadge("stBatch", `‚óè Batch: OK ${batchOK} | FAIL ${batchFail}`, (batchFail>0) ? "warn" : "ok");
}

function showKPI(db2, g6, g7, gate){
  el("kDB").textContent = db2 || "--";
  el("kG6").textContent = g6?.length ? g6.join(" ") : "--";
  el("kG7").textContent = g7?.length ? g7.join(" ") : "--";
  el("kGate").textContent = gate;
}

/* ---------------------------
   OpenCV ready
---------------------------- */
function onOpenCvReady(){
  cvReady = true;
  setStatus();
}

setStatus();

/* ---------------------------
   Helpers
---------------------------- */
function pad2(n){ return String(n).padStart(2,"0"); }

function canvasFromMat(mat){
  const canvas = document.createElement("canvas");
  canvas.width = mat.cols;
  canvas.height = mat.rows;
  cv.imshow(canvas, mat);
  return canvas;
}

function preprocess(mat){
  // grayscale + blur + adaptive threshold
  const gray = new cv.Mat();
  cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY, 0);
  const blur = new cv.Mat();
  cv.GaussianBlur(gray, blur, new cv.Size(3,3), 0, 0, cv.BORDER_DEFAULT);

  const thr = new cv.Mat();
  cv.adaptiveThreshold(
    blur, thr, 255,
    cv.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv.THRESH_BINARY, 31, 8
  );

  gray.delete(); blur.delete();
  return thr;
}

async function ocrText(canvas){
  const res = await Tesseract.recognize(canvas, "eng", {
    logger: ()=>{},
    tessedit_char_whitelist: "0123456789",
    preserve_interword_spaces: "1",
  });
  return (res.data.text || "");
}

function cleanOCRDigits(txt){
  return String(txt)
    .replace(/[Oo]/g,"0")
    .replace(/[Il|]/g,"1")
    .replace(/S/g,"5")
    .replace(/B/g,"8")
    .replace(/[^\d\s\n]/g," ")
    .replace(/\s+\n/g,"\n")
    .replace(/\n\s+/g,"\n")
    .replace(/[ \t]+/g," ")
    .trim();
}

function extractDB5_fromLabel(text){
  // t√¨m ƒëo·∫°n c√≥ nh√£n ƒêB / DB, sau ƒë√≥ b·∫Øt 5 s·ªë ngay sau
  // OCR c√≥ th·ªÉ m·∫•t d·∫•u ƒê => v·∫´n ∆∞u ti√™n b·∫Øt "DB"
  // d√πng regex m·ªÅm: (D|ƒê)\s*B\s* + 5digits
  const t = text.replace(/\s+/g," ");
  let m = t.match(/(?:ƒê\s*B|D\s*B)\s*(\d{5})/);
  if(m) return m[1];

  // fallback: t√¨m 1 s·ªë 5 ch·ªØ s·ªë "ƒë·∫≠m" nh·∫•t g·∫ßn top: l·∫•y s·ªë 5 ch·ªØ s·ªë ƒë·∫ßu ti√™n
  m = t.match(/\b\d{5}\b/);
  return m ? m[0] : "";
}

function findG7Line(lines){
  for(let i=lines.length-1;i>=0;i--){
    const nums2 = (lines[i].match(/\b\d{2}\b/g) || []);
    if(nums2.length >= 4){
      return {arr: nums2.slice(0,4), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}

function findG6Line(lines, g7Index){
  for(let i=g7Index-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  for(let i=lines.length-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}

function gateCheck(db5, g6_3, g7_4){
  // DB: ph·∫£i c√≥ 5 s·ªë, db2 l√† 2 s·ªë cu·ªëi
  // G6: 3 s·ªë, m·ªói s·ªë 3 ch·ªØ s·ªë
  // G7: 4 s·ªë, m·ªói s·ªë 2 ch·ªØ s·ªë
  if(!/^\d{5}$/.test(db5)) return {ok:false, reason:"DB kh√¥ng ƒë·ªß 5 s·ªë"};
  if(!g7_4 || g7_4.length!==4 || !g7_4.every(x=>/^\d{2}$/.test(x))) return {ok:false, reason:"G7 ph·∫£i ƒë√∫ng 4 s·ªë (2 ch·ªØ s·ªë)"};
  if(!g6_3 || g6_3.length!==3 || !g6_3.every(x=>/^\d{3}$/.test(x))) return {ok:false, reason:"G6 ph·∫£i ƒë√∫ng 3 s·ªë (3 ch·ªØ s·ªë)"};
  return {ok:true, reason:"OK"};
}

function addLineToInput(db5, g7, g6){
  const db2 = db5.slice(-2);
  const line = `DB ${db2} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`;
  const cur = el("inputData").value.trim();
  el("inputData").value = (cur ? cur + "\n" : "") + line;
}

/* ---------------------------
   OCR pipeline: read DB/G6/G7
---------------------------- */
async function runOCRFromBlob(blob){
  if(!cvReady){
    alert("OpenCV ch∆∞a load xong. ƒê·ª£i 2‚Äì3 gi√¢y r·ªìi th·ª≠ l·∫°i.");
    return;
  }
  lastImageBlob = blob;

  setBadge("stOcr", "‚óè OCR: running‚Ä¶", "warn");
  setBadge("stGate", "‚óè Gate: checking‚Ä¶", "warn");
  showKPI("", [], [], "--");

  // load image
  const url = URL.createObjectURL(blob);
  el("imgPreview").src = url;

  await new Promise(r=>{
    el("imgPreview").onload = ()=>r();
  });

  // draw to canvas
  const img = el("imgPreview");
  const canvas = el("cvCanvas");
  canvas.style.display = "none";
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0);

  // OpenCV read
  let src = cv.imread(canvas); // RGBA
  // crop nh·∫π bi√™n ƒë·ªÉ gi·∫£m footer/header d√≠nh
  const W = src.cols, H = src.rows;
  const crop = src.roi(new cv.Rect(
    Math.floor(W*0.02),
    Math.floor(H*0.02),
    Math.floor(W*0.96),
    Math.floor(H*0.96)
  ));
  src.delete(); src = crop;

  // t√°ch v√πng DB (upper) v√† v√πng b·∫£ng d∆∞·ªõi (body)
  const upH = Math.floor(src.rows * 0.55);
  const upper = src.roi(new cv.Rect(0,0, src.cols, upH));
  const body  = src.roi(new cv.Rect(0, Math.floor(src.rows*0.35), src.cols, Math.floor(src.rows*0.65)));

  // OCR upper ƒë·ªÉ l·∫•y DB theo nh√£n ƒêB/DB
  const upperBin = preprocess(upper);
  const upperCanvas = canvasFromMat(upperBin);
  const upperTxt1 = await ocrText(upperCanvas);

  // invert pass upper
  const upperInv = new cv.Mat(); cv.bitwise_not(upperBin, upperInv);
  const upperCanvas2 = canvasFromMat(upperInv);
  const upperTxt2 = await ocrText(upperCanvas2);

  const upperTxt = cleanOCRDigits((upperTxt1||"") + "\n" + (upperTxt2||""));
  const db5 = extractDB5_fromLabel(upperTxt);

  upper.delete(); upperBin.delete(); upperInv.delete();

  // OCR body ƒë·ªÉ l·∫•y G6/G7 theo pattern, 2-pass
  const bodyBin = preprocess(body);
  const bodyCanvas = canvasFromMat(bodyBin);
  const bodyTxt1 = await ocrText(bodyCanvas);

  const bodyInv = new cv.Mat(); cv.bitwise_not(bodyBin, bodyInv);
  const bodyCanvas2 = canvasFromMat(bodyInv);
  const bodyTxt2 = await ocrText(bodyCanvas2);

  const bodyTxt = cleanOCRDigits((bodyTxt1||"") + "\n" + (bodyTxt2||""));
  const lines = bodyTxt.split("\n").map(s=>s.trim()).filter(Boolean);

  const g7Found = findG7Line(lines);
  const g6Found = findG6Line(lines, g7Found.idx);

  const g7 = g7Found.arr;
  const g6 = g6Found.arr;

  body.delete(); bodyBin.delete(); bodyInv.delete();
  src.delete();
  URL.revokeObjectURL(url);

  // Gate
  const gate = gateCheck(db5, g6, g7);
  const db2 = (/^\d{5}$/.test(db5)) ? db5.slice(-2) : "";

  // Debug box
  el("dbg").textContent =
`[UPPER_OCR]
${upperTxt || "(empty)"}

[DB_5DIG]
${db5 || "(none)"}

[LOWER_OCR]
${bodyTxt || "(empty)"}

[G7_LINE]
${g7Found.line || "(none)"}

[G6_LINE]
${g6Found.line || "(none)"}
`;

  showKPI(db2, g6, g7, gate.ok ? "PASS" : "FAIL");
  setBadge("stOcr", "‚óè OCR: done", "ok");
  if(gate.ok){
    setBadge("stGate", "‚óè Gate: PASS", "ok");
    addLineToInput(db5, g7, g6);
    batchOK++;
  }else{
    setBadge("stGate", `‚óè Gate: FAIL ‚Äî ${gate.reason}`, "fail");
    batchFail++;

    // g·ª£i √Ω manual ƒëi·ªÅn s·∫µn (n·∫øu c√≥)
    el("manualDB").value = db2 || "";
    el("manualG6").value = g6.length ? g6.join(" ") : "";
    el("manualG7").value = g7.length ? g7.join(" ") : "";
  }
  setStatus();
}

/* ---------------------------
   Manual apply
---------------------------- */
function parseManual(){
  const db2 = (el("manualDB").value || "").replace(/\D/g,"").slice(-2);
  const g6 = (el("manualG6").value || "").match(/\b\d{3}\b/g) || [];
  const g7 = (el("manualG7").value || "").match(/\b\d{2}\b/g) || [];
  if(db2.length!==2) return {ok:false, msg:"DB manual ph·∫£i ƒë√∫ng 2 s·ªë"};
  if(g6.length<3) return {ok:false, msg:"G6 manual ph·∫£i ƒë·ªß 3 s·ªë (3 ch·ªØ s·ªë)"};
  if(g7.length<4) return {ok:false, msg:"G7 manual ph·∫£i ƒë·ªß 4 s·ªë (2 ch·ªØ s·ªë)"};

  // DB5 gi·∫£ l·∫≠p (ƒë·ªÉ th·ªëng nh·∫•t format), ch·ªâ c·∫ßn db2 cho tool full
  const fakeDB5 = "000" + db2;
  return {ok:true, fakeDB5, g6:g6.slice(0,3), g7:g7.slice(0,4)};
}

el("btnApplyManual").onclick = ()=>{
  const r = parseManual();
  if(!r.ok){ alert(r.msg); return; }
  addLineToInput(r.fakeDB5, r.g7, r.g6);
  setBadge("stGate","‚óè Gate: MANUAL OK","ok");
};

/* ---------------------------
   Inputs (upload/camera)
---------------------------- */
el("btnMulti").onclick = ()=> el("fileMulti").click();
el("btnCam").onclick   = ()=> el("fileCam").click();

el("fileMulti").addEventListener("change", async (e)=>{
  const files = [...(e.target.files || [])];
  if(!files.length) return;

  setBadge("stOcr","‚óè OCR: batch running‚Ä¶","warn");
  // reset batch counters for this run
  batchOK = 0; batchFail = 0;
  setStatus();

  // ch·∫°y tu·∫ßn t·ª± ƒë·ªÉ ƒë·ª° crash tr√™n Android
  for(const f of files){
    await runOCRFromBlob(f);
    await new Promise(r=>setTimeout(r, 120)); // th·ªü nh·∫π
  }
  setBadge("stOcr","‚óè OCR: batch done","ok");
});

el("fileCam").addEventListener("change", async (e)=>{
  const f = (e.target.files || [])[0];
  if(!f) return;
  await runOCRFromBlob(f);
});

el("btnRetryLast").onclick = async ()=>{
  if(!lastImageBlob){ alert("Ch∆∞a c√≥ ·∫£nh n√†o ƒë·ªÉ retry."); return; }
  await runOCRFromBlob(lastImageBlob);
};

el("btnClear").onclick = ()=>{
  el("inputData").value = "";
  el("out").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
  el("ppOut").textContent = "Ch∆∞a ch·∫°y FULL.";
  el("dbg").textContent = "Ch∆∞a c√≥ OCR.";
  batchOK=0; batchFail=0;
  setBadge("stOcr","‚óè OCR: idle","ok");
  setBadge("stGate","‚óè Gate: waiting","warn");
  setStatus();
  showKPI("", [], [], "--");
};

el("btnSample").onclick = ()=>{
  el("inputData").value =
`DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 21 | G7: 76 47 21 77 | G6: 801 295 993
DB 14 | G7: 81 87 60 32 | G6: 206 200 971
DB 13 | G7: 77 19 86 10 | G6: 484 417 202
DB 59 | G7: 21 41 02 14 | G6: 03 63 87`;
};

/* ---------------------------
   FULL analysis (basic): hot/gan + score + suggest main/sub
---------------------------- */
function parseLines(){
  const raw = el("inputData").value.trim().split("\n").map(s=>s.trim()).filter(Boolean);
  const win = Math.max(5, parseInt(el("winDays").value||"30",10));
  const slice = raw.slice(0, win); // n·∫øu b·∫°n d√°n newest ·ªü tr√™n
  const days = [];

  for(const line of slice){
    // format: DB xx | G7: a b c d | G6: xxx yyy zzz
    const dbm = line.match(/DB\s+(\d{2})/);
    const g7m = line.match(/G7:\s*([0-9 ]+)/);
    const g6m = line.match(/G6:\s*([0-9 ]+)/);

    if(!dbm || !g7m || !g6m) continue;

    const db2 = dbm[1];
    const g7 = (g7m[1].match(/\b\d{2}\b/g)||[]).slice(0,4);
    const g6 = (g6m[1].match(/\b\d{3}\b/g)||[]).slice(0,3);

    // b√≥c 00-99 t·ª´ g6 (3 ch·ªØ s·ªë -> l·∫•y 2 s·ªë cu·ªëi)
    const g6_2 = g6.map(x=>x.slice(-2));

    const pool = [db2, ...g7, ...g6_2].map(pad2);
    days.push({db2, g7, g6_2, pool});
  }
  return days;
}

function runFULL(){
  const days = parseLines();
  if(days.length < 5){
    el("out").textContent = "‚ùå Thi·∫øu d·ªØ li·ªáu: c·∫ßn √≠t nh·∫•t 5 d√≤ng (5 ng√†y).";
    el("ppOut").textContent = "‚ùå Thi·∫øu d·ªØ li·ªáu: ch∆∞a ch·∫°y PP.";
    return;
  }

  const topN = Math.max(5, parseInt(el("topN").value||"15",10));
  const wHot = parseFloat(el("wHot").value||"2");
  const wGan = parseFloat(el("wGan").value||"1.5");
  const wPas = parseFloat(el("wPas").value||"2"); // gi·ªØ nguy√™n (ch∆∞a d√πng s√¢u)

  // freq (hot)
  const freq = {};
  days.forEach(d=>d.pool.forEach(n=>freq[n]=(freq[n]||0)+1));

  // gan: s·ªë ng√†y k·ªÉ t·ª´ l·∫ßn xu·∫•t hi·ªán g·∫ßn nh·∫•t (trong window)
  const lastSeen = {};
  days.forEach((d, idx)=>{
    d.pool.forEach(n=>{
      if(lastSeen[n]===undefined) lastSeen[n]=idx; // idx 0 l√† newest
    });
  });
  const gan = {};
  for(let i=0;i<100;i++){
    const n = pad2(i);
    gan[n] = (lastSeen[n]===undefined) ? 999 : lastSeen[n];
  }

  // score: hot cao + gan v·ª´a ph·∫£i (kh√¥ng qu√° 999)
  const score = {};
  for(let i=0;i<100;i++){
    const n = pad2(i);
    const hot = freq[n]||0;
    const g = gan[n];
    // gan ∆∞u ti√™n 2..9, ph·∫°t gan qu√° d√†i
    const ganScore = (g===999) ? -2 : (g>=2 && g<=9 ? 2 : (g===0 ? -1 : 0));
    score[n] = hot*wHot + ganScore*wGan;
  }

  // sort
  const hotSorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,topN);
  const scoreSorted = Object.entries(score).sort((a,b)=>b[1]-a[1]).slice(0,topN);

  const main = scoreSorted[0]?.[0] || "--";
  const sub  = scoreSorted[1]?.[0] || "--";

  let out =
`T·ªïng ng√†y: ${days.length}

TOP HOT:
${hotSorted.map(([n,c])=>`${n} ‚Üí ${c}`).join("\n")}

TOP SCORE (hot+gan):
${scoreSorted.map(([n,s])=>`${n} ‚Üí ${s.toFixed(2)}`).join("\n")}

CH·ªêT G·ª¢I √ù:
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•:  ${sub}

* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng
`;

  el("out").textContent = out;

  // NEW: build PP ULTRA
  const pp = buildUltraPP(days, topN);
  wireTabs(pp);
}

el("btnFull").onclick = runFULL;

/* ===========================
   ULTRA PP: HOT/GAN + HEAD/TAIL + TOUCH + KE + BONG + TRUC + ANTI-BAy
=========================== */

// bong (ƒë·ªëi x·ª©ng 9)
function bongOf(d){ return String(9 - parseInt(d,10)); }

function buildPool(days){
  const freq = {};
  for(let i=0;i<100;i++) freq[pad2(i)] = 0;
  days.forEach(d=>{
    d.pool.forEach(n=>{ freq[n] = (freq[n]||0) + 1; });
  });
  return freq;
}

function buildLastSeen(days){
  const lastSeen = {};
  days.forEach((d, idx)=>{
    d.pool.forEach(n=>{
      if(lastSeen[n]===undefined) lastSeen[n] = idx;
    });
  });
  for(let i=0;i<100;i++){
    const n = pad2(i);
    if(lastSeen[n]===undefined) lastSeen[n] = 999;
  }
  return lastSeen;
}

function headTailStats(days){
  const head = Array(10).fill(0);
  const tail = Array(10).fill(0);
  days.forEach(d=>{
    d.pool.forEach(n=>{
      head[parseInt(n[0],10)]++;
      tail[parseInt(n[1],10)]++;
    });
  });
  return {head, tail};
}

function touchStats(days){
  const touch = Array(10).fill(0);
  days.forEach(d=>{
    d.pool.forEach(n=>{
      touch[parseInt(n[0],10)]++;
      touch[parseInt(n[1],10)]++;
    });
  });
  return touch;
}

function keSetOf(n){
  const a = parseInt(n[0],10), b = parseInt(n[1],10);
  const k = [];
  const pm = (x)=>[(x+9)%10,(x+1)%10];
  pm(a).forEach(ha=>k.push(`${ha}${b}`));
  pm(b).forEach(tb=>k.push(`${a}${tb}`));
  return [...new Set(k.map(pad2))];
}

function trucOf(n){
  const a = parseInt(n[0],10), b = parseInt(n[1],10);
  return (a+b)%10;
}

function fmtPairs(arr){
  return arr.map(([k,v])=>`${k} ‚Üí ${Number(v).toFixed(2)}`).join("\n");
}

function antiBayHints(scoreSorted, lastSeen, freq){
  const warns = [];
  const top = scoreSorted.slice(0, 10).map(x=>x[0]);

  const justHit = top.filter(n=>lastSeen[n]===0);
  if(justHit.length) warns.push(`‚ö†Ô∏è B·∫´y l·∫∑p: s·ªë v·ª´a xu·∫•t hi·ªán (gan=0) nh∆∞ng ƒëang top: ${justHit.join(" ")}`);

  const weird = top.filter(n=>(freq[n]||0)>=3 && lastSeen[n]>=20 && lastSeen[n]!==999);
  if(weird.length) warns.push(`‚ö†Ô∏è N√≥ng nh∆∞ng gan d√†i b·∫•t th∆∞·ªùng (check crop/d·ªØ li·ªáu): ${weird.join(" ")}`);

  const heads = {}; const tails = {};
  top.forEach(n=>{
    heads[n[0]]=(heads[n[0]]||0)+1;
    tails[n[1]]=(tails[n[1]]||0)+1;
  });
  const maxHead = Math.max(...Object.values(heads));
  const maxTail = Math.max(...Object.values(tails));
  if(maxHead>=6) warns.push(`‚ö†Ô∏è D·ªìn ƒë·∫ßu m·∫°nh (>=6/10 s·ªë top c√πng 1 ƒë·∫ßu) ‚Üí d·ªÖ nhi·ªÖu/overfit.`);
  if(maxTail>=6) warns.push(`‚ö†Ô∏è D·ªìn ƒëu√¥i m·∫°nh (>=6/10 s·ªë top c√πng 1 ƒëu√¥i) ‚Üí d·ªÖ nhi·ªÖu/overfit.`);

  return warns.length ? warns.join("\n") : "OK (ch∆∞a th·∫•y b·∫´y r√µ).";
}

function buildUltraPP(days, topN){
  const freq = buildPool(days);
  const lastSeen = buildLastSeen(days);
  const {head, tail} = headTailStats(days);
  const touch = touchStats(days);

  // Score gi·ªØ ƒë√∫ng logic FULL
  const wHot = parseFloat(el("wHot").value||"2");
  const wGan = parseFloat(el("wGan").value||"1.5");

  const score = {};
  for(let i=0;i<100;i++){
    const n = pad2(i);
    const hot = freq[n]||0;
    const g = lastSeen[n]; // 0 newest
    const ganScore = (g===999) ? -2 : (g>=2 && g<=9 ? 2 : (g===0 ? -1 : 0));
    score[n] = hot*wHot + ganScore*wGan;
  }
  const scoreSorted = Object.entries(score)
    .sort((a,b)=>b[1]-a[1])
    .slice(0, topN);

  const main = scoreSorted[0]?.[0] || "??";
  const sub  = scoreSorted[1]?.[0] || "??";

  // top ƒë·∫ßu/ƒëu√¥i/ch·∫°m
  const headRank = head.map((v,i)=>[String(i), v]).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const tailRank = tail.map((v,i)=>[String(i), v]).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const touchRank = touch.map((v,i)=>[String(i), v]).sort((a,b)=>b[1]-a[1]).slice(0,5);

  const mainKe = keSetOf(main).join(" ");
  const subKe  = keSetOf(sub).join(" ");

  const mainBong = pad2(bongOf(main[0]) + bongOf(main[1]));
  const subBong  = pad2(bongOf(sub[0]) + bongOf(sub[1]));

  // tr·ª•c sum%10 gom top20
  const trucMap = {};
  scoreSorted.slice(0,20).forEach(([n,s])=>{
    const t = trucOf(n);
    trucMap[t] = trucMap[t] || [];
    trucMap[t].push(n);
  });
  const trucLines = Object.entries(trucMap)
    .sort((a,b)=>b[1].length - a[1].length)
    .slice(0,5)
    .map(([t,arr])=>`Tr·ª•c ${t}: ${arr.join(" ")}`)
    .join("\n");

  const warns = antiBayHints(scoreSorted, lastSeen, freq);

  return {
    hotGanBlock:
`[HOT/GAN ‚Äî TOP SCORE]
${fmtPairs(scoreSorted)}

Ch·ªët g·ª£i √Ω:
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•:  ${sub}

Anti-b·∫´y:
${warns}
`,

    headTailBlock:
`[ƒê·∫¶U m·∫°nh]
${headRank.map(([d,v])=>`ƒê·∫ßu ${d} ‚Üí ${v}`).join("\n")}

[ƒêU√îI m·∫°nh]
${tailRank.map(([d,v])=>`ƒêu√¥i ${d} ‚Üí ${v}`).join("\n")}

G·ª£i √Ω r√°p nhanh:
- R√°p ƒê·∫ßu(top) √ó ƒêu√¥i(top) ‚Üí t·∫°o d√†n nh·ªè
- L·ªçc l·∫°i b·∫±ng TOP SCORE ƒë·ªÉ tr√°nh ·∫£o
`,

    touchKeBongBlock:
`[CH·∫†M m·∫°nh (ƒë·∫øm ch·ªØ s·ªë xu·∫•t hi·ªán)]
${touchRank.map(([d,v])=>`Ch·∫°m ${d} ‚Üí ${v}`).join("\n")}

[K·ªÄ]
K·ªÅ c·ªßa Ch√≠nh ${main}: ${mainKe}
K·ªÅ c·ªßa Ph·ª•  ${sub}:  ${subKe}

[B√ìNG (ƒë·ªëi 9)]
B√≥ng Ch√≠nh ${main} ‚Üí ${mainBong}
B√≥ng Ph·ª•  ${sub}  ‚Üí ${subBong}
`,

    trucBlock:
`[TR·ª§C (sum 2 s·ªë mod 10) ‚Äî gom top 20]
${trucLines || "(none)"}

G·ª£i √Ω:
- Tr·ª•c n√†o gom d√†y ‚Üí ∆∞u ti√™n quan s√°t tr·ª•c ƒë√≥
- Nh∆∞ng v·∫´n ph·∫£i qua Anti-b·∫´y
`,

    allBlock:
`=== ULTRA T·ªîNG H·ª¢P ===

1) TOP SCORE (Top 10):
${fmtPairs(scoreSorted.slice(0,10))}

2) CH·ªêT:
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•:  ${sub}

3) H·ªñ TR·ª¢ NHANH:
- ƒê·∫ßu m·∫°nh: ${headRank.map(x=>x[0]).join(", ")}
- ƒêu√¥i m·∫°nh: ${tailRank.map(x=>x[0]).join(", ")}
- Ch·∫°m m·∫°nh: ${touchRank.slice(0,3).map(x=>x[0]).join(", ")}
- K·ªÅ Ch√≠nh: ${mainKe}
- B√≥ng Ch√≠nh: ${mainBong}

4) ANTI-B·∫™Y:
${warns}
`
  };
}

function setActiveTab(activeId){
  const ids = ["tabHot","tabHeadTail","tabTouch","tabTruc","tabAll"];
  ids.forEach(id=>{
    const b = el(id);
    if(!b) return;
    b.classList.remove("active");
  });
  if(el(activeId)) el(activeId).classList.add("active");
}

function wireTabs(pp){
  const out = el("ppOut");
  const set = (id, txt)=>{ setActiveTab(id); out.textContent = txt; };

  el("tabHot").onclick = ()=>set("tabHot", pp.hotGanBlock);
  el("tabHeadTail").onclick = ()=>set("tabHeadTail", pp.headTailBlock);
  el("tabTouch").onclick = ()=>set("tabTouch", pp.touchKeBongBlock);
  el("tabTruc").onclick = ()=>set("tabTruc", pp.trucBlock);
  el("tabAll").onclick = ()=>set("tabAll", pp.allBlock);

  // m·∫∑c ƒë·ªãnh m·ªü t·ªïng h·ª£p
  set("tabAll", pp.allBlock);
}
</script>
</body>
</html>
