<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --muted:#93a4c7; --text:#e9f1ff;
      --btn:#2563eb; --btn2:#111827; --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
      --line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#07101f,#0b1220);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .h1{font-size:22px;font-weight:800;margin:6px 0 10px}
    .sub{color:var(--muted);font-size:13px;line-height:1.35;margin:0 0 10px}
    .card{background:rgba(17,26,43,.75);border:1px solid var(--line);border-radius:18px;padding:14px;margin:12px 0;box-shadow:0 12px 40px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:7px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px;background:rgba(255,255,255,.03)}
    .ok{color:#d9ffe6;border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.12)}
    .bad{color:#ffe2e2;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .warn{color:#fff1d6;border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12)}
    button{
      appearance:none;border:0;border-radius:14px;padding:12px 14px;
      font-weight:800;color:white;background:var(--btn);cursor:pointer
    }
    button.secondary{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text)}
    button.danger{background:#b91c1c}
    button:disabled{opacity:.5;cursor:not-allowed}
    input, textarea, select{
      width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--text);outline:none
    }
    textarea{min-height:150px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:840px){.grid{grid-template-columns:1fr}}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:840px){.kpi{grid-template-columns:1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:12px;color:var(--muted)}
    .imgBox{border-radius:14px;overflow:hidden;border:1px solid var(--line);background:rgba(255,255,255,.02)}
    .imgBox img{width:100%;display:block}
    .label{font-size:12px;color:var(--muted);margin:10px 0 6px}
    .stat{font-size:13px;color:var(--muted)}
    .big{font-size:18px;font-weight:900}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="h1">B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL)</div>
    <div class="sub">
      Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí OCR (Tesseract) ‚Üí <b>Parse DB/G6/G7</b> ‚Üí <b>Gate c·ª©ng</b> (sai th√¨ kh√¥ng ƒë·ªï d·ªØ li·ªáu)
      ‚Üí D·ªØ li·ªáu s·∫°ch ‚Üí Ch·∫°y FULL.
      <br/>M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi h√†ng ‚Äú7‚Äù), tr√°nh d√≠nh header/footer tab.
    </div>

    <div class="row">
      <span id="st_tess" class="pill warn">Tesseract: loading‚Ä¶</span>
      <span id="st_batch" class="pill">Batch: 0 ·∫£nh</span>
      <span id="st_gate" class="pill">Gate: ‚Äî</span>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label>
        <input id="file" type="file" accept="image/*" multiple style="display:none">
        <button id="btnUpload">üì∏ Upload nhi·ªÅu ·∫£nh</button>
      </label>
      <button id="btnPaste" class="secondary">D√°n m·∫´u</button>
      <button id="btnClear" class="danger">X√≥a</button>
      <button id="btnRun" style="margin-left:auto">üöÄ Ch·∫°y FULL</button>
    </div>

    <div class="label">Preview ·∫£nh cu·ªëi (ƒë·ªÉ H√†o bi·∫øt m√¨nh crop ƒë√∫ng ch∆∞a)</div>
    <div class="imgBox"><img id="preview" alt="preview" /></div>
  </div>

  <div class="card">
    <div class="h1" style="font-size:18px">·∫¢nh ‚Üí OCR ‚Üí Gate</div>
    <div class="sub">
      Parse theo logic ‚Äúc·ª©ng‚Äù:
      <br/>‚Ä¢ <b>DB</b>: t√¨m nh√£n ‚ÄúƒêB/DB‚Äù + l·∫•y <b>ƒë√∫ng 5 s·ªë</b> g·∫ßn nh·∫•t.
      <br/>‚Ä¢ <b>G7</b>: t√¨m d√≤ng c√≥ ‚Äú7‚Äù + l·∫•y <b>4 s·ªë 2 ch·ªØ s·ªë</b>.
      <br/>‚Ä¢ <b>G6</b>: t√¨m d√≤ng c√≥ ‚Äú6‚Äù + l·∫•y <b>3 s·ªë 3 ch·ªØ s·ªë</b>.
      <br/>N·∫øu OCR b·ªã nhi·ªÖu (O‚Üí0, I‚Üí1‚Ä¶) tool t·ª± normalize.
    </div>

    <div class="grid">
      <div>
        <div class="label">K·∫øt qu·∫£ parse (·∫£nh cu·ªëi)</div>
        <div class="row">
          <span class="pill">DB (2 s·ªë): <b id="p_db2">‚Äî</b></span>
          <span class="pill">G6: <b id="p_g6">‚Äî</b></span>
          <span class="pill">G7: <b id="p_g7">‚Äî</b></span>
        </div>
        <div class="label">Debug OCR (r√∫t g·ªçn)</div>
        <textarea id="debug" class="mono" readonly></textarea>
      </div>

      <div>
        <div class="label">S·ª≠a tay (ch·ªâ khi Gate fail)</div>
        <div class="small">DB nh·∫≠p 2 s·ªë. G6 nh·∫≠p 3 s·ªë (3 ch·ªØ s·ªë). G7 nh·∫≠p 4 s·ªë (2 ch·ªØ s·ªë).</div>
        <div class="grid" style="margin-top:8px">
          <div>
            <div class="label">DB (2 s·ªë)</div>
            <input id="m_db2" placeholder="VD: 45" inputmode="numeric" />
          </div>
          <div>
            <div class="label">G6 (3 s·ªë)</div>
            <input id="m_g6" placeholder="VD: 392 255 854" />
          </div>
        </div>
        <div class="label">G7 (4 s·ªë)</div>
        <input id="m_g7" placeholder="VD: 03 82 85 81" />

        <div class="row" style="margin-top:10px">
          <button id="btnApplyManual" class="secondary">√Åp manual ‚Üí th√™m d√≤ng</button>
          <button id="btnRetry" class="secondary">Th·ª≠ OCR l·∫°i ·∫£nh cu·ªëi</button>
        </div>

        <div class="hr"></div>

        <div class="label">C√†i ƒë·∫∑t FULL</div>
        <div class="kpi">
          <div>
            <div class="label">C·ª≠a s·ªï ng√†y (window)</div>
            <input id="win" value="30" inputmode="numeric" />
          </div>
          <div>
            <div class="label">Top hi·ªÉn th·ªã</div>
            <input id="topN" value="15" inputmode="numeric" />
          </div>
          <div>
            <div class="label">T·ªëi thi·ªÉu s·ªë ng√†y</div>
            <input id="minDays" value="5" inputmode="numeric" />
          </div>
        </div>

        <div class="kpi" style="margin-top:8px">
          <div>
            <div class="label">Tr·ªçng s·ªë Hot</div>
            <input id="wHot" value="2" inputmode="decimal" />
          </div>
          <div>
            <div class="label">Tr·ªçng s·ªë Gan</div>
            <input id="wGan" value="1.5" inputmode="decimal" />
          </div>
          <div>
            <div class="label">Tr·ªçng s·ªë Pascal</div>
            <input id="wPas" value="2" inputmode="decimal" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="h1" style="font-size:18px">D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</div>
    <div class="sub">Format chu·∫©n auto: <span class="mono">DB xx | G7: a b c d | G6: xxx yyy zzz</span></div>
    <textarea id="inputData" class="mono" placeholder="VD:
DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 14 | G7: 81 87 60 32 | G6: 206 200 971"></textarea>
    <div class="row" style="margin-top:10px">
      <span class="pill">T·ªïng d√≤ng h·ª£p l·ªá: <b id="lineCount">0</b></span>
      <button id="btnSanitize" class="secondary">D·ªçn s·∫°ch d·ªØ li·ªáu (sanitize)</button>
    </div>
  </div>

  <div class="card">
    <div class="h1" style="font-size:18px">K·∫æT QU·∫¢ FULL</div>
    <div id="fullOut" class="mono"></div>
    <div class="small" style="margin-top:10px">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng.</div>
  </div>

</div>

<!-- Tesseract -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
  // ========= Helpers =========
  const el = (id)=>document.getElementById(id);

  function pad2(x){
    x = String(x||"").replace(/\D/g,"");
    if(x.length===1) return "0"+x;
    return x.slice(-2);
  }
  function normOCR(s){
    // Normalize common OCR confusions
    return (s||"")
      .replace(/[ÔºØ–û]/g,"0")
      .replace(/[ŒôIl|]/g,"1")
      .replace(/[Ôº≥]/g,"5")
      .replace(/[Ôº¢]/g,"8")
      .replace(/[Z]/g,"2")
      .replace(/[A]/g,"4")
      .replace(/[‚Äî‚Äì]/g,"-")
      .replace(/\s+/g," ")
      .trim();
  }
  function onlyDigits(s){ return (s||"").replace(/\D/g,""); }

  function parseManualG7(s){
    const m = (s||"").match(/\d{1,2}/g) || [];
    return m.slice(0,4).map(pad2);
  }
  function parseManualG6(s){
    const m = (s||"").match(/\d{3}/g) || [];
    return m.slice(0,3);
  }

  function gateOK(db2,g6,g7){
    return (db2 && /^\d{2}$/.test(db2) && Array.isArray(g6) && g6.length===3 && g6.every(x=>/^\d{3}$/.test(x))
      && Array.isArray(g7) && g7.length===4 && g7.every(x=>/^\d{2}$/.test(x)));
  }

  function setStatusGate(ok, msg){
    el("st_gate").className = "pill " + (ok ? "ok":"bad");
    el("st_gate").textContent = ok ? ("Gate: PASS") : ("Gate: FAIL" + (msg?(" ‚Äî "+msg):""));
  }

  function addLineToInput(db5, g7, g6){
    const db2 = (String(db5).match(/\d{5}/)?.[0] || "").slice(-2);
    const g7c = (g7||[]).map(x=>String(x).match(/\d{2}/)?.[0]).filter(Boolean).slice(0,4).map(pad2);
    const g6c = (g6||[]).map(x=>String(x).match(/\d{3}/)?.[0]).filter(Boolean).slice(0,3);

    if(!gateOK(db2,g6c,g7c)) return false;

    const line = `DB ${db2} | G7: ${g7c.join(" ")} | G6: ${g6c.join(" ")}`;
    const ta = el("inputData");
    const cur = (ta.value || "").trim();
    const set = new Set(cur.split("\n").map(s=>s.trim()).filter(Boolean));
    set.add(line);
    ta.value = Array.from(set).join("\n");
    refreshLineCount();
    return true;
  }

  function refreshLineCount(){
    const lines = sanitizeLines(el("inputData").value, false);
    el("lineCount").textContent = String(lines.length);
  }

  // ========= Sanitize Input =========
  function sanitizeLines(text, writeBack=true){
    const raw = (text||"").split("\n").map(s=>s.trim()).filter(Boolean);
    const ok = [];

    for(const line of raw){
      const m = line.match(/DB\s*(\d{1,2})\s*\|\s*G7:\s*([0-9\s]+)\s*\|\s*G6:\s*([0-9\s]+)/i);
      if(!m) continue;

      const db2 = pad2(m[1]);
      const g7 = (m[2].match(/\d{1,2}/g)||[]).slice(0,4).map(pad2);
      const g6 = (m[3].match(/\d{3}/g)||[]).slice(0,3);

      if(gateOK(db2,g6,g7)){
        ok.push(`DB ${db2} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`);
      }
    }

    const uniq = Array.from(new Set(ok));
    if(writeBack) el("inputData").value = uniq.join("\n");
    refreshLineCount();
    return uniq;
  }

  // ========= OCR Parse =========
  async function ocrImage(file){
    const url = URL.createObjectURL(file);
    el("preview").src = url;

    // OCR full image (ƒë·ªÉ ƒë∆°n gi·∫£n + ·ªïn ƒë·ªãnh khi user crop s√°t b·∫£ng)
    const { data } = await Tesseract.recognize(url, "vie+eng", {
      logger: (m)=>{} // im l·∫∑ng cho nh·∫π
    });

    const textRaw = data.text || "";
    const text = normOCR(textRaw);

    // Debug r√∫t g·ªçn: show 1200 k√Ω t·ª± ƒë·∫ßu + cu·ªëi
    const head = textRaw.slice(0,900);
    const tail = textRaw.slice(-900);
    el("debug").value = "[OCR_HEAD]\n" + head + "\n\n[OCR_TAIL]\n" + tail;

    // Parse DB5: ∆∞u ti√™n t√¨m quanh nh√£n ƒêB/DB
    // 1) ƒëo·∫°n g·∫ßn "ƒêB"/"DB"
    let db5 = "";
    const idx = Math.max(text.indexOf("ƒêB"), text.indexOf("DB"));
    if(idx >= 0){
      const near = text.slice(idx, idx + 120);
      const m = near.match(/(?:ƒêB|DB)\s*[^0-9]*\s*(\d{5})/i) || near.match(/(\d{5})/);
      if(m) db5 = m[1];
    }
    // 2) fallback: l·∫•y 5 s·ªë l·ªõn nh·∫•t xu·∫•t hi·ªán, ∆∞u ti√™n s·ªë 5 ch·ªØ s·ªë ƒë·ª©ng ƒë·ªôc l·∫≠p
    if(!db5){
      const m2 = text.match(/\b\d{5}\b/g) || [];
      db5 = m2[0] || "";
    }

    // Parse G7 line: t√¨m d√≤ng c√≥ s·ªë 7 ƒë·∫ßu d√≤ng ho·∫∑c " 7 " + 4 s·ªë 2 ch·ªØ s·ªë
    let g7 = [];
    const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);

    function pick4_2digits(str){
      const arr = (str.match(/\b\d{1,2}\b/g)||[]).map(pad2);
      // lo·∫°i c√°c s·ªë "7" ƒë∆°n l·∫ª ƒë·ª©ng ƒë·∫ßu
      const cleaned = arr.filter(x=>x!=="07" || str.includes("07 ")); // gi·ªØ 07 n·∫øu ƒë√∫ng
      // l·∫•y 4 s·ªë cu·ªëi c√πng th∆∞·ªùng l√† d√£y G7
      if(cleaned.length >= 4) return cleaned.slice(-4);
      return [];
    }

    for(const ln of lines){
      // ∆∞u ti√™n d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng 7
      if(/^\s*7\b/.test(ln)){
        const cand = pick4_2digits(ln);
        if(cand.length===4){ g7 = cand; break; }
      }
    }
    if(g7.length!==4){
      // fallback: d√≤ng c√≥ " 7 " k√®m 4 s·ªë 2 ch·ªØ s·ªë
      for(const ln of lines){
        if(/\b7\b/.test(ln)){
          const cand = pick4_2digits(ln);
          if(cand.length===4){ g7 = cand; break; }
        }
      }
    }

    // Parse G6 line: t√¨m d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng 6 v√† c√≥ 3 s·ªë 3 ch·ªØ s·ªë
    let g6 = [];
    function pick3_3digits(str){
      const arr = (str.match(/\b\d{3}\b/g)||[]);
      if(arr.length>=3) return arr.slice(-3);
      return [];
    }
    for(const ln of lines){
      if(/^\s*6\b/.test(ln)){
        const cand = pick3_3digits(ln);
        if(cand.length===3){ g6 = cand; break; }
      }
    }
    if(g6.length!==3){
      // fallback: d√≤ng c√≥ " 6 " + 3 s·ªë 3 ch·ªØ s·ªë
      for(const ln of lines){
        if(/\b6\b/.test(ln)){
          const cand = pick3_3digits(ln);
          if(cand.length===3){ g6 = cand; break; }
        }
      }
    }

    // Update parse display
    const db2 = db5 ? db5.slice(-2) : "";
    el("p_db2").textContent = db2 || "‚Äî";
    el("p_g6").textContent = g6.length? g6.join(" ") : "‚Äî";
    el("p_g7").textContent = g7.length? g7.join(" ") : "‚Äî";

    const ok = gateOK(db2, g6, g7);
    setStatusGate(ok, ok ? "" : "DB/G6/G7 ch∆∞a ƒë·ªß chu·∫©n");
    return { ok, db5, g6, g7, textRaw };
  }

  // ========= FULL Stats =========
  function runFULL(){
    const minDays = Math.max(1, parseInt(el("minDays").value || "5",10));
    const topN = Math.max(5, parseInt(el("topN").value || "15",10));
    const wHot = parseFloat(String(el("wHot").value || "2").replace(",","."));
    const wGan = parseFloat(String(el("wGan").value || "1.5").replace(",","."));
    const wPas = parseFloat(String(el("wPas").value || "2").replace(",","."));

    const lines = sanitizeLines(el("inputData").value, true);
    if(lines.length < minDays){
      el("fullOut").innerHTML = `‚ùå Thi·∫øu d·ªØ li·ªáu: c·∫ßn √≠t nh·∫•t ${minDays} d√≤ng (${minDays} ng√†y).`;
      return;
    }

    // Extract all 2-digit numbers from each day: DB2 + all G7 + last2 of each G6
    const days = lines.map(line=>{
      const m = line.match(/DB\s*(\d{2}).*G7:\s*([0-9\s]+)\s*\|\s*G6:\s*([0-9\s]+)/i);
      const db2 = m? pad2(m[1]) : "";
      const g7 = m? (m[2].match(/\d{1,2}/g)||[]).slice(0,4).map(pad2) : [];
      const g6 = m? (m[3].match(/\d{3}/g)||[]).slice(0,3).map(x=>pad2(x.slice(-2))) : [];
      return { db2, g7, g6, all:[db2,...g7,...g6].filter(Boolean) };
    });

    // Hot frequency
    const freq = {};
    for(const d of days){
      for(const n of d.all){
        freq[n] = (freq[n]||0)+1;
      }
    }

    // Gan: days since last seen (0 = h√¥m g·∫ßn nh·∫•t c√≥)
    // duy·ªát t·ª´ cu·ªëi v·ªÅ ƒë·∫ßu
    const gan = {};
    for(let i=0;i<100;i++) gan[String(i).padStart(2,"0")] = 999;
    for(let i=0;i<days.length;i++){
      const idxFromEnd = i; // 0 = day g·∫ßn nh·∫•t
      const set = new Set(days[days.length-1-i].all);
      for(const n of set){
        gan[n] = Math.min(gan[n], idxFromEnd);
      }
    }

    // Pascal lite: l·∫•y DB2 ng√†y g·∫ßn nh·∫•t, t·∫°o "b√≥ng" + k·ªÅ ƒë·ªÉ c·ªông ƒëi·ªÉm
    const lastDB = days[days.length-1].db2;
    const lastA = parseInt(lastDB[0],10), lastB = parseInt(lastDB[1],10);
    const pasSet = new Set();
    // b√≥ng
    pasSet.add(String((lastA+5)%10)+String((lastB+5)%10));
    // k·ªÅ
    pasSet.add(String((lastA+1)%10)+String(lastB));
    pasSet.add(String((lastA+9)%10)+String(lastB));
    pasSet.add(String(lastA)+String((lastB+1)%10));
    pasSet.add(String(lastA)+String((lastB+9)%10));
    // ƒë·∫£o
    pasSet.add(String(lastB)+String(lastA));

    // Score
    const scored = [];
    for(let i=0;i<100;i++){
      const n = String(i).padStart(2,"0");
      const hot = freq[n]||0;
      const g = gan[n]===999 ? days.length+5 : gan[n]; // c√†ng l·ªõn c√†ng gan
      const pas = pasSet.has(n) ? 1 : 0;

      // quy ƒë·ªïi gan: mu·ªën s·ªë gan v·ª´a ph·∫£i, kh√¥ng qu√° ‚Äúm·∫•t h√∫t‚Äù
      // ƒëi·ªÉm gan = clamp( (g / days.length), 0..1 )
      const ganScore = Math.min(1, g / Math.max(1, days.length));
      const score = (wHot*hot) + (wGan*ganScore*10) + (wPas*pas*5);

      scored.push({n, hot, gan:g, pas, score});
    }

    scored.sort((a,b)=>b.score-a.score);

    const topHot = Object.entries(freq)
      .sort((a,b)=>b[1]-a[1])
      .slice(0, topN)
      .map(([n,c])=>`${n} ‚Üí ${c}`);

    const topScore = scored.slice(0, topN).map(x=>{
      return `${x.n} ‚Üí ${x.score.toFixed(2)}  (hot:${x.hot}, gan:${x.gan}, pas:${x.pas})`;
    });

    const main = scored[0]?.n || "--";
    const sub = scored[1]?.n || "--";

    el("fullOut").innerHTML =
`T·ªïng ng√†y: ${days.length}

TOP HOT:
${topHot.join("\n")}

TOP SCORE (hot+gan+pascal):
${topScore.join("\n")}

CH·ªêT G·ª¢I √ù:
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª• : ${sub}

* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng.`;
  }

  // ========= UI Wiring =========
  let lastFiles = [];
  let lastFile = null;

  async function handleFiles(files){
    if(!files || !files.length) return;

    lastFiles = Array.from(files);
    el("st_batch").textContent = `Batch: ${lastFiles.length} ·∫£nh`;

    let okCount = 0, failCount = 0;

    // l√†m tu·∫ßn t·ª± cho ·ªïn ƒë·ªãnh RAM
    for(const f of lastFiles){
      lastFile = f;

      // preview
      el("preview").src = URL.createObjectURL(f);

      try{
        const r = await ocrImage(f);
        if(r.ok){
          const pushed = addLineToInput(r.db5, r.g7, r.g6);
          if(pushed) okCount++; else failCount++;
        }else{
          failCount++;
        }
      }catch(e){
        failCount++;
      }

      el("st_batch").className = "pill";
      el("st_batch").textContent = `Batch: OK ${okCount} | FAIL ${failCount}`;
    }
  }

  // Tesseract load indicator
  (function init(){
    if(window.Tesseract){
      el("st_tess").className = "pill ok";
      el("st_tess").textContent = "Tesseract: ready";
    }else{
      el("st_tess").className = "pill bad";
      el("st_tess").textContent = "Tesseract: missing";
    }
    refreshLineCount();
  })();

  el("btnUpload").onclick = ()=> el("file").click();
  el("file").addEventListener("change", async (e)=>{
    const files = e.target.files;
    await handleFiles(files);
    e.target.value = "";
  });

  el("btnPaste").onclick = ()=>{
    el("inputData").value = [
      "DB 45 | G7: 03 82 85 81 | G6: 392 255 854",
      "DB 14 | G7: 81 87 60 32 | G6: 206 200 971",
      "DB 21 | G7: 76 47 21 77 | G6: 801 295 993",
      "DB 80 | G7: 22 20 16 61 | G6: 733 014 672",
      "DB 13 | G7: 53 69 39 43 | G6: 105 054 444"
    ].join("\n");
    sanitizeLines(el("inputData").value, true);
  };

  el("btnClear").onclick = ()=>{
    el("inputData").value = "";
    el("debug").value = "";
    el("p_db2").textContent = "‚Äî";
    el("p_g6").textContent = "‚Äî";
    el("p_g7").textContent = "‚Äî";
    el("fullOut").textContent = "";
    el("st_batch").textContent = "Batch: 0 ·∫£nh";
    el("st_gate").textContent = "Gate: ‚Äî";
    el("st_gate").className = "pill";
    refreshLineCount();
  };

  el("btnSanitize").onclick = ()=>{
    sanitizeLines(el("inputData").value, true);
  };

  el("btnRun").onclick = ()=> runFULL();

  el("btnApplyManual").onclick = ()=>{
    const db2 = pad2(el("m_db2").value);
    const g6 = parseManualG6(el("m_g6").value);
    const g7 = parseManualG7(el("m_g7").value);

    if(!gateOK(db2,g6,g7)){
      setStatusGate(false, "Manual ch∆∞a ƒë√∫ng format");
      return;
    }

    // gh√©p th√†nh db5 gi·∫£ ƒë·ªÉ d√πng chung pipeline
    const db5fake = "000" + db2;
    const ok = addLineToInput(db5fake, g7, g6);
    setStatusGate(ok, ok ? "" : "Kh√¥ng th√™m ƒë∆∞·ª£c d√≤ng");
  };

  el("btnRetry").onclick = async ()=>{
    if(!lastFile) return;
    try{
      await ocrImage(lastFile);
    }catch(e){}
  };

  // auto sanitize nh·∫π m·ªói khi user s·ª≠a input
  el("inputData").addEventListener("input", ()=>{
    refreshLineCount();
  });
</script>
</body>
</html>
