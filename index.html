<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (A-FULL ‚Ä¢ 1-file)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.10);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#f97066;
      --pill:#0f2347;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, rgba(67,105,255,.15), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(50,213,131,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px 12px 28px;
    }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; padding:12px 12px 6px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .title{
      font-weight:800; letter-spacing:.2px; font-size:16px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
    }
    .subtitle{
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      padding:0 12px 10px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
    }
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h3{
      margin:0; font-size:14px; letter-spacing:.2px;
    }
    .card .bd{padding:12px 14px 14px}
    .small{font-size:12px;color:var(--muted)}
    textarea{
      width:100%;
      min-height:220px;
      resize:vertical;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      color:var(--text);
      padding:12px;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      outline:none;
    }
    textarea:focus{border-color: rgba(99, 147, 255, .55)}
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .row > *{flex:0 0 auto}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:.15s transform ease, .15s background ease, .15s border-color ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.18)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(67,105,255,.35), rgba(67,105,255,.15));
      border-color: rgba(67,105,255,.45);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(50,213,131,.28), rgba(50,213,131,.12));
      border-color: rgba(50,213,131,.40);
    }
    .btn.warn{
      background: linear-gradient(180deg, rgba(253,176,34,.24), rgba(253,176,34,.10));
      border-color: rgba(253,176,34,.35);
    }
    .btn.bad{
      background: linear-gradient(180deg, rgba(249,112,102,.24), rgba(249,112,102,.10));
      border-color: rgba(249,112,102,.35);
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){ .kv{grid-template-columns:1fr} }
    .field{
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px 12px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="number"], select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 10px;
      outline:none;
      font-weight:700;
    }
    .tabs{
      display:flex; gap:10px; padding:10px 12px 0;
    }
    .tab{
      flex:0 0 auto;
      padding:10px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(67,105,255,.55);
      background: rgba(67,105,255,.12);
    }
    .panel{padding:12px}
    .pillbox{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
    }
    .pill{
      background: rgba(0,0,0,.15);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      letter-spacing:.2px;
      min-width: 88px;
      text-align:center;
    }
    .pill strong{font-weight:900}
    .bigPick{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
      font-size:28px; font-weight:950; letter-spacing:.3px;
    }
    .metaLine{color:var(--muted); font-size:13px; margin-top:6px; line-height:1.35}
    .pickRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .pickChip{
      display:flex; align-items:center; gap:8px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      min-width: 138px;
    }
    .icon{
      width:22px; height:22px; display:grid; place-items:center;
      border-radius:8px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-size:13px;
    }
    .alerts{margin-top:12px; padding:12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .alerts h4{margin:0 0 10px; font-size:13px}
    .alerts ul{margin:0; padding-left:18px; color:var(--text)}
    .alerts li{margin:6px 0; color:var(--text)}
    .ok{color:var(--good)}
    .warnT{color:var(--warn)}
    .badT{color:var(--bad)}
    details{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:12px 12px;
      font-weight:900;
      color:var(--text);
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .console{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      line-height:1.42;
      white-space:pre-wrap;
      color: #eaf2ff;
    }
    .foot{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      padding:10px 4px 0;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="title">B√πi H√†o ‚Äî Lotto ULTRA MASTER</div>
        <div class="badge">A-FULL ‚Ä¢ 1-file ‚Ä¢ ∆∞u ti√™n ch·ªët 3 ‚Ä¢ c√≥ DEMO test</div>
      </div>
      <div class="row">
        <button class="btn good" id="btnRun">RUN</button>
        <button class="btn primary" id="btnDemo">DEMO</button>
        <button class="btn bad" id="btnClear">CLEAR</button>
      </div>
    </header>

    <div class="subtitle">
      Nh·∫≠p d·ªØ li·ªáu m·ªói d√≤ng = 1 ng√†y (newest ·ªü tr√™n). Format: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b>.
      Tool h·ªó tr·ª£ th·ªëng k√™/soi, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="hd">
          <h3>D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h3>
          <div class="small">New nh·∫•t ·ªü tr√™n</div>
        </div>
        <div class="bd">
          <textarea id="inputData" spellcheck="false" placeholder="VD:
DB 54 | G7: 77 51 67 47 | G6: 813 258 481
DB 45 | G7: 03 82 85 81 | G6: 392 255 854
..."></textarea>

          <div style="height:10px"></div>

          <div class="kv">
            <div class="field">
              <label>C·ª≠a s·ªï ng√†y (khuy·∫øn ngh·ªã)</label>
              <input id="winDays" type="number" min="5" max="120" step="1" value="20"/>
            </div>
            <div class="field">
              <label>Top hi·ªÉn th·ªã (tham kh·∫£o)</label>
              <input id="topN" type="number" min="5" max="30" step="1" value="10"/>
            </div>

            <div class="field">
              <label>AI gi√°m s√°t</label>
              <select id="aiGuard">
                <option value="on">ON (kh√≥a theo pha)</option>
                <option value="off">OFF</option>
              </select>
            </div>
            <div class="field">
              <label>Ng∆∞·ª°ng TR·ª§C n·ªëi (>=)</label>
              <input id="trucTh" type="number" min="2" max="10" step="1" value="4"/>
            </div>

            <div class="field">
              <label>K ƒë·ªçc pha (ng√†y g·∫ßn nh·∫•t)</label>
              <input id="kPhase" type="number" min="3" max="30" step="1" value="9"/>
            </div>

            <div class="field">
              <label>∆Øu ti√™n</label>
              <select id="modePick">
                <option value="pick3" selected>Ch·ªët 3 (Ch√≠nh/Ph·ª•/K√®m)</option>
                <option value="top10">Ch·ªâ Top 10</option>
              </select>
            </div>

            <div class="field">
              <label>Tr·ªçng s·ªë Hot</label>
              <input id="wHot" type="number" step="0.1" value="1.5"/>
            </div>
            <div class="field">
              <label>Tr·ªçng s·ªë Gan</label>
              <input id="wGan" type="number" step="0.1" value="2"/>
            </div>
            <div class="field">
              <label>Tr·ªçng s·ªë Pascal</label>
              <input id="wPas" type="number" step="0.1" value="2"/>
            </div>
            <div class="field">
              <label>Tr·ªçng s·ªë Tr·ª•c</label>
              <input id="wTruc" type="number" step="0.1" value="2.4"/>
            </div>
            <div class="field">
              <label>Tr·ªçng s·ªë G7</label>
              <input id="wG7" type="number" step="0.1" value="0.9"/>
            </div>
            <div class="field">
              <label>Build tag</label>
              <input id="buildTag" type="text" value="A-FULL-2026-02-02-TEST" style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);padding:10px 10px;outline:none;font-weight:800"/>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="small">
            Tip ch·ªëng ‚Äúƒë·ªçc ng∆∞·ª£c‚Äù: n·∫øu d√πng data test, b·∫•m DEMO ƒë·ªÉ ƒë·ª° tr·ªôn. Newest ph·∫£i ·ªü d√≤ng 1.
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="hd">
          <h3>K·∫æT QU·∫¢ FULL</h3>
          <div class="small" id="statusLine">Ch∆∞a ch·∫°y</div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="simple">SIMPLE</div>
          <div class="tab" data-tab="pro">PRO</div>
        </div>

        <div class="panel" id="panelSimple">
          <div class="card" style="border-radius:14px;margin:0;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.12)">
            <div class="bd">
              <div class="small" style="font-weight:800; letter-spacing:.2px">CH·ªêT (TH∆Ø∆†NG M·∫†I)</div>
              <div class="bigPick" id="pickLine">-- / -- / --</div>
              <div class="metaLine" id="metaLine">Pha: -- ‚Ä¢ H∆∞·ªõng: -- ‚Ä¢ Tin c·∫≠y: --</div>

              <div class="pickRow">
                <div class="pickChip"><span class="icon">üéØ</span> <span>Ch√≠nh: <span id="pickMain">--</span></span></div>
                <div class="pickChip"><span class="icon">üõ°Ô∏è</span> <span>Ph·ª•: <span id="pickSub">--</span></span></div>
                <div class="pickChip"><span class="icon">‚ûï</span> <span>K√®m: <span id="pickAdd">--</span></span></div>
              </div>

              <div class="alerts">
                <h4>3 C·∫¢NH B√ÅO M·∫†NH</h4>
                <ul id="alertList">
                  <li class="warnT">‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu</li>
                </ul>
              </div>

              <div class="small" style="margin-top:10px">
                AI supervisor: <b id="aiLock">--</b><br/>
                <span id="weightLine">WEIGHTS: --</span><br/>
                T·ªïng ng√†y d√πng: <b id="daysUsed">0</b><br/>
                BUILD: <b id="buildOut">--</b>
              </div>

              <div class="small" style="margin-top:10px">
                ‚úÖ MODE: <b id="modeLine">--</b>
              </div>
            </div>
          </div>
        </div>

        <div class="panel" id="panelPro" style="display:none">
          <div class="small" style="font-weight:800;margin:2px 0 10px">PRO: Th√™m Top + % + m·ªü FULL PRO chi ti·∫øt</div>

          <div class="pillbox" id="topPills"></div>

          <div class="alerts" style="margin-top:12px">
            <h4>GI·∫¢I TH√çCH S·ªê CH·ªêT</h4>
            <div class="small" id="explainList">--</div>
          </div>

          <details id="detailBox">
            <summary>‚ñº Xem chi ti·∫øt FULL PRO</summary>
            <div class="console" id="consoleOut">--</div>
          </details>
        </div>

        <div class="foot">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
      </section>
    </div>
  </div>

<script>
/* ===========================
   ULTRA MASTER ‚Äî A-FULL (1 file)
   - ∆∞u ti√™n CH·ªêT 3 (Ch√≠nh/Ph·ª•/K√®m)
   - parse DB/G7/G6
   - t√≠nh HOT / GAN / ƒê·∫ßu-ƒëu√¥i / Tr·ª•c n·ªëi / G7 lead (+b√≥ng) / Pascal seed
   - pha & trust/noise heuristics (kh√¥ng ph·∫£i d·ª± ƒëo√°n ch·∫Øc ch·∫Øn)
   =========================== */

const $ = (id)=>document.getElementById(id);
const pad2 = (n)=>String(n).padStart(2,'0');
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

function parseLine(line){
  // Format: DB xx | G7: a b c d | G6: xxx yyy zzz
  const raw = line.trim();
  if(!raw) return null;
  const m = raw.match(/DB\s+(\d{1,2})\s*\|\s*G7\s*:\s*([0-9]{1,2})\s+([0-9]{1,2})\s+([0-9]{1,2})\s+([0-9]{1,2})\s*\|\s*G6\s*:\s*([0-9]{1,3})\s+([0-9]{1,3})\s+([0-9]{1,3})/i);
  if(!m) return { ok:false, raw };
  const db = pad2(parseInt(m[1],10));
  const g7 = [m[2],m[3],m[4],m[5]].map(x=>pad2(parseInt(x,10)));
  const g6 = [m[6],m[7],m[8]].map(x=>String(parseInt(x,10)).padStart(3,'0'));
  const g6_2 = g6.map(x=>x.slice(-2));
  const pool = [db, ...g7, ...g6_2]; // 8 con / ng√†y
  return { ok:true, raw, db, g7, g6, g6_2, pool };
}

function mirrorDigit(d){
  // b√≥ng 0-5,1-6,2-7,3-8,4-9
  const map = {0:5,1:6,2:7,3:8,4:9,5:0,6:1,7:2,8:3,9:4};
  return map[d];
}
function mirror2(num2){
  const a = parseInt(num2[0],10), b = parseInt(num2[1],10);
  return String(mirrorDigit(a))+String(mirrorDigit(b));
}

function analyze(lines, opts){
  const parsed = lines.map(parseLine).filter(x=>x && x.raw.length>0);
  const bad = parsed.filter(x=>x && x.ok===false);
  const good = parsed.filter(x=>x && x.ok===true);

  const windowN = Math.min(opts.winDays, good.length);
  const use = good.slice(0, windowN); // newest -> older
  const daysUsed = use.length;

  // freq HOT
  const freq = new Map();
  use.forEach(day=>{
    day.pool.forEach(n=>{
      freq.set(n,(freq.get(n)||0)+1);
    });
  });

  // GAN: days since last seen (0 = seen today, 1 = yesterday ...)
  const lastSeen = new Map();
  use.forEach((day, idx)=>{
    day.pool.forEach(n=>{
      if(!lastSeen.has(n)) lastSeen.set(n, idx);
    });
  });

  // head/tail counts
  const head = Array(10).fill(0);
  const tail = Array(10).fill(0);
  use.forEach(day=>{
    day.pool.forEach(n=>{
      head[parseInt(n[0],10)]++;
      tail[parseInt(n[1],10)]++;
    });
  });
  const topHead = [...head.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([d,c])=>({d, c}));
  const topTail = [...tail.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([d,c])=>({d, c}));

  // Tr·ª•c n·ªëi (heuristic): con n√†o c√≥ freq >= threshold
  const trucSet = new Set();
  for(let i=0;i<100;i++){
    const n = pad2(i);
    if((freq.get(n)||0) >= opts.trucTh) trucSet.add(n);
  }

  // G7 lead set: l·∫•y s·ªë t·ª´ G7 K g·∫ßn nh·∫•t + b√≥ng
  const k = Math.min(opts.kPhase, use.length);
  const g7Lead = new Set();
  for(let i=0;i<k;i++){
    use[i].g7.forEach(n=>{
      g7Lead.add(n);
      g7Lead.add(mirror2(n));
    });
  }

  // Pascal seed (heuristic): seed t·ª´ ng√†y m·ªõi nh·∫•t
  const pas = new Set();
  if(use[0]){
    const db = parseInt(use[0].db,10);
    const g7a = parseInt(use[0].g7[0],10);
    const g7b = parseInt(use[0].g7[1],10);
    const g6a = parseInt(use[0].g6_2[0],10);
    const seeds = [
      db,
      g7a, g7b,
      (db+g7a)%100,
      (db+g7b)%100,
      (g7a+g7b)%100,
      (db+g6a)%100,
      (g7a+g6a)%100,
    ].map(x=>pad2(x));
    seeds.forEach(x=>pas.add(x));
  }

  // Phase (heuristic)
  // - ganTop cao & hotTop th·∫•p => TRUC_MO
  // - hotTop cao & ganTop th·∫•p => TRUC_GAN
  // - hot d√†y, t·∫≠p trung 1-2 ƒë·∫ßu/ƒëu√¥i => DAO
  // - noise cao (top g·∫ßn nhau) => XA
  const allNums = [];
  for(let i=0;i<100;i++) allNums.push(pad2(i));

  // score components
  function ganScore(n){
    const ls = lastSeen.has(n) ? lastSeen.get(n) : 99;
    const capped = Math.min(ls, 15);
    return (capped/15)*10; // 0..10
  }
  function hotScore(n){
    const f = freq.get(n)||0;
    // scale (0..?) => 0..10 roughly
    return clamp((f / Math.max(1, Math.ceil(daysUsed*8/35))) * 4, 0, 10);
  }

  // weights (may be guarded by phase later)
  let wHot = opts.wHot, wGan = opts.wGan, wPas = opts.wPas, wTruc = opts.wTruc, wG7 = opts.wG7;

  // preliminary ranking for phase detection
  function rawTotal(n){
    const hs = hotScore(n);
    const gs = ganScore(n);
    const ts = trucSet.has(n) ? 1 : 0;
    const g7s = g7Lead.has(n) ? 1 : 0;
    const ps = pas.has(n) ? 1 : 0;
    return (wHot*hs) + (wGan*gs) + (wTruc*ts) + (wG7*g7s) + (wPas*ps);
  }
  let pre = allNums.map(n=>({n, s: rawTotal(n)})).sort((a,b)=>b.s-a.s);
  const top3 = pre.slice(0,3).map(x=>x.n);

  const avgGanTop = top3.reduce((a,n)=>a+ganScore(n),0)/3;
  const avgHotTop = top3.reduce((a,n)=>a+hotScore(n),0)/3;

  const headMax = Math.max(...head);
  const tailMax = Math.max(...tail);
  const concentration = (headMax + tailMax) / Math.max(1, (daysUsed*8/10)); // heuristic

  let pha = "P2";
  let huong = "TRUC_GAN";
  if(avgGanTop >= 6.5 && avgHotTop <= 4.5){ pha="P6"; huong="TRUC_MO"; }
  else if(concentration >= 2.2){ pha="P4"; huong="DAO"; }
  else if(Math.abs(pre[0].s - pre[6].s) <= 1.2){ pha="P8"; huong="XA"; }

  // AI guard adjusts weights by phase
  let aiSupervisor = opts.aiGuard === "on" ? "LOCKED" : "OPEN";
  if(opts.aiGuard === "on"){
    if(huong==="TRUC_MO"){
      // ∆∞u ti√™n gan & tr·ª•c
      wGan *= 1.2;
      wTruc *= 1.15;
      wHot *= 0.9;
    }else if(huong==="TRUC_GAN"){
      // ∆∞u ti√™n hot + gan c√¢n
      wHot *= 1.05;
      wGan *= 1.05;
    }else if(huong==="DAO"){
      // ∆∞u ti√™n G7 + Pascal ƒë·ªÉ gi·∫£m l·ªách
      wG7 *= 1.2;
      wPas *= 1.1;
      wHot *= 0.95;
    }else{
      // XA: gi·∫£m all-in, gi·ªØ c√¢n
      wHot *= 0.95; wGan *= 0.95; wTruc *= 0.95; wG7 *= 0.95; wPas *= 0.95;
    }
  }

  // final scoring
  function total(n){
    const hs = hotScore(n);
    const gs = ganScore(n);
    const ts = trucSet.has(n) ? 1 : 0;
    const g7s = g7Lead.has(n) ? 1 : 0;
    const ps = pas.has(n) ? 1 : 0;
    return (wHot*hs) + (wGan*gs) + (wTruc*ts) + (wG7*g7s) + (wPas*ps);
  }
  const ranked = allNums.map(n=>{
    const f = freq.get(n)||0;
    const ls = lastSeen.has(n) ? lastSeen.get(n) : Infinity;
    const hs = hotScore(n);
    const gs = ganScore(n);
    const ts = trucSet.has(n);
    const g7s = g7Lead.has(n);
    const ps = pas.has(n);
    const s = total(n);
    return {n, s, f, ls, hs, gs, ts, g7s, ps};
  }).sort((a,b)=>b.s-a.s);

  // top pills
  const topN = ranked.slice(0, opts.topN);
  const top1 = ranked[0]?.n || "--";
  const top2n = ranked[1]?.n || "--";
  const top3n = ranked[2]?.n || "--";

  // trust/noise heuristic
  const spread = (ranked[0]?.s || 0) - (ranked[6]?.s || 0);
  const trust = clamp(Math.round(55 + spread*6), 40, 92);
  const noise = clamp(100 - trust + Math.round(concentration*4), 20, 80);

  // alerts
  const alerts = [];
  if(bad.length>0) alerts.push({t:"‚ö†Ô∏è C√≥ d√≤ng sai format ‚Üí b·ªè qua (nh·ªõ newest ·ªü tr√™n).", cls:"warnT"});
  // ‚Äúb·∫´y c·ª•m/hot‚Äù n·∫øu top10 qu√° nhi·ªÅu con c√πng ƒë·∫ßu ho·∫∑c ƒëu√¥i
  const top10 = ranked.slice(0,10).map(x=>x.n);
  const topHeadCount = Array(10).fill(0);
  const topTailCount = Array(10).fill(0);
  top10.forEach(n=>{ topHeadCount[+n[0]]++; topTailCount[+n[1]]++; });
  const maxH = Math.max(...topHeadCount);
  const maxT = Math.max(...topTailCount);
  if(maxH>=5 || maxT>=5){
    alerts.push({t:"‚ö†Ô∏è B·∫™Y C·ª§M/HOT: c·ª•m ƒë·∫ßu/ƒëu√¥i d√†y ‚Üí d·ªÖ l·ªách, tr√°nh all-in theo c·ª•m.", cls:"warnT"});
  }else{
    alerts.push({t:"‚úÖ OK: ch∆∞a th·∫•y b·∫´y c·ª•m qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).", cls:"ok"});
  }
  if(huong==="XA"){
    alerts.push({t:"‚ö†Ô∏è NHI·ªÑU/PH√ÇN T√ÅN: ƒëi·ªÉm top s√°t nhau ‚Üí n√™n ƒë√°nh nh·ªè/gi·ªØ d√†n d·ª± ph√≤ng.", cls:"warnT"});
  }else{
    alerts.push({t:"‚úÖ OK: xu h∆∞·ªõng t∆∞∆°ng ƒë·ªëi r√µ theo pha hi·ªán t·∫°i.", cls:"ok"});
  }
  if(daysUsed<6){
    alerts.push({t:"‚ö†Ô∏è √çt d·ªØ li·ªáu: c·ª≠a s·ªï ng√†y nh·ªè ‚Üí k·∫øt qu·∫£ d·ªÖ tr√¥i.", cls:"warnT"});
  }else{
    alerts.push({t:"‚úÖ OK: d·ªØ li·ªáu ƒë·ªß t·ªëi thi·ªÉu ƒë·ªÉ th·ªëng k√™.", cls:"ok"});
  }

  // ‚Äútr·ª•c n·ªëi‚Äù list
  const trucList = [...trucSet].sort((a,b)=> (freq.get(b)||0)-(freq.get(a)||0) || (parseInt(a)-parseInt(b)));

  // explain for top3
  function explain(x){
    return `${x.n} | hot:${x.f} | gan:${(x.ls===Infinity?"‚àû":x.ls)} | truc:${x.ts?"Y":"-"} | g7:${x.g7s?"Y":"-"} | pas:${x.ps?"Y":"-"} | dau:${x.n[0]} | duoi:${x.n[1]} | score:${x.s.toFixed(2)}`;
  }
  const expTop3 = ranked.slice(0,3).map(explain);

  // console FULL PRO
  const hot15 = ranked.slice().sort((a,b)=>b.f-a.f).slice(0,15).map(x=>`${x.n}‚Üí${x.f}`).join("  ");
  const gan15 = ranked.slice().sort((a,b)=>{
    const la = (a.ls===Infinity?999:a.ls), lb=(b.ls===Infinity?999:b.ls);
    return lb-la;
  }).slice(0,15).map(x=>`${x.n}‚Üí${(x.ls===Infinity?"‚àû":x.ls)}`).join("  ");
  const headStr = topHead.map(x=>`${x.d}(${x.c})`).join(" ");
  const tailStr = topTail.map(x=>`${x.d}(${x.c})`).join(" ");

  const g7List = [...g7Lead].sort((a,b)=>parseInt(a)-parseInt(b)).join(" ");
  const pasList = [...pas].sort((a,b)=>parseInt(a)-parseInt(b)).join(" ");

  const cumXacNhan = ranked.slice(0,10).filter(x=>x.ts && x.g7s).slice(0,8).map(x=>x.n).join(" ") || "(ch∆∞a r√µ)";

  const consoleText =
`===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++ ‚Ä¢ HIT@3>=2) =====
BUILD: ${opts.buildTag}
T·ªïng ng√†y d√πng: ${daysUsed}

AI ƒê·ªåC PHA:
Pha: ${pha} | H∆∞·ªõng: ${huong} | Tin c·∫≠y: ${trust}%
Nh·∫≠n ƒë·ªãnh: ${huong==="TRUC_MO"?"M·ªû TR·ª§C ‚Äì gan v·ª´a/ƒë·ªß, tr·ª•c ƒëang n·ªï. ∆Øu ti√™n TR·ª§C + x√°c nh·∫≠n gan."
:huong==="TRUC_GAN"?"TR·ª§C + GAN lead ‚Äì ∆∞u ti√™n tr·ª•c n·ªïi, tr√°nh b√°m c·ª•m G6/G7 thu·∫ßn."
:huong==="DAO"?"PHA ƒê·∫¢O ‚Äì c·ª•m ƒë·∫ßu/ƒëu√¥i d·ªÖ l·∫Øc. ∆Øu ti√™n G7+k·ªÅ/b√≥ng + Pascal ƒë·ªÉ gi·∫£m l·ªách."
:"PHA NHI·ªÑU ‚Äì ƒëi·ªÉm s√°t nhau, ∆∞u ti√™n k·ª∑ lu·∫≠t ti·ªÅn, tr√°nh all-in."}

TOP ${opts.topN} (tham kh·∫£o) + %:
${topN.map((x,i)=>{
  const pct = clamp(Math.round(100 - i*4 - (noise/10)), 55, 100);
  return `${x.n}(${pct}%)`;
}).join("  ")}

CH·ªêT (3 s·ªë, ∆∞u ti√™n):
üéØ Ch√≠nh: ${top1}
üõ°Ô∏è Ph·ª• : ${top2n}
‚ûï K√®m : ${top3n}

3 C·∫¢NH B√ÅO M·∫†NH:
1) ${alerts[0]?.t || "‚Äî"}
2) ${alerts[1]?.t || "‚Äî"}
3) ${alerts[2]?.t || "‚Äî"}

NOTE:
‚úÖ MODE: HIT@3>=2 ‚Ä¢ trust ${trust}% ‚Ä¢ noise ${noise}% ‚Ä¢ BUILD ${opts.buildTag}

===== AI ƒê·ªåC PHA (MASTER+++) =====
Pha: ${pha} | H∆∞·ªõng: ${huong} | Tin c·∫≠y: ${trust}%
Nh·∫≠n ƒë·ªãnh: (xem tr√™n)

===== SOI FULL LOTO 2 S·ªê (FULL PRO) =====
[1] HOT (15): ${hot15}
[2] GAN (15): ${gan15}
[3] ƒê·∫¶U/ƒêU√îI Top5 (K=${Math.min(9,daysUsed)}):  ƒê·∫ßu: ${headStr}  |  ƒêu√¥i: ${tailStr}
[4] TR·ª§C n·ªëi (freq>=${opts.trucTh}): ${trucList.slice(0,42).join(" ")}${trucList.length>42?" ...":""}
[5] G7 lead set (k·ªÅ+b√≥ng, K=${k}): ${g7List}
[6] PASCAL seed: ${pasList}
[7] C·ª§M x√°c nh·∫≠n (kh√¥ng √©p): ${cumXacNhan}

[8] GI·∫¢I TH√çCH TOP (A=CORE, B=BACKUP):
1) ${expTop3[0] || "--"}
2) ${expTop3[1] || "--"}
3) ${expTop3[2] || "--"}

WEIGHTS (UI ‚Äî ƒë·ªÉ tham kh·∫£o/soi full):
wHot=${opts.wHot} | wGan=${opts.wGan} | wPas=${opts.wPas} | wTruc=${opts.wTruc} | wG7=${opts.wG7}

* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.
`;

  return {
    bad, good, daysUsed,
    pha, huong, trust, noise,
    ranked, topN,
    picks: {main: top1, sub: top2n, add: top3n},
    alerts,
    aiSupervisor,
    weights: {wHot, wGan, wPas, wTruc, wG7},
    consoleText,
    expTop3,
    trucList, g7List, pasList
  };
}

function render(res, opts){
  $("statusLine").textContent = res.good.length ? `ƒê√£ ch·∫°y ‚Ä¢ d√πng ${res.daysUsed} ng√†y` : "Ch∆∞a c√≥ d·ªØ li·ªáu h·ª£p l·ªá";

  // SIMPLE
  $("pickMain").textContent = res.picks.main;
  $("pickSub").textContent  = res.picks.sub;
  $("pickAdd").textContent  = res.picks.add;
  $("pickLine").textContent = `${res.picks.main} / ${res.picks.sub} / ${res.picks.add}`;
  $("metaLine").textContent = `Pha ${res.pha} ‚Ä¢ ${res.huong} ‚Ä¢ Tin c·∫≠y: ${res.trust}%`;

  // alerts
  $("alertList").innerHTML = res.alerts.slice(0,3).map(a=>`<li class="${a.cls}">${a.t}</li>`).join("");

  $("aiLock").textContent = res.aiSupervisor;
  $("weightLine").textContent = `WEIGHTS (AI supervisor ${res.aiSupervisor}): wHot=${opts.wHot} ‚Ä¢ wGan=${opts.wGan} ‚Ä¢ wPas=${opts.wPas} ‚Ä¢ wTruc=${opts.wTruc} ‚Ä¢ wG7=${opts.wG7}`;
  $("daysUsed").textContent = String(res.daysUsed);
  $("buildOut").textContent = opts.buildTag;

  $("modeLine").textContent = `HIT@3>=2 ‚Ä¢ trust ${res.trust}% ‚Ä¢ noise ${res.noise}% ‚Ä¢ BUILD ${opts.buildTag}`;

  // PRO: pills top
  $("topPills").innerHTML = res.topN.map((x,i)=>{
    const pct = clamp(Math.round(100 - i*4 - (res.noise/10)), 55, 100);
    return `<div class="pill"><strong>${x.n}</strong>(${pct}%)</div>`;
  }).join("");

  // explain
  $("explainList").innerHTML = res.expTop3.map((t, idx)=>`‚Ä¢ ${idx+1}) ${t}`).join("<br/>");

  $("consoleOut").textContent = res.consoleText;

  // auto open details if PRO
  // (gi·ªØ nguy√™n)
}

function getOpts(){
  return {
    winDays: parseInt($("winDays").value,10) || 20,
    topN: parseInt($("topN").value,10) || 10,
    aiGuard: $("aiGuard").value,
    trucTh: parseInt($("trucTh").value,10) || 4,
    kPhase: parseInt($("kPhase").value,10) || 9,
    wHot: parseFloat(String($("wHot").value).replace(",",".")) || 1.5,
    wGan: parseFloat(String($("wGan").value).replace(",",".")) || 2.0,
    wPas: parseFloat(String($("wPas").value).replace(",",".")) || 2.0,
    wTruc: parseFloat(String($("wTruc").value).replace(",",".")) || 2.4,
    wG7: parseFloat(String($("wG7").value).replace(",",".")) || 0.9,
    buildTag: ($("buildTag").value||"A-FULL").trim()
  };
}

function run(){
  const lines = $("inputData").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const opts = getOpts();
  const res = analyze(lines, opts);
  render(res, opts);
}

function setDemo(){
  const demo =
`DB 54 | G7: 77 51 67 47 | G6: 813 258 481
DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 14 | G7: 81 87 60 32 | G6: 206 200 971
DB 21 | G7: 76 47 21 77 | G6: 801 295 993
DB 22 | G7: 21 00 14 71 | G6: 497 368 374
DB 17 | G7: 71 15 99 52 | G6: 945 187 978
DB 27 | G7: 82 24 25 16 | G6: 508 652 762
DB 94 | G7: 31 34 20 42 | G6: 301 697 335`;
  $("inputData").value = demo;
}

function clearAll(){
  $("inputData").value = "";
  $("statusLine").textContent = "Ch∆∞a ch·∫°y";
  $("pickLine").textContent = "-- / -- / --";
  $("pickMain").textContent = $("pickSub").textContent = $("pickAdd").textContent = "--";
  $("metaLine").textContent = "Pha: -- ‚Ä¢ H∆∞·ªõng: -- ‚Ä¢ Tin c·∫≠y: --";
  $("alertList").innerHTML = `<li class="warnT">‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu</li>`;
  $("topPills").innerHTML = "";
  $("explainList").textContent = "--";
  $("consoleOut").textContent = "--";
}

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.dataset.tab;
    $("panelSimple").style.display = (tab==="simple") ? "" : "none";
    $("panelPro").style.display = (tab==="pro") ? "" : "none";
  });
});

$("btnRun").addEventListener("click", run);
$("btnDemo").addEventListener("click", ()=>{ setDemo(); run(); });
$("btnClear").addEventListener("click", clearAll);

// auto demo first load for convenience
setDemo();
run();
</script>
</body>
</html>
