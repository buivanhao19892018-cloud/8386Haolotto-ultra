<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (UPLOAD-FIX ‚Ä¢ OCR GATE FULL)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b36; --card2:#0b1328;
      --txt:#e8eefc; --mut:#9fb0d4; --ok:#34d399; --bad:#fb7185;
      --blue:#2563eb; --red:#dc2626; --chip:#14234a;
      --shadow: 0 20px 50px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:12px}
    .wrap{max-width:760px;margin:0 auto}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border-radius:var(--r);
      padding:14px;
      margin:12px 0;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.06);
    }
    h1,h2,h3{margin:0 0 8px}
    h1{font-size:20px}
    p{margin:8px 0;color:var(--mut);line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:0;border-radius:14px;padding:12px 14px;font-weight:800;
      color:white;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 10px 25px rgba(0,0,0,.25);
    }
    .btn.blue{background:var(--blue)}
    .btn.red{background:var(--red)}
    .btn.gray{background:#223257}
    .btn:active{transform:scale(.99)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      background:var(--chip);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 10px;border-radius:999px;
      color:var(--mut);font-weight:700;font-size:12px;
    }
    .chip.ok{color:var(--ok)}
    .chip.bad{color:var(--bad)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .box{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      padding:12px;border-radius:14px;
    }
    .box b{font-size:22px}
    .small{font-size:12px;color:var(--mut)}
    img{max-width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
    textarea,input{
      width:100%;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.08);
      color:var(--txt);padding:12px;border-radius:14px;font-size:14px;outline:none;
    }
    textarea{min-height:140px;white-space:pre;overflow:auto}
    pre{white-space:pre-wrap;word-break:break-word;margin:0;color:#cfe0ff;font-size:12px}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .footer{opacity:.8;font-size:12px;color:var(--mut);text-align:center;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER (UPLOAD-FIX ‚Ä¢ OCR GATE FULL)</h1>
    <p>
      Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí OCR (Tesseract) ‚Üí Parse <b>DB/G6/G7</b> ‚Üí
      Gate c·ª©ng (sai l√† kh√¥ng ƒë·ªï) ‚Üí Xu·∫•t d·ªØ li·ªáu s·∫°ch.
    </p>

    <!-- Upload FIX: input lu√¥n n·∫±m trong DOM, click t·ª´ button (user gesture), multiple, accept image/* -->
    <input id="file" type="file" accept="image/*" multiple />

    <div class="row" style="margin-top:10px">
      <button class="btn blue" id="btnRun">üöÄ OCR + Gate + Th√™m d√≤ng</button>
      <button class="btn gray" id="btnRetryLast">üîÅ OCR l·∫°i ·∫£nh cu·ªëi</button>
      <button class="btn red" id="btnReset">üóë X√≥a h·∫øt</button>
    </div>

    <div class="chips">
      <div class="chip" id="cHttps">HTTPS: ‚Ä¶</div>
      <div class="chip" id="cTess">Tesseract: ‚Ä¶</div>
      <div class="chip" id="cBatch">Batch: 0 ·∫£nh</div>
      <div class="chip" id="cGate">Gate: ‚Äî</div>
    </div>

    <p class="small">
      M·∫πo crop: ch·ª•p/c·∫Øt s√°t ph·∫ßn b·∫£ng t·ª´ ‚ÄúƒêB‚Äù t·ªõi h√†ng ‚Äú7‚Äù. Tr√°nh d√≠nh header qu·∫£ng c√°o & footer tab (Mi·ªÅn B·∫Øc/Trung/Nam).
      N·∫øu b·∫•m Upload m√† kh√¥ng m·ªü ch·ªçn ·∫£nh: d√πng <b>Chrome</b> v√† ch·∫Øc ch·∫Øn URL l√† <b>https</b>.
    </p>
  </div>

  <div class="card">
    <h3>Preview ·∫£nh g·∫ßn nh·∫•t</h3>
    <img id="preview" style="display:none" alt="preview" />
  </div>

  <div class="card">
    <h3>·∫¢nh ‚Üí OCR ‚Üí Gate</h3>
    <p class="small">
      Parse ‚Äúc·ª©ng‚Äù theo quy t·∫Øc:
      <br>‚Ä¢ <b>ƒêB</b>: t√¨m nh√£n ‚ÄúƒêB/DB/ƒê8‚Ä¶‚Äù ‚Üí l·∫•y ƒë√∫ng <b>5 s·ªë</b>
      <br>‚Ä¢ <b>G7</b>: t√¨m d√≤ng c√≥ <b>7</b> ‚Üí l·∫•y <b>4 s·ªë 2 ch·ªØ s·ªë</b> (∆∞u ti√™n l·∫•y 4 s·ªë cu·ªëi)
      <br>‚Ä¢ <b>G6</b>: t√¨m d√≤ng c√≥ <b>6</b> ‚Üí l·∫•y <b>3 s·ªë 3 ch·ªØ s·ªë</b> (∆∞u ti√™n l·∫•y 3 s·ªë cu·ªëi)
    </p>

    <div class="grid">
      <div class="box"><div class="small">DB (2 s·ªë)</div><b id="outDB">‚Äî</b></div>
      <div class="box"><div class="small">Tr·∫°ng th√°i</div><b id="outGate">‚Äî</b></div>
      <div class="box"><div class="small">G7 (4 s·ªë)</div><b id="outG7">‚Äî</b></div>
      <div class="box"><div class="small">G6 (3 s·ªë)</div><b id="outG6">‚Äî</b></div>
    </div>

    <div class="sep"></div>

    <h3>S·ª≠a tay (ch·ªâ khi Gate FAIL)</h3>
    <div class="grid">
      <div><div class="small">DB (2 s·ªë) VD: 45</div><input id="mDB" placeholder="VD: 45" /></div>
      <div><div class="small">G7 (4 s·ªë) VD: 03 82 85 81</div><input id="mG7" placeholder="VD: 03 82 85 81" /></div>
      <div style="grid-column:1/-1"><div class="small">G6 (3 s·ªë) VD: 392 255 854</div><input id="mG6" placeholder="VD: 392 255 854" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn blue" id="btnApplyManual">‚úÖ √Åp manual ‚Üí th√™m d√≤ng</button>
    </div>
  </div>

  <div class="card">
    <h3>D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h3>
    <p class="small">Format chu·∫©n: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b></p>
    <textarea id="data" placeholder="Ch∆∞a c√≥ d·ªØ li·ªáu..."></textarea>

    <div class="row" style="margin-top:10px">
      <button class="btn gray" id="btnCopy">üìã Copy to√†n b·ªô</button>
      <button class="btn gray" id="btnClearData">üßΩ X√≥a d·ªØ li·ªáu</button>
    </div>
  </div>

  <div class="card">
    <h3>Debug OCR (r√∫t g·ªçn)</h3>
    <pre id="debug"></pre>
  </div>

  <div class="footer">¬© B√πi H√†o ‚Äî Tool h·ªó tr·ª£ th·ªëng k√™, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* =========================
   STATE
========================= */
let lastFile = null;
let worker = null;

const el = (id)=>document.getElementById(id);
const cHttps = el("cHttps");
const cTess  = el("cTess");
const cBatch = el("cBatch");
const cGate  = el("cGate");

const outDB = el("outDB");
const outG6 = el("outG6");
const outG7 = el("outG7");
const outGate = el("outGate");
const debug = el("debug");
const preview = el("preview");

const fileInput = el("file");
const dataBox = el("data");

function setChip(node, text, cls){
  node.className = "chip" + (cls ? (" "+cls) : "");
  node.textContent = text;
}

/* =========================
   UPLOAD FIX + ENV
========================= */
(function initEnv(){
  setChip(cHttps, (location.protocol === "https:" ? "HTTPS: OK" : "HTTPS: NO"), location.protocol==="https:" ? "ok":"bad");
  setChip(cTess, "Tesseract: ready", "ok");
  setChip(cBatch, "Batch: 0 ·∫£nh");
  setChip(cGate, "Gate: ‚Äî");
})();

fileInput.addEventListener("change", ()=>{
  const files = [...fileInput.files||[]];
  setChip(cBatch, `Batch: ${files.length} ·∫£nh`);
  if (files.length) lastFile = files[files.length-1];
});

/* =========================
   OCR WORKER (reuse)
========================= */
async function getWorker(){
  if (worker) return worker;
  worker = await Tesseract.createWorker("vie+eng");
  return worker;
}

function normalizeText(raw){
  // Ch·ªëng OCR nh·∫ßm ph·ªï bi·∫øn
  let t = raw || "";
  t = t.replace(/\u00A0/g," ");          // nbsp
  t = t.replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äô‚Äò]/g,"'");
  // nh·∫ßm ch·ªØ th√†nh s·ªë
  t = t.replace(/O/g,"0").replace(/o/g,"0");
  t = t.replace(/I/g,"1").replace(/l/g,"1").replace(/\|/g,"1");
  // nh·∫ßm ƒêB -> DB / ƒê8 / D8 ...
  t = t.replace(/√ê/g,"ƒê");
  // gom kho·∫£ng tr·∫Øng
  t = t.replace(/[ \t]+/g," ");
  return t.trim();
}

function clampDebug(t){
  // r√∫t g·ªçn debug ƒë·ªÉ ƒë·ª° d√†i
  const lines = t.split("\n").map(s=>s.trim()).filter(Boolean);
  return lines.slice(0, 120).join("\n");
}

/* =========================
   PARSER "C·ª®NG"
========================= */
function tokensFromLine(line){
  // t√°ch token s·ªë theo nh√≥m: 5-digit, 3-digit, 2-digit
  const toks = [];
  const re = /\b\d{5}\b|\b\d{3}\b|\b\d{2}\b/g;
  let m;
  while((m=re.exec(line))!==null) toks.push(m[0]);
  return toks;
}

function findDB(text){
  // ∆Øu ti√™n: c√≥ nh√£n ƒêB/DB/D8/ƒê8 g·∫ßn ƒë√≥ v√† 5 s·ªë
  // OCR ƒë√¥i khi m·∫•t d·∫•u: "DB 32845" ho·∫∑c "ƒê8 32845"
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);

  // 1) scan line c√≥ nh√£n
  for (const ln of lines){
    const label = ln.match(/\b(ƒêB|DB|D8|ƒê8)\b/i);
    if (label){
      const m = ln.match(/\b\d{5}\b/);
      if (m) return m[0];
    }
  }

  // 2) fallback: t√¨m c·ª•m "ƒêB ... 5 s·ªë" d·∫°ng d√≠nh
  const m2 = text.match(/(ƒêB|DB|D8|ƒê8)[^\d]{0,10}(\d{5})/i);
  if (m2) return m2[2];

  return null;
}

function findRowNumbers(text, rowDigit){
  // rowDigit: 6 ho·∫∑c 7
  // OCR hay ra ki·ªÉu: "7 1 03 82 85 81" => l·∫•y 4 s·ªë 2-digit CU·ªêI
  //               "6 392 255 854"      => l·∫•y 3 s·ªë 3-digit CU·ªêI
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);

  // ∆∞u ti√™n line c√≥ b·∫Øt ƒë·∫ßu b·∫±ng "6" ho·∫∑c "7"
  const candidates = [];
  for (const ln of lines){
    // c√≥ token rowDigit ƒë·ªôc l·∫≠p
    if (new RegExp(`(^|\\s)${rowDigit}(\\s|$)`).test(ln)){
      candidates.push(ln);
    }
  }

  // n·∫øu kh√¥ng th·∫•y, fallback: t√¨m line ch·ª©a nhi·ªÅu s·ªë ph√π h·ª£p (G7: 2-digit, G6: 3-digit)
  if (!candidates.length){
    for (const ln of lines){
      if (rowDigit===7){
        if ((ln.match(/\b\d{2}\b/g)||[]).length >= 4) candidates.push(ln);
      } else {
        if ((ln.match(/\b\d{3}\b/g)||[]).length >= 3) candidates.push(ln);
      }
    }
  }

  // ch·ªçn candidate "h·ª£p l√Ω nh·∫•t":
  // - row 7: nhi·ªÅu 2-digit nh·∫•t
  // - row 6: nhi·ªÅu 3-digit nh·∫•t
  let best = null;
  let bestScore = -1;
  for (const ln of candidates){
    const score = rowDigit===7 ? (ln.match(/\b\d{2}\b/g)||[]).length : (ln.match(/\b\d{3}\b/g)||[]).length;
    if (score > bestScore){ bestScore = score; best = ln; }
  }

  if (!best) return null;

  if (rowDigit===7){
    const nums = best.match(/\b\d{2}\b/g) || [];
    if (nums.length >= 4) return nums.slice(-4).join(" ");
    return null;
  } else {
    const nums = best.match(/\b\d{3}\b/g) || [];
    if (nums.length >= 3) return nums.slice(-3).join(" ");
    return null;
  }
}

function last2OfDB5(db5){
  if (!db5 || db5.length!==5) return null;
  return db5.slice(-2);
}

function gate(db2, g6, g7){
  // gate c·ª©ng ƒë√∫ng format
  if (!/^\d{2}$/.test(db2||"")) return false;
  if (!/^\d{3} \d{3} \d{3}$/.test(g6||"")) return false;
  if (!/^\d{2} \d{2} \d{2} \d{2}$/.test(g7||"")) return false;
  return true;
}

/* =========================
   ACTIONS
========================= */
async function ocrFile(file){
  if (!file) throw new Error("Ch∆∞a c√≥ ·∫£nh");
  lastFile = file;

  const url = URL.createObjectURL(file);
  preview.src = url;
  preview.style.display = "block";

  setChip(cTess, "Tesseract: running...", "");
  const w = await getWorker();
  const { data } = await w.recognize(url);
  setChip(cTess, "Tesseract: done", "ok");

  const text = normalizeText(data.text || "");
  debug.textContent = clampDebug(text);

  const db5 = findDB(text);
  const db2 = last2OfDB5(db5);
  const g7  = findRowNumbers(text, 7);
  const g6  = findRowNumbers(text, 6);

  outDB.textContent = db2 || "‚Äî";
  outG6.textContent = g6  || "‚Äî";
  outG7.textContent = g7  || "‚Äî";

  const ok = gate(db2, g6, g7);
  outGate.textContent = ok ? "PASS" : "FAIL";
  outGate.style.color = ok ? "var(--ok)" : "var(--bad)";
  setChip(cGate, "Gate: " + (ok ? "PASS" : "FAIL"), ok ? "ok":"bad");

  return { ok, db2, g6, g7 };
}

function appendLine(db2,g7,g6){
  const line = `DB ${db2} | G7: ${g7} | G6: ${g6}`;
  const cur = (dataBox.value||"").trim();
  dataBox.value = (cur ? (cur + "\n" + line) : line);
}

function cleanManual(s){
  return (s||"").trim().replace(/\s+/g," ");
}

el("btnRun").addEventListener("click", async ()=>{
  const files = [...(fileInput.files||[])];
  if (!files.length){
    alert("Ch∆∞a ch·ªçn ·∫£nh. H√†o b·∫•m Upload nhi·ªÅu ·∫£nh ƒë·ªÉ ch·ªçn ·∫£nh tr∆∞·ªõc.");
    return;
  }

  // OCR l·∫ßn l∆∞·ª£t, ·∫£nh n√†o PASS th√¨ th√™m d√≤ng
  let okCount = 0, failCount = 0;

  for (const f of files){
    try{
      const r = await ocrFile(f);
      if (r.ok){
        appendLine(r.db2, r.g7, r.g6);
        okCount++;
      } else {
        failCount++;
      }
      setChip(cBatch, `Batch: ${files.length} ·∫£nh | OK ${okCount} | FAIL ${failCount}`, failCount? "bad":"ok");
    }catch(e){
      failCount++;
      setChip(cBatch, `Batch: ${files.length} ·∫£nh | OK ${okCount} | FAIL ${failCount}`, "bad");
    }
  }
});

el("btnRetryLast").addEventListener("click", async ()=>{
  if (!lastFile){
    alert("Ch∆∞a c√≥ ·∫£nh n√†o ƒë·ªÉ OCR l·∫°i.");
    return;
  }
  await ocrFile(lastFile);
});

el("btnApplyManual").addEventListener("click", ()=>{
  const db = cleanManual(el("mDB").value);
  const g7 = cleanManual(el("mG7").value);
  const g6 = cleanManual(el("mG6").value);

  const ok = gate(db, g6, g7);
  outDB.textContent = db || "‚Äî";
  outG6.textContent = g6 || "‚Äî";
  outG7.textContent = g7 || "‚Äî";
  outGate.textContent = ok ? "PASS" : "FAIL";
  outGate.style.color = ok ? "var(--ok)" : "var(--bad)";
  setChip(cGate, "Gate: " + (ok ? "PASS" : "FAIL"), ok ? "ok":"bad");

  if (!ok){
    alert("Manual ch∆∞a ƒë√∫ng format.\nDB: 2 s·ªë\nG7: 4 s·ªë (2 ch·ªØ s·ªë)\nG6: 3 s·ªë (3 ch·ªØ s·ªë)");
    return;
  }
  appendLine(db, g7, g6);
});

el("btnCopy").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(dataBox.value||"");
    alert("ƒê√£ copy d·ªØ li·ªáu.");
  }catch(e){
    alert("Kh√¥ng copy ƒë∆∞·ª£c. H√†o b√¥i ƒëen to√†n b·ªô r·ªìi copy tay gi√∫p m√¨nh.");
  }
});

el("btnClearData").addEventListener("click", ()=>{
  dataBox.value = "";
});

el("btnReset").addEventListener("click", async ()=>{
  dataBox.value = "";
  debug.textContent = "";
  outDB.textContent = "‚Äî";
  outG6.textContent = "‚Äî";
  outG7.textContent = "‚Äî";
  outGate.textContent = "‚Äî";
  setChip(cGate, "Gate: ‚Äî");
  setChip(cBatch, "Batch: 0 ·∫£nh");
  fileInput.value = "";
  lastFile = null;
  preview.style.display = "none";
  // gi·ªØ worker ƒë·ªÉ kh·ªèi load l·∫°i n·∫∑ng; n·∫øu mu·ªën, c√≥ th·ªÉ terminate:
  // if(worker){ await worker.terminate(); worker=null; }
});

/* N·∫øu trang b·ªã nh√∫ng / tr√¨nh duy·ªát ch·∫∑n file input:
   - v·∫´n kh√¥ng c√≥ c√°ch code n√†o ph√° quy·ªÅn ƒë∆∞·ª£c. Gi·∫£i ph√°p th·ª±c t·∫ø: Chrome + https + cho ph√©p quy·ªÅn ·∫£nh.
*/
</script>
</body>
</html>
