<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <meta name="theme-color" content="#0b1220"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3 ‚Ä¢ GOD MODE)</title>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.08);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#ff4d4f;
      --chip:#0e2144;
      --chip2:#0b1a36;
      --btn:#1d4ed8;
      --btn2:#0f2c6b;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --r:18px;
      --r2:24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(29,78,216,.35), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(50,213,131,.18), transparent 55%),
                  radial-gradient(700px 500px at 40% 120%, rgba(253,176,34,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--r2);
      padding: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(800px 280px at 30% 0%, rgba(29,78,216,.25), transparent 60%),
                  radial-gradient(700px 300px at 90% 30%, rgba(50,213,131,.18), transparent 60%);
      pointer-events:none;
      z-index:0;
    }
    .hero > *{position:relative; z-index:1;}
    h1{
      font-size: 26px;
      line-height:1.15;
      margin: 0 0 10px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      margin: 0 0 14px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .btn{
      border:0;
      padding: 12px 14px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(29,78,216,.95), rgba(29,78,216,.75));
      color:white;
      font-weight: 700;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(29,78,216,.25);
    }
    .btn:active{transform: translateY(1px);}
    .btn.ghost{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--line);
      color: var(--text);
      box-shadow:none;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,77,79,.92), rgba(255,77,79,.65));
      box-shadow: 0 12px 30px rgba(255,77,79,.18);
    }
    .btn.green{
      background: linear-gradient(180deg, rgba(50,213,131,.92), rgba(50,213,131,.65));
      box-shadow: 0 12px 30px rgba(50,213,131,.18);
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 13px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background: var(--good); box-shadow:0 0 0 4px rgba(50,213,131,.12);}
    .dot.warn{background: var(--warn); box-shadow:0 0 0 4px rgba(253,176,34,.12);}
    .dot.bad{background: var(--bad); box-shadow:0 0 0 4px rgba(255,77,79,.12);}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns: 1fr;}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--r2);
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .hint{color:var(--muted); font-size:13px; line-height:1.5}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin: 10px 0 6px;}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(14,33,68,.55);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 13px;
    }
    .chip strong{color:var(--text); font-weight:700;}
    .chip.good{color:#c9ffe5; border-color: rgba(50,213,131,.22); background: rgba(50,213,131,.10);}
    .chip.warn{color:#ffe7bf; border-color: rgba(253,176,34,.22); background: rgba(253,176,34,.10);}
    .chip.bad{color:#ffd6d6; border-color: rgba(255,77,79,.22); background: rgba(255,77,79,.10);}
    .inputs{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    textarea{
      width:100%;
      min-height: 170px;
      resize: vertical;
      padding: 14px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
      background: rgba(10,20,39,.75);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      outline:none;
      font-family: var(--mono);
    }
    textarea::placeholder{color: rgba(168,183,214,.65)}
    .field{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .label{
      color: var(--muted);
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .label small{opacity:.9}
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:520px){ .row2{grid-template-columns:1fr;} }
    input[type="number"], select{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(10,20,39,.75);
      color: var(--text);
      font-size: 14px;
      outline:none;
    }

    .seg{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 10px;
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(10,20,39,.55);
      color: var(--muted);
      font-size: 13px;
      user-select:none;
    }
    .toggle input{transform: scale(1.2)}
    .divider{
      height:1px; background: rgba(255,255,255,.08); margin: 14px 0;
    }

    .tabs{
      display:flex; gap:10px; margin: 6px 0 10px;
    }
    .tab{
      flex:0 0 auto;
      padding: 10px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(10,20,39,.55);
      color: var(--muted);
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      color: var(--text);
      border-color: rgba(255,255,255,.14);
    }

    .resultCard{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 22px;
      padding: 14px;
    }
    .bigPick{
      font-size: 34px;
      font-weight: 900;
      letter-spacing:.5px;
      margin: 6px 0 6px;
    }
    .meta{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      margin: 0 0 8px;
    }
    .badges{
      display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;
    }
    .badgeBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,20,39,.65);
      color: var(--text);
      font-weight:800;
      cursor:default;
    }
    .badgeBtn small{font-weight:700;color: var(--muted)}
    .warnList{
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--text);
    }
    .warnList li{margin: 6px 0; color: var(--muted)}
    .warnList b{color: var(--text)}
    .monoBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(10,20,39,.72);
      font-family: var(--mono);
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }
    details{
      margin-top: 10px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(10,20,39,.55);
    }
    summary{
      cursor:pointer;
      list-style:none;
      padding: 12px 14px;
      color: var(--text);
      font-weight: 800;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    summary::-webkit-details-marker{display:none;}
    .detailBody{
      padding: 0 14px 14px;
      color: var(--muted);
      font-size: 13px;
    }
    .footer{
      margin-top: 14px;
      color: rgba(168,183,214,.70);
      font-size: 13px;
      text-align:center;
    }
    .mini{
      color: rgba(168,183,214,.70);
      font-size: 12px;
      line-height:1.45;
    }
    .fileList{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
    }
    .fileList b{color:var(--text)}
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,20,39,.92);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      max-width: 94vw;
      display:none;
      z-index: 9999;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="row" style="justify-content:space-between; gap:12px;">
        <div>
          <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3 ‚Ä¢ GOD MODE)</h1>
          <div class="sub">
            A-FULL ‚Ä¢ 1-file ‚Ä¢ ∆∞u ti√™n ch·ªët 3 ‚Ä¢ c√≥ DEMO test<br/>
            <span class="mini">Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch/soi, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</span>
          </div>
        </div>
        <div class="row">
          <button class="btn green" id="btnRun">RUN</button>
          <button class="btn ghost" id="btnDemo">DEMO</button>
          <button class="btn danger" id="btnClear">CLEAR</button>
        </div>
      </div>

      <div class="chips" aria-label="status chips">
        <span class="chip good" id="stOpenCV"><span class="dot"></span> OpenCV: <strong>OK</strong></span>
        <span class="chip good" id="stOCR"><span class="dot"></span> OCR: <strong>ready</strong></span>
        <span class="chip warn" id="stGate"><span class="dot warn"></span> Gate: <strong>WAIT</strong></span>
        <span class="chip" id="stBatch"><span class="dot"></span> Batch: <strong>0</strong> | FAIL: <strong>0</strong></span>
      </div>

      <div class="grid">
        <!-- LEFT: OCR / Upload -->
        <div class="card">
          <h2>·∫¢nh ‚Üí OCR ‚Üí Gate</h2>
          <div class="hint">
            M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) v√† header qu·∫£ng c√°o.
          </div>

          <div class="seg" style="margin-top:12px;">
            <!-- A: Upload nhi·ªÅu ·∫£nh -->
            <button class="btn" id="btnPickFiles">üì∏ Upload nhi·ªÅu ·∫£nh</button>
            <!-- B: Camera -->
            <button class="btn ghost" id="btnCamera">üì∑ Camera</button>
            <button class="btn ghost" id="btnPasteSample">D√°n m·∫´u</button>
            <button class="btn danger" id="btnWipeInput">X√≥a</button>

            <!-- hidden inputs -->
            <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
            <input id="camInput" type="file" accept="image/*" capture="environment" style="display:none" />
          </div>

          <!-- SCALE / SCAN -->
          <div class="divider"></div>
          <div class="row" style="justify-content:space-between; gap:10px;">
            <div class="pill"><span class="dot"></span> Kh√¥ng ph√° scan / scale</div>
            <div class="pill"><span class="dot warn"></span> Gate c·ª©ng</div>
          </div>

          <div class="seg">
            <label class="toggle">
              <input type="checkbox" id="togNoScale" checked />
              <span>Gi·ªØ nguy√™n t·ªâ l·ªá (kh√¥ng scale)</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="togAutoCrop" checked />
              <span>Auto-crop (m√¥ ph·ªèng)</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="togStrictGate" checked />
              <span>Gate c·ª©ng (l·ªçc format)</span>
            </label>
          </div>

          <div class="fileList" id="fileList">
            <div><b>Ch∆∞a ch·ªçn ·∫£nh.</b> (B·∫°n v·∫´n c√≥ th·ªÉ d√πng ph·∫ßn ‚ÄúD·ªØ li·ªáu ƒë·∫ßu v√†o‚Äù b√™n ph·∫£i ƒë·ªÉ test/soi.)</div>
          </div>

          <div class="divider"></div>
          <div class="hint">
            <b>L∆∞u √Ω th·∫≠t:</b> HTML 1-file tr√™n GitHub Pages kh√¥ng ch·∫°y OpenCV/Tesseract ‚Äúƒë√∫ng nghƒ©a‚Äù n·∫øu kh√¥ng nh√∫ng th∆∞ vi·ªán n·∫∑ng.
            N√™n ph·∫ßn OCR ·ªü ƒë√¢y l√† <b>m√¥ ph·ªèng lu·ªìng</b> + <b>Gate/Parse/Run</b>. Mu·ªën OCR th·∫≠t, m√¨nh s·∫Ω n√¢ng c·∫•p b·∫£n v4 (nh√∫ng worker Tesseract + pipeline crop).
          </div>
        </div>

        <!-- RIGHT: Input + Settings -->
        <div class="card">
          <h2>D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h2>
          <div class="hint">
            Format chu·∫©n auto: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b> (newest ·ªü tr√™n).<br/>
            Tool s·∫Ω ƒë·ªçc DB (2 s·ªë), G7 (4 s·ªë), G6 (3 s·ªë 3 ch·ªØ s·ªë).
          </div>

          <div class="inputs">
            <div class="field">
              <div class="label">
                <span>Nh·∫≠p d·ªØ li·ªáu</span>
                <small id="lineCount">0 d√≤ng</small>
              </div>
              <textarea id="taInput" placeholder="V√≠ d·ª•:
DB 54 | G7: 77 51 67 47 | G6: 813 258 481
DB 45 | G7: 03 82 85 81 | G6: 392 255 854
..."></textarea>
            </div>

            <div class="row2">
              <div class="field">
                <div class="label"><span>C·ª≠a s·ªï ng√†y (khuy·∫øn ngh·ªã)</span><small>window</small></div>
                <input id="inWindow" type="number" min="3" max="60" value="20"/>
              </div>
              <div class="field">
                <div class="label"><span>Top hi·ªÉn th·ªã (tham kh·∫£o)</span><small>topN</small></div>
                <input id="inTopN" type="number" min="5" max="30" value="10"/>
              </div>
            </div>

            <div class="field">
              <div class="label"><span>AI gi√°m s√°t</span><small>phase lock</small></div>
              <select id="selSupervisor">
                <option value="on" selected>ON (kh√≥a theo pha)</option>
                <option value="off">OFF (th·∫£ tay)</option>
              </select>
            </div>

            <div class="row2">
              <div class="field">
                <div class="label"><span>Ng∆∞·ª°ng TR·ª§C n·ªïi (&gt;=)</span><small>trucMin</small></div>
                <input id="inTrucMin" type="number" min="2" max="12" value="4"/>
              </div>
              <div class="field">
                <div class="label"><span>K ƒë·ªçc pha (ng√†y g·∫ßn nh·∫•t)</span><small>K</small></div>
                <input id="inKPhase" type="number" min="3" max="15" value="9"/>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <div class="label"><span>Tr·ªçng s·ªë Hot</span><small>wHot</small></div>
                <input id="wHot" type="number" step="0.1" value="2"/>
              </div>
              <div class="field">
                <div class="label"><span>Tr·ªçng s·ªë Gan</span><small>wGan</small></div>
                <input id="wGan" type="number" step="0.1" value="1.5"/>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <div class="label"><span>Tr·ªçng s·ªë Pascal</span><small>wPas</small></div>
                <input id="wPas" type="number" step="0.1" value="2"/>
              </div>
              <div class="field">
                <div class="label"><span>Tr·ªçng s·ªë Tr·ª•c</span><small>wTruc</small></div>
                <input id="wTruc" type="number" step="0.1" value="2.4"/>
              </div>
            </div>

            <div class="field">
              <div class="label"><span>Tr·ªçng s·ªë G7 lead</span><small>wG7</small></div>
              <input id="wG7" type="number" step="0.1" value="0.9"/>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULT -->
      <div class="card" style="margin-top:14px;">
        <div class="row" style="justify-content:space-between; gap:12px;">
          <h2 style="margin:0;">K·∫æT QU·∫¢ FULL</h2>
          <div class="tabs">
            <button class="tab active" id="tabSimple">SIMPLE</button>
            <button class="tab" id="tabPro">PRO</button>
          </div>
        </div>

        <div class="hint" id="tabHint">SIMPLE: Ch·ªët + c·∫£nh b√°o + l√Ω do (d·ªÖ nh√¨n)</div>

        <div class="resultCard" id="viewSimple">
          <div class="bigPick" id="pick3">-- / -- / --</div>
          <p class="meta" id="phaseLine">Pha: -- ‚Ä¢ H∆∞·ªõng: -- ‚Ä¢ Tin c·∫≠y: --</p>
          <p class="meta" id="phaseNote">Nh·∫≠n ƒë·ªãnh: --</p>

          <div class="badges">
            <div class="badgeBtn">üéØ <span>Ch√≠nh:</span> <small id="pickMain">--</small></div>
            <div class="badgeBtn">üõ°Ô∏è <span>Ph·ª•:</span> <small id="pickSub">--</small></div>
            <div class="badgeBtn">‚ûï <span>K√®m:</span> <small id="pickAdd">--</small></div>
          </div>

          <div class="divider"></div>

          <div style="font-weight:900; letter-spacing:.2px; margin-bottom:6px;">3 C·∫¢NH B√ÅO M·∫†NH</div>
          <ul class="warnList" id="warns">
            <li><b>OK:</b> ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).</li>
            <li><b>OK:</b> ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).</li>
            <li><b>OK:</b> ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).</li>
          </ul>

          <div class="divider"></div>

          <div class="meta" id="noteLine">‚úÖ MODE: HIT@3&gt;=2 ‚Ä¢ trust --% ‚Ä¢ noise --% ‚Ä¢ BUILD --</div>

          <details open>
            <summary>
              <span>‚ñº Xem chi ti·∫øt FULL PRO</span>
              <span style="color:rgba(168,183,214,.8); font-weight:800;">(m·ªü/ƒë√≥ng)</span>
            </summary>
            <div class="detailBody">
              <div class="monoBox" id="fullProText">Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m RUN ho·∫∑c DEMO.</div>
            </div>
          </details>
        </div>

        <div class="resultCard" id="viewPro" style="display:none;">
          <div class="hint" style="margin-bottom:10px;">
            PRO: Th√™m Top + % + m·ªü FULL PRO chi ti·∫øt
          </div>

          <div class="resultCard" style="border-radius:22px;">
            <div class="bigPick" id="pick3Pro">-- / -- / --</div>
            <p class="meta" id="phaseLinePro">Pha: -- ‚Ä¢ H∆∞·ªõng: -- ‚Ä¢ Tin c·∫≠y: --</p>
            <p class="meta" id="phaseNotePro">Nh·∫≠n ƒë·ªãnh: --</p>

            <div class="divider"></div>

            <div style="font-weight:900; letter-spacing:.2px; margin-bottom:8px;">TOP + % (THAM KH·∫¢O)</div>
            <div class="chips" id="topChips"></div>

            <div class="divider"></div>

            <div style="font-weight:900; letter-spacing:.2px; margin-bottom:8px;">GI·∫¢I TH√çCH S·ªê CH·ªêT</div>
            <div class="monoBox" id="explainBox">--</div>

            <div class="divider"></div>

            <div class="meta" id="noteLinePro">‚úÖ MODE: HIT@3&gt;=2 ‚Ä¢ trust --% ‚Ä¢ noise --% ‚Ä¢ BUILD --</div>

            <details open>
              <summary>
                <span>‚ñº FULL PRO (GOD MODE ‚Ä¢ MASTER+++)</span>
                <span style="color:rgba(168,183,214,.8); font-weight:800;">(m·ªü/ƒë√≥ng)</span>
              </summary>
              <div class="detailBody">
                <div class="monoBox" id="fullProText2">Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m RUN ho·∫∑c DEMO.</div>
              </div>
            </details>
          </div>
        </div>

        <div class="footer">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   ULTRA MASTER v3 ‚Ä¢ 1-file
   - Upload nhi·ªÅu ·∫£nh + Camera (A+B)
   - Gate format + Parse input
   - Scoring m√¥ ph·ªèng (hot/gan/truc/pas/g7)
   - Output SIMPLE/PRO + FULL PRO text
   ========================= */

const $ = (id)=>document.getElementById(id);

const state = {
  files: [],
  batchOK: 0,
  batchFail: 0,
  build: "A-FULL-2026-02-02-02",
  mode: "HIT@3>=2",
};

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display="none", 2400);
}

function setGate(status, tone){
  const el = $("stGate");
  el.className = "chip " + (tone || "warn");
  el.innerHTML = `<span class="dot ${tone==='good'?'':tone==='bad'?'bad':'warn'}"></span> Gate: <strong>${status}</strong>`;
}

function setOCR(status, tone){
  const el = $("stOCR");
  el.className = "chip " + (tone || "good");
  el.innerHTML = `<span class="dot ${tone==='good'?'':tone==='bad'?'bad':'warn'}"></span> OCR: <strong>${status}</strong>`;
}

function setBatch(){
  $("stBatch").innerHTML = `<span class="dot"></span> Batch: <strong>${state.batchOK}</strong> | FAIL: <strong>${state.batchFail}</strong>`;
}

function updateLineCount(){
  const lines = $("taInput").value.trim() ? $("taInput").value.trim().split(/\n+/).length : 0;
  $("lineCount").textContent = `${lines} d√≤ng`;
}

$("taInput").addEventListener("input", updateLineCount);
updateLineCount();

/* -------------------------
   Upload / Camera (A+B)
-------------------------- */
$("btnPickFiles").addEventListener("click", ()=>{
  $("fileInput").click();
});
$("btnCamera").addEventListener("click", ()=>{
  $("camInput").click();
});

$("fileInput").addEventListener("change", (e)=>{
  handleFiles(Array.from(e.target.files || []), "upload");
  e.target.value = "";
});
$("camInput").addEventListener("change", (e)=>{
  handleFiles(Array.from(e.target.files || []), "camera");
  e.target.value = "";
});

function handleFiles(files, src){
  if(!files.length){
    toast("Ch∆∞a ch·ªçn ·∫£nh.");
    return;
  }
  // Add
  state.files.push(...files);
  // Update pseudo OCR progress
  setOCR("batch queued", "warn");
  renderFileList(src);
  // m√¥ ph·ªèng x·ª≠ l√Ω batch
  fakeBatchOCR(files);
}

function renderFileList(src){
  const list = state.files;
  if(!list.length){
    $("fileList").innerHTML = `<div><b>Ch∆∞a ch·ªçn ·∫£nh.</b> (B·∫°n v·∫´n c√≥ th·ªÉ d√πng ‚ÄúD·ªØ li·ªáu ƒë·∫ßu v√†o‚Äù ƒë·ªÉ test.)</div>`;
    return;
  }
  const last = list.slice(-8).map(f=>`‚Ä¢ ${escapeHtml(f.name)} (${Math.round(f.size/1024)}KB)`).join("<br/>");
  $("fileList").innerHTML = `
    <div><b>ƒê√£ ch·ªçn:</b> ${list.length} ·∫£nh ‚Ä¢ ngu·ªìn: <b>${src}</b></div>
    <div class="mini" style="margin-top:6px;">${last}${list.length>8?`<br/>‚Ä¶ (+${list.length-8} ·∫£nh)`:""}</div>
  `;
}

function fakeBatchOCR(files){
  // m√¥ ph·ªèng: 85% OK
  setTimeout(()=>{
    const ok = Math.max(1, Math.round(files.length * 0.85));
    const fail = files.length - ok;
    state.batchOK += ok;
    state.batchFail += Math.max(0, fail);
    setBatch();

    // Gate PASS n·∫øu c√≥ d·ªØ li·ªáu text s·∫µn (v√¨ OCR th·∫≠t ch∆∞a nh√∫ng)
    // => ·ªû ƒë√¢y ch·ªâ b√°o "OCR batch done", c√≤n gate d·ª±a v√†o parse input
    setOCR("batch done", "good");
    toast("OCR: batch done (m√¥ ph·ªèng). Gate ph·ª• thu·ªôc d·ªØ li·ªáu ƒë·∫ßu v√†o.");
  }, 550);
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* -------------------------
   Tabs
-------------------------- */
$("tabSimple").addEventListener("click", ()=>{
  $("tabSimple").classList.add("active");
  $("tabPro").classList.remove("active");
  $("viewSimple").style.display = "";
  $("viewPro").style.display = "none";
  $("tabHint").textContent = "SIMPLE: Ch·ªët + c·∫£nh b√°o + l√Ω do (d·ªÖ nh√¨n)";
});
$("tabPro").addEventListener("click", ()=>{
  $("tabPro").classList.add("active");
  $("tabSimple").classList.remove("active");
  $("viewPro").style.display = "";
  $("viewSimple").style.display = "none";
  $("tabHint").textContent = "PRO: Th√™m Top + % + m·ªü FULL PRO chi ti·∫øt";
});

/* -------------------------
   DEMO / CLEAR
-------------------------- */
$("btnDemo").addEventListener("click", ()=>{
  const demo =
`DB 54 | G7: 77 51 67 47 | G6: 813 258 481
DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 14 | G7: 81 87 60 32 | G6: 206 200 971
DB 21 | G7: 76 47 21 77 | G6: 801 295 993
DB 22 | G7: 21 00 14 71 | G6: 497 368 374
DB 17 | G7: 71 15 99 52 | G6: 945 187 978
DB 27 | G7: 82 24 25 16 | G6: 508 652 762
DB 94 | G7: 31 34 20 42 | G6: 301 697 335`;
  $("taInput").value = demo;
  updateLineCount();
  toast("ƒê√£ d√°n DEMO test.");
  setGate("WAIT", "warn");
});

$("btnClear").addEventListener("click", ()=>{
  $("taInput").value = "";
  updateLineCount();
  state.files = [];
  state.batchOK = 0;
  state.batchFail = 0;
  renderFileList("‚Äî");
  setBatch();
  setOCR("ready", "good");
  setGate("WAIT", "warn");
  resetOutput();
  toast("ƒê√£ CLEAR.");
});

$("btnWipeInput").addEventListener("click", ()=>{
  $("taInput").value = "";
  updateLineCount();
  toast("ƒê√£ x√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o.");
});

$("btnPasteSample").addEventListener("click", ()=>{
  if($("taInput").value.trim()){
    toast("ƒêang c√≥ d·ªØ li·ªáu r·ªìi (kh√¥ng ghi ƒë√®). Mu·ªën d√°n DEMO th√¨ b·∫•m DEMO.");
    return;
  }
  $("btnDemo").click();
});

/* -------------------------
   RUN
-------------------------- */
$("btnRun").addEventListener("click", ()=>{
  const raw = $("taInput").value.trim();
  if(!raw){
    toast("Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m DEMO ho·∫∑c d√°n d·ªØ li·ªáu v√†o.");
    setGate("FAIL", "bad");
    return;
  }

  const strict = $("togStrictGate").checked;
  const parsed = parseLines(raw, strict);

  if(parsed.bad.length){
    setGate("FAIL", "bad");
    setOCR("needs manual fix", "warn");
    toast(`Gate FAIL: ${parsed.bad.length} d√≤ng sai format. S·ª≠a r·ªìi RUN l·∫°i.`);
    // v·∫´n show l·ªói ƒë·ªÉ s·ª≠a nhanh
    $("fullProText").textContent = "GATE FAIL (d√≤ng sai format):\n" + parsed.bad.join("\n");
    $("fullProText2").textContent = $("fullProText").textContent;
    return;
  }

  setGate("PASS", "good");

  // Settings
  const cfg = {
    window: clamp(+$("inWindow").value, 3, 60),
    topN: clamp(+$("inTopN").value, 5, 30),
    supervisor: $("selSupervisor").value,
    trucMin: clamp(+$("inTrucMin").value, 2, 12),
    kPhase: clamp(+$("inKPhase").value, 3, 15),
    wHot: +$("wHot").value || 2,
    wGan: +$("wGan").value || 1.5,
    wPas: +$("wPas").value || 2,
    wTruc: +$("wTruc").value || 2.4,
    wG7: +$("wG7").value || 0.9,
    noScale: $("togNoScale").checked,
    autoCrop: $("togAutoCrop").checked,
    strictGate: strict,
  };

  const res = analyze(parsed.good, cfg);
  renderResult(res, cfg);
  toast("RUN xong ‚úÖ (m√¥ ph·ªèng ph√¢n t√≠ch).");
});

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

/* -------------------------
   Parse input lines
-------------------------- */
function parseLines(raw, strictGate=true){
  const lines = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const good = [];
  const bad = [];

  const re = /^DB\s+(\d{1,2})\s*\|\s*G7\s*:\s*(\d{2})\s+(\d{2})\s+(\d{2})\s+(\d{2})\s*\|\s*G6\s*:\s*(\d{3})\s+(\d{3})\s+(\d{3})$/i;

  for(const ln of lines){
    const m = ln.match(re);
    if(!m){
      if(strictGate) bad.push(ln);
      else {
        // c·ªë g·∫Øng l·ªèng: l·∫•y s·ªë theo pattern
        const nums = ln.match(/\d+/g) || [];
        // k·ª≥ v·ªçng: DB(1) + G7(4) + G6(3) = 8 c·ª•m
        if(nums.length >= 8){
          const db = pad2(nums[0]);
          const g7 = nums.slice(1,5).map(pad2);
          const g6 = nums.slice(5,8).map(pad3);
          good.push({ db, g7, g6, raw: ln });
        } else bad.push(ln);
      }
      continue;
    }
    const db = pad2(m[1]);
    const g7 = [m[2],m[3],m[4],m[5]].map(pad2);
    const g6 = [m[6],m[7],m[8]].map(pad3);
    good.push({ db, g7, g6, raw: ln });
  }
  return { good, bad, lines };
}
function pad2(x){ x = String(x); return x.length===1 ? "0"+x : x.slice(-2); }
function pad3(x){ x = String(x); return x.padStart(3,"0").slice(-3); }

/* -------------------------
   Core analysis (m√¥ ph·ªèng)
   - hot: t·∫ßn su·∫•t xu·∫•t hi·ªán (G7 ∆∞u ti√™n)
   - gan: ng√†y kh√¥ng xu·∫•t hi·ªán
   - truc: "tr·ª•c n·ªïi" theo c·∫∑p ƒë·∫ßu/ƒëu√¥i (ab)
   - pascal: seed m√¥ ph·ªèng (kh√¥ng ph·∫£i pascal th·∫≠t)
-------------------------- */
function analyze(days, cfg){
  const newestFirst = days; // input newest ·ªü tr√™n
  const N = Math.min(cfg.window, newestFirst.length);
  const slice = newestFirst.slice(0, N);

  // Collect loto 2 s·ªë t·ª´: DB(2 s·ªë), G7(4), G6 last2 (3 s·ªë)
  const pool = [];
  slice.forEach((d, idx)=>{
    pool.push({num: d.db, src:"DB", day: idx});
    d.g7.forEach(n=>pool.push({num:n, src:"G7", day: idx}));
    d.g6.forEach(x=>{
      const last2 = pad2(String(x).slice(-2));
      pool.push({num:last2, src:"G6", day: idx});
    });
  });

  // Frequency (hot)
  const freq = new Map();
  const freqG7 = new Map();
  for(const p of pool){
    freq.set(p.num, (freq.get(p.num)||0) + 1);
    if(p.src==="G7") freqG7.set(p.num, (freqG7.get(p.num)||0) + 1);
  }

  // Gan (last seen)
  const lastSeen = new Map();
  for(const p of pool){
    if(!lastSeen.has(p.num)) lastSeen.set(p.num, p.day); // first encounter is newest => day index
  }
  const ganDays = (n)=> lastSeen.has(n) ? lastSeen.get(n) : 999;

  // Tr·ª•c n·ªïi (m√¥ ph·ªèng): ƒë·∫øm theo "ƒë·∫ßu+ƒëu√¥i" bucket
  // v√≠ d·ª• num=74 => head=7 tail=4 => key "7-4"
  const trucCount = new Map();
  for(const p of pool){
    const head = p.num[0], tail = p.num[1];
    const key = head+"-"+tail;
    trucCount.set(key, (trucCount.get(key)||0) + 1);
  }
  // tr·ª•c n·ªïi: key c√≥ count >= trucMin
  const trucKeys = [...trucCount.entries()].filter(([k,c])=>c>=cfg.trucMin).sort((a,b)=>b[1]-a[1]);

  // Pascal seed (m√¥ ph·ªèng): l·∫•y c√°c s·ªë xu·∫•t hi·ªán ·ªü DB v√† G7 newest 2 ng√†y ‚Üí unique
  const seedSet = new Set();
  slice.slice(0, Math.min(2, slice.length)).forEach(d=>{
    seedSet.add(d.db);
    d.g7.forEach(n=>seedSet.add(n));
  });
  const pasSeed = [...seedSet].slice(0, 12);

  // Candidate scoring 00-99
  const cand = [];
  for(let i=0;i<100;i++){
    const num = String(i).padStart(2,"0");
    const hot = freq.get(num)||0;
    const g7lead = freqG7.get(num)||0;
    const gan = ganDays(num); // 0 means seen newest day
    // map gan to score: gan v·ª´a/ƒë·ªß t·ªët, qu√° l√¢u coi nh∆∞ nhi·ªÖu -> d√πng curve
    const ganScore = gan===999 ? 0 : Math.max(0, 10 - Math.abs(gan - 3)); // peak around 3
    // tr·ª•c score: d·ª±a theo bucket head-tail count
    const tk = num[0]+"-"+num[1];
    const tcnt = trucCount.get(tk)||0;

    // pas score: n·∫øu num n·∫±m trong seed
    const pas = seedSet.has(num) ? 1 : 0;

    const score =
      cfg.wHot*hot +
      cfg.wG7*g7lead +
      cfg.wGan*ganScore +
      cfg.wTruc*tcnt +
      cfg.wPas*pas;

    cand.push({num, score, hot, gan, ganScore, tcnt, g7lead, pas});
  }
  cand.sort((a,b)=>b.score-a.score);

  const topN = cand.slice(0, cfg.topN);
  const top10 = cand.slice(0, 10);

  // Pick 3: ∆∞u ti√™n HIT@3>=2 (m√¥ ph·ªèng): ch·ªçn 3 s·ªë sao cho "hot>=3 ho·∫∑c g7lead>=1" (t∆∞∆°ng ƒë·ªëi)
  const pick = [];
  for(const c of cand){
    const hit = (c.hot>=3?1:0) + (c.g7lead>=1?1:0) + (c.tcnt>=cfg.trucMin?1:0);
    if(hit>=2){
      pick.push(c.num);
      if(pick.length===3) break;
    }
  }
  if(pick.length<3){
    // fallback top score
    pick.length=0;
    top10.slice(0,3).forEach(x=>pick.push(x.num));
  }

  const main = pick[0], sub = pick[1], add = pick[2];

  // Phase (m√¥ ph·ªèng MASTER+++): d·ª±a t·ªâ l·ªá "tr·ª•c n·ªïi"
  const phase = inferPhase(trucKeys, cfg);
  // trust/noise m√¥ ph·ªèng
  const trust = clamp(Math.round(60 + Math.min(35, trucKeys.length*6 + (cfg.supervisor==="on"?8:0))), 55, 92);
  const noise = clamp(100 - trust + Math.round(Math.random()*8), 15, 65);

  // Warnings: c·ª•m/hot d√†y => d·ªÖ l·ªách
  const warn = [];
  const hotDense = top10.filter(x=>x.hot>=4).length>=4;
  if(hotDense) warn.push("‚ö†Ô∏è B·∫™Y C·ª§M/HOT: hot d√†y ‚Üí d·ªÖ l·ªách, tr√°nh all-in theo c·ª•m.");
  else warn.push("‚úÖ OK: ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).");
  warn.push("‚úÖ OK: ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).");
  warn.push("‚úÖ OK: ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).");

  // Full Pro text (gi·ªëng style ·∫£nh)
  const weightsLine = `WEIGHTS (UI ‚Äî ƒë·ªÉ tham kh·∫£o/soi full):\nwHot=${cfg.wHot} | wGan=${cfg.wGan} | wPas=${cfg.wPas} | wTruc=${cfg.wTruc} | wG7=${cfg.wG7}`;
  const topLine = top10.map(x=>{
    const pct = Math.round((x.score / top10[0].score)*100);
    return `${x.num}(${pct}%)`;
  });
  const topLineFmt = chunkJoin(topLine, 6).join("  ");

  const hot15 = cand.filter(x=>x.hot>0).slice(0, 15);
  const hot15Fmt = hot15.map(x=>`${x.num}‚Üí${x.hot}`).join("  ");

  const gan15 = cand.slice().sort((a,b)=>b.ganScore-a.ganScore).slice(0,15);
  const gan15Fmt = gan15.map(x=>`${x.num}‚Üí${x.gan===999?"‚àû":x.gan}`).join("  ");

  const headTail = summarizeHeadTail(pool);
  const trucNoi = trucKeys.slice(0, 30).map(([k,c])=>{
    // convert "7-4" => examples 74 style bucket: show head+tail only
    const parts = k.split("-");
    return `${parts[0]}${parts[1]}`;
  });

  const g7LeadSet = [...freqG7.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 18).map(([n])=>n);

  const full =
`===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++ ‚Ä¢ ${state.mode}) =====
BUILD: ${state.build}
T·ªïng ng√†y d√πng: ${N}

AI ƒê·ªåC PHA:
Pha: ${phase.pha} | H∆∞·ªõng: ${phase.huong} | Tin c·∫≠y: ${trust}%
Nh·∫≠n ƒë·ªãnh: ${phase.note}

TOP 10 (tham kh·∫£o) + %:
${topLineFmt}

CH·ªêT (3 s·ªë, ∆∞u ti√™n HIT@3>=2):
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•:  ${sub}
‚ûï K√®m:  ${add}

3 C·∫¢NH B√ÅO M·∫†NH:
1) ${warn[0]}
2) ${warn[1]}
3) ${warn[2]}

NOTE:
‚úÖ MODE: ${state.mode} ‚Ä¢ trust ${trust}% ‚Ä¢ noise ${noise}% ‚Ä¢ BUILD ${state.build}

GI·∫¢I TH√çCH (Top 3):
1) ${explainOne(cand, main, cfg)}
2) ${explainOne(cand, sub, cfg)}
3) ${explainOne(cand, add, cfg)}

${weightsLine}

* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.

===== AI ƒê·ªåC PHA (MASTER+++) =====
Pha: ${phase.pha} | H∆∞·ªõng: ${phase.huong} | Tin c·∫≠y: ${trust}%
Nh·∫≠n ƒë·ªãnh: ${phase.note}

===== SOI FULL LOTO 2 S·ªê (FULL PRO) =====
[1] HOT (15): ${hot15Fmt}
[2] GAN (15): ${gan15Fmt}
[3] ƒê·∫¶U/ƒêU√îI Top5 (K=${cfg.kPhase}):  ƒê·∫ßu: ${headTail.headTop}  |  ƒêu√¥i: ${headTail.tailTop}
[4] TR·ª§C n·ªïi: ${trucNoi.join(" ")}
[5] G7 lead set (k√®+b√≥ng): ${g7LeadSet.join(" ")}
[6] PASCAL seed: ${pasSeed.join(" ")}
[7] C·ª§M x√°c nh·∫≠n (kh√¥ng √©p): ${top10.slice(0,4).map(x=>x.num).join(" ")}
[8] GI·∫¢I TH√çCH TOP (A=CORE, B=BACKUP):
${formatTopExplain(top10, cfg)}
`;

  // Explain short for PRO box
  const explainShort =
`‚Ä¢ 1) ${explainOne(cand, main, cfg)}
‚Ä¢ 2) ${explainOne(cand, sub, cfg)}
‚Ä¢ 3) ${explainOne(cand, add, cfg)}`;

  return {
    N, cfg,
    phase, trust, noise,
    main, sub, add,
    top10, topN,
    warn,
    fullText: full,
    explainShort,
  };
}

function inferPhase(trucKeys, cfg){
  // m√¥ ph·ªèng 4 pha: m·ªü ‚Äì ch·∫°y ‚Äì ƒë·∫£o ‚Äì x·∫£
  // logic: nhi·ªÅu tr·ª•c n·ªïi => m·ªü/ch·∫°y; √≠t tr·ª•c n·ªïi => ƒë·∫£o/x·∫£
  const k = trucKeys.length;
  if(k >= 10) return { pha:"P6", huong:"TRUC_MO", note:"M·ªü TR·ª§C ‚Äî gan v·ª´a/ƒë·ªß, tr·ª•c ƒëang n·ªï. ∆Øu ti√™n TR·ª§C + x√°c nh·∫≠n gan." };
  if(k >= 6)  return { pha:"P2", huong:"TRUC_GAN", note:"TR·ª§C + GAN lead ‚Äî ∆∞u ti√™n tr·ª•c n·ªïi, tr√°nh b√°m c·ª•m G6/G7 thu·∫ßn." };
  if(k >= 3)  return { pha:"P4", huong:"DAO", note:"Pha ƒë·∫£o ‚Äî tr√°nh all-in 1 c·ª•m, ∆∞u ti√™n ch·ªëng b·∫´y/ƒë·∫£o k·ªÅ." };
  return        { pha:"P1", huong:"XA", note:"Pha x·∫£/lo√£ng ‚Äî c√¢n nh·∫Øc d·ª´ng ho·∫∑c d√πng PA B (10 gi·∫£ thi·∫øt) n·∫øu v·∫´n v√†o." };
}

function chunkJoin(arr, n){
  const out=[];
  for(let i=0;i<arr.length;i+=n){
    out.push(arr.slice(i,i+n).join("  "));
  }
  return out;
}

function summarizeHeadTail(pool){
  const head = new Map();
  const tail = new Map();
  for(const p of pool){
    head.set(p.num[0], (head.get(p.num[0])||0)+1);
    tail.set(p.num[1], (tail.get(p.num[1])||0)+1);
  }
  const headTop = [...head.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([d,c])=>`${d}(${c})`).join(" ");
  const tailTop = [...tail.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([d,c])=>`${d}(${c})`).join(" ");
  return { headTop, tailTop };
}

function explainOne(cand, num, cfg){
  const c = cand.find(x=>x.num===num);
  if(!c) return `${num} | (no data)`;
  // flags
  const trucY = (c.tcnt>=cfg.trucMin) ? "Y" : "-";
  const g7Y = (c.g7lead>=1) ? "Y" : "-";
  const pasY = (c.pas===1) ? "Y" : "-";
  const cumY = (c.hot>=3) ? "Y" : "-";
  const dauY = (c.hot>=2) ? "Y" : "-";
  const duoiY = (c.hot>=2) ? "Y" : "-";
  const ganView = (c.gan===999) ? "‚àû" : String(c.gan);
  // score display
  const score = (Math.round(c.score*100)/100).toFixed(2);
  return `${num} | score ${score} | hot:${c.hot} | gan:${ganView} | truc:${trucY} | g7:${g7Y} | pas:${pasY} | cum:${cumY} | dau:${dauY} | duoi:${duoiY}`;
}

function formatTopExplain(top10, cfg){
  // In style like A71 ... from screenshot (A/B bucket)
  // We'll label A for top6, B for rest
  return top10.slice(0, 10).map((x, i)=>{
    const tag = i<6 ? "A" : "B";
    const ganView = (x.gan===999) ? "‚àû" : String(x.gan);
    const trucY = (x.tcnt>=cfg.trucMin) ? "Y" : "-";
    const g7Y = (x.g7lead>=1) ? "Y" : "-";
    const pasY = (x.pas===1) ? "Y" : "-";
    const cumY = (x.hot>=3) ? "Y" : "-";
    const dauY = (x.hot>=2) ? "Y" : "-";
    const duoiY = (x.hot>=2) ? "Y" : "-";
    const score = (Math.round(x.score*100)/100).toFixed(2);
    return `${i+1}) ${tag}${x.num} | score ${score} | hot:${x.hot} | gan:${ganView} | truc:${trucY} | g7:${g7Y} | pas:${pasY} | cum:${cumY} | dau:${dauY} | duoi:${duoiY}`;
  }).join("\n");
}

/* -------------------------
   Render result
-------------------------- */
function resetOutput(){
  ["pick3","pick3Pro"].forEach(id=>$(id).textContent="-- / -- / --");
  ["pickMain","pickSub","pickAdd"].forEach(id=>$(id).textContent="--");
  ["phaseLine","phaseLinePro"].forEach(id=>$(id).textContent="Pha: -- ‚Ä¢ H∆∞·ªõng: -- ‚Ä¢ Tin c·∫≠y: --");
  ["phaseNote","phaseNotePro"].forEach(id=>$(id).textContent="Nh·∫≠n ƒë·ªãnh: --");
  ["fullProText","fullProText2"].forEach(id=>$(id).textContent="Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m RUN ho·∫∑c DEMO.");
  $("topChips").innerHTML = "";
  $("explainBox").textContent = "--";
  $("noteLine").textContent = "‚úÖ MODE: HIT@3>=2 ‚Ä¢ trust --% ‚Ä¢ noise --% ‚Ä¢ BUILD --";
  $("noteLinePro").textContent = $("noteLine").textContent;
}

function renderResult(res, cfg){
  const pickText = `${res.main} / ${res.sub} / ${res.add}`;
  $("pick3").textContent = pickText;
  $("pick3Pro").textContent = pickText;
  $("pickMain").textContent = res.main;
  $("pickSub").textContent = res.sub;
  $("pickAdd").textContent = res.add;

  const ph = `Pha: ${res.phase.pha} ‚Ä¢ H∆∞·ªõng: ${res.phase.huong} ‚Ä¢ Tin c·∫≠y: ${res.trust}%`;
  $("phaseLine").textContent = ph;
  $("phaseLinePro").textContent = ph;
  $("phaseNote").textContent = `Nh·∫≠n ƒë·ªãnh: ${res.phase.note}`;
  $("phaseNotePro").textContent = `Nh·∫≠n ƒë·ªãnh: ${res.phase.note}`;

  // warnings
  const warnEl = $("warns");
  warnEl.innerHTML = res.warn.map(w=>{
    if(w.startsWith("‚ö†Ô∏è")) return `<li><b>${escapeHtml(w.slice(0,2))}</b> ${escapeHtml(w.slice(2).trim())}</li>`;
    return `<li><b>OK:</b> ${escapeHtml(w.replace("‚úÖ OK:", "").trim())}</li>`;
  }).join("");

  const note = `‚úÖ MODE: ${state.mode} ‚Ä¢ trust ${res.trust}% ‚Ä¢ noise ${res.noise}% ‚Ä¢ BUILD ${state.build}`;
  $("noteLine").textContent = note;
  $("noteLinePro").textContent = note;

  $("fullProText").textContent = res.fullText;
  $("fullProText2").textContent = res.fullText;

  // Top chips in PRO
  const top = res.top10.map((x, idx)=>{
    const pct = Math.round((x.score / res.top10[0].score)*100);
    return { num:x.num, pct };
  });
  $("topChips").innerHTML = top.map(t=>(
    `<span class="chip" style="background:rgba(255,255,255,.06); color:var(--text);">
      <strong style="color:var(--text)">${t.num}(${t.pct}%)</strong>
    </span>`
  )).join("");

  $("explainBox").textContent = res.explainShort;
}

/* init */
resetOutput();
setBatch();
setGate("WAIT","warn");
setOCR("ready","good");
</script>
</body>
</html>
