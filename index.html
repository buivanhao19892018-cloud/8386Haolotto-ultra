<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (Web OCR Gate)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --card:#111b2e; --card2:#0f172a; --text:#e6edf7; --muted:#9db0d0;
      --blue:#2f6bff; --red:#ff3b3b; --green:#35d07f; --amber:#ffb020;
      --border:rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(180deg,#071022,#0b1220 20%,#070e19); color:var(--text);}
    .wrap{max-width:980px; margin:0 auto; padding:16px 14px 40px;}
    .title{font-size:22px; font-weight:800; letter-spacing:.2px; margin:10px 0 6px;}
    .sub{color:var(--muted); line-height:1.35; margin:0 0 14px;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin:12px 0;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .chip{padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--muted); font-size:13px;}
    .chip.ok{color:#d8ffe9; border-color:rgba(53,208,127,.35); background:rgba(53,208,127,.08);}
    .chip.bad{color:#ffe2e2; border-color:rgba(255,59,59,.35); background:rgba(255,59,59,.08);}
    .chip.warn{color:#fff3db; border-color:rgba(255,176,32,.35); background:rgba(255,176,32,.08);}
    .btn{
      border:0; padding:12px 14px; border-radius:14px; font-weight:700;
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      border:1px solid var(--border);
    }
    .btn.blue{background:linear-gradient(180deg,rgba(47,107,255,.95),rgba(47,107,255,.72)); border-color:rgba(47,107,255,.35);}
    .btn.red{background:linear-gradient(180deg,rgba(255,59,59,.95),rgba(255,59,59,.72)); border-color:rgba(255,59,59,.35);}
    .btn.gray{background:rgba(255,255,255,.06);}
    .btn:active{transform:translateY(1px)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px;}
    @media(min-width:900px){.grid{grid-template-columns:1.15fr .85fr;}}
    .label{color:var(--muted); font-size:13px; margin:6px 0;}
    .box{
      width:100%; min-height:110px; padding:12px; border-radius:14px;
      border:1px solid var(--border); background:rgba(0,0,0,.20); color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; line-height:1.35;
      outline:none;
    }
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .k{padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.03);}
    .k .t{color:var(--muted); font-size:12px;}
    .k .v{font-size:18px; font-weight:800; margin-top:2px;}
    .preview{width:100%; border-radius:14px; border:1px solid var(--border); background:#050a12; overflow:hidden;}
    .preview img{width:100%; display:block;}
    .small{font-size:12px; color:var(--muted); line-height:1.35;}
    .hr{height:1px; background:var(--border); margin:12px 0;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .foot{color:var(--muted); font-size:12px; margin-top:10px;}
    .danger{color:#ffd5d5;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">B√πi H√†o ‚Äî Lotto ULTRA MASTER (Web OCR Gate)</div>
      <p class="sub">
        Lu·ªìng chu·∫©n: <b>Upload ·∫£nh</b> ‚Üí <b>OCR (Tesseract)</b> ‚Üí <b>Parse DB/G6/G7</b> ‚Üí <b>Gate c·ª©ng</b> ‚Üí ƒë·ªï d·ªØ li·ªáu s·∫°ch ‚Üí <b>Ch·∫°y FULL</b>.
        <br/>M·∫πo: ·∫£nh ch·ª•p n√™n th·∫•y t·ª´ <b>ƒêB t·ªõi h√†ng ‚Äú7‚Äù</b>, tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) & header qu·∫£ng c√°o.
      </p>

      <div class="row" style="margin-bottom:8px">
        <span id="chipTess" class="chip warn">Tesseract: loading‚Ä¶</span>
        <span id="chipBatch" class="chip">Batch: 0 ·∫£nh</span>
        <span id="chipGate" class="chip">Gate: ‚Äî</span>
      </div>

      <!-- INPUT FILE: ƒë·ªÉ ch·∫Øc tr√™n mobile, KH√îNG hide display:none (m·ªôt s·ªë m√°y k√©n) -->
      <input id="fileInput" type="file" accept="image/*" multiple style="opacity:0; position:absolute; left:-9999px; width:1px; height:1px;" />

      <div class="row">
        <button id="btnUpload" class="btn blue">üì∏ Upload nhi·ªÅu ·∫£nh</button>
        <button id="btnClear" class="btn red">X√≥a</button>
        <button id="btnRunFull" class="btn gray">üöÄ Ch·∫°y FULL</button>
      </div>

      <div class="small" style="margin-top:10px">
        N·∫øu b·∫•m Upload m√† kh√¥ng m·ªü ch·ªçn ·∫£nh: h√£y th·ª≠ <b>Chrome</b> (kh√¥ng d√πng tr√¨nh duy·ªát l·∫°), v√† ƒë·∫£m b·∫£o trang ƒëang l√† <b>https</b> (GitHub Pages).
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="title" style="font-size:18px">·∫¢nh ‚Üí OCR ‚Üí Gate</div>
        <div class="small">
          Parse ‚Äúc·ª©ng‚Äù:
          <ul style="margin:8px 0 0 18px; color:var(--muted)">
            <li><b>ƒêB</b>: t√¨m nh√£n <b>ƒêB/DB</b> + l·∫•y <b>ƒë√∫ng 5 s·ªë</b> g·∫ßn nh·∫•t.</li>
            <li><b>G7</b>: t√¨m d√≤ng b·∫Øt ƒë·∫ßu <b>7</b> + l·∫•y <b>4 s·ªë 2 ch·ªØ s·ªë</b>.</li>
            <li><b>G6</b>: t√¨m d√≤ng b·∫Øt ƒë·∫ßu <b>6</b> + l·∫•y <b>3 s·ªë 3 ch·ªØ s·ªë</b>.</li>
            <li>Gate pass khi ƒë·ªß: <b>DB=2 s·ªë</b>, <b>G6=3 s·ªë</b>, <b>G7=4 s·ªë</b>.</li>
          </ul>
        </div>

        <div class="hr"></div>

        <div class="kpi">
          <div class="k"><div class="t">DB (2 s·ªë)</div><div id="kDB" class="v">‚Äî</div></div>
          <div class="k"><div class="t">G6 (3 s·ªë)</div><div id="kG6" class="v" style="font-size:15px">‚Äî</div></div>
          <div class="k"><div class="t">G7 (4 s·ªë)</div><div id="kG7" class="v" style="font-size:15px">‚Äî</div></div>
          <div class="k"><div class="t">Tr·∫°ng th√°i</div><div id="kStatus" class="v">‚Äî</div></div>
        </div>

        <div class="hr"></div>

        <div class="label">Preview ·∫£nh g·∫ßn nh·∫•t</div>
        <div class="preview">
          <img id="previewImg" alt="preview" style="display:none" />
          <div id="previewEmpty" class="small" style="padding:12px">Ch∆∞a c√≥ ·∫£nh</div>
        </div>

        <div class="hr"></div>

        <div class="label">S·ª≠a tay (ch·ªâ khi Gate fail)</div>
        <div class="row">
          <input id="mDB" class="btn" style="flex:1; text-align:left; background:rgba(0,0,0,.20)" placeholder="DB (2 s·ªë) VD: 45" />
          <input id="mG6" class="btn" style="flex:2; text-align:left; background:rgba(0,0,0,.20)" placeholder="G6 (3 s·ªë) VD: 392 255 854" />
          <input id="mG7" class="btn" style="flex:2; text-align:left; background:rgba(0,0,0,.20)" placeholder="G7 (4 s·ªë) VD: 03 82 85 81" />
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnApplyManual" class="btn">√Åp manual ‚Üí th√™m d√≤ng</button>
        </div>

        <div class="hr"></div>

        <div class="label">Debug OCR (r√∫t g·ªçn)</div>
        <textarea id="dbg" class="box" placeholder="OCR log s·∫Ω hi·ªán ·ªü ƒë√¢y‚Ä¶" readonly></textarea>
      </div>

      <div class="card">
        <div class="title" style="font-size:18px">D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</div>
        <div class="small">Format chu·∫©n auto: <span class="mono">DB xx | G7: a b c d | G6: xxx yyy zzz</span></div>
        <textarea id="data" class="box" placeholder="Sau batch scan, tool t·ª± ƒë·ªï v√†o ƒë√¢y‚Ä¶"></textarea>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1">
            <div class="label">C·ª≠a s·ªï ng√†y (N)</div>
            <input id="winN" class="btn" style="width:100%; text-align:left; background:rgba(0,0,0,.20)" value="30" />
          </div>
          <div style="flex:1">
            <div class="label">Top hi·ªÉn th·ªã</div>
            <input id="topK" class="btn" style="width:100%; text-align:left; background:rgba(0,0,0,.20)" value="15" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <div class="label">Tr·ªçng s·ªë Hot</div>
            <input id="wHot" class="btn" style="width:100%; text-align:left; background:rgba(0,0,0,.20)" value="2" />
          </div>
          <div style="flex:1">
            <div class="label">Tr·ªçng s·ªë Gan</div>
            <input id="wGan" class="btn" style="width:100%; text-align:left; background:rgba(0,0,0,.20)" value="1.5" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="title" style="font-size:18px">K·∫øt qu·∫£ FULL</div>
        <div id="out" class="box" style="min-height:240px">Ch∆∞a ch·∫°y.</div>

        <div class="foot">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script>
    // ====== STATE ======
    const st = {
      worker: null,
      ready: false,
      files: [],
      lastOCRText: "",
      lastParse: null,
    };

    // ====== UI ======
    const $ = (id)=>document.getElementById(id);
    const chipTess = $("chipTess");
    const chipBatch = $("chipBatch");
    const chipGate = $("chipGate");
    const previewImg = $("previewImg");
    const previewEmpty = $("previewEmpty");
    const dbg = $("dbg");
    const data = $("data");
    const out = $("out");

    const kDB = $("kDB"), kG6=$("kG6"), kG7=$("kG7"), kStatus=$("kStatus");

    const fileInput = $("fileInput");
    const btnUpload = $("btnUpload");
    const btnClear = $("btnClear");
    const btnRunFull = $("btnRunFull");

    const mDB = $("mDB"), mG6 = $("mG6"), mG7 = $("mG7");
    const btnApplyManual = $("btnApplyManual");

    // ====== INIT TESSERACT ======
    (async function init(){
      try{
        chipTess.className = "chip warn";
        chipTess.textContent = "Tesseract: loading‚Ä¶";
        st.worker = await Tesseract.createWorker({
          logger: (m)=>{
            // progress r√∫t g·ªçn
            if(m.status && typeof m.progress==="number"){
              chipTess.textContent = `Tesseract: ${m.status} ${(m.progress*100).toFixed(0)}%`;
            }
          }
        });
        await st.worker.loadLanguage("eng");
        await st.worker.initialize("eng");
        // c·∫•u h√¨nh ƒë·ªÉ OCR s·ªë t·ªët h∆°n
        await st.worker.setParameters({
          tessedit_char_whitelist: "0123456789ƒêDBdb ",
          preserve_interword_spaces: "1"
        });
        st.ready = true;
        chipTess.className = "chip ok";
        chipTess.textContent = "Tesseract: ready";
      }catch(e){
        st.ready = false;
        chipTess.className = "chip bad";
        chipTess.textContent = "Tesseract: FAIL";
        dbg.value = "L·ªói Tesseract: " + (e?.message || e);
      }
    })();

    // ====== HELPERS ======
    function setPreview(src){
      previewImg.src = src;
      previewImg.style.display = "block";
      previewEmpty.style.display = "none";
    }
    function resetPreview(){
      previewImg.style.display = "none";
      previewEmpty.style.display = "block";
      previewImg.src = "";
    }

    function clampInt(v, def){
      const n = parseInt(String(v||"").trim(),10);
      return Number.isFinite(n) ? n : def;
    }
    function clampFloat(v, def){
      const n = parseFloat(String(v||"").trim().replace(",","."));
      return Number.isFinite(n) ? n : def;
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    // normalize OCR: ch·ªâ ‚Äúƒë√°nh‚Äù m·∫°nh l√™n v√πng s·ªë
    function normalizeForNumbers(s){
      // thay c√°c k√Ω t·ª± d·ªÖ nh·∫ßm khi n·∫±m c·∫°nh s·ªë
      // B->8, O->0, I/l->1, S->5 (nh·∫π tay)
      return s
        .replace(/[Oo]/g,"0")
        .replace(/[Il]/g,"1")
        .replace(/S/g,"5")
        .replace(/B/g,"8");
    }

    // ====== PARSER ======
    function parseFromOCR(raw){
      const text = raw || "";
      const norm = normalizeForNumbers(text);

      // 1) DB_5DIG: ∆∞u ti√™n "ƒêB/DB + 5 s·ªë"
      let db5 = null;
      {
        const re = /(?:ƒêB|DB)\s*([0-9]{5})/g;
        let m, last=null;
        while((m=re.exec(norm))){ last=m[1]; }
        if(last) db5 = last;
      }

      // fallback: n·∫øu OCR m·∫•t ch·ªØ ƒêB/DB, ƒë√¥i khi v·∫´n c√≥ block [DB_5DIG] ho·∫∑c ƒë·ª©ng g·∫ßn ƒë·∫ßu
      if(!db5){
        // t√¨m m·ªçi 5 s·ªë, l·∫•y c√°i "h·ª£p l√Ω" nh·∫•t: xu·∫•t hi·ªán s·ªõm, nh∆∞ng kh√¥ng ph·∫£i nƒÉm (2026)
        const all = Array.from(norm.matchAll(/\b([0-9]{5})\b/g)).map(x=>x[1]);
        const filtered = all.filter(x => x !== "20260" && x !== "12012" && x !== "30012");
        if(filtered.length) db5 = filtered[0]; // l·∫•y c√°i ƒë·∫ßu ti√™n trong b·∫£ng
      }

      // 2) G7: d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng 7, l·∫•y 4 s·ªë 2 ch·ªØ s·ªë
      let g7 = null;
      {
        // c√≥ th·ªÉ OCR ra: "7 1 03 82 85 81" ho·∫∑c "7 03 82 85 81"
        const re = /^7\D*(?:\d\D+)?(\d{2})\D+(\d{2})\D+(\d{2})\D+(\d{2})/gm;
        let m, last=null;
        while((m=re.exec(norm))){
          last = [m[1],m[2],m[3],m[4]];
        }
        if(last) g7 = last;
      }

      // 3) G6: d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng 6, l·∫•y 3 s·ªë 3 ch·ªØ s·ªë
      let g6 = null;
      {
        const re = /^6\D*(\d{3})\D+(\d{3})\D+(\d{3})/gm;
        let m, last=null;
        while((m=re.exec(norm))){
          last = [m[1],m[2],m[3]];
        }
        if(last) g6 = last;
      }

      // db2 = 2 s·ªë cu·ªëi c·ªßa db5
      let db2 = null;
      if(db5 && /^\d{5}$/.test(db5)){
        db2 = db5.slice(-2);
      }

      // gate
      const gatePass = !!(db2 && /^\d{2}$/.test(db2) && g6 && g6.length===3 && g7 && g7.length===4);

      return { db5, db2, g6, g7, gatePass, normText:norm };
    }

    function updateGateUI(p){
      if(!p){
        kDB.textContent = "‚Äî";
        kG6.textContent = "‚Äî";
        kG7.textContent = "‚Äî";
        kStatus.textContent = "‚Äî";
        chipGate.textContent = "Gate: ‚Äî";
        chipGate.className = "chip";
        return;
      }
      kDB.textContent = p.db2 || "‚Äî";
      kG6.textContent = p.g6 ? p.g6.join(" ") : "‚Äî";
      kG7.textContent = p.g7 ? p.g7.join(" ") : "‚Äî";
      if(p.gatePass){
        kStatus.textContent = "PASS";
        chipGate.textContent = "Gate: PASS";
        chipGate.className = "chip ok";
      }else{
        kStatus.textContent = "FAIL";
        chipGate.textContent = "Gate: FAIL";
        chipGate.className = "chip bad";
      }
    }

    // ====== OCR PIPELINE ======
    async function ocrOneFile(file){
      if(!st.ready || !st.worker) throw new Error("Tesseract ch∆∞a s·∫µn s√†ng");
      dbg.value = `ƒêang OCR: ${file.name}\n`;
      const imgUrl = await fileToDataURL(file);
      setPreview(imgUrl);

      // OCR tr·ª±c ti·∫øp dataURL
      const { data: { text } } = await st.worker.recognize(imgUrl);

      st.lastOCRText = text || "";
      const p = parseFromOCR(st.lastOCRText);
      st.lastParse = p;

      // debug r√∫t g·ªçn: show 80 d√≤ng ƒë·∫ßu
      const lines = (p.normText || "").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      dbg.value = [
        "[OCR_NORM] (r√∫t g·ªçn)",
        ...lines.slice(0, 80),
        "",
        `[DB_5DIG] ${p.db5 || "none"}`,
        `[DB_2DIG] ${p.db2 || "none"}`,
        `[G7_LINE] ${p.g7 ? p.g7.join(" ") : "none"}`,
        `[G6_LINE] ${p.g6 ? p.g6.join(" ") : "none"}`,
        `[GATE] ${p.gatePass ? "PASS" : "FAIL"}`
      ].join("\n");

      updateGateUI(p);

      // n·∫øu pass ‚Üí ƒë·ªï d·ªØ li·ªáu 1 d√≤ng
      if(p.gatePass){
        const line = `DB ${p.db2} | G7: ${p.g7.join(" ")} | G6: ${p.g6.join(" ")}`;
        appendDataLine(line);
      }
      return p;
    }

    function appendDataLine(line){
      const cur = data.value.trim();
      data.value = cur ? (cur + "\n" + line) : line;
    }

    function fileToDataURL(file){
      return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = ()=>rej(r.error || new Error("FileReader error"));
        r.readAsDataURL(file);
      });
    }

    // ====== EVENTS ======

    // Upload: ƒë·∫£m b·∫£o click n·∫±m trong handler tr·ª±c ti·∫øp (mobile m·ªõi m·ªü picker)
    btnUpload.addEventListener("click", ()=>{
      fileInput.value = ""; // reset ƒë·ªÉ ch·ªçn l·∫°i c√πng ·∫£nh v·∫´n trigger change
      fileInput.click();
    });

    fileInput.addEventListener("change", async ()=>{
      const files = Array.from(fileInput.files || []);
      st.files = files;
      chipBatch.textContent = `Batch: ${files.length} ·∫£nh`;
      if(!files.length) return;

      let ok=0, fail=0;
      for(let i=0;i<files.length;i++){
        try{
          const p = await ocrOneFile(files[i]);
          if(p.gatePass) ok++; else fail++;
          chipBatch.className = ok>0 ? "chip ok" : "chip";
          chipBatch.textContent = `Batch: OK ${ok} | FAIL ${fail}`;
        }catch(e){
          fail++;
          chipBatch.className = "chip warn";
          chipBatch.textContent = `Batch: OK ${ok} | FAIL ${fail}`;
          dbg.value = "L·ªói OCR: " + (e?.message || e);
          updateGateUI({gatePass:false});
        }
      }
    });

    btnClear.addEventListener("click", ()=>{
      st.files = [];
      st.lastOCRText = "";
      st.lastParse = null;
      fileInput.value = "";
      data.value = "";
      dbg.value = "";
      out.textContent = "Ch∆∞a ch·∫°y.";
      chipBatch.className = "chip";
      chipBatch.textContent = "Batch: 0 ·∫£nh";
      updateGateUI(null);
      resetPreview();
    });

    btnApplyManual.addEventListener("click", ()=>{
      const db = String(mDB.value||"").trim();
      const g6 = String(mG6.value||"").trim();
      const g7 = String(mG7.value||"").trim();

      const dbOk = /^\d{2}$/.test(db);
      const g6Arr = g6.split(/\s+/).filter(Boolean);
      const g7Arr = g7.split(/\s+/).filter(Boolean);

      const g6Ok = g6Arr.length===3 && g6Arr.every(x=>/^\d{3}$/.test(x));
      const g7Ok = g7Arr.length===4 && g7Arr.every(x=>/^\d{2}$/.test(x));

      if(!dbOk || !g6Ok || !g7Ok){
        out.textContent = "‚ùå Manual sai format. DB=2 s·ªë, G6=3 s·ªë 3 ch·ªØ s·ªë, G7=4 s·ªë 2 ch·ªØ s·ªë.";
        return;
      }

      const line = `DB ${db} | G7: ${g7Arr.join(" ")} | G6: ${g6Arr.join(" ")}`;
      appendDataLine(line);

      // set gate ok tr√™n UI
      updateGateUI({db2:db, g6:g6Arr, g7:g7Arr, gatePass:true});
      chipGate.className = "chip ok";
      chipGate.textContent = "Gate: PASS (manual)";
    });

    btnRunFull.addEventListener("click", ()=>{
      runFull();
    });

    // ====== FULL ANALYSIS (Hot + Gan) ======
    function runFull(){
      const lines = data.value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);

      if(lines.length < 5){
        out.textContent = "‚ùå Thi·∫øu d·ªØ li·ªáu: c·∫ßn √≠t nh·∫•t 5 d√≤ng (5 ng√†y).";
        return;
      }

      const N = clampInt($("winN").value, 30);
      const K = clampInt($("topK").value, 15);
      const wHot = clampFloat($("wHot").value, 2);
      const wGan = clampFloat($("wGan").value, 1.5);

      const recent = lines.slice(-N);

      // l·∫•y t·∫•t c·∫£ s·ªë 2 ch·ªØ s·ªë xu·∫•t hi·ªán trong: DB, G7 (4 s·ªë), v√† s·ªë 2 ch·ªØ s·ªë trong G6 (l·∫•y 2 s·ªë cu·ªëi t·ª´ng s·ªë 3 ch·ªØ s·ªë)
      const perDay = [];

      for(const ln of recent){
        const mDB = ln.match(/DB\s+(\d{2})/);
        const mG7 = ln.match(/G7:\s*([0-9 ]+)/);
        const mG6 = ln.match(/G6:\s*([0-9 ]+)/);

        if(!mDB || !mG7 || !mG6) continue;

        const db = mDB[1];
        const g7 = mG7[1].trim().split(/\s+/).filter(x=>/^\d{2}$/.test(x));
        const g6_3 = mG6[1].trim().split(/\s+/).filter(x=>/^\d{3}$/.test(x));

        if(g7.length!==4 || g6_3.length!==3) continue;

        const g6_2 = g6_3.map(x=>x.slice(-2));
        const all2 = [db, ...g7, ...g6_2].map(x=>x.padStart(2,"0"));
        perDay.push(all2);
      }

      if(perDay.length < 5){
        out.textContent = "‚ùå D·ªØ li·ªáu parse kh√¥ng ƒë·ªß (d√≤ng b·ªã sai format). H√£y gi·ªØ ƒë√∫ng format chu·∫©n.";
        return;
      }

      // Hot: t·∫ßn su·∫•t
      const freq = new Map();
      perDay.flat().forEach(x=>freq.set(x,(freq.get(x)||0)+1));

      // Gan: s·ªë ng√†y k·ªÉ t·ª´ l·∫ßn cu·ªëi xu·∫•t hi·ªán (c√†ng l·ªõn c√†ng gan)
      const gan = new Map();
      const totalDays = perDay.length;
      for(const [num] of freq){
        let last = -1;
        for(let i=totalDays-1;i>=0;i--){
          if(perDay[i].includes(num)){ last = i; break; }
        }
        gan.set(num, last===-1 ? totalDays : (totalDays-1-last));
      }

      // Score
      const scored = Array.from(freq.keys()).map(num=>{
        const f = freq.get(num)||0;
        const g = gan.get(num)||0;
        const score = f*wHot + g*wGan;
        return { num, f, g, score };
      }).sort((a,b)=>b.score-a.score);

      const topHot = Array.from(freq.entries())
        .sort((a,b)=>b[1]-a[1])
        .slice(0, K);

      const topScore = scored.slice(0, K);

      const pickMain = topScore[0]?.num || "‚Äî";
      const pickSub = topScore[1]?.num || "‚Äî";

      out.textContent =
`T·ªïng ng√†y d√πng: ${perDay.length}

TOP HOT (t·∫ßn su·∫•t):
${topHot.map(([n,c])=>`${n}  ‚Üí ${c}`).join("\n")}

TOP SCORE (hot*${wHot} + gan*${wGan}):
${topScore.map(x=>`${x.num}  ‚Üí ${x.score.toFixed(2)}   (hot:${x.f}, gan:${x.g})`).join("\n")}

CH·ªêT G·ª¢I √ù:
üéØ Ch√≠nh: ${pickMain}
üõ°Ô∏è Ph·ª•:  ${pickSub}

* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng`;
    }
  </script>
</body>
</html>
