<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3 ‚Ä¢ GOD MODE)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.09);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#ff4d4f;
      --blue:#3b82f6;
      --chip:rgba(255,255,255,.06);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, rgba(59,130,246,.18), transparent 55%),
                  radial-gradient(1000px 700px at 80% 20%, rgba(50,213,131,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      letter-spacing:.2px;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 30px}
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:24px;
      padding:16px 14px;
      box-shadow: var(--shadow);
    }
    h1{margin:0 0 10px;font-size:20px;line-height:1.2}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 12px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:var(--chip);border:1px solid var(--line);
      font-size:12px;color:var(--muted)
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.g{background:var(--good)}
    .dot.w{background:var(--warn)}
    .dot.b{background:var(--blue)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;border-radius:16px;
      font-weight:700;cursor:pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    .btn.primary{background:linear-gradient(180deg, rgba(59,130,246,.85), rgba(59,130,246,.55));border-color:rgba(59,130,246,.35)}
    .btn.danger{background:linear-gradient(180deg, rgba(255,77,79,.85), rgba(255,77,79,.55));border-color:rgba(255,77,79,.35)}
    .btn.gray{background:rgba(255,255,255,.05)}
    .btn:active{transform:translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(min-width:860px){
      .grid{grid-template-columns: 1.1fr .9fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:24px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px;font-size:14px;letter-spacing:.7px;text-transform:uppercase;color:rgba(232,240,255,.85)}
    .sub{font-size:12px;color:var(--muted);margin-top:-6px;margin-bottom:10px}
    .kv{
      display:grid;grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .field{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;padding:10px 10px;
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{
      width:100%;
      border:0;outline:0;
      background:transparent;
      color:var(--text);
      font-size:14px;
      font-weight:700;
    }
    textarea{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight:600;font-size:12px;line-height:1.35;
      min-height:140px;resize:vertical;
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      font-size:12px;color:var(--muted);
    }
    .chip.good{color:rgba(50,213,131,.95)}
    .chip.warn{color:rgba(253,176,34,.95)}
    .chip.bad{color:rgba(255,77,79,.95)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .result{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
    }
    .big{
      font-size:34px;font-weight:900;letter-spacing:1px;
      margin:2px 0 8px;
    }
    .mini{font-size:12px;color:var(--muted);line-height:1.4}
    .pickRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      font-weight:900;
    }
    .icon{
      width:22px;height:22px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      font-size:13px;
    }
    .warnBox{
      background:rgba(0,0,0,.20);
      border:1px dashed rgba(253,176,34,.45);
      border-radius:18px;
      padding:12px;
      color:rgba(232,240,255,.92);
    }
    ul{margin:8px 0 0 18px;padding:0}
    li{margin:6px 0;color:rgba(232,240,255,.88)}
    details{
      border:1px solid var(--line);
      border-radius:18px;
      padding:10px 12px;
      background:rgba(0,0,0,.16);
    }
    summary{cursor:pointer;font-weight:900}
    pre{
      margin:10px 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;line-height:1.35;
      color:rgba(232,240,255,.90)
    }
    footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center}
    a{color:#93c5fd;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3 ‚Ä¢ GOD MODE)</h1>

      <div class="badges">
        <span class="badge"><span class="dot g"></span> OpenCV</span>
        <span class="badge"><span class="dot g"></span> Tesseract OCR</span>
        <span class="badge"><span class="dot w"></span> Gate c·ª©ng</span>
        <span class="badge"><span class="dot w"></span> Batch nhi·ªÅu ·∫£nh</span>
        <span class="badge"><span class="dot w"></span> DB theo nh√£n ‚ÄúƒêB/DB‚Äù + 5 s·ªë</span>
        <span class="badge"><span class="dot w"></span> G7/G6 theo pattern</span>
        <span class="badge"><span class="dot g"></span> Kh√¥ng ph√° scan/scale</span>
      </div>

      <div class="muted" style="font-size:12px;line-height:1.45">
        Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí tool t·ª± c·∫Øt v√πng b·∫£ng ‚Üí <b>DB</b>: t√¨m nh√£n ƒêB/DB + 5 s·ªë ‚Üí
        <b>G7</b>: d√≤ng g·∫ßn cu·ªëi c√≥ 4 s·ªë 2 ch·ªØ s·ªë ‚Üí <b>G6</b>: d√≤ng ph√≠a tr√™n c√≥ 3 s·ªë 3 ch·ªØ s·ªë ‚Üí
        <b>Gate PASS</b> m·ªõi ƒë·ªï v√†o d·ªØ li·ªáu ‚Üí b·∫•m <b>Ch·∫°y FULL</b>.<br/>
        <span class="muted">* Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</span>
      </div>

      <div class="row" style="margin-top:12px">
        <input id="file" type="file" accept="image/*" multiple hidden>
        <button class="btn primary" id="btnUpload">üì∏ Upload nhi·ªÅu ·∫£nh</button>
        <button class="btn gray" id="btnCamera">üì∑ Camera</button>
        <button class="btn gray" id="btnPaste">D√°n m·∫´u</button>
        <button class="btn danger" id="btnClear">X√≥a</button>
        <button class="btn" id="btnRun">‚ñ∂ Ch·∫°y FULL</button>
      </div>

      <div class="chips">
        <span class="chip good" id="stCv">‚óè OpenCV: OK</span>
        <span class="chip good" id="stOcr">‚óè OCR: idle</span>
        <span class="chip" id="stGate">‚óè Gate: ‚Äî</span>
        <span class="chip good" id="stBatch">‚óè Batch: OK 0 | FAIL 0</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>·∫¢nh ‚Üí OCR ‚Üí Gate</h2>
        <div class="sub">M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) v√† header qu·∫£ng c√°o.</div>

        <div class="kv">
          <div class="field">
            <label>C·ª≠a s·ªï ng√†y (khuy·∫øn ngh·ªã)</label>
            <input id="winDays" type="number" value="20" min="7" max="60"/>
          </div>
          <div class="field">
            <label>Top hi·ªÉn th·ªã (tham kh·∫£o)</label>
            <input id="topShow" type="number" value="10" min="5" max="30"/>
          </div>

          <div class="field">
            <label>AI gi√°m s√°t</label>
            <select id="aiLock">
              <option value="on">ON (kh√≥a theo pha)</option>
              <option value="off">OFF (tham kh·∫£o)</option>
            </select>
          </div>
          <div class="field">
            <label>Ng∆∞·ª°ng TR·ª§C n·ªïi (>=)</label>
            <input id="trucTh" type="number" value="4" min="2" max="10"/>
          </div>

          <div class="field">
            <label>K ƒë·ªçc pha (ng√†y g·∫ßn nh·∫•t)</label>
            <input id="skipPhaseDays" type="number" value="9" min="0" max="30"/>
          </div>
          <div class="field">
            <label>Tr·ªçng s·ªë Hot</label>
            <input id="wHot" type="number" step="0.1" value="2"/>
          </div>

          <div class="field">
            <label>Tr·ªçng s·ªë Gan</label>
            <input id="wGan" type="number" step="0.1" value="1.5"/>
          </div>
          <div class="field">
            <label>Tr·ªçng s·ªë Pascal</label>
            <input id="wPas" type="number" step="0.1" value="2"/>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Debug OCR (paste text OCR v√†o ƒë√¢y n·∫øu kh√¥ng ch·∫°y OCR tr·ª±c ti·∫øp)</label>
            <textarea id="ocrText" spellcheck="false" placeholder="[UPPER_OCR] ...&#10;[DB_5DIG] ...&#10;[LOWER_OCR] ..."></textarea>
          </div>
        </div>

        <details style="margin-top:10px">
          <summary>Debug OCR (auto extract)</summary>
          <pre id="dbg"></pre>
        </details>
      </div>

      <div class="card">
        <h2>K·∫æT QU·∫¢ FULL</h2>
        <div class="sub">ƒê∆†N GI·∫¢N: Ch·ªët + c·∫£nh b√°o + l√Ω do (d·ªÖ nh√¨n)</div>

        <div class="result" id="simpleBox">
          <div class="muted" style="font-weight:900;letter-spacing:.8px">CH·ªêT (TH∆Ø∆†NG M·∫†I)</div>
          <div class="big" id="pickBig">‚Äî / ‚Äî / ‚Äî</div>
          <div class="mini" id="phaseLine">Pha: ‚Äî ‚Ä¢ H∆∞·ªõng: ‚Äî ‚Ä¢ Tin c·∫≠y: ‚Äî</div>
          <div class="mini" id="noteLine" style="margin-top:6px">‚Äî</div>

          <div class="pickRow" id="pickPills" style="display:none">
            <span class="pill"><span class="icon">üéØ</span> Ch√≠nh: <span id="pMain"></span></span>
            <span class="pill"><span class="icon">üõ°Ô∏è</span> Ph·ª•: <span id="pSub"></span></span>
            <span class="pill"><span class="icon">‚ûï</span> K√®m: <span id="pAdd"></span></span>
          </div>

          <div class="sep"></div>

          <div class="muted" style="font-weight:900;letter-spacing:.8px">3 C·∫¢NH B√ÅO M·∫†NH</div>
          <div class="warnBox" style="margin-top:8px">
            <ul id="warnList">
              <li>‚Äî</li>
            </ul>
          </div>

          <div class="sep"></div>
          <div class="mini">
            <span id="modeLine">MODE: ‚Äî</span>
          </div>

          <details style="margin-top:10px">
            <summary>‚ñº Xem chi ti·∫øt FULL PRO</summary>
            <pre id="fullPro"></pre>
          </details>
        </div>

        <footer>¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</footer>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   FULL v3 ‚Ä¢ GOD MODE ‚Äî single-file
   - Paste OCR text / or upload images (OCR runtime optional)
   - Gate + parse + build dataset (20 ng√†y)
   - Patch 2..5: calibrate confidence + anti-cum + optimize HIT@3>=2 + fallback B mode
   ========================================================= */

const $ = (id)=>document.getElementById(id);
const stCv = $("stCv"), stOcr=$("stOcr"), stGate=$("stGate"), stBatch=$("stBatch");
const ocrText=$("ocrText"), dbg=$("dbg");
const pickBig=$("pickBig"), phaseLine=$("phaseLine"), noteLine=$("noteLine");
const warnList=$("warnList"), fullPro=$("fullPro");
const pickPills=$("pickPills"), pMain=$("pMain"), pSub=$("pSub"), pAdd=$("pAdd");
const modeLine=$("modeLine");

const state = {
  days: [],          // [{dateKey, db5, db2, g7:[..], g6:[..], loto2: Set, raw}]
  lastParsed: null,  // last parse object
  batchOK: 0,
  batchFail: 0,
};

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function pad2(n){ n=String(n); return n.length===1?("0"+n):n; }
function head(n){ return Math.floor(Number(n)/10); }
function tail(n){ return Number(n)%10; }
function uniq(arr){ return [...new Set(arr)]; }
function nowKey(){
  const d=new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}

/* ===== PATCH 2: CALIBRATE CONFIDENCE ===== */
function calibrateConfidence({base=0.92, trust=0.74, noise=0.56, validCount=20, badCount=0}){
  const pNoise = (noise <= 0.45) ? 0 : (noise - 0.45) * 1.25;
  const pTrust = (trust >= 0.78) ? 0 : (0.78 - trust) * 1.10;
  const pData  = (validCount >= 18) ? 0 : (18 - validCount) * 0.03;
  const pBad   = Math.min(0.10, badCount * 0.02);

  let conf = base - pNoise - pTrust - pData - pBad;
  conf = clamp(conf, 0.35, 0.92);

  const isNoisyDay = (noise >= 0.55) || (trust <= 0.70) || (validCount < 18);
  return { conf, isNoisyDay };
}

/* ===== PATCH 5: AUTO FALLBACK MODE ===== */
function decideMode({trust, noise, validCount}){
  const noisy = (noise >= 0.55) || (trust <= 0.70) || (validCount < 18);
  return noisy ? "B_MODE_DAN10" : "A_MODE_CHOT3";
}

/* ===== PATCH 3: SIMILARITY PENALTY (anti-cum) ===== */
function similarity(a,b, meta){
  let s = 0;
  if(head(a) === head(b)) s += 1.0;
  if(tail(a) === tail(b)) s += 0.8;

  const ma = meta?.[a] || {};
  const mb = meta?.[b] || {};
  if(ma.trucKey && mb.trucKey && ma.trucKey === mb.trucKey) s += 1.2;
  if(ma.cumKey  && mb.cumKey  && ma.cumKey  === mb.cumKey)  s += 1.0;
  if(ma.isHotCluster && mb.isHotCluster) s += 0.8;

  return s;
}

/* ===== PATCH 4: OPTIMIZE HIT@3>=2 ===== */
function softmaxProb(scoreMap){
  const entries = Object.entries(scoreMap);
  if(!entries.length) return {};
  const mx = Math.max(...entries.map(([,v])=>v));
  let sum = 0;
  const expv = {};
  for(const [k,v] of entries){
    const e = Math.exp((v - mx) / 2.2);
    expv[k]=e; sum += e;
  }
  const p = {};
  for(const [k] of entries) p[k] = expv[k]/sum;
  return p;
}
function probHitGE2(pa,pb,pc){
  return pa*pb*(1-pc) + pa*pc*(1-pb) + pb*pc*(1-pa) + pa*pb*pc;
}
function pickBestTriple(scoreMap, meta, lambda=0.22){
  const p = softmaxProb(scoreMap);
  const keys = Object.keys(p);
  if(keys.length < 3) return null;

  keys.sort((a,b)=>p[b]-p[a]);
  const K = Math.min(18, keys.length);
  const cand = keys.slice(0,K);

  let best = null;
  let bestVal = -1;

  for(let i=0;i<cand.length;i++){
    for(let j=i+1;j<cand.length;j++){
      for(let k=j+1;k<cand.length;k++){
        const a=cand[i], b=cand[j], c=cand[k];
        const valHit = probHitGE2(p[a],p[b],p[c]);
        const sim = similarity(a,b,meta)+similarity(a,c,meta)+similarity(b,c,meta);
        const val = valHit - lambda*sim;
        if(val > bestVal){
          bestVal = val;
          best = {a,b,c, valHit, sim, val, probs:{a:p[a],b:p[b],c:p[c]}};
        }
      }
    }
  }
  return best;
}

/* =========================
   PARSE OCR TEXT ‚Üí DAY DATA
   ========================= */
function extractAllNumbers(text){
  // l·∫•y m·ªçi c·ª•m s·ªë >=2 ch·ªØ s·ªë (vd 01377, 431, 58...)
  const m = text.match(/\d{2,6}/g);
  return m ? m : [];
}
function extractDB5(text){
  // ∆∞u ti√™n theo nh√£n
  let m = text.match(/(?:\bƒêB\b|\bDB\b)[^\d]*(\d{5})/);
  if(m) return m[1];
  // ho·∫∑c [DB_5DIG]
  m = text.match(/\[DB_5DIG\][^\d]*(\d{5})/);
  if(m) return m[1];
  // fallback: s·ªë 5 ch·ªØ s·ªë ƒë·ªè th∆∞·ªùng ƒë·ª©ng ri√™ng
  const all = (text.match(/\b\d{5}\b/g) || []);
  return all.length ? all[0] : null;
}
function extractG7Line(text){
  // ∆∞u ti√™n [G7_LINE]
  let m = text.match(/\[G7_LINE\][\s\S]*?(\d{1,2})\s+(\d{2})\s+(\d{2})\s+(\d{2})\s+(\d{2})/);
  if(m) return [m[2],m[3],m[4],m[5]];
  // fallback: d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng 7 + 4 s·ªë 2 ch·ªØ s·ªë
  const lines = text.split(/\r?\n/);
  for(let i=lines.length-1;i>=0;i--){
    const ln = lines[i].trim().replace(/\s+/g,' ');
    const mm = ln.match(/^(?:7\s+)?(\d{2})\s+(\d{2})\s+(\d{2})\s+(\d{2})$/);
    if(mm) return [mm[1],mm[2],mm[3],mm[4]];
    const mm2 = ln.match(/^7\s+\d+\s+(\d{2})\s+(\d{2})\s+(\d{2})\s+(\d{2})$/); // ki·ªÉu "7 1 77 51 67 47"
    if(mm2) return [mm2[1],mm2[2],mm2[3],mm2[4]];
  }
  return null;
}
function extractG6Line(text){
  // ∆∞u ti√™n [G6_LINE]
  let m = text.match(/\[G6_LINE\][\s\S]*?(\d{1,2})\s+(\d{3})\s+(\d{3})\s+(\d{3})/);
  if(m) return [m[2],m[3],m[4]];
  // fallback: d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng 6 + 3 s·ªë 3 ch·ªØ s·ªë
  const lines = text.split(/\r?\n/);
  for(let i=lines.length-1;i>=0;i--){
    const ln = lines[i].trim().replace(/\s+/g,' ');
    const mm = ln.match(/^(?:6\s+)?(\d{3})\s+(\d{3})\s+(\d{3})$/);
    if(mm) return [mm[1],mm[2],mm[3]];
    const mm2 = ln.match(/^6\s+\d+\s+(\d{3})\s+(\d{3})\s+(\d{3})$/);
    if(mm2) return [mm2[1],mm2[2],mm2[3]];
  }
  return null;
}
function buildLoto2FromRaw(rawText){
  // l·∫•y 2 s·ªë cu·ªëi c·ªßa m·ªçi c·ª•m >=2 ch·ªØ s·ªë (c·∫Øt t·ª´ to√†n b·ªô b·∫£ng)
  const nums = extractAllNumbers(rawText);
  const loto2 = [];
  for(const s of nums){
    if(s.length >= 2){
      loto2.push(s.slice(-2));
    }
  }
  return uniq(loto2).filter(x=>/^\d{2}$/.test(x));
}
function gatePass(day){
  // Gate c·ª©ng: c√≥ DB5 + G7 (4 s·ªë 2 digit) + G6 (3 s·ªë 3 digit)
  if(!day.db5 || !/^\d{5}$/.test(day.db5)) return false;
  if(!day.g7 || day.g7.length!==4 || day.g7.some(x=>!/^\d{2}$/.test(x))) return false;
  if(!day.g6 || day.g6.length!==3 || day.g6.some(x=>!/^\d{3}$/.test(x))) return false;
  return true;
}

/* =========================
   DATASET + FEATURES
   ========================= */
function addDayFromOCR(text){
  const db5 = extractDB5(text);
  const g7 = extractG7Line(text);
  const g6 = extractG6Line(text);
  const loto2 = buildLoto2FromRaw(text);
  const day = {
    dateKey: nowKey(),
    db5,
    db2: db5 ? db5.slice(-2) : null,
    g7,
    g6,
    loto2: new Set(loto2),
    raw: text
  };
  return day;
}
function upsertDay(day){
  // n·∫øu c√πng ng√†y th√¨ replace, kh√¥ng th√¨ push
  const idx = state.days.findIndex(d=>d.dateKey===day.dateKey && d.db5===day.db5);
  if(idx>=0) state.days[idx]=day;
  else state.days.push(day);

  // gi·ªØ t·ªëi ƒëa 60 ng√†y
  if(state.days.length>60) state.days = state.days.slice(state.days.length-60);
}

function computeHotGan(days, win){
  // hot: t·∫ßn su·∫•t xu·∫•t hi·ªán trong win ng√†y
  // gan: s·ªë ng√†y t·ª´ l·∫ßn xu·∫•t hi·ªán g·∫ßn nh·∫•t (0 n·∫øu h√¥m nay c√≥)
  const hot = {};
  const lastSeen = {};
  for(let i=0;i<100;i++){
    const k=pad2(i);
    hot[k]=0; lastSeen[k]=Infinity;
  }

  const use = days.slice(-win);
  for(let di=0; di<use.length; di++){
    const d=use[use.length-1-di]; // duy·ªát t·ª´ m·ªõi -> c≈© ƒë·ªÉ lastSeen
    for(const n of d.loto2){
      hot[n] += 1;
      if(lastSeen[n]===Infinity) lastSeen[n]=di; // di=0 l√† h√¥m nay
    }
  }
  // n·∫øu ch∆∞a seen th√¨ lastSeen = Infinity, ta gi·ªØ Infinity
  return {hot, lastSeen};
}

function computeTruc(days, win){
  // "tr·ª•c" d·∫°ng ƒë∆°n gi·∫£n: c√πng ng√†y v·ªõi DB2 => tƒÉng ƒëi·ªÉm tr·ª•c cho s·ªë ƒë√≥
  // v√† tr·ª•cKey d√πng theo tail (ƒëu√¥i) ƒë·ªÉ t·∫°o nh√≥m tr·ª•c
  const use = days.slice(-win);
  const truc = {};
  for(let i=0;i<100;i++) truc[pad2(i)]=0;

  for(const d of use){
    if(!d.db2) continue;
    for(const n of d.loto2){
      if(n===d.db2) continue;
      // c√πng xu·∫•t hi·ªán v·ªõi DB2: c·ªông 1
      truc[n] += 1;
    }
  }
  return truc;
}

function computeG7LeadSeeds(days, win){
  // seed t·ª´ G7 (4 s·ªë 2 ch·ªØ s·ªë) + b√≥ng (99-x)
  const use = days.slice(-Math.min(win, 12)); // g·∫ßn h∆°n
  const seeds = new Set();
  for(const d of use){
    if(!d.g7) continue;
    for(const n of d.g7){
      seeds.add(n);
      const b = pad2(99 - Number(n));
      seeds.add(b);
    }
  }
  return seeds;
}

function computePascalSeeds(days, win){
  // Pascal seed d·∫°ng "ƒë∆°n gi·∫£n an to√†n": l·∫•y DB2 + (DB2¬±1) + c√°c s·ªë g7 g·∫ßn
  const use = days.slice(-Math.min(win, 15));
  const seeds = new Set();
  for(const d of use){
    if(d.db2){
      const x=Number(d.db2);
      seeds.add(pad2(x));
      seeds.add(pad2((x+1)%100));
      seeds.add(pad2((x+99)%100));
    }
    if(d.g7){
      for(const n of d.g7) seeds.add(n);
    }
  }
  return seeds;
}

function buildScores(days){
  const win = Number($("winDays").value)||20;
  const topShow = Number($("topShow").value)||10;
  const wHot = Number($("wHot").value)||2;
  const wGan = Number($("wGan").value)||1.5;
  const wPas = Number($("wPas").value)||2;
  const trucTh = Number($("trucTh").value)||4;

  const {hot, lastSeen} = computeHotGan(days, win);
  const truc = computeTruc(days, win);
  const g7Seeds = computeG7LeadSeeds(days, win);
  const pasSeeds = computePascalSeeds(days, win);

  // x√°c ƒë·ªãnh c·ª•m hot d√†y (top hot)
  const hotSorted = Object.entries(hot).sort((a,b)=>b[1]-a[1]);
  const hotMax = hotSorted[0]?.[1] || 0;
  const hotCluster = new Set(hotSorted.filter(([k,v])=>v>=Math.max(3, Math.floor(hotMax*0.75))).map(([k])=>k));

  // meta & score
  const meta = {};
  const scoreMap = {};
  const flags = {
    hotTop: hotSorted.slice(0,15).map(([k,v])=>[k,v]),
    ganTop: [],
    trucTop: [],
    pasSeeds: [...pasSeeds],
    g7Seeds: [...g7Seeds],
  };

  // gan: ∆∞u ti√™n s·ªë "gan v·ª´a/ƒë·ªß" (2..9) ‚Äî tr√°nh gan qu√° d√†i (d·ªÖ b·∫´y) v√† gan 0 (ƒë√£ ra)
  const ganScore = {};
  for(let i=0;i<100;i++){
    const n=pad2(i);
    const g = lastSeen[n];
    let gs = 0;
    if(g===0) gs = 0;                   // m·ªõi ra h√¥m nay: b·ªè
    else if(g>=2 && g<=6) gs = 3.0;     // gan v·ª´a ƒë·∫πp
    else if(g>=7 && g<=10) gs = 2.0;
    else if(g>=11 && g<=14) gs = 1.2;
    else if(g===Infinity) gs = 0.6;     // ch∆∞a th·∫•y trong c·ª≠a s·ªï
    else gs = 0.4;
    ganScore[n]=gs;
  }
  flags.ganTop = Object.entries(lastSeen)
    .filter(([k,v])=>v!==Infinity)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,15)
    .map(([k,v])=>[k,v]);

  flags.trucTop = Object.entries(truc).sort((a,b)=>b[1]-a[1]).slice(0,25);

  // build final
  for(let i=0;i<100;i++){
    const n=pad2(i);
    const hotS = hot[n]; // 0..win
    const ganS = ganScore[n];
    const trucS = truc[n] >= trucTh ? 1.0 : (truc[n] > 0 ? 0.5 : 0);
    const g7S  = g7Seeds.has(n) ? 1.0 : 0;
    const pasS = pasSeeds.has(n) ? 1.0 : 0;

    const score = wHot*hotS + wGan*ganS + (2.4)*trucS + (0.9)*g7S + wPas*pasS;

    scoreMap[n]=score;

    meta[n]={
      trucKey: "t"+tail(n),                    // nh√≥m tr·ª•c theo ƒëu√¥i (·ªïn ƒë·ªãnh, ch·ªëng d·ªìn)
      cumKey:  "h"+head(n),                    // nh√≥m c·ª•m theo ƒë·∫ßu
      isHotCluster: hotCluster.has(n),
      hot:hotS, gan:lastSeen[n], truc:truc[n],
      g7:g7S>0, pas:pasS>0,
      dau:true, duoi:true
    };
  }

  // trust/noise th√¥ (ƒë·ªÉ calibrate)
  const probs = softmaxProb(scoreMap);
  const sortedP = Object.values(probs).sort((a,b)=>b-a);
  const p1 = sortedP[0]||0, p3 = (sortedP[2]||0), p10 = (sortedP[9]||0);
  const concentration = clamp((p1 - p10) * 12, 0, 1); // c√†ng cao c√†ng √≠t nhi·ªÖu
  const noise = clamp(1 - concentration, 0, 1);

  // agreement: top s·ªë c√≥ c√πng nhi·ªÅu c·ªù (truc/g7/pas) -> trust tƒÉng
  const topKeys = Object.keys(probs).sort((a,b)=>probs[b]-probs[a]).slice(0,12);
  let agree=0;
  for(const k of topKeys){
    const m=meta[k];
    agree += (m.truc>=trucTh?1:0) + (m.g7?1:0) + (m.pas?1:0) + (m.hot>=3?1:0);
  }
  const trust = clamp(0.55 + (agree/(topKeys.length*4))*0.45 - noise*0.22, 0.35, 0.92);

  return {win, topShow, scoreMap, meta, flags, trust, noise};
}

/* =========================
   OUTPUT (SIMPLE + FULLPRO)
   ========================= */
function renderResult(days){
  const validCount = days.length;
  const {win, topShow, scoreMap, meta, flags, trust, noise} = buildScores(days);
  const {conf, isNoisyDay} = calibrateConfidence({base:0.92, trust, noise, validCount, badCount:0});
  const mode = decideMode({trust, noise, validCount});

  // phase (ƒë∆°n gi·∫£n) ‚Äî b·∫°n c√≥ th·ªÉ thay b·∫±ng b·∫£ng pha th·∫≠t c·ªßa b·∫°n
  const pha = isNoisyDay ? "P2" : "P6";
  const huong = isNoisyDay ? "TRUC_GAN" : "TRUC_MO";

  let pickText = "‚Äî / ‚Äî / ‚Äî";
  let main="‚Äî", sub="‚Äî", add="‚Äî";
  let note = "‚Äî";

  // warnings
  const warns = [];
  if(noise >= 0.55) warns.push("‚ö†Ô∏è B·∫™Y C·ª§M/HOT: hot d√†y ‚Üí d·ªÖ l·ªách, tr√°nh all-in theo c·ª•m.");
  else warns.push("‚úÖ OK: nhi·ªÖu th·∫•p ‚Üí c√≥ th·ªÉ ch·ªët theo tr·ª•c + x√°c nh·∫≠n.");

  if(trust <= 0.70) warns.push("‚ö†Ô∏è TRUST th·∫•p: t√≠n hi·ªáu kh√¥ng ƒë·ªìng thu·∫≠n ‚Üí ∆∞u ti√™n d√†n/B-mode ho·∫∑c gi·∫£m ti·ªÅn.");
  else warns.push("‚úÖ OK: t√≠n hi·ªáu ƒë·ªìng thu·∫≠n m·ª©c kh√°.");

  if(validCount < 18) warns.push("‚ö†Ô∏è D·ªØ li·ªáu √≠t: <18 ng√†y trong c·ª≠a s·ªï ‚Üí gi·∫£m tin c·∫≠y.");
  else warns.push("‚úÖ OK: d·ªØ li·ªáu ƒë·ªß c·ª≠a s·ªï.");

  // pick
  if(mode === "A_MODE_CHOT3"){
    const best = pickBestTriple(scoreMap, meta, 0.22);
    if(best){
      main = best.a; sub = best.b; add = best.c;
      pickText = `${main} / ${sub} / ${add}`;
      note = `T·ªëi ∆∞u HIT@3>=2 (anti-c·ª•m). valHit‚âà${(best.valHit*100).toFixed(1)}% ‚Ä¢ sim=${best.sim.toFixed(2)}.`;
    }
  }else{
    // B mode: d√†n 10 theo gi·∫£ thi·∫øt (l·∫•y top nh∆∞ng t√°ch c·ª•m)
    const probs = softmaxProb(scoreMap);
    const keys = Object.keys(probs).sort((a,b)=>probs[b]-probs[a]);
    const dan = [];
    const usedHead = new Set();
    for(const k of keys){
      if(dan.length>=10) break;
      const h=head(k);
      if(usedHead.has(h)) continue;
      dan.push(k);
      usedHead.add(h);
    }
    pickText = dan.slice(0,3).join(" / ") + (dan.length>=3 ? "" : "");
    main = dan[0]||"‚Äî"; sub = dan[1]||"‚Äî"; add = dan[2]||"‚Äî";
    note = `Ng√†y nhi·ªÖu ‚Üí B_MODE_DAN10 (t√°ch c·ª•m theo ƒë·∫ßu). D√†n10: ${dan.join(" ")}.`;
  }

  // update UI
  pickBig.textContent = pickText;
  phaseLine.textContent = `Pha: ${pha} ‚Ä¢ H∆∞·ªõng: ${huong} ‚Ä¢ Tin c·∫≠y: ${(conf*100).toFixed(0)}%`;
  noteLine.textContent = note;

  pickPills.style.display = "flex";
  pMain.textContent = main;
  pSub.textContent = sub;
  pAdd.textContent = add;

  warnList.innerHTML = "";
  for(const w of warns.slice(0,3)){
    const li=document.createElement("li");
    li.textContent=w;
    warnList.appendChild(li);
  }
  modeLine.textContent = `MODE: ${mode} ‚Ä¢ trust ${(trust*100).toFixed(0)}% ‚Ä¢ noise ${(noise*100).toFixed(0)}%`;

  // FULL PRO text
  const probs = softmaxProb(scoreMap);
  const topKeys = Object.keys(probs).sort((a,b)=>probs[b]-probs[a]).slice(0,topShow);
  const topLine = topKeys.map(k=>`${k}(${Math.round(probs[k]*100)}%)`).join("  ");

  const hot15 = flags.hotTop.slice(0,15).map(([k,v])=>`${k}‚Üí${v}`).join("  ");
  const gan15 = Object.entries(meta).map(([k,m])=>[k,m.gan]).filter(([,g])=>g!==Infinity)
                   .sort((a,b)=>b[1]-a[1]).slice(0,15).map(([k,g])=>`${k}‚Üí${g}`).join("  ");
  const dauCounts = countHeadTail(days.slice(-win));
  const trucTop = flags.trucTop.slice(0,30).map(([k,v])=>v>0?`${k}`:null).filter(Boolean).join(" ");

  const g7SeedLine = [...new Set(flags.g7Seeds)].sort().slice(0,24).join(" ");
  const pasSeedLine = [...new Set(flags.pasSeeds)].sort().slice(0,24).join(" ");

  const explainTop = explainTopN(scoreMap, meta, 6);

  fullPro.textContent =
`===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++ ‚Ä¢ HIT@3>=2) =====
T·ªïng ng√†y d√πng: ${validCount}

AI ƒê·ªåC PHA:
Pha: ${pha} | H∆∞·ªõng: ${huong} | Tin c·∫≠y (calib): ${(conf*100).toFixed(0)}%
Nh·∫≠n ƒë·ªãnh: ${mode==="B_MODE_DAN10" ? "Nhi·ªÖu cao ‚Üí ∆∞u ti√™n B_MODE (d√†n/gi·∫£m ti·ªÅn)." : "C√≥ th·ªÉ ch·ªët 3 theo t·ªëi ∆∞u HIT + anti-c·ª•m."}

TOP ${topShow} (tham kh·∫£o) + %:
${topLine}

CH·ªêT (3 s·ªë, t·ªëi ∆∞u HIT@3>=2):
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•: ${sub}
‚ûï K√®m:  ${add}

3 C·∫¢NH B√ÅO M·∫†NH:
1) ${warns[0]||"-"}
2) ${warns[1]||"-"}
3) ${warns[2]||"-"}

NOTE:
MODE: ${mode} ‚Ä¢ trust ${(trust*100).toFixed(0)}% ‚Ä¢ noise ${(noise*100).toFixed(0)}%

===== SOI FULL LOTO 2 S·ªê (FULL PRO) =====
[1] HOT (15): ${hot15}
[2] GAN (15): ${gan15 || "(kh√¥ng ƒë·ªß d·ªØ li·ªáu)"}
[3] ƒê·∫¶U/ƒêU√îI Top5 (K=${win}):
  ƒê·∫ßu: ${dauCounts.headTop5}
  ƒêu√¥i: ${dauCounts.tailTop5}
[4] TR·ª§C n·ªïi (>=${Number($("trucTh").value)||4}): ${trucTop || "(ch∆∞a n·ªïi)"}
[5] G7 lead set (k√®+b√≥ng): ${g7SeedLine}
[6] PASCAL seed: ${pasSeedLine}

[7] GI·∫¢I TH√çCH TOP (A=CORE):
${explainTop}

WEIGHTS (UI ‚Äî ƒë·ªÉ tham kh·∫£o/soi full):
wHot=${Number($("wHot").value)||2} | wGan=${Number($("wGan").value)||1.5} | wPas=${Number($("wPas").value)||2} | wTruc=2.4 | wG7=0.9

* Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.`;
}

function countHeadTail(useDays){
  const headC = Array(10).fill(0);
  const tailC = Array(10).fill(0);
  for(const d of useDays){
    for(const n of d.loto2){
      headC[head(n)]++;
      tailC[tail(n)]++;
    }
  }
  const headTop = headC.map((v,i)=>[i,v]).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([i,v])=>`${i}(${v})`).join("  ");
  const tailTop = tailC.map((v,i)=>[i,v]).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([i,v])=>`${i}(${v})`).join("  ");
  return {headTop5: headTop, tailTop5: tailTop};
}

function explainTopN(scoreMap, meta, N){
  const arr = Object.entries(scoreMap).sort((a,b)=>b[1]-a[1]).slice(0,N);
  let out = "";
  for(let i=0;i<arr.length;i++){
    const [k,sc] = arr[i];
    const m = meta[k] || {};
    const g = (m.gan===Infinity) ? "‚àû" : m.gan;
    out += `${i+1}) ${k} | score ${sc.toFixed(2)} | hot:${m.hot} | gan:${g} | truc:${m.truc} | g7:${m.g7?"Y":"-"} | pas:${m.pas?"Y":"-"} | dau:Y | duoi:Y\n`;
  }
  return out.trimEnd();
}

/* =========================
   OCR Debug Formatting
   ========================= */
function updateDebug(day){
  const lines = [];
  lines.push("[DB_5DIG]");
  lines.push(day.db5 || "(null)");
  lines.push("");
  lines.push("[G7_LINE]");
  lines.push(day.g7 ? day.g7.join(" ") : "(null)");
  lines.push("");
  lines.push("[G6_LINE]");
  lines.push(day.g6 ? day.g6.join(" ") : "(null)");
  lines.push("");
  lines.push(`[LOTO2 uniq] ${day.loto2 ? [...day.loto2].sort().join(" ") : "(null)"}`);
  dbg.textContent = lines.join("\n");
}

/* =========================
   UI Actions
   ========================= */
$("btnUpload").onclick = ()=>$("file").click();
$("btnCamera").onclick = ()=>{
  // mobile: d√πng input capture n·∫øu mu·ªën
  $("file").setAttribute("capture","environment");
  $("file").click();
};
$("btnPaste").onclick = ()=>{
  const sample =
`[UPPER_OCR]
X·ªï s·ªë Mi·ªÅn B·∫Øc
[DB_5DIG]
01377
[LOWER_OCR]
1 62903
2 18387 07354
3 10059 81560 41701
37260 17099 22989
4 6605 3887 2927 2963
5 1390 7638 4761
2703 7094 7161
6 431 107 573
7 58 03 47 05
[G7_LINE]
7 1 58 03 47 05
[G6_LINE]
6 431 107 573`;
  ocrText.value = sample;
};

$("btnClear").onclick = ()=>{
  ocrText.value="";
  dbg.textContent="";
  state.lastParsed=null;
  stGate.textContent="‚óè Gate: ‚Äî";
  stGate.className="chip";
  stOcr.textContent="‚óè OCR: idle";
  state.batchOK=0; state.batchFail=0;
  stBatch.textContent=`‚óè Batch: OK 0 | FAIL 0`;
};

$("btnRun").onclick = ()=>{
  const txt = (ocrText.value||"").trim();
  if(!txt){
    alert("Ch∆∞a c√≥ OCR text. B·∫°n d√°n OCR v√†o √¥ Debug OCR ho·∫∑c upload ·∫£nh (n·∫øu b·∫°n c√≥ OCR runtime).");
    return;
  }
  const day = addDayFromOCR(txt);
  const pass = gatePass(day);

  stGate.textContent = `‚óè Gate: ${pass ? "PASS" : "FAIL"}`;
  stGate.className = `chip ${pass ? "good":"bad"}`;

  updateDebug(day);

  if(pass){
    upsertDay(day);
    state.batchOK++;
    stBatch.textContent = `‚óè Batch: OK ${state.batchOK} | FAIL ${state.batchFail}`;
    stOcr.textContent="‚óè OCR: batch done";
    // render full
    renderResult(state.days.slice(-(Number($("winDays").value)||20)));
  }else{
    state.batchFail++;
    stBatch.textContent = `‚óè Batch: OK ${state.batchOK} | FAIL ${state.batchFail}`;
    stOcr.textContent="‚óè OCR: done (gate fail)";
    alert("Gate FAIL: Thi·∫øu DB5/G7/G6 ƒë√∫ng format. B·∫°n ki·ªÉm tra l·∫°i crop ho·∫∑c OCR text.");
  }
};

/* Optional: image OCR placeholder (kh√¥ng b·∫Øt bu·ªôc) */
$("file").addEventListener("change", async (e)=>{
  const files=[...e.target.files||[]];
  if(!files.length) return;
  stOcr.textContent="‚óè OCR: running...";
  try{
    // N·∫øu b·∫°n c√≥ runtime OCR ri√™ng (Tesseract.js), b·∫°n thay ph·∫ßn n√†y.
    // ·ªû b·∫£n full single-file n√†y, m√¨nh kh√¥ng nh√∫ng th∆∞ vi·ªán ƒë·ªÉ tr√°nh n·∫∑ng.
    stOcr.textContent="‚óè OCR: (runtime not embedded) ‚Üí h√£y paste OCR text";
    alert("B·∫£n single-file n√†y kh√¥ng nh√∫ng OCR engine ƒë·ªÉ nh·∫π. B·∫°n d√πng OCR s·∫µn c·ªßa app b·∫°n (OpenCV/Tesseract) r·ªìi d√°n text v√†o √¥ Debug OCR nh√©.");
  }catch(err){
    stOcr.textContent="‚óè OCR: error";
    console.error(err);
  }finally{
    e.target.value="";
  }
});

/* Auto run n·∫øu c√≥ text */
ocrText.addEventListener("input", ()=>{
  // no auto-run ƒë·ªÉ b·∫°n ch·ªß ƒë·ªông, tr√°nh ‚Äúm√°y m√≥c‚Äù
});

/* init UI */
pickBig.textContent="‚Äî / ‚Äî / ‚Äî";
warnList.innerHTML="<li>‚Äî</li>";
fullPro.textContent="(ch∆∞a c√≥ d·ªØ li·ªáu)";

</script>
</body>
</html>
```Ó®Å0Ó®Ç
