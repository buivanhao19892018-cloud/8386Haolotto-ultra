<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (UPLOAD FIX)</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
body{
  background:#0b1220;
  color:#e5e7eb;
  font-family:system-ui;
  margin:0;padding:12px
}
.card{
  background:#0f172a;
  border-radius:16px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 0 0 1px rgba(255,255,255,.05)
}
h2{margin:0 0 6px;font-size:18px}
button{
  padding:12px 16px;
  border-radius:12px;
  border:none;
  background:#2563eb;
  color:white;
  font-weight:700;
  margin:6px 4px 6px 0
}
button.secondary{background:#334155}
button.red{background:#dc2626}
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:#1e293b;
  font-size:12px;
  margin:3px 3px 0 0
}
.ok{color:#22c55e}
.fail{color:#ef4444}
textarea{
  width:100%;
  min-height:140px;
  border-radius:12px;
  padding:10px;
  background:#020617;
  color:#e5e7eb;
  border:1px solid rgba(255,255,255,.1)
}
.fileHidden{
  position:absolute;
  left:-9999px;
  width:1px;
  height:1px;
  opacity:0;
}
pre{
  background:#020617;
  border-radius:12px;
  padding:10px;
  overflow:auto;
  font-size:12px
}
</style>
</head>

<body>

<div class="card">
<h2>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL)</h2>
<div class="badge ok">OpenCV: simulated</div>
<div class="badge ok">Tesseract OCR</div>
<div class="badge">Gate c·ª©ng</div>

<p>Lu·ªìng chu·∫©n: Upload ·∫£nh ‚Üí OCR ‚Üí Parse DB/G6/G7 ‚Üí Gate pass ‚Üí FULL</p>

<input id="file" type="file" accept="image/*" multiple class="fileHidden">

<label for="file">
  <button type="button">üì∏ Upload nhi·ªÅu ·∫£nh</button>
</label>

<button id="btnClear" class="red">X√≥a</button>
<button id="btnRun" class="secondary">üöÄ Ch·∫°y FULL</button>

<div id="status" class="badge">Ch∆∞a c√≥ ·∫£nh</div>
</div>

<div class="card">
<h3>Debug OCR</h3>
<pre id="debug"></pre>
</div>

<div class="card">
<h3>D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h3>
<textarea id="inputData"></textarea>
</div>

<div class="card">
<h3>K·∫øt qu·∫£ FULL</h3>
<pre id="output"></pre>
</div>

<script>
const el = id => document.getElementById(id);

let rows = [];
let debugLog = [];

el("file").addEventListener("change", async e=>{
  rows = [];
  debugLog = [];
  const files = [...e.target.files];
  el("status").textContent = "OCR ƒëang ch·∫°y: " + files.length + " ·∫£nh...";

  for(const file of files){
    await processImage(file);
  }

  el("status").textContent = `Batch xong: OK ${rows.length} ·∫£nh`;
  el("inputData").value = rows.join("\n");
});

async function processImage(file){
  const worker = await Tesseract.createWorker("eng");
  const imgURL = URL.createObjectURL(file);
  const res = await worker.recognize(imgURL);
  const raw = res.data.text;
  await worker.terminate();

  debugLog.push("RAW OCR:\n" + raw);

  const parsed = parseOCR(raw);
  if(parsed){
    rows.push(parsed);
  } else {
    debugLog.push("‚ùå FAIL PARSE");
  }

  el("debug").textContent = debugLog.join("\n\n-----------------\n");
}

function normalize(txt){
  return txt.replace(/O/g,"0").replace(/I/g,"1").replace(/l/g,"1");
}

function parseOCR(text){
  text = normalize(text);

  // DB = t√¨m nh√£n ƒêB + 5 s·ªë
  let dbMatch = text.match(/ƒêB\s*([0-9]{5})/);
  let db = dbMatch ? dbMatch[1].slice(-2) : null;

  // G7 = d√≤ng c√≥ 4 s·ªë 2 ch·ªØ s·ªë
  let g7 = null;
  let lines = text.split("\n");
  for(let line of lines){
    let nums = line.match(/\b\d{2}\b/g);
    if(nums && nums.length >= 4){
      g7 = nums.slice(0,4);
      break;
    }
  }

  // G6 = d√≤ng c√≥ 3 s·ªë 3 ch·ªØ s·ªë
  let g6 = null;
  for(let line of lines){
    let nums = line.match(/\b\d{3}\b/g);
    if(nums && nums.length >= 3){
      g6 = nums.slice(0,3);
      break;
    }
  }

  debugLog.push("PARSED DB=" + db + " | G7=" + g7 + " | G6=" + g6);

  if(!db || !g7 || !g6) return null;

  return `DB ${db} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`;
}

el("btnRun").onclick = ()=>{
  const lines = el("inputData").value.trim().split("\n").filter(Boolean);
  if(lines.length < 5){
    el("output").textContent = "‚ùå C·∫ßn √≠t nh·∫•t 5 ng√†y d·ªØ li·ªáu";
    return;
  }

  let freq = {};
  for(const line of lines){
    const nums = line.match(/\b\d{2}\b/g) || [];
    nums.forEach(n=>freq[n]=(freq[n]||0)+1);
  }

  let sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]);

  let out = `T·ªïng ng√†y: ${lines.length}\n\nTOP HOT:\n`;
  sorted.slice(0,15).forEach(([n,c])=>{
    out += `${n} ‚Üí ${c}\n`;
  });

  out += `\nüéØ Ch·ªët g·ª£i √Ω:\nCh√≠nh: ${sorted[0]?.[0] || "--"}\nPh·ª•: ${sorted[1]?.[0] || "--"}`;

  el("output").textContent = out;
};

el("btnClear").onclick = ()=>{
  rows = [];
  debugLog = [];
  el("inputData").value = "";
  el("output").textContent = "";
  el("debug").textContent = "";
  el("status").textContent = "ƒê√£ reset";
};
</script>

</body>
</html>
