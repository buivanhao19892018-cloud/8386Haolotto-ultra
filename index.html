<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v4 ‚Ä¢ GOD MODE)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.08);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#ff4d4f;
      --btn:#1e5eff;
      --btn2:#1a3fa8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 10% -20%, rgba(30,94,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(50,213,131,.18), transparent 55%),
        linear-gradient(180deg, #06101f, #050b16 45%, #050a13);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      margin-bottom:14px;
    }
    h1{margin:0 0 8px;font-size:22px;letter-spacing:.2px}
    .pillrow{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}
    .pill{
      padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{display:inline-block;width:8px;height:8px;border-radius:99px;margin-right:6px;vertical-align:middle}
    .g{background:var(--good)} .y{background:var(--warn)} .r{background:var(--bad)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px}
    .btn{
      appearance:none;border:0;cursor:pointer;
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:white;font-weight:800;
      padding:12px 14px;border-radius:14px;
      box-shadow:0 10px 18px rgba(30,94,255,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;color:var(--text);
    }
    .btn.danger{
      background:linear-gradient(180deg,#ff4d4f,#b42318);
      box-shadow:0 10px 18px rgba(255,77,79,.18);
    }
    .hint{color:var(--muted);line-height:1.45;font-size:13px;margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:860px){ .grid{grid-template-columns:1.2fr .8fr} }
    .preview{
      width:100%;
      border-radius:16px;border:1px solid var(--line);
      background:#060b13;overflow:hidden;
    }
    canvas, img{display:block;width:100%;height:auto}
    .status{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .badge{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:800;font-size:12px
    }
    .badge.ok{color:var(--good)}
    .badge.fail{color:var(--bad)}
    .badge.warn{color:var(--warn)}
    .sectionTitle{font-size:18px;margin:0 0 6px}
    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      color:#d7e2ff;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .inputs{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:700px){ .inputs{grid-template-columns:1fr 1fr} }
    .field{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input, .field textarea, .field select{
      width:100%;border:0;outline:none;background:transparent;
      color:var(--text);font-size:14px;padding:6px 0;
    }
    textarea{min-height:150px;resize:vertical}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .split .field{flex:1;min-width:180px}
    .kpi{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;margin-top:10px;
    }
    @media(min-width:700px){ .kpi{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .kpi .box{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      padding:10px;
    }
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:16px;font-weight:900;margin-top:4px}
    .god{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;margin-top:10px;
    }
    @media(min-width:860px){ .god{grid-template-columns:1fr 1fr} }
    .callout{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:14px;
      padding:10px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.45;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- =========================
       1) SCAN PRO (GI·ªÆ NGUY√äN)
       ========================= -->
  <div class="card">
    <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v4 ‚Ä¢ GOD MODE)</h1>
    <div class="pillrow">
      <div class="pill"><span class="dot g"></span>OpenCV</div>
      <div class="pill"><span class="dot g"></span>Tesseract OCR</div>
      <div class="pill"><span class="dot y"></span>Gate c·ª©ng</div>
      <div class="pill"><span class="dot y"></span>Batch nhi·ªÅu ·∫£nh</div>
      <div class="pill"><span class="dot y"></span>DB theo nh√£n ‚ÄúƒêB/DB‚Äù + 5 s·ªë</div>
      <div class="pill"><span class="dot y"></span>G7/G6 theo pattern (kh√¥ng c·∫ßn s·ªë 6/7)</div>
      <div class="pill"><span class="dot g"></span>‚úÖ Kh√¥ng ph√° scan / scale</div>
    </div>

    <div class="hint">
      Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí <b>DB</b> theo nh√£n ƒêB/DB + 5 s·ªë ‚Üí <b>G7</b> 4 s·ªë 2 ch·ªØ s·ªë ‚Üí <b>G6</b> 3 s·ªë 3 ch·ªØ s·ªë ‚Üí
      <b>Gate PASS</b> m·ªõi ƒë·ªï d·ªØ li·ªáu ‚Üí b·∫•m <b>Ch·∫°y FULL</b>.
      <br/><b>* Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</b>
    </div>

    <div class="row">
      <button class="btn" id="btnMulti">üì∏ Upload nhi·ªÅu ·∫£nh</button>
      <button class="btn ghost" id="btnCam">üì∑ Camera</button>
      <button class="btn ghost" id="btnSample">D√°n m·∫´u</button>
      <button class="btn danger" id="btnClear">X√≥a</button>
      <input id="fileMulti" type="file" accept="image/*" multiple hidden />
      <input id="fileCam" type="file" accept="image/*" capture="environment" hidden />
    </div>

    <div class="status">
      <div class="badge ok" id="stCv">‚óè OpenCV: loading‚Ä¶</div>
      <div class="badge ok" id="stOcr">‚óè OCR: idle</div>
      <div class="badge warn" id="stGate">‚óè Gate: waiting</div>
      <div class="badge warn" id="stBatch">‚óè Batch: 0</div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <h2 class="sectionTitle">·∫¢nh ‚Üí OCR ‚Üí Gate</h2>
        <div class="hint">M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab v√† header qu·∫£ng c√°o.</div>

        <div class="preview" style="margin-top:10px">
          <img id="imgPreview" alt="preview" />
          <canvas id="cvCanvas" style="display:none"></canvas>
        </div>

        <div class="kpi">
          <div class="box"><div class="t">DB (2 s·ªë)</div><div class="v" id="kDB">--</div></div>
          <div class="box"><div class="t">G6 (3 s·ªë)</div><div class="v" id="kG6">--</div></div>
          <div class="box"><div class="t">G7 (4 s·ªë)</div><div class="v" id="kG7">--</div></div>
          <div class="box"><div class="t">Gate</div><div class="v" id="kGate">--</div></div>
        </div>

        <div class="inputs">
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî DB (2 s·ªë)</label>
            <input id="manualDB" placeholder="VD: 45" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G6 (3 s·ªë 3 ch·ªØ s·ªë)</label>
            <input id="manualG6" placeholder="VD: 392 255 854" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G7 (4 s·ªë 2 ch·ªØ s·ªë)</label>
            <input id="manualG7" placeholder="VD: 03 82 85 81" />
          </div>
          <div class="field">
            <label>H√†nh ƒë·ªông</label>
            <div class="split">
              <button class="btn ghost" id="btnApplyManual">√Åp manual ‚Üí th√™m d√≤ng</button>
              <button class="btn ghost" id="btnRetryLast">Th·ª≠ OCR l·∫°i ·∫£nh cu·ªëi</button>
            </div>
          </div>
        </div>
      </div>

      <div>
        <h2 class="sectionTitle">Debug OCR</h2>
        <div class="mono" id="dbg">Ch∆∞a c√≥ OCR.</div>
      </div>
    </div>
  </div>

  <!-- =========================
       2) INPUT DATA + GOD MODE
       ========================= -->
  <div class="card">
    <h2 class="sectionTitle">D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h2>
    <div class="hint">Format: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b> (newest ·ªü tr√™n)</div>
    <div class="field" style="margin-top:10px">
      <textarea id="inputData" placeholder="Sau batch scan, tool t·ª± ƒë·ªï v√†o ƒë√¢y..."></textarea>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="field">
        <label>C·ª≠a s·ªï ng√†y (khuy·∫øn ngh·ªã)</label>
        <input id="winDays" type="number" value="20" min="10" max="60" />
      </div>
      <div class="field">
        <label>Top hi·ªÉn th·ªã (tham kh·∫£o)</label>
        <input id="topN" type="number" value="10" min="10" max="10" />
      </div>
      <div class="field">
        <label>AI gi√°m s√°t</label>
        <select id="aiSup">
          <option value="on" selected>ON (kh√≥a theo pha)</option>
          <option value="off">OFF</option>
        </select>
      </div>
      <div class="field">
        <label>Ng∆∞·ª°ng TR·ª§C n·ªïi (>=)</label>
        <input id="trucThreshold" type="number" value="4" min="2" max="10" />
      </div>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="field">
        <label>K ƒë·ªçc pha (ng√†y g·∫ßn nh·∫•t)</label>
        <input id="phaseK" type="number" value="9" min="5" max="20" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Hot</label>
        <input id="wHot" type="number" value="2" step="0.5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Gan</label>
        <input id="wGan" type="number" value="1.5" step="0.5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Pascal</label>
        <input id="wPas" type="number" value="2" step="0.5" />
      </div>
    </div>

    <div class="god">
      <div class="callout">
        <b>MASTER+++:</b> App s·∫Ω <b>ƒê·ªåC PHA TR∆Ø·ªöC</b> ‚Üí k·∫øt lu·∫≠n h√¥m nay n√™n ƒÉn theo <b>TR·ª§C+GAN</b> hay <b>G7/G6</b> hay <b>N√â NG√ÄY</b> ‚Üí
        r·ªìi m·ªõi <b>SOI FULL LOTO 2 S·ªê</b> (kh√¥ng ƒëo√°n b·ª´a).
      </div>
      <div class="callout">
        <b>Khuy·∫øn ngh·ªã s·ªë ng√†y:</b> <b>20</b> ·ªïn nh·∫•t. D·ªØ li·ªáu √≠t: 12‚Äì15. Tr√°nh >30 v√¨ lo√£ng & pha c≈©.
        <br/><b>L∆∞u √Ω th∆∞∆°ng m·∫°i:</b> app c√≥ th·ªÉ n√≥i th·∫≥ng: <b>‚ÄúKH√îNG N√äN ƒê√ÅNH‚Äù</b> khi P4/nhi·ªÖu.
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btnFull">üöÄ Ch·∫°y FULL (Pha ‚Üí Soi Loto ‚Üí Anti-b·∫´y)</button>
    </div>
  </div>

  <!-- =========================
       3) OUTPUT
       ========================= -->
  <div class="card">
    <h2 class="sectionTitle">K·∫æT QU·∫¢ FULL</h2>
    <div class="mono" id="out">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
  </div>

  <div class="card">
    <div class="small">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
  </div>

</div>

<!-- Load libs -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>

<script>
/* =========================================================
   PH·∫¶N 1 ‚Äî SCAN PRO (GI·ªÆ NGUY√äN LOGIC)
========================================================= */
let cvReady = false;
let lastImageBlob = null;
let batchOK = 0, batchFail = 0;

const el = (id)=>document.getElementById(id);

function setBadge(id, text, cls){
  const e = el(id);
  e.textContent = text;
  e.classList.remove("ok","warn","fail");
  e.classList.add(cls);
}

function setStatus(){
  setBadge("stCv", `‚óè OpenCV: ${cvReady ? "OK" : "loading‚Ä¶"}`, cvReady ? "ok" : "warn");
  setBadge("stBatch", `‚óè Batch: OK ${batchOK} | FAIL ${batchFail}`, (batchFail>0) ? "warn" : "ok");
}

function showKPI(db2, g6, g7, gate){
  el("kDB").textContent = db2 || "--";
  el("kG6").textContent = g6?.length ? g6.join(" ") : "--";
  el("kG7").textContent = g7?.length ? g7.join(" ") : "--";
  el("kGate").textContent = gate;
}

function onOpenCvReady(){
  cvReady = true;
  setStatus();
}

setStatus();

function pad2(n){ return String(n).padStart(2,"0"); }

function canvasFromMat(mat){
  const canvas = document.createElement("canvas");
  canvas.width = mat.cols;
  canvas.height = mat.rows;
  cv.imshow(canvas, mat);
  return canvas;
}

function preprocess(mat){
  const gray = new cv.Mat();
  cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY, 0);
  const blur = new cv.Mat();
  cv.GaussianBlur(gray, blur, new cv.Size(3,3), 0, 0, cv.BORDER_DEFAULT);

  const thr = new cv.Mat();
  cv.adaptiveThreshold(
    blur, thr, 255,
    cv.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv.THRESH_BINARY, 31, 8
  );

  gray.delete(); blur.delete();
  return thr;
}

async function ocrText(canvas){
  const res = await Tesseract.recognize(canvas, "eng", {
    logger: ()=>{},
    tessedit_char_whitelist: "0123456789",
    preserve_interword_spaces: "1",
  });
  return (res.data.text || "");
}

function cleanOCRDigits(txt){
  return String(txt)
    .replace(/[Oo]/g,"0")
    .replace(/[Il|]/g,"1")
    .replace(/S/g,"5")
    .replace(/B/g,"8")
    .replace(/[^\d\s\n]/g," ")
    .replace(/\s+\n/g,"\n")
    .replace(/\n\s+/g,"\n")
    .replace(/[ \t]+/g," ")
    .trim();
}

function extractDB5_fromLabel(text){
  const t = text.replace(/\s+/g," ");
  let m = t.match(/(?:ƒê\s*B|D\s*B)\s*(\d{5})/);
  if(m) return m[1];
  m = t.match(/\b\d{5}\b/);
  return m ? m[0] : "";
}

function findG7Line(lines){
  for(let i=lines.length-1;i>=0;i--){
    const nums2 = (lines[i].match(/\b\d{2}\b/g) || []);
    if(nums2.length >= 4){
      return {arr: nums2.slice(0,4), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}

function findG6Line(lines, g7Index){
  for(let i=g7Index-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  for(let i=lines.length-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}

function gateCheck(db5, g6_3, g7_4){
  if(!/^\d{5}$/.test(db5)) return {ok:false, reason:"DB kh√¥ng ƒë·ªß 5 s·ªë"};
  if(!g7_4 || g7_4.length!==4 || !g7_4.every(x=>/^\d{2}$/.test(x))) return {ok:false, reason:"G7 ph·∫£i ƒë√∫ng 4 s·ªë (2 ch·ªØ s·ªë)"};
  if(!g6_3 || g6_3.length!==3 || !g6_3.every(x=>/^\d{3}$/.test(x))) return {ok:false, reason:"G6 ph·∫£i ƒë√∫ng 3 s·ªë (3 ch·ªØ s·ªë)"};
  return {ok:true, reason:"OK"};
}

function addLineToInput(db5, g7, g6){
  const db2 = db5.slice(-2);
  const line = `DB ${db2} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`;
  const cur = el("inputData").value.trim();
  el("inputData").value = (cur ? cur + "\n" : "") + line;
}

async function runOCRFromBlob(blob){
  if(!cvReady){
    alert("OpenCV ch∆∞a load xong. ƒê·ª£i 2‚Äì3 gi√¢y r·ªìi th·ª≠ l·∫°i.");
    return;
  }
  lastImageBlob = blob;

  setBadge("stOcr", "‚óè OCR: running‚Ä¶", "warn");
  setBadge("stGate", "‚óè Gate: checking‚Ä¶", "warn");
  showKPI("", [], [], "--");

  const url = URL.createObjectURL(blob);
  el("imgPreview").src = url;

  await new Promise(r=>{
    el("imgPreview").onload = ()=>r();
  });

  const img = el("imgPreview");
  const canvas = el("cvCanvas");
  canvas.style.display = "none";
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0);

  let src = cv.imread(canvas);
  const W = src.cols, H = src.rows;
  const crop = src.roi(new cv.Rect(
    Math.floor(W*0.02),
    Math.floor(H*0.02),
    Math.floor(W*0.96),
    Math.floor(H*0.96)
  ));
  src.delete(); src = crop;

  const upH = Math.floor(src.rows * 0.55);
  const upper = src.roi(new cv.Rect(0,0, src.cols, upH));
  const body  = src.roi(new cv.Rect(0, Math.floor(src.rows*0.35), src.cols, Math.floor(src.rows*0.65)));

  const upperBin = preprocess(upper);
  const upperCanvas = canvasFromMat(upperBin);
  const upperTxt1 = await ocrText(upperCanvas);

  const upperInv = new cv.Mat(); cv.bitwise_not(upperBin, upperInv);
  const upperCanvas2 = canvasFromMat(upperInv);
  const upperTxt2 = await ocrText(upperCanvas2);

  const upperTxt = cleanOCRDigits((upperTxt1||"") + "\n" + (upperTxt2||""));
  const db5 = extractDB5_fromLabel(upperTxt);

  upper.delete(); upperBin.delete(); upperInv.delete();

  const bodyBin = preprocess(body);
  const bodyCanvas = canvasFromMat(bodyBin);
  const bodyTxt1 = await ocrText(bodyCanvas);

  const bodyInv = new cv.Mat(); cv.bitwise_not(bodyBin, bodyInv);
  const bodyCanvas2 = canvasFromMat(bodyInv);
  const bodyTxt2 = await ocrText(bodyCanvas2);

  const bodyTxt = cleanOCRDigits((bodyTxt1||"") + "\n" + (bodyTxt2||""));
  const lines = bodyTxt.split("\n").map(s=>s.trim()).filter(Boolean);

  const g7Found = findG7Line(lines);
  const g6Found = findG6Line(lines, g7Found.idx);

  const g7 = g7Found.arr;
  const g6 = g6Found.arr;

  body.delete(); bodyBin.delete(); bodyInv.delete();
  src.delete();
  URL.revokeObjectURL(url);

  const gate = gateCheck(db5, g6, g7);
  const db2 = (/^\d{5}$/.test(db5)) ? db5.slice(-2) : "";

  el("dbg").textContent =
`[UPPER_OCR]
${upperTxt || "(empty)"}

[DB_5DIG]
${db5 || "(none)"}

[LOWER_OCR]
${bodyTxt || "(empty)"}

[G7_LINE]
${g7Found.line || "(none)"}

[G6_LINE]
${g6Found.line || "(none)"}
`;

  showKPI(db2, g6, g7, gate.ok ? "PASS" : "FAIL");
  setBadge("stOcr", "‚óè OCR: done", "ok");
  if(gate.ok){
    setBadge("stGate", "‚óè Gate: PASS", "ok");
    addLineToInput(db5, g7, g6);
    batchOK++;
  }else{
    setBadge("stGate", `‚óè Gate: FAIL ‚Äî ${gate.reason}`, "fail");
    batchFail++;
    el("manualDB").value = db2 || "";
    el("manualG6").value = g6.length ? g6.join(" ") : "";
    el("manualG7").value = g7.length ? g7.join(" ") : "";
  }
  setStatus();
}

function parseManual(){
  const db2 = (el("manualDB").value || "").replace(/\D/g,"").slice(-2);
  const g6 = (el("manualG6").value || "").match(/\b\d{3}\b/g) || [];
  const g7 = (el("manualG7").value || "").match(/\b\d{2}\b/g) || [];
  if(db2.length!==2) return {ok:false, msg:"DB manual ph·∫£i ƒë√∫ng 2 s·ªë"};
  if(g6.length<3) return {ok:false, msg:"G6 manual ph·∫£i ƒë·ªß 3 s·ªë (3 ch·ªØ s·ªë)"};
  if(g7.length<4) return {ok:false, msg:"G7 manual ph·∫£i ƒë·ªß 4 s·ªë (2 ch·ªØ s·ªë)"};
  const fakeDB5 = "000" + db2;
  return {ok:true, fakeDB5, g6:g6.slice(0,3), g7:g7.slice(0,4)};
}

el("btnApplyManual").onclick = ()=>{
  const r = parseManual();
  if(!r.ok){ alert(r.msg); return; }
  addLineToInput(r.fakeDB5, r.g7, r.g6);
  setBadge("stGate","‚óè Gate: MANUAL OK","ok");
};

el("btnMulti").onclick = ()=> el("fileMulti").click();
el("btnCam").onclick   = ()=> el("fileCam").click();

el("fileMulti").addEventListener("change", async (e)=>{
  const files = [...(e.target.files || [])];
  if(!files.length) return;

  setBadge("stOcr","‚óè OCR: batch running‚Ä¶","warn");
  batchOK = 0; batchFail = 0;
  setStatus();

  for(const f of files){
    await runOCRFromBlob(f);
    await new Promise(r=>setTimeout(r, 120));
  }
  setBadge("stOcr","‚óè OCR: batch done","ok");
});

el("fileCam").addEventListener("change", async (e)=>{
  const f = (e.target.files || [])[0];
  if(!f) return;
  await runOCRFromBlob(f);
});

el("btnRetryLast").onclick = async ()=>{
  if(!lastImageBlob){ alert("Ch∆∞a c√≥ ·∫£nh n√†o ƒë·ªÉ retry."); return; }
  await runOCRFromBlob(lastImageBlob);
};

el("btnClear").onclick = ()=>{
  el("inputData").value = "";
  el("out").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
  el("dbg").textContent = "Ch∆∞a c√≥ OCR.";
  batchOK=0; batchFail=0;
  setBadge("stOcr","‚óè OCR: idle","ok");
  setBadge("stGate","‚óè Gate: waiting","warn");
  setStatus();
  showKPI("", [], [], "--");
};

el("btnSample").onclick = ()=>{
  el("inputData").value =
`DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 21 | G7: 76 47 21 77 | G6: 801 295 993
DB 14 | G7: 81 87 60 32 | G6: 206 200 971
DB 80 | G7: 22 20 16 61 | G6: 733 014 672`;
};

/* =========================================================
   PH·∫¶N 2 ‚Äî ENGINE GOD MODE v4 (MASTER+++)
   - Parse -> ƒê·ªçc pha -> Quy·∫øt ƒë·ªãnh h∆∞·ªõng -> Soi full -> Top10 + Ch·ªët 2‚Äì3
========================================================= */

/* ---------- Parse lines ---------- */
function parseLines(){
  const raw = el("inputData").value.trim().split("\n").map(s=>s.trim()).filter(Boolean);
  const win = Math.min(Math.max(10, parseInt(el("winDays").value||"20",10)), 60);
  const slice = raw.slice(0, win); // newest ·ªü tr√™n
  const days = [];

  for(const line of slice){
    const dbm = line.match(/DB\s+(\d{2})/);
    const g7m = line.match(/G7:\s*([0-9 ]+)/);
    const g6m = line.match(/G6:\s*([0-9 ]+)/);
    if(!dbm || !g7m || !g6m) continue;

    const db2 = pad2(dbm[1]);
    const g7 = (g7m[1].match(/\b\d{2}\b/g)||[]).slice(0,4).map(pad2);
    const g6 = (g6m[1].match(/\b\d{3}\b/g)||[]).slice(0,3);
    const g6_2 = g6.map(x=>pad2(x.slice(-2)));

    const pool = [db2, ...g7, ...g6_2];
    days.push({db2, g7, g6_2, pool});
  }
  return days;
}

/* ---------- Core helpers ---------- */
function buildHeadTail(days, K){
  const h = {}; const t = {};
  days.slice(0,K).forEach(d=>{
    d.pool.forEach(n=>{
      const a=n[0], b=n[1];
      h[a]=(h[a]||0)+1;
      t[b]=(t[b]||0)+1;
    });
  });
  return {h,t};
}

function ganMap(days, K){
  const lastSeen = {};
  days.slice(0,K).forEach((d, idx)=>{
    d.pool.forEach(n=>{
      if(lastSeen[n]===undefined) lastSeen[n]=idx;
    });
  });
  const gan = {};
  for(let i=0;i<100;i++){
    const n = pad2(i);
    gan[n] = (lastSeen[n]===undefined) ? 999 : lastSeen[n];
  }
  return gan;
}

function makeTrucSet(topHeads, topTails){
  const s = new Set();
  for(const a of topHeads){
    for(const b of topTails){
      s.add(`${a}${b}`);
    }
  }
  return s;
}

function keSet(n2){
  const x = parseInt(n2,10);
  const prev = pad2((x+99)%100);
  const next = pad2((x+1)%100);
  const bong = pad2(99-x);
  return new Set([pad2(x), prev, next, bong]);
}

function pascalSeed(days){
  if(days.length<2) return new Set();
  const a = parseInt(days[0].db2,10);
  const b = parseInt(days[1].db2,10);
  const sum = pad2((a+b)%100);
  const dif = pad2((a-b+100)%100);
  const s = new Set([sum,dif]);
  [sum,dif].forEach(x=>{
    const rev = x[1]+x[0];
    s.add(rev);
    keSet(x).forEach(v=>s.add(v));
  });
  return s;
}

/* =========================================================
   AI ƒê·ªåC PHA ‚Äî MASTER+++ (pha‚Äìtr·ª•c‚Äìx·∫£‚Äìm·ªü)
========================================================= */
function detectPhase(days){
  const K = Math.min(Math.max(5, parseInt(el("phaseK").value||"9",10)), days.length);
  const ht = buildHeadTail(days, K);
  const headTop = Object.entries(ht.h).sort((a,b)=>b[1]-a[1]).slice(0,4).map(x=>x[0]);
  const tailTop = Object.entries(ht.t).sort((a,b)=>b[1]-a[1]).slice(0,4).map(x=>x[0]);
  const trucSet = makeTrucSet(headTop, tailTop);
  const g = ganMap(days, K);

  let hitTruc = 0, total=0;
  let ganLong = 0;
  let g7LeadHit = 0;

  for(let i=0;i<K;i++){
    const d = days[i];
    d.pool.forEach(n=>{
      total++;
      if(trucSet.has(n)) hitTruc++;
      const gv = g[n];
      if(gv>=5 && gv!==999) ganLong++;
    });
    if(i+1 < K){
      const lead = new Set();
      days[i+1].g7.forEach(x=>keSet(x).forEach(v=>lead.add(v)));
      const inter = d.pool.filter(n=>lead.has(n)).length;
      g7LeadHit += inter;
    }
  }

  const trucRatio = total ? hitTruc/total : 0;
  const ganRatio  = total ? ganLong/total : 0;
  const g7Ratio   = total ? g7LeadHit/(total) : 0;

  const freq = {};
  days.slice(0,K).forEach(d=>d.pool.forEach(n=>freq[n]=(freq[n]||0)+1));
  const topHot = Object.values(freq).sort((a,b)=>b-a)[0] || 0;
  const uniq = Object.keys(freq).length || 1;
  const noise = (uniq>0) ? (1 - (topHot/(K*8))) : 1;

  let pha="P3", dir="GIAO_THAO", conf=0.62, note="Giao thoa ‚Äì c·∫ßn l·ªçc tr√πng ƒëi·ªÅu ki·ªán.";

  if(noise>0.82 && trucRatio<0.16 && g7Ratio<0.18){
    pha="P4"; dir="NHIU_NANG"; conf=0.78;
    note="Nhi·ªÖu n·∫∑ng ‚Äì t√≠n hi·ªáu d·∫´n d·∫Øt y·∫øu. N√™n n√© ho·∫∑c ƒë√°nh c·ª±c nh·ªè.";
    return {pha,dir,conf,note,metrics:{trucRatio,ganRatio,g7Ratio,noise}, headTop, tailTop};
  }

  if(trucRatio>=0.20 && ganRatio>=0.18 && g7Ratio<0.22){
    pha = (ganRatio>=0.25) ? "P6" : "P2";
    dir = (pha==="P6") ? "TRUC_MO" : "TRUC_GAN";
    conf = Math.min(0.92, 0.68 + trucRatio + ganRatio);
    note = (pha==="P6")
      ? "M·ªû TR·ª§C ‚Äì gan v·ª´a/ƒë·ªß, tr·ª•c ƒëang n·ªï. ∆Øu ti√™n TR·ª§C + x√°c nh·∫≠n gan."
      : "TR·ª§C + GAN lead ‚Äì ∆∞u ti√™n tr·ª•c n·ªïi, tr√°nh b√°m c·ª•m G6/G7 thu·∫ßn.";
    return {pha,dir,conf,note,metrics:{trucRatio,ganRatio,g7Ratio,noise}, headTop, tailTop};
  }

  if(g7Ratio>=0.22 && trucRatio<0.20){
    pha="P1"; dir="THEO_G7"; conf=Math.min(0.90, 0.62 + g7Ratio);
    note="G7 lead ‚Äì ∆∞u ti√™n k·ªÅ/b√≥ng/ch·∫°m t·ª´ G7, tr·ª•c ch·ªâ d√πng x√°c nh·∫≠n.";
    return {pha,dir,conf,note,metrics:{trucRatio,ganRatio,g7Ratio,noise}, headTop, tailTop};
  }

  if(topHot>=4 && ganRatio<0.14 && noise<0.75){
    pha="P5"; dir="XA"; conf=0.74;
    note="Pha x·∫£ ‚Äì c·ª•m/hot d·ªÖ ƒë√°nh l·ª´a, gi·∫£m ti·ªÅn, tr√°nh all-in.";
    return {pha,dir,conf,note,metrics:{trucRatio,ganRatio,g7Ratio,noise}, headTop, tailTop};
  }

  return {pha,dir,conf,note,metrics:{trucRatio,ganRatio,g7Ratio,noise}, headTop, tailTop};
}

/* ---------- AI gi√°m s√°t kh√≥a tr·ªçng s·ªë theo pha ---------- */
function lockWeightsByPhase(phaObj){
  let wHot = parseFloat(el("wHot").value||"2");
  let wGan = parseFloat(el("wGan").value||"1.5");
  let wPas = parseFloat(el("wPas").value||"2");
  let wTruc = 1.2, wG7 = 1.0;

  if(el("aiSup").value==="off"){
    return {wHot,wGan,wPas,wTruc,wG7, locked:false};
  }

  if(phaObj.dir==="TRUC_GAN"){
    wHot = Math.min(wHot, 1.5);
    wGan = Math.max(wGan, 2.0);
    wTruc = 2.4;
    wG7 = 0.9;
  } else if(phaObj.dir==="TRUC_MO"){
    wHot = Math.min(wHot, 1.8);
    wGan = Math.max(wGan, 1.8);
    wTruc = 2.8;
    wG7 = 1.0;
  } else if(phaObj.dir==="THEO_G7"){
    wHot = Math.max(wHot, 2.0);
    wGan = Math.max(1.2, wGan);
    wTruc = 1.2;
    wG7 = 2.2;
  } else if(phaObj.dir==="XA"){
    wHot = Math.max(wHot, 2.2);
    wGan = Math.min(wGan, 1.2);
    wTruc = 1.0;
    wG7 = 1.0;
  } else if(phaObj.pha==="P4"){
    wHot = 1.0; wGan = 1.0; wPas = 1.0;
    wTruc = 0.8; wG7 = 0.8;
  }

  return {wHot,wGan,wPas,wTruc,wG7, locked:true};
}

/* =========================================================
   ENGINE v4: gi·∫£m l·ªách
   - KH√îNG sinh b·ª´a 00-99
   - Ch·ªâ sinh t·ª´ D√íNG D·∫™N (TR·ª§C ho·∫∑c G7 lead) r·ªìi m·ªõi L·ªåC PP
========================================================= */
function uniqArr(arr){
  const s = new Set(); const out = [];
  for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x);} }
  return out;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function reverse2(n){ return n[1]+n[0]; }
function is2(n){ return /^\d{2}$/.test(n); }

function buildLeadSetFromG7Prev(days){
  const idx = (days.length>=2) ? 1 : 0;
  const lead = new Set();
  const g7 = (days[idx]?.g7 || []).filter(is2);
  for(const x of g7){
    lead.add(x);
    keSet(x).forEach(v=>lead.add(v));
    const r = reverse2(x);
    lead.add(r);
    keSet(r).forEach(v=>lead.add(v));
  }
  return lead;
}

function buildTrucSetFromHT(days, K){
  const ht = buildHeadTail(days, K);
  const headTop = Object.entries(ht.h).sort((a,b)=>b[1]-a[1]).slice(0,4).map(x=>x[0]);
  const tailTop = Object.entries(ht.t).sort((a,b)=>b[1]-a[1]).slice(0,4).map(x=>x[0]);
  const trucSet = makeTrucSet(headTop, tailTop);
  return {trucSet, headTop, tailTop, ht};
}

function buildClusterSet(days){
  const N = Math.min(3, days.length);
  const cnt = {};
  for(let i=0;i<N;i++){
    for(const n of days[i].pool){
      cnt[n] = (cnt[n]||0)+1;
    }
  }
  const core = Object.entries(cnt).filter(([,c])=>c>=2).map(([n])=>n);
  const clu = new Set(core);
  for(const n of core){
    keSet(n).forEach(v=>clu.add(v));
    clu.add(reverse2(n));
  }
  return clu;
}

function buildChamTop(days, K){
  const digitCnt = Array(10).fill(0);
  days.slice(0,K).forEach(d=>{
    d.pool.forEach(n=>{
      digitCnt[parseInt(n[0],10)]++;
      digitCnt[parseInt(n[1],10)]++;
    });
  });
  return digitCnt.map((c,i)=>[String(i),c]).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
}

function shouldSkipByPhase(phaObj, days){
  if(days.length < 15) return {skip:true, reason:"Thi·∫øu d·ªØ li·ªáu (<15 ng√†y). Khuy·∫øn ngh·ªã 20 ng√†y ƒë·ªÉ ·ªïn ƒë·ªãnh pha."};
  if(phaObj.pha==="P4" || phaObj.dir==="NHIU_NANG") return {skip:true, reason:"P4 / Nhi·ªÖu n·∫∑ng: khuy·∫øn ngh·ªã N√â (ho·∫∑c ƒë√°nh c·ª±c nh·ªè)."};
  const m = phaObj.metrics || {};
  const tr = m.trucRatio ?? 0;
  const gr = m.g7Ratio ?? 0;
  const nz = m.noise ?? 0;
  if(tr < 0.18 && gr < 0.18 && nz > 0.78) return {skip:true, reason:"T√≠n hi·ªáu y·∫øu (tr·ª•c & g7 th·∫•p, noise cao) -> N√äN N√â."};
  return {skip:false, reason:"OK"};
}

function buildCandidatesByDir(days, phaObj){
  const K = Math.min(Math.max(5, parseInt(el("phaseK").value||"9",10)), days.length);
  const {trucSet, headTop, tailTop} = buildTrucSetFromHT(days, K);
  const leadSet = buildLeadSetFromG7Prev(days);

  let base = new Set();
  if(phaObj.dir==="TRUC_GAN" || phaObj.dir==="TRUC_MO") base = new Set(trucSet);
  else if(phaObj.dir==="THEO_G7") base = new Set(leadSet);
  else{
    const inter = [];
    trucSet.forEach(n=>{ if(leadSet.has(n)) inter.push(n); });
    if(inter.length>=3) base = new Set(inter);
    else{
      const tr = phaObj.metrics?.trucRatio ?? 0;
      const gr = phaObj.metrics?.g7Ratio ?? 0;
      base = new Set(tr>=gr ? trucSet : leadSet);
    }
  }
  return {base, trucSet, leadSet, headTop, tailTop};
}

function filterCandidates(days, phaObj, pack){
  const K = Math.min(Math.max(10, parseInt(el("winDays").value||"20",10)), days.length);
  const gan = ganMap(days, Math.min(12, K));
  const pas = pascalSeed(days);
  const cluster = buildClusterSet(days);
  const chamTop = buildChamTop(days, K);

  let arr = Array.from(pack.base).filter(is2);

  if(phaObj.dir==="TRUC_GAN" || phaObj.dir==="TRUC_MO") arr = arr.filter(n=>pack.trucSet.has(n));
  if(phaObj.dir==="THEO_G7") arr = arr.filter(n=>pack.leadSet.has(n));

  // lo·∫°i gan=0 v√† gan=‚àû
  arr = arr.filter(n=>{
    const g = gan[n];
    if(g===0) return false;
    if(g===999) return false;
    return true;
  });

  // ph·∫£i d√≠nh √≠t nh·∫•t 1 ch·∫°m top3
  arr = arr.filter(n=> chamTop.includes(n[0]) || chamTop.includes(n[1]) );

  if(arr.length > 10){
    return {ok:false, reason:`Candidate >10 (${arr.length}) -> t√≠n hi·ªáu lo√£ng, n√™n N√â ho·∫∑c gi·∫£m c·ª≠a s·ªï ng√†y.`, cands:[]};
  }

  // n·∫øu qu√° √≠t th√¨ n·ªõi nh·∫π b·∫±ng pas/cluster (v·∫´n trong base)
  if(arr.length < 2){
    const relax = Array.from(pack.base).filter(is2);
    const relaxed = relax.filter(n=>{
      const g = gan[n];
      if(g===0 || g===999) return false;
      const okCham = chamTop.includes(n[0]) || chamTop.includes(n[1]);
      const okBoost = pas.has(n) || cluster.has(n);
      return okCham && okBoost;
    });
    arr = uniqArr(relaxed).slice(0,10);
  }

  return {ok:true, reason:"OK", cands:arr, gan, pas, cluster, chamTop};
}

function scoreAndPick(days, phaObj, weights, pack, filt){
  const K = Math.min(Math.max(10, parseInt(el("winDays").value||"20",10)), days.length);

  const freq = {};
  days.slice(0,K).forEach(d=>d.pool.forEach(n=>freq[n]=(freq[n]||0)+1));

  const scored = filt.cands.map(n=>{
    const hot = freq[n]||0;
    const g = filt.gan[n];
    const ganFeat = (g>=2 && g<=9) ? 2 : 0;

    const isTruc = pack.trucSet.has(n) ? 1 : 0;
    const isLead = pack.leadSet.has(n) ? 1 : 0;
    const isPas  = filt.pas.has(n) ? 1 : 0;
    const isClu  = filt.cluster.has(n) ? 1 : 0;
    const isHead = pack.headTop.includes(n[0]) ? 1 : 0;
    const isTail = pack.tailTop.includes(n[1]) ? 1 : 0;

    let s =
      hot*weights.wHot +
      ganFeat*weights.wGan +
      isPas*weights.wPas +
      isClu*0.9 +
      (isHead+isTail)*0.35 +
      isTruc*weights.wTruc +
      isLead*weights.wG7;

    return {n, s, hot, gan:g, isTruc:!!isTruc, isLead:!!isLead, isPas:!!isPas, isClu:!!isClu, isHead:!!isHead, isTail:!!isTail};
  }).sort((a,b)=>b.s-a.s);

  const top10 = scored.slice(0,10);

  const pickCount = (phaObj.pha==="P6" && (phaObj.conf||0) >= 0.75) ? 3 : 2;
  const topPick = top10.slice(0, pickCount);

  const sum = top10.reduce((acc,x)=>acc + Math.max(0,x.s), 0) || 1;
  const pct = top10.map(x=>({n:x.n, p:(Math.max(0,x.s)/sum)*100}));

  return {top10, topPick, pct, freq};
}

function buildWarningsCommercial(phaObj, rank){
  const out = [];

  if(phaObj.pha==="P5" || phaObj.dir==="XA") out.push("‚ö†Ô∏è PHA X·∫¢: hot/c·ª•m d·ªÖ ƒë√°nh l·ª´a ‚Üí gi·∫£m ti·ªÅn, ch·ªâ ch·ªçn s·ªë giao thoa.");
  if(phaObj.pha==="P3") out.push("‚ö†Ô∏è GIAO THOA: TR·ª§C & G7 ch∆∞a r√µ ‚Üí ch·ªâ ch·ªçn s·ªë tr√πng ‚â•2 ti√™u ch√≠.");

  const topHot = Object.values(rank.freq||{}).sort((a,b)=>b-a)[0] || 0;
  if(topHot>=5) out.push("‚ö†Ô∏è B·∫™Y C·ª§M/HOT: hot d√†y ‚Üí d·ªÖ l·ªách, tr√°nh all-in theo c·ª•m.");

  let gan1 = 0;
  for(const x of rank.top10){ if(x.gan===1) gan1++; }
  if(gan1>=3) out.push("‚ö†Ô∏è B·∫™Y GAN NG·∫ÆN: nhi·ªÅu s·ªë gan=1 l·ªçt top ‚Üí d·ªÖ ƒë·∫£o nh·ªãp.");

  const tr = phaObj.metrics?.trucRatio ?? 0;
  const gr = phaObj.metrics?.g7Ratio ?? 0;
  if(tr>0.22 && gr>0.22) out.push("‚ö†Ô∏è ƒê·∫¢O PHA: TR·ª§C & G7 c√πng m·∫°nh ‚Üí ch·ªâ l·∫•y s·ªë giao thoa.");

  const uniq = uniqArr(out);
  while(uniq.length<3) uniq.push("‚úÖ OK: ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).");
  return uniq.slice(0,3);
}

function renderReport(days, phaObj, weights, filt, pack, rank, skipObj){
  if(skipObj?.skip){
    return (
`===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++) =====
T·ªïng ng√†y d√πng: ${days.length}

K·∫æT LU·∫¨N: KH√îNG N√äN ƒê√ÅNH
L√Ω do: ${skipObj.reason}

* G·ª£i √Ω: d√πng 20 ng√†y, newest ·ªü tr√™n, crop ·∫£nh s·∫°ch.
`
    );
  }

  const pctLine = rank.pct.map(x=>`${x.n}(${x.p.toFixed(0)}%)`).join("  ");
  const main = rank.topPick[0]?.n || "--";
  const sub  = rank.topPick[1]?.n || "--";
  const third= rank.topPick[2]?.n;

  const warnings = buildWarningsCommercial(phaObj, rank);

  const explain = rank.topPick.map((x,i)=>{
    const tags = [
      `hot:${x.hot}`,
      `gan:${x.gan}`,
      `truc:${x.isTruc?"Y":"-"}`,
      `g7:${x.isLead?"Y":"-"}`,
      `pas:${x.isPas?"Y":"-"}`,
      `cum:${x.isClu?"Y":"-"}`,
      `dau:${x.isHead?"Y":"-"}`,
      `duoi:${x.isTail?"Y":"-"}`
    ].join(" | ");
    return `${i+1}) ${x.n} | score ${x.s.toFixed(2)} | ${tags}`;
  }).join("\n");

  let huong = "GIAO THOA: ch·ªçn s·ªë tr√πng ‚â•2 ti√™u ch√≠.";
  if(phaObj.dir==="TRUC_GAN" || phaObj.dir==="TRUC_MO") huong = "∆ØU TI√äN TR·ª§C + GAN (gi·∫£m b√°m G6/G7).";
  if(phaObj.dir==="THEO_G7") huong = "∆ØU TI√äN G7 (k·ªÅ/b√≥ng/ƒë·∫£o) + x√°c nh·∫≠n gan.";
  if(phaObj.dir==="XA") huong = "PHA X·∫¢: gi·∫£m ti·ªÅn, tr√°nh all-in.";

  // Full soi (ƒë·∫πp m·∫Øt, c√≥ th·ª© t·ª±)
  return (
`===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++) =====
T·ªïng ng√†y d√πng: ${days.length}

AI ƒê·ªåC PHA:
Pha: ${phaObj.pha} | H∆∞·ªõng: ${phaObj.dir} | Tin c·∫≠y: ${(phaObj.conf*100).toFixed(0)}%
Nh·∫≠n ƒë·ªãnh: ${phaObj.note}
Ch·ªâ th·ªã: ${huong}

TOP 10 (tham kh·∫£o) + %:
${pctLine}

CH·ªêT (2‚Äì3 s·ªë, th∆∞∆°ng m·∫°i):
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•:  ${sub}${third ? `\n‚ûï K√®m: ${third}` : ""}

3 C·∫¢NH B√ÅO M·∫†NH:
1) ${warnings[0]}
2) ${warnings[1]}
3) ${warnings[2]}

GI·∫¢I TH√çCH S·ªê CH·ªêT:
${explain}

WEIGHTS (AI supervisor ${weights.locked?"LOCKED":"OFF"}):
wHot=${weights.wHot} | wGan=${weights.wGan} | wPas=${weights.wPas} | wTruc=${weights.wTruc} | wG7=${weights.wG7}
`
  );
}

/* =========================================================
   RUN FULL
========================================================= */
function runFULL(){
  const days = parseLines();
  if(days.length < 10){
    el("out").textContent = "‚ùå Thi·∫øu d·ªØ li·ªáu: c·∫ßn √≠t nh·∫•t 10 d√≤ng. Khuy·∫øn ngh·ªã 20 d√≤ng.";
    return;
  }

  // 1) ƒê·ªçc pha tr∆∞·ªõc
  const phaObj = detectPhase(days);

  // 2) Quy·∫øt ƒë·ªãnh ƒë√°nh/n√© (gi·∫£m sai th∆∞∆°ng m·∫°i)
  const skipObj = shouldSkipByPhase(phaObj, days);
  if(skipObj.skip){
    el("out").textContent = renderReport(days, phaObj, {wHot:0,wGan:0,wPas:0,wTruc:0,wG7:0,locked:false}, null, null, {pct:[],topPick:[],top10:[],freq:{}}, skipObj);
    return;
  }

  // 3) Kh√≥a tr·ªçng s·ªë theo pha
  const weights = lockWeightsByPhase(phaObj);

  // 4) Sinh theo d√≤ng d·∫´n (tr·ª•c ho·∫∑c g7 lead)
  const pack = buildCandidatesByDir(days, phaObj);

  // 5) L·ªçc full PP (gan/ch·∫°m/c·ª•m/pascal‚Ä¶)
  const filt = filterCandidates(days, phaObj, pack);
  if(!filt.ok){
    el("out").textContent =
`===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++) =====
T·ªïng ng√†y d√πng: ${days.length}

K·∫æT LU·∫¨N: KH√îNG N√äN ƒê√ÅNH
L√Ω do: ${filt.reason}

* G·ª£i √Ω: gi·∫£m c·ª≠a s·ªï ng√†y v·ªÅ 15‚Äì20, ƒë·∫£m b·∫£o newest ·ªü tr√™n, ho·∫∑c ch·ªâ quan s√°t.
`;
    return;
  }

  // 6) Ch·∫•m ƒëi·ªÉm + top10 + ch·ªët 2‚Äì3
  const rank = scoreAndPick(days, phaObj, weights, pack, filt);

  // 7) Render
  el("out").textContent = renderReport(days, phaObj, weights, filt, pack, rank, {skip:false});
}

el("btnFull").onclick = runFULL;
</script>
</body>
</html>
