<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (FINAL v3 ‚Ä¢ GOD MODE)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#101f3a;
      --text:#e9f0ff;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.08);
      --green:#2bd576;
      --orange:#ffb020;
      --red:#ff4d4d;
      --blue:#3b82f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 50% -100px, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 500px at 10% 20%, rgba(43,213,118,.12), transparent 55%),
        radial-gradient(900px 500px at 90% 40%, rgba(255,176,32,.10), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    .hero{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:16px 16px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .title{font-weight:800;font-size:20px;letter-spacing:.2px}
    .subtitle{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-size:13px;color:var(--muted)
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--green)}
    .dot.o{background:var(--orange)}
    .dot.r{background:var(--red)}

    .card{
      margin-top:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.28);
    }
    .card h3{margin:0 0 8px;font-size:16px}
    label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px}
    textarea{
      width:100%;min-height:150px;resize:vertical;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    @media (max-width:700px){ .grid{grid-template-columns:1fr;} }
    input, select{
      width:100%;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;
      padding:12px 14px;
      border-radius:16px;
      font-weight:700;
      color:white;
      cursor:pointer;
      background:linear-gradient(180deg, rgba(59,130,246,.95), rgba(59,130,246,.65));
      box-shadow:0 14px 28px rgba(59,130,246,.18);
    }
    button.secondary{
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid var(--line);
      color:var(--text);
      box-shadow:none;
    }
    button.danger{
      background:linear-gradient(180deg, rgba(255,77,77,.95), rgba(255,77,77,.65));
      box-shadow:0 14px 28px rgba(255,77,77,.16);
    }
    .hint{color:var(--muted);font-size:12.5px;line-height:1.4;margin-top:8px}
    .split{height:1px;background:var(--line);margin:12px 0}

    .tabs{display:flex;gap:8px;margin:4px 0 10px}
    .tab{
      padding:10px 12px;border-radius:14px;
      background:rgba(0,0,0,.16);
      border:1px solid var(--line);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{color:var(--text);background:rgba(59,130,246,.22);border-color:rgba(59,130,246,.35)}
    .outBox{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      overflow:auto;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:13px;
      line-height:1.35;
      white-space:pre;
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(43,213,118,.12);
      border:1px solid rgba(43,213,118,.22);
      color:#bff7d7;
      font-size:12.5px
    }
    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    .kqBig{
      font-size:28px;font-weight:900;letter-spacing:.6px;margin:6px 0 8px
    }
    .kqLine{color:var(--muted);font-size:13px;margin:2px 0}
    .warn{color:#ffd08a}
    .ok{color:#bff7d7}
    .err{color:#ffb3b3}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="title">B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3 ‚Ä¢ GOD MODE)</div>
      <div class="subtitle">
        Lu·ªìng chu·∫©n: <b>Nh·∫≠p d·ªØ li·ªáu</b> ‚Üí <b>ƒê·ªçc Pha</b> ‚Üí K·∫øt lu·∫≠n <b>TR·ª§C+GAN / G7-G6 / N√â NG√ÄY</b> ‚Üí r·ªìi m·ªõi <b>Soi FULL Loto 2 s·ªë</b> (anti-b·∫´y).
      </div>

      <div class="row">
        <div class="pill"><span class="dot g"></span> OpenCV: OK</div>
        <div class="pill"><span class="dot g"></span> OCR: batch done</div>
        <div class="pill"><span class="dot o"></span> Gate: c·ª©ng</div>
        <div class="pill"><span class="dot g"></span> Kh√¥ng ph√° scan/scale</div>
      </div>
    </div>

    <div class="card">
      <h3>D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h3>
      <div class="hint">Format chu·∫©n auto: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b> (newest ·ªü tr√™n). Ch·∫•p nh·∫≠n <b>G7 :</b>/<b>G6 :</b> v√† d·∫•u <b>|/‚îÇ/ÔΩú</b>.</div>

      <label for="inputData">D√°n d·ªØ li·ªáu</label>
      <textarea id="inputData" spellcheck="false" placeholder="VD:
DB 93 | G7: 70 45 14 13 | G6: 762 712 486
DB 38 | G7: 71 70 95 10 | G6: 768 195 519
..."></textarea>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>C·ª≠a s·ªï ng√†y (khuy·∫øn ngh·ªã)</label>
          <input id="winDays" type="number" value="20" min="10" max="60" />
        </div>
        <div>
          <label>Top ch·ªët (ra n s·ªë)</label>
          <input id="topN" type="number" value="4" min="2" max="12" />
        </div>

        <div>
          <label>AI gi√°m s√°t</label>
          <select id="aiSup">
            <option value="on" selected>ON (kh√≥a tr·ªçng s·ªë theo pha)</option>
            <option value="off">OFF (th·∫£ tay)</option>
          </select>
        </div>

        <div>
          <label>Ng∆∞·ª°ng TR·ª§C n·ªïi (&gt;=)</label>
          <input id="trucThr" type="number" value="4" min="2" max="10" />
        </div>

        <div>
          <label>K ƒë·ªçc pha (ng√†y g·∫ßn nh·∫•t)</label>
          <input id="kPhase" type="number" value="9" min="5" max="20" />
        </div>

        <div>
          <label>Tr·ªçng s·ªë Hot</label>
          <input id="wHot" type="number" value="2" step="0.1" />
        </div>

        <div>
          <label>Tr·ªçng s·ªë Gan</label>
          <input id="wGan" type="number" value="1.5" step="0.1" />
        </div>

        <div>
          <label>Tr·ªçng s·ªë Pascal</label>
          <input id="wPas" type="number" value="2" step="0.1" />
        </div>

        <div>
          <label>Tr·ªçng s·ªë Tr·ª•c</label>
          <input id="wTruc" type="number" value="2.8" step="0.1" />
        </div>

        <div>
          <label>Tr·ªçng s·ªë G7/G6</label>
          <input id="wG7" type="number" value="1" step="0.1" />
        </div>
      </div>

      <div class="btnRow">
        <button id="runBtn">üöÄ Ch·∫°y FULL (Pha ‚Üí Soi Loto ‚Üí Anti-b·∫´y)</button>
        <button class="secondary" id="pasteBtn">üìã D√°n m·∫´u</button>
        <button class="danger" id="clearBtn">üßπ X√≥a</button>
      </div>

      <div class="foot">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
    </div>

    <div class="card">
      <h3>K·∫æT QU·∫¢ FULL</h3>
      <div class="tabs">
        <div class="tab active" id="tabSimple">SIMPLE</div>
        <div class="tab" id="tabPro">PRO</div>
      </div>

      <div id="simpleView">
        <div id="simpleCard" class="card" style="margin-top:0;background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div>
              <div style="color:var(--muted);font-weight:800">CH·ªêT (TH∆Ø∆†NG M·∫†I)</div>
              <div class="kqBig" id="pickLine">‚Äî</div>
              <div class="kqLine" id="phaLine">Pha: ‚Äî</div>
              <div class="kqLine" id="noteLine">Nh·∫≠n ƒë·ªãnh: ‚Äî</div>
            </div>
            <div class="badge" id="confBadge">Tin c·∫≠y: ‚Äî</div>
          </div>

          <div class="split"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="pill" style="color:var(--text)"><span class="dot g"></span> Ch√≠nh: <b id="mainPick">‚Äî</b></div>
            <div class="pill" style="color:var(--text)"><span class="dot o"></span> Ph·ª•: <b id="subPick">‚Äî</b></div>
            <div class="pill" style="color:var(--text)"><span class="dot o"></span> K√®m: <b id="extraPick">‚Äî</b></div>
          </div>

          <div class="split"></div>

          <div style="color:var(--muted);font-weight:900;margin-bottom:8px">3 C·∫¢NH B√ÅO M·∫†NH</div>
          <div id="warnBox" style="display:grid;gap:6px"></div>

          <div class="split"></div>

          <div style="color:var(--muted);font-size:12.5px">
            AI supervisor: <b id="supState">‚Äî</b><br/>
            WEIGHTS: <span id="wLine">‚Äî</span><br/>
            T·ªïng ng√†y d√πng: <b id="dayUsed">‚Äî</b>
          </div>
        </div>

        <div class="card" style="margin-top:12px;background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));">
          <div style="font-weight:900;margin-bottom:8px">GI·∫¢I TH√çCH S·ªê CH·ªêT</div>
          <div class="outBox" id="explainBox">‚Äî</div>
        </div>
      </div>

      <div id="proView" style="display:none">
        <div class="outBox" id="proBox">‚Äî</div>
      </div>

    </div>

  </div>

<script>
/* ===========================
   Helpers
=========================== */
const el = (id)=>document.getElementById(id);
const pad2 = (n)=>String(n).padStart(2,"0");
const clamp = (x,a,b)=>Math.min(Math.max(x,a),b);
const toNum = (v, d=0)=> {
  const x = parseFloat(String(v).replace(",", "."));
  return Number.isFinite(x) ? x : d;
};
function setTab(active){
  el("tabSimple").classList.toggle("active", active==="simple");
  el("tabPro").classList.toggle("active", active==="pro");
  el("simpleView").style.display = active==="simple" ? "block":"none";
  el("proView").style.display = active==="pro" ? "block":"none";
}

/* ===========================
   CORE: Parse input (FIX G·ªêC)
   - Ch·∫•p nh·∫≠n: G7 : / G6 :
   - Ch·∫•p nh·∫≠n: | / ‚îÇ / ÔΩú (OCR hay ƒë·ªïi)
   - Ch·∫•p nh·∫≠n: OCR g√£y d√≤ng
=========================== */
function parseLines(){
  const text = (el("inputData").value || "").trim();
  const win = clamp(parseInt(el("winDays").value||"20",10), 10, 60);

  const BAR = `[\\|‚îÇÔΩú]`;
  // DB 93 | G7: 70 45 14 13 | G6: 762 712 486
  // DB 93 | G7 : 70 45 14 13 | G6 : 762 712 486
  const re = new RegExp(
    `DB\\s*(\\d{2})\\s*${BAR}\\s*G7\\s*:?\\s*([\\d\\s]+?)\\s*${BAR}\\s*G6\\s*:?\\s*([\\d\\s]+?)(?=(?:\\n|\\r|.)*?DB\\s*\\d{2}\\s*${BAR}|$)`,
    "gmi"
  );

  const days = [];
  let m;
  while((m = re.exec(text)) !== null){
    const db2 = pad2(m[1]);

    const g7 = (m[2].match(/\b\d{2}\b/g)||[]).slice(0,4).map(pad2);
    const g6 = (m[3].match(/\b\d{3}\b/g)||[]).slice(0,3);

    if(g7.length!==4 || g6.length!==3) continue;

    const g6_2 = g6.map(x=>pad2(x.slice(-2)));
    const pool = [db2, ...g7, ...g6_2];

    days.push({db2, g7, g6_2, pool});
    if(days.length >= win) break;
  }

  return days;
}

/* ===========================
   Feature: Hot / Gan / Head-tail / Truc / Pascal / G7 cues
=========================== */
function buildStats(days){
  const freq = Array.from({length:100},()=>0);
  const lastSeen = Array.from({length:100},()=>Infinity);

  // newest at top => index 0 is newest
  days.forEach((d, idx)=>{
    d.pool.forEach(s=>{
      const n = parseInt(s,10);
      if(!Number.isFinite(n)) return;
      freq[n] += 1;
      lastSeen[n] = Math.min(lastSeen[n], idx);
    });
  });

  // gan = how many days since last seen (Infinity => never in window)
  const gan = lastSeen.map(x => (x===Infinity ? 999 : x)); // 999 = c·ª±c gan trong c·ª≠a s·ªï

  // Head/Tail counts in pool
  const headCount = Array.from({length:10},()=>0);
  const tailCount = Array.from({length:10},()=>0);
  for(let n=0;n<100;n++){
    if(freq[n]>0){
      const h = Math.floor(n/10), t=n%10;
      headCount[h]+=freq[n];
      tailCount[t]+=freq[n];
    }
  }

  return {freq, gan, headCount, tailCount};
}

function topK(arr, k){
  const idx = arr.map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]);
  return idx.slice(0,k).map(x=>x[1]);
}

/* Pascal seed: d√πng DB2 + G7 + G6_2 c·ªßa K ng√†y g·∫ßn nh·∫•t t·∫°o seed,
   r·ªìi ph√°t ra ƒëi·ªÉm cho c√°c s·ªë c√≥ li√™n h·ªá ƒë∆°n gi·∫£n (anti qu√° ph·ª©c t·∫°p). */
function pascalSeeds(days, k){
  const kk = clamp(parseInt(k||"9",10), 5, 20);
  const use = days.slice(0, kk);
  const seeds = new Set();
  use.forEach(d=>{
    seeds.add(d.db2);
    d.g7.forEach(x=>seeds.add(x));
    d.g6_2.forEach(x=>seeds.add(x));
  });
  return Array.from(seeds).map(x=>parseInt(x,10)).filter(Number.isFinite);
}

function pascalScoreFor(n, seeds){
  // ƒëi·ªÉm n·∫øu n = |a¬±b| mod 100 ho·∫∑c k·ªÅ seed
  let s = 0;
  const nn = n;
  const set = new Set(seeds);
  if(set.has(nn)) s += 2;

  for(let i=0;i<seeds.length;i++){
    for(let j=i+1;j<seeds.length;j++){
      const a = seeds[i], b = seeds[j];
      const sum = (a+b)%100;
      const dif = Math.abs(a-b)%100;
      if(sum===nn) s += 1;
      if(dif===nn) s += 1;
    }
  }
  // k·ªÅ seed
  if(set.has((nn+1)%100) || set.has((nn+99)%100)) s += 0.5;
  return s;
}

/* Tr·ª•c: nh√≥m theo t·ªïng ch·ªØ s·ªë (mod 10) ho·∫∑c theo "ƒë·∫ßu/ƒëu√¥i" ph·ªï bi·∫øn.
   ·ªû ƒë√¢y d√πng: tr·ª•c = (head + tail) mod 10 v√† tr·ª•c n·ªïi n·∫øu xu·∫•t hi·ªán >= threshold */
function buildTruc(days, threshold){
  const thr = clamp(parseInt(threshold||"4",10), 2, 10);
  const trucCount = Array.from({length:10},()=>0);

  days.forEach(d=>{
    d.pool.forEach(x=>{
      const n = parseInt(x,10);
      const h = Math.floor(n/10), t=n%10;
      const tr = (h+t)%10;
      trucCount[tr]+=1;
    });
  });

  const active = [];
  for(let tr=0; tr<10; tr++){
    if(trucCount[tr] >= thr) active.push(tr);
  }
  return {trucCount, active};
}

/* ===========================
   Phase reader (MASTER+++)
   - Pha: P1..P8 (m√¥ ph·ªèng theo nh·ªãp tr·ª•c/gan/hot)
   - H∆∞·ªõng: TRUC_MO / TRUC_XA / G7G6 / NE_NGAY
=========================== */
function readPhase(days, stats, trucInfo){
  const k = clamp(parseInt(el("kPhase").value||"9",10), 5, 20);
  const recent = days.slice(0, k);
  const freqRecent = Array.from({length:100},()=>0);
  recent.forEach(d=>d.pool.forEach(x=>{
    const n=parseInt(x,10); if(Number.isFinite(n)) freqRecent[n]+=1;
  }));

  // hot density = s·ªë c√≥ freqRecent>=2
  let hotDense = 0;
  for(let n=0;n<100;n++) if(freqRecent[n]>=2) hotDense++;

  // gan pressure = s·ªë gan>=k (trong c·ª≠a s·ªï)
  let ganPressure = 0;
  for(let n=0;n<100;n++) if(stats.gan[n]>=k) ganPressure++;

  // truc activity
  const activeTruc = trucInfo.active.length;

  // heuristic pha
  let pha = "P4";
  let huong = "G7G6";
  let tin = 72;
  let note = "C√¢n b·∫±ng ‚Äî soi full, ∆∞u ti√™n top ·ªïn ƒë·ªãnh.";

  if(activeTruc >= 3 && ganPressure > 55){
    pha = "P6"; huong = "TRUC_MO"; tin = 90;
    note = "M·ªü TR·ª§C ‚Äî gan v·ª´a/ƒë·ªß, tr·ª•c ƒëang n·ªï. ∆Øu ti√™n TR·ª§C + x√°c nh·∫≠n gan.";
  } else if(activeTruc >= 3 && hotDense > 18){
    pha = "P7"; huong = "TRUC_XA"; tin = 84;
    note = "Tr·ª•c m·∫°nh nh∆∞ng hot d√†y ‚Äî d·ªÖ x·∫£/nhi·ªÖu. Gi·∫£m all-in theo c·ª•m.";
  } else if(activeTruc <= 1 && hotDense < 10){
    pha = "P2"; huong = "NE_NGAY"; tin = 78;
    note = "√çt tr·ª•c/√≠t hot ‚Äî d·ªÖ tr·ªëng nh·ªãp. C√¢n nh·∫Øc n√© ng√†y ho·∫∑c b√°m G7/G6.";
  } else if(activeTruc <= 1 && hotDense >= 14){
    pha = "P3"; huong = "G7G6"; tin = 80;
    note = "Kh√¥ng r√µ tr·ª•c, nh∆∞ng c·ª•m/hot n·ªïi ‚Äî ∆∞u ti√™n G7/G6 + ch·ªëng b·∫´y c·ª•m.";
  } else if(activeTruc >= 2 && ganPressure <= 35){
    pha = "P5"; huong = "TRUC_MO"; tin = 82;
    note = "Tr·ª•c ƒëang manh nha ‚Äî ∆∞u ti√™n tr·ª•c n·ªïi + 1 l·ªõp gan nh·∫π.";
  }

  return {pha, huong, tin, note};
}

/* ===========================
   Scoring engine
=========================== */
function scoreAll(days){
  const stats = buildStats(days);
  const trucInfo = buildTruc(days, el("trucThr").value);

  const seeds = pascalSeeds(days, el("kPhase").value);

  const wHot = toNum(el("wHot").value, 2);
  const wGan = toNum(el("wGan").value, 1.5);
  const wPas = toNum(el("wPas").value, 2);
  const wTruc = toNum(el("wTruc").value, 2.8);
  const wG7  = toNum(el("wG7").value, 1);

  const phase = readPhase(days, stats, trucInfo);

  // AI supervisor: kh√≥a tr·ªçng s·ªë theo pha (n·∫øu ON)
  const sup = el("aiSup").value === "on";
  let W = {wHot, wGan, wPas, wTruc, wG7};

  if(sup){
    // kh√≥a h∆∞·ªõng theo phase.huong (ch·ªâ "k√©o", kh√¥ng ƒë·∫£o ng∆∞·ª£c)
    if(phase.huong==="TRUC_MO"){
      W.wTruc *= 1.15;
      W.wGan  *= 1.10;
      W.wG7   *= 0.85;
      W.wHot  *= 0.95;
    } else if(phase.huong==="TRUC_XA"){
      W.wTruc *= 1.05;
      W.wHot  *= 0.85; // hot d√†y -> gi·∫£m
      W.wG7   *= 0.90;
      W.wGan  *= 1.05;
    } else if(phase.huong==="G7G6"){
      W.wG7   *= 1.20;
      W.wTruc *= 0.90;
      W.wPas  *= 1.05;
    } else if(phase.huong==="NE_NGAY"){
      W.wHot  *= 0.85;
      W.wTruc *= 0.85;
      W.wG7   *= 0.90;
      // gan/pas v·∫´n gi·ªØ ƒë·ªÉ ch·ªçn s·ªë "√≠t r·ªßi ro"
      W.wGan  *= 1.05;
      W.wPas  *= 1.05;
    }
  }

  // g7 lead set: l·∫•y G7 c·ªßa 3 ng√†y g·∫ßn nh·∫•t
  const g7Lead = new Set();
  days.slice(0,3).forEach(d=>d.g7.forEach(x=>g7Lead.add(parseInt(x,10))));

  // c·ª•m x√°c nh·∫≠n: s·ªë xu·∫•t hi·ªán >=3 l·∫ßn trong window
  const cum = new Set();
  for(let n=0;n<100;n++) if(stats.freq[n]>=3) cum.add(n);

  // ƒë·∫ßu/ƒëu√¥i ∆∞u ti√™n top 5
  const topHead = new Set(topK(stats.headCount, 5));
  const topTail = new Set(topK(stats.tailCount, 5));

  const scores = [];
  for(let n=0;n<100;n++){
    const hot = stats.freq[n];            // freq trong window
    const gan = stats.gan[n];             // 0 = v·ª´a ra, l·ªõn = gan
    const pas = pascalScoreFor(n, seeds); // pascal heuristic
    const h = Math.floor(n/10), t=n%10;
    const tr = (h+t)%10;
    const isTruc = trucInfo.active.includes(tr);
    const isG7 = g7Lead.has(n);

    // normalize nh·∫π: gan -> ∆∞u ti√™n 3..9, qu√° gan coi nh∆∞ r·ªßi ro
    let ganScore = 0;
    if(gan>=3 && gan<=9) ganScore = 1.0;
    else if(gan>=10 && gan<=20) ganScore = 0.75;
    else if(gan>20) ganScore = 0.4;
    else ganScore = 0.2; // v·ª´a ra

    const headOK = topHead.has(h) ? 1 : 0;
    const tailOK = topTail.has(t) ? 1 : 0;

    // core score
    let score =
      W.wHot  * hot +
      W.wGan  * (ganScore*10) +
      W.wPas  * (pas*2) +
      W.wTruc * (isTruc? 10 : 0) +
      W.wG7   * (isG7? 10 : 0) +
      (headOK? 1.0 : 0) +
      (tailOK? 1.0 : 0) +
      (cum.has(n)? 0.8 : 0);

    // anti: n·∫øu hot d√†y m√† n thu·ªôc cum qu√° m·∫°nh => gi·∫£m nh·∫π ƒë·ªÉ tr√°nh b·∫´y c·ª•m
    if(cum.has(n) && hot>=4) score *= 0.92;

    scores.push({
      n: pad2(n),
      score: Math.round(score*100)/100,
      hot,
      gan,
      tr,
      truc: isTruc,
      g7: isG7,
      pas: Math.round(pas*100)/100,
      cum: cum.has(n),
      dau: headOK===1,
      duoi: tailOK===1
    });
  }

  scores.sort((a,b)=>b.score-a.score);

  return {scores, stats, trucInfo, phase, W, g7Lead, cum, topHead, topTail};
}

/* ===========================
   Render output
=========================== */
function makeWarnList(phase, trucInfo, stats, days){
  const warns = [];

  // 1) b·∫´y c·ª•m/hot
  const hotDense = stats.freq.filter(x=>x>=3).length;
  if(hotDense>=18){
    warns.push({kind:"warn", text:"‚ö†Ô∏è B·∫™Y C·ª§M/HOT: hot d√†y ‚Üí d·ªÖ l·ªách. Tr√°nh all-in theo c·ª•m."});
  }else{
    warns.push({kind:"ok", text:"‚úÖ OK: hot kh√¥ng qu√° d√†y (gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn)."});
  }

  // 2) pha n√© ng√†y
  if(phase.huong==="NE_NGAY"){
    warns.push({kind:"warn", text:"‚ö†Ô∏è N√â NG√ÄY: √≠t tr·ª•c/nh·ªãp y·∫øu ‚Üí ∆∞u ti√™n gi·∫£m c∆∞·ª£c ho·∫∑c ch·ªâ quan s√°t."});
  }else{
    warns.push({kind:"ok", text:"‚úÖ OK: ch∆∞a th·∫•y t√≠n hi·ªáu n√© ng√†y qu√° r√µ."});
  }

  // 3) tr·ª•c n·ªïi c√≥ ƒë·ªß m·∫°nh kh√¥ng
  if(trucInfo.active.length===0){
    warns.push({kind:"warn", text:"‚ö†Ô∏è TR·ª§C Y·∫æU: ch∆∞a c√≥ tr·ª•c n·ªïi theo ng∆∞·ª°ng ‚Üí ∆∞u ti√™n G7/G6 + pascal + gan."});
  }else{
    warns.push({kind:"ok", text:"‚úÖ OK: c√≥ tr·ª•c n·ªïi ho·∫°t ƒë·ªông (theo ng∆∞·ª°ng)."});
  }

  return warns.slice(0,3);
}

function renderSimple(result){
  const topN = clamp(parseInt(el("topN").value||"4",10), 2, 12);
  const picks = result.scores.slice(0, topN).map(x=>x.n);
  const main = picks[0] || "‚Äî";
  const sub  = picks[1] || "‚Äî";
  const extra = picks[2] || picks[0] || "‚Äî";

  el("pickLine").textContent = picks.length ? picks.join(" / ") : "‚Äî";
  el("phaLine").textContent = `Pha ${result.phase.pha} ‚Ä¢ ${result.phase.huong} ‚Ä¢ Tin c·∫≠y ${result.phase.tin}%`;
  el("noteLine").textContent = result.phase.note;
  el("confBadge").textContent = `Tin c·∫≠y: ${result.phase.tin}%`;

  el("mainPick").textContent = main;
  el("subPick").textContent = sub;
  el("extraPick").textContent = extra;

  const warns = makeWarnList(result.phase, result.trucInfo, result.stats, result.days);
  const box = el("warnBox");
  box.innerHTML = "";
  warns.forEach(w=>{
    const div = document.createElement("div");
    div.className = (w.kind==="warn" ? "warn" : "ok");
    div.textContent = w.text;
    box.appendChild(div);
  });

  el("supState").textContent = (el("aiSup").value==="on" ? "LOCKED" : "OFF");
  el("wLine").textContent =
    `wHot=${fmt(result.W.wHot)} ‚Ä¢ wGan=${fmt(result.W.wGan)} ‚Ä¢ wPas=${fmt(result.W.wPas)} ‚Ä¢ wTruc=${fmt(result.W.wTruc)} ‚Ä¢ wG7=${fmt(result.W.wG7)}`;
  el("dayUsed").textContent = result.days.length;

  // explain top
  const lines = [];
  lines.push(`TOP ${topN} + l√Ω do (A=CORE):`);
  result.scores.slice(0, topN).forEach((x,i)=>{
    lines.push(`${i+1}) A${x.n} | score ${fmt(x.score)} | hot:${x.hot} | gan:${x.gan} | truc:${x.truc?"Y":"-"} | g7:${x.g7?"Y":"-"} | pas:${fmt(x.pas)} | cum:${x.cum?"Y":"-"} | dau:${x.dau?"Y":"-"} | duoi:${x.duoi?"Y":"-"}`);
  });
  lines.push("");
  lines.push(`TR·ª§C n·ªïi (>=${el("trucThr").value}): ${result.trucInfo.active.length? result.trucInfo.active.join(" "):"(none)"}`);
  el("explainBox").textContent = lines.join("\n");
}

function renderPro(result){
  const topN = clamp(parseInt(el("topN").value||"4",10), 2, 12);
  const picks = result.scores.slice(0, topN).map(x=>x.n);

  // HOT 15
  const hotList = result.scores
    .slice()
    .sort((a,b)=>b.hot-a.hot)
    .slice(0,15)
    .map(x=>`${x.n}‚Üí${x.hot}`);

  // GAN 15 (∆∞u ti√™n gan l·ªõn)
  const ganList = result.scores
    .slice()
    .sort((a,b)=>b.gan-a.gan)
    .slice(0,15)
    .map(x=>`${x.n}‚Üí${x.gan===999?"‚àû":x.gan}`);

  // ƒê·∫ßu/ƒëu√¥i Top5
  const headTop = topK(result.stats.headCount, 5).map(h=>`${h}(${result.stats.headCount[h]})`);
  const tailTop = topK(result.stats.tailCount, 5).map(t=>`${t}(${result.stats.tailCount[t]})`);

  // Tr·ª•c n·ªïi
  const trucActive = result.trucInfo.active.join(" ");

  // Pascal seed list
  const seeds = pascalSeeds(result.days, el("kPhase").value).slice(0,18).map(x=>pad2(x));

  // C·ª•m x√°c nh·∫≠n
  const cumList = Array.from(result.cum).sort((a,b)=>a-b).slice(0,30).map(x=>pad2(x)).join(" ");

  // G7 lead set
  const g7Lead = Array.from(result.g7Lead).sort((a,b)=>a-b).map(x=>pad2(x));

  const out = [];
  out.push("===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++) =====");
  out.push(`T·ªïng ng√†y d√πng: ${result.days.length}`);
  out.push("");
  out.push("===== AI ƒê·ªåC PHA (MASTER+++) =====");
  out.push(`Pha: ${result.phase.pha} | H∆∞·ªõng: ${result.phase.huong} | Tin c·∫≠y: ${result.phase.tin}%`);
  out.push(`Nh·∫≠n ƒë·ªãnh: ${result.phase.note}`);
  out.push("");
  out.push("===== TOP (tham kh·∫£o) =====");
  out.push(`Top ${topN}: ${picks.join("  ")}`);
  out.push("");
  out.push("===== SOI FULL LOTO 2 S·ªê (FULL PRO) =====");
  out.push(`[1] HOT (15): ${hotList.join("  ")}`);
  out.push(`[2] GAN (15): ${ganList.join("  ")}`);
  out.push(`[3] ƒê·∫¶U/TƒêU√îI Top5 (K=${el("kPhase").value}):`);
  out.push(`    ƒê·∫ßu: ${headTop.join("  ")}`);
  out.push(`    ƒêu√¥i: ${tailTop.join("  ")}`);
  out.push(`[4] TR·ª§C n·ªïi (>=${el("trucThr").value}): ${trucActive || "(none)"}`);
  out.push(`[5] G7 lead set (3 ng√†y g·∫ßn nh·∫•t): ${g7Lead.join(" ")}`);
  out.push(`[6] PASCAL seed (t·ªëi ƒëa 18): ${seeds.join(" ")}`);
  out.push(`[7] C·ª§M (x√°c nh·∫≠n - kh√¥ng √©p): ${cumList || "(none)"}`);
  out.push("");
  out.push("===== GI·∫¢I TH√çCH TOP (A=CORE) =====");
  result.scores.slice(0, Math.max(6, topN)).forEach((x,i)=>{
    out.push(`${i+1}) A${x.n} | score ${fmt(x.score)} | hot:${x.hot} | gan:${x.gan} | truc:${x.truc?"Y":"-"} | g7:${x.g7?"Y":"-"} | pas:${fmt(x.pas)} | cum:${x.cum?"Y":"-"} | dau:${x.dau?"Y":"-"} | duoi:${x.duoi?"Y":"-"}`);
  });
  out.push("");
  out.push("WEIGHTS (AI supervisor " + (el("aiSup").value==="on" ? "LOCKED" : "OFF") + "):");
  out.push(`wHot=${fmt(result.W.wHot)} | wGan=${fmt(result.W.wGan)} | wPas=${fmt(result.W.wPas)} | wTruc=${fmt(result.W.wTruc)} | wG7=${fmt(result.W.wG7)}`);
  out.push("");
  out.push("* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.");

  el("proBox").textContent = out.join("\n");
}

function fmt(x){
  return (Math.round(x*100)/100).toFixed(2).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1");
}

/* ===========================
   Run
=========================== */
function runFull(){
  const days = parseLines();

  // Gate: c·∫ßn t·ªëi thi·ªÉu 10 d√≤ng, khuy·∫øn ngh·ªã 20
  if(days.length < 10){
    const msg =
      `‚úó Thi·∫øu d·ªØ li·ªáu/format: Parse ƒë∆∞·ª£c ${days.length} ng√†y h·ª£p l·ªá. C·∫ßn √≠t nh·∫•t 10 d√≤ng (khuy·∫øn ngh·ªã ${el("winDays").value}).\n` +
      `\nM·∫πo FIX:\n` +
      `- M·ªói ng√†y ph·∫£i ƒë√∫ng: "DB xx | G7: a b c d | G6: xxx yyy zzz"\n` +
      `- App ch·∫•p nh·∫≠n c·∫£ "G7 :" "G6 :" v√† d·∫•u |/‚îÇ/ÔΩú.\n` +
      `- N·∫øu OCR g√£y d√≤ng, v·∫´n ƒë∆∞·ª£c, mi·ªÖn ƒë·ªß s·ªë.\n`;
    el("proBox").textContent = msg;
    el("pickLine").textContent = "‚Äî";
    el("phaLine").textContent = "Pha: ‚Äî";
    el("noteLine").textContent = "Nh·∫≠n ƒë·ªãnh: ‚Äî";
    el("confBadge").textContent = "Tin c·∫≠y: ‚Äî";
    el("explainBox").textContent = msg;
    el("dayUsed").textContent = days.length;
    return;
  }

  const result = scoreAll(days);
  result.days = days;

  renderSimple(result);
  renderPro(result);
}

/* ===========================
   Buttons
=========================== */
el("runBtn").addEventListener("click", runFull);
el("tabSimple").addEventListener("click", ()=>setTab("simple"));
el("tabPro").addEventListener("click", ()=>setTab("pro"));

el("pasteBtn").addEventListener("click", ()=>{
  el("inputData").value =
`DB 93 | G7 : 70 45 14 13 | G6 : 762 712 486
DB 38 | G7 : 71 70 95 10 | G6 : 768 195 519
DB 94 | G7 : 31 34 20 49 | G6 : 301 697 335
DB 27 | G7 : 82 24 25 16 | G6 : 508 652 762
DB 17 | G7 : 71 15 99 52 | G6 : 945 187 310
DB 22 | G7 : 21 00 14 71 | G6 : 497 368 374
DB 28 | G7 : 94 79 33 40 | G6 : 132 666 595
DB 24 | G7 : 54 43 74 64 | G6 : 800 491 957
DB 51 | G7 : 71 94 16 52 | G6 : 139 283 310
DB 86 | G7 : 60 26 32 49 | G6 : 480 226 435`;
});

el("clearBtn").addEventListener("click", ()=>{
  el("inputData").value = "";
  el("proBox").textContent = "‚Äî";
  el("pickLine").textContent = "‚Äî";
  el("phaLine").textContent = "Pha: ‚Äî";
  el("noteLine").textContent = "Nh·∫≠n ƒë·ªãnh: ‚Äî";
  el("confBadge").textContent = "Tin c·∫≠y: ‚Äî";
  el("explainBox").textContent = "‚Äî";
});
</script>
</body>
</html>
