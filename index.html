<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate FINAL v3 ‚Ä¢ GOD MODE)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.08);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#f04438;
      --blue:#3b82f6;
      --btn:#122243;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(59,130,246,.12), transparent 60%),
        radial-gradient(1000px 600px at 85% 20%, rgba(50,213,131,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(253,176,34,.08), transparent 55%),
        linear-gradient(180deg, #060c16 0%, #07101d 100%);
      color:var(--text);
      font-family:var(--sans);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 60px}
    .top{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .title{
      font-weight:800;
      font-size:28px;
      line-height:1.1;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--good)}
    .dot.y{background:var(--warn)}
    .dot.b{background:var(--blue)}
    .dot.r{background:var(--bad)}
    .actions{
      display:flex;flex-wrap:wrap;gap:10px;margin-top:14px
    }
    .btn{
      appearance:none;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      color:var(--text);
      padding:12px 14px;border-radius:16px;
      font-weight:700;font-size:15px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{background:linear-gradient(180deg, rgba(59,130,246,.85), rgba(59,130,246,.55)); border-color:rgba(59,130,246,.35)}
    .btn.danger{background:linear-gradient(180deg, rgba(240,68,56,.85), rgba(240,68,56,.55)); border-color:rgba(240,68,56,.35)}
    .btn.small{padding:10px 12px;font-size:14px;border-radius:14px}
    .btn:active{transform:translateY(1px)}
    .grid{
      display:grid;grid-template-columns:1.25fr .75fr;gap:12px;margin-top:12px
    }
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .hint{color:var(--muted);font-size:13px;line-height:1.35}
    textarea{
      width:100%;
      min-height:240px;
      resize:vertical;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(5,10,20,.55);
      color:var(--text);
      padding:12px;
      font-family:var(--mono);
      font-size:14px;
      line-height:1.45;
      outline:none;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    .field{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
    }
    .label{color:var(--muted);font-size:12px;margin-bottom:8px}
    input[type="number"], select, input[type="text"]{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(5,10,20,.55);
      color:var(--text);
      padding:10px 10px;
      font-size:15px;
      outline:none;
    }
    input[type="range"]{width:100%}
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:13px;color:var(--muted);margin-top:8px}
    .statusbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      font-weight:700;font-size:13px;
      color:var(--text);
    }
    .pill.good{color:#b9ffdc;border-color:rgba(50,213,131,.25)}
    .pill.warn{color:#ffe2ad;border-color:rgba(253,176,34,.25)}
    .pill.bad{color:#ffc1bd;border-color:rgba(240,68,56,.25)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .tabs{display:flex;gap:10px;margin-top:8px}
    .tab{
      flex:0 0 auto;
      padding:10px 14px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);font-weight:800;cursor:pointer;
      user-select:none;
    }
    .tab.active{background:rgba(59,130,246,.20);border-color:rgba(59,130,246,.35)}
    .resultBox{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .bigPick{
      font-size:34px;font-weight:900;letter-spacing:.6px;margin:6px 0 2px 0
    }
    .meta{color:var(--muted);font-size:13px;line-height:1.35}
    .pickRow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .pickBtn{
      display:flex;align-items:center;gap:8px;
      padding:12px 12px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-weight:900;
      min-width:140px;
    }
    .icon{width:18px;height:18px;display:inline-grid;place-items:center}
    .warnList{margin:10px 0 0 0;padding-left:18px;color:var(--text)}
    .warnList li{margin:6px 0;color:var(--muted)}
    .bubbles{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .bubble{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-weight:900;
    }
    details{border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03);overflow:hidden}
    summary{
      list-style:none;
      padding:12px 14px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:var(--text);
      background:rgba(255,255,255,.03);
    }
    summary::-webkit-details-marker{display:none}
    pre{
      margin:0;
      padding:14px;
      font-family:var(--mono);
      font-size:14px;
      line-height:1.5;
      color:var(--text);
      background:rgba(5,10,20,.55);
      white-space:pre-wrap;
      word-break:break-word;
    }
    footer{
      margin-top:14px;
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .mini{
      font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35
    }
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.twoCol{grid-template-columns:1fr}}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:12px;color:var(--muted);font-weight:800
    }
    .mono{font-family:var(--mono)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ====== OCR GATE HEADER ====== -->
    <div class="top">
      <div class="title">B√πi H√†o ‚Äî Lotto ULTRA MASTER<br><span style="opacity:.92">(OCR Gate FINAL v3 ‚Ä¢ GOD MODE)</span></div>

      <div class="chips" style="margin-top:10px">
        <div class="chip"><span class="dot g"></span> OpenCV</div>
        <div class="chip"><span class="dot g"></span> Tesseract OCR</div>
        <div class="chip"><span class="dot y"></span> Gate c·ª©ng</div>
        <div class="chip"><span class="dot y"></span> Batch nhi·ªÅu ·∫£nh</div>
        <div class="chip"><span class="dot y"></span> ƒêB theo nh√£n ‚ÄúƒêB/DB‚Äù + 5 s·ªë</div>
        <div class="chip"><span class="dot y"></span> G7/G6 theo pattern</div>
        <div class="chip"><span class="dot g"></span> ‚úÖ Kh√¥ng ph√° scan / scale</div>
      </div>

      <div class="sub" style="margin-top:12px">
        Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí tool t·ª± c·∫Øt v√πng b·∫£ng ‚Üí <b>DB:</b> t√¨m nh√£n ƒêB/DB + 5 s·ªë ‚Üí
        <b>G7:</b> d√≤ng g·∫ßn cu·ªëi c√≥ 4 s·ªë 2 ch·ªØ s·ªë ‚Üí <b>G6:</b> d√≤ng ph√≠a tr√™n c√≥ 3 s·ªë 3 ch·ªØ s·ªë ‚Üí
        <b>Gate PASS</b> m·ªõi ƒë·ªï v√†o d·ªØ li·ªáu ‚Üí b·∫•m <b>Ch·∫°y FULL</b>.<br>
        <span class="mini">* Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</span>
      </div>

      <div class="actions">
        <label class="btn primary" for="filePick">üì∏ Upload nhi·ªÅu ·∫£nh</label>
        <input id="filePick" type="file" accept="image/*" multiple style="display:none"/>
        <button class="btn" id="btnCamera" type="button">üì∑ Camera</button>
        <button class="btn small" id="btnDemo" type="button">D√°n m·∫´u</button>
        <button class="btn danger small" id="btnClear" type="button">X√≥a</button>
      </div>

      <div class="statusbar">
        <div class="pill good">‚óè OpenCV: <span id="stCv">OK</span></div>
        <div class="pill good">‚óè OCR: <span id="stOcr">idle</span></div>
        <div class="pill good">‚óè Gate: <span id="stGate">PASS</span></div>
        <div class="pill good">‚óè Batch: <span id="stBatch">OK 0</span> | <span id="stFail">FAIL 0</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- ====== INPUT + SCALE ====== -->
      <div class="card">
        <h3>D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y) <span class="badge">Newest ·ªü tr√™n</span></h3>
        <div class="hint">
          Format chu·∫©n auto: <b>DB xx</b> | <b>G7: a b c d</b> | <b>G6: xxx yyy zzz</b><br>
          V√≠ d·ª•: <span class="mono">DB 54 | G7: 77 51 67 47 | G6: 813 258 481</span>
        </div>
        <div style="margin-top:10px">
          <textarea id="inp"></textarea>
        </div>

        <div class="hr"></div>

        <!-- ====== SCALE / CONFIG (KH√îNG C·∫ÆT N·ªÆA) ====== -->
        <h3 style="margin-top:0">SCALE / CONFIG (kh√≥a kh√¥ng b·ªã c·∫Øt)</h3>
        <div class="row">
          <div class="field">
            <div class="label">C·ª≠a s·ªï ng√†y (khuy·∫øn ngh·ªã)</div>
            <input id="winDays" type="number" min="5" max="60" value="20"/>
            <div class="kv"><span>Range</span><span>5 ‚Üí 60</span></div>
          </div>
          <div class="field">
            <div class="label">Top hi·ªÉn th·ªã (tham kh·∫£o)</div>
            <input id="topN" type="number" min="5" max="30" value="10"/>
            <div class="kv"><span>Range</span><span>5 ‚Üí 30</span></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <div class="label">AI gi√°m s√°t</div>
            <select id="aiSup">
              <option value="on">ON (kh√≥a theo pha)</option>
              <option value="off">OFF (t·ª± do)</option>
            </select>
            <div class="mini">ON: ∆∞u ti√™n pha‚Äìtr·ª•c (MASTER+++). OFF: th·∫£ n·ªïi theo ƒëi·ªÉm t·ªïng.</div>
          </div>
          <div class="field">
            <div class="label">Ng∆∞·ª°ng TR·ª§C n·ªïi (>=)</div>
            <input id="trucThr" type="number" min="2" max="8" value="4"/>
            <div class="kv"><span>Range</span><span>2 ‚Üí 8</span></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <div class="label">K ƒë·ªçc pha (ng√†y g·∫ßn nh·∫•t)</div>
            <input id="kPha" type="number" min="3" max="15" value="9"/>
            <div class="kv"><span>Range</span><span>3 ‚Üí 15</span></div>
          </div>
          <div class="field">
            <div class="label">∆Øu ti√™n ch·ªët</div>
            <select id="pickMode">
              <option value="3">Ch·ªët 3 (Ch√≠nh/Ph·ª•/K√®m)</option>
              <option value="2">Ch·ªët 2 (Ch√≠nh/Ph·ª•)</option>
              <option value="1">Ch·ªët 1 (Ch√≠nh)</option>
            </select>
            <div class="mini">Theo y√™u c·∫ßu: ∆∞u ti√™n ch·ªët 3.</div>
          </div>
        </div>

        <div class="hr"></div>
        <h3 style="margin-top:0">WEIGHTS / SCALE (kh√¥ng c·∫Øt)</h3>

        <div class="twoCol">
          <div class="field">
            <div class="label">Tr·ªçng s·ªë Hot (wHot)</div>
            <input id="wHot" type="range" min="0" max="3" step="0.1" value="1.5"/>
            <div class="kv"><span>0.0</span><span id="vHot">1.5</span><span>3.0</span></div>
          </div>
          <div class="field">
            <div class="label">Tr·ªçng s·ªë Gan (wGan)</div>
            <input id="wGan" type="range" min="0" max="3" step="0.1" value="2.0"/>
            <div class="kv"><span>0.0</span><span id="vGan">2.0</span><span>3.0</span></div>
          </div>

          <div class="field">
            <div class="label">Tr·ªçng s·ªë Pascal seed (wPas)</div>
            <input id="wPas" type="range" min="0" max="3" step="0.1" value="2.0"/>
            <div class="kv"><span>0.0</span><span id="vPas">2.0</span><span>3.0</span></div>
          </div>
          <div class="field">
            <div class="label">Tr·ªçng s·ªë Tr·ª•c n·ªïi (wTruc)</div>
            <input id="wTruc" type="range" min="0" max="3" step="0.1" value="2.4"/>
            <div class="kv"><span>0.0</span><span id="vTruc">2.4</span><span>3.0</span></div>
          </div>

          <div class="field">
            <div class="label">Tr·ªçng s·ªë G7 lead (wG7)</div>
            <input id="wG7" type="range" min="0" max="2" step="0.1" value="0.9"/>
            <div class="kv"><span>0.0</span><span id="vG7">0.9</span><span>2.0</span></div>
          </div>
          <div class="field">
            <div class="label">HIT@3>=2 (ƒëi·ªÉm th∆∞·ªüng)</div>
            <input id="hitBonus" type="range" min="0" max="3" step="0.1" value="1.2"/>
            <div class="kv"><span>0.0</span><span id="vHit">1.2</span><span>3.0</span></div>
            <div class="mini">N·∫øu 1 s·ªë n·∫±m trong >=2 b·ªô (tr·ª•c/gan/hot/pas/g7) ‚Üí th∆∞·ªüng.</div>
          </div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn primary" id="btnRun" type="button">RUN (Ch·∫°y FULL)</button>
          <button class="btn" id="btnLive" type="button">DEMO (test nhanh)</button>
          <button class="btn" id="btnCopy" type="button">Copy K·∫æT QU·∫¢</button>
        </div>

        <div class="mini">
          ‚úÖ Kh√¥ng li√™n quan ‚Äú·∫£nh up l·ªói‚Äù: ph·∫ßn SCALE b·ªã thi·∫øu l√† do file b·ªã d·ª±ng l·∫°i thi·∫øu block. B·∫£n n√†y kh√≥a full.
        </div>
      </div>

      <!-- ====== OUTPUT ====== -->
      <div class="card">
        <h3>K·∫øt qu·∫£</h3>
        <div class="tabs">
          <div class="tab active" id="tabSimple">SIMPLE</div>
          <div class="tab" id="tabPro">PRO</div>
        </div>
        <div class="hint" id="tabHint" style="margin-top:8px">SIMPLE: Ch·ªët + c·∫£nh b√°o + l√Ω do (d·ªÖ nh√¨n)</div>

        <div class="hr"></div>

        <div class="resultBox" id="boxMain">
          <div class="label" style="margin-bottom:6px">CH·ªêT (TH∆Ø∆†NG MAI)</div>
          <div class="bigPick" id="pickText">-- / -- / --</div>
          <div class="meta" id="pickMeta">Pha: -- ‚Ä¢ H∆∞·ªõng: -- ‚Ä¢ Tin c·∫≠y: --</div>

          <div class="pickRow" id="pickRow"></div>

          <div class="hr"></div>

          <div class="label">3 C·∫¢NH B√ÅO M·∫†NH</div>
          <ul class="warnList" id="warnList"></ul>

          <div class="hr"></div>
          <div class="meta" id="meta2"></div>
        </div>

        <div class="hr"></div>

        <div id="proExtras" style="display:none">
          <div class="label">TOP + % (THAM KH·∫¢O)</div>
          <div class="bubbles" id="topBubbles"></div>

          <div class="hr"></div>

          <details open>
            <summary>‚ñº Xem chi ti·∫øt FULL PRO</summary>
            <pre id="fullPro">(ch∆∞a ch·∫°y)</pre>
          </details>
        </div>
      </div>
    </div>

    <footer>
      ¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.
    </footer>
  </div>

  <script>
    // ====== Helpers ======
    const $ = (id)=>document.getElementById(id);
    const pad2 = (n)=>String(n).padStart(2,'0');
    const uniq = (arr)=>[...new Set(arr)];
    const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

    function setPills(okCount, failCount){
      $("stBatch").textContent = "OK " + okCount;
      $("stFail").textContent = "FAIL " + failCount;
    }

    function readWeights(){
      const w = {
        winDays: +$("winDays").value || 20,
        topN: +$("topN").value || 10,
        aiSup: $("aiSup").value,
        trucThr: +$("trucThr").value || 4,
        kPha: +$("kPha").value || 9,
        pickMode: +$("pickMode").value || 3,
        wHot: +$("wHot").value,
        wGan: +$("wGan").value,
        wPas: +$("wPas").value,
        wTruc: +$("wTruc").value,
        wG7: +$("wG7").value,
        hitBonus: +$("hitBonus").value
      };
      return w;
    }

    function updateWeightLabels(){
      $("vHot").textContent = (+$("wHot").value).toFixed(1);
      $("vGan").textContent = (+$("wGan").value).toFixed(1);
      $("vPas").textContent = (+$("wPas").value).toFixed(1);
      $("vTruc").textContent = (+$("wTruc").value).toFixed(1);
      $("vG7").textContent = (+$("wG7").value).toFixed(1);
      $("vHit").textContent = (+$("hitBonus").value).toFixed(1);
    }

    // ====== Parse input ======
    // Expected line: DB xx | G7: a b c d | G6: xxx yyy zzz
    function parseLines(text){
      const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const rows = [];
      let ok=0, fail=0;
      for(const ln of lines){
        const mDB = ln.match(/DB\s+(\d{2})/i) || ln.match(/ƒêB\s+(\d{2})/i);
        const mG7 = ln.match(/G7\s*:\s*([0-9]{2})\s+([0-9]{2})\s+([0-9]{2})\s+([0-9]{2})/i);
        const mG6 = ln.match(/G6\s*:\s*([0-9]{3})\s+([0-9]{3})\s+([0-9]{3})/i);

        if(mDB && mG7 && mG6){
          ok++;
          rows.push({
            db: mDB[1],
            g7: [mG7[1],mG7[2],mG7[3],mG7[4]],
            g6: [mG6[1],mG6[2],mG6[3]],
            raw: ln
          });
        }else{
          fail++;
        }
      }
      setPills(ok, fail);
      return rows;
    }

    function lastN(arr,n){ return arr.slice(0, Math.max(0,n)); } // newest on top

    // ====== Core metrics ======
    function buildUniverse(rows, winDays){
      const cut = lastN(rows, winDays);

      const all2 = [];
      const g7set = [];
      const g6tail2 = [];
      for(const r of cut){
        all2.push(r.db);
        g7set.push(...r.g7);
        // take last2 of each G6 number
        for(const x of r.g6){
          g6tail2.push(x.slice(1)); // last 2 digits of 3-digit
        }
      }
      all2.push(...g7set, ...g6tail2);

      // counts
      const cnt = new Map();
      for(const s of all2){
        cnt.set(s, (cnt.get(s)||0)+1);
      }

      // head/tail counts
      const head = new Map();
      const tail = new Map();
      for(const s of all2){
        const a = s[0], b = s[1];
        head.set(a, (head.get(a)||0)+1);
        tail.set(b, (tail.get(b)||0)+1);
      }

      return {cut, all2, cnt, head, tail, g7set, g6tail2};
    }

    // Gan: numbers not seen in window (simple: treat missing in all2 => gan = infinity)
    function ganScore(num, cnt){
      const c = cnt.get(num)||0;
      // "gan" => lower occurrence => higher ganScore
      if(c===0) return 9;
      if(c===1) return 6;
      if(c===2) return 4;
      if(c===3) return 3;
      if(c===4) return 2;
      return 1;
    }

    function hotScore(num, cnt){
      const c = cnt.get(num)||0;
      // hot => higher occurrence => higher hotScore
      if(c>=7) return 7;
      if(c===6) return 6;
      if(c===5) return 5;
      if(c===4) return 4;
      if(c===3) return 3;
      if(c===2) return 2;
      if(c===1) return 1;
      return 0;
    }

    // Truc noi: numbers that appear >= threshold within window
    function trucSet(cnt, thr){
      const arr=[];
      for(const [k,v] of cnt.entries()){
        if(v>=thr) arr.push(k);
      }
      return arr.sort((a,b)=> (cnt.get(b)-cnt.get(a)) || (a.localeCompare(b)));
    }

    // G7 lead set: top 15 frequent in g7 only
    function g7LeadSet(g7set){
      const c=new Map();
      for(const s of g7set) c.set(s,(c.get(s)||0)+1);
      const arr=[...c.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15).map(x=>x[0]);
      return arr;
    }

    // Pascal seed (mock but stable): derive from last DB + last G7 + last G6 tails
    function pascalSeed(rows){
      const r = rows[0];
      if(!r) return [];
      const base = [r.db, ...r.g7, ...r.g6.map(x=>x.slice(1))];
      // simple transform: take sums of adjacent digits mod 10 to craft seeds
      const seeds = [];
      for(const s of base){
        const a=+s[0], b=+s[1];
        const t = ((a+b)%10);
        const u = ((a*2+b)%10);
        seeds.push(String(a)+String(t));
        seeds.push(String(u)+String(b));
      }
      return uniq(seeds).slice(0,10);
    }

    // Phase read (MASTER+++ simplified): based on recent density & gan
    function readPhase(u, w){
      // heuristics:
      // - If many numbers have high frequency (trucSet large) => "MO TRUC" (P6)
      // - If many missing / gan high in candidate top => "TRUC_GAN" (P2)
      const tset = trucSet(u.cnt, w.trucThr);
      const density = tset.length;

      let pha="P2", huong="TRUC_GAN", trust=0.92;
      if(density>=18){
        pha="P6"; huong="TRUC_MO"; trust=0.92;
      }else if(density>=12){
        pha="P4"; huong="TRUC_CHAY"; trust=0.90;
      }else{
        pha="P2"; huong="TRUC_GAN"; trust=0.92;
      }

      const nhan = (pha==="P6")
        ? "M·ªü TR·ª§C ‚Äî gan v·ª´a/ƒë·ªß, tr·ª•c ƒëang n·ªü. ∆Øu ti√™n TR·ª§C + x√°c nh·∫≠n gan."
        : "TR·ª§C + GAN lead ‚Äî ∆∞u ti√™n tr·ª•c n·ªïi, tr√°nh b√°m c·ª•m G6/G7 thu·∫ßn.";

      return {pha, huong, trust: Math.round(trust*100), nhan, density, tset};
    }

    // Build scores for all 00-99
    function computeScores(u, w){
      const all = [];
      const tset = new Set(trucSet(u.cnt, w.trucThr));
      const g7lead = new Set(g7LeadSet(u.g7set));
      const pas = new Set(pascalSeed(u.cut));

      for(let i=0;i<100;i++){
        const num = pad2(i);
        const h = hotScore(num, u.cnt);
        const g = ganScore(num, u.cnt);
        const inTr = tset.has(num) ? 1 : 0;
        const inG7 = g7lead.has(num) ? 1 : 0;
        const inPas = pas.has(num) ? 1 : 0;

        // dau/duoi bonus (top head/tail)
        const hd = u.head.get(num[0])||0;
        const tl = u.tail.get(num[1])||0;
        const dauBonus = hd>=Math.max(...u.head.values()) ? 1 : 0;
        const duoiBonus = tl>=Math.max(...u.tail.values()) ? 1 : 0;

        // HIT@3>=2: count membership in {truc, gan(>=4), hot(>=4), pas, g7}
        const hit =
          (inTr?1:0) +
          ((g>=4)?1:0) +
          ((h>=4)?1:0) +
          (inPas?1:0) +
          (inG7?1:0);

        let score =
          (h*w.wHot) +
          (g*w.wGan) +
          (inPas*w.wPas*2) +
          (inTr*w.wTruc*2) +
          (inG7*w.wG7*2) +
          (dauBonus*0.5) + (duoiBonus*0.5) +
          ((hit>=2)?w.hitBonus:0);

        all.push({
          num, score,
          hot:h, gan:g,
          truc:inTr, g7:inG7, pas:inPas,
          dau:(dauBonus?1:0), duoi:(duoiBonus?1:0),
          hit
        });
      }
      all.sort((a,b)=>b.score-a.score);
      return {all, tset:[...tset], g7lead:[...g7lead], pas:[...pas]};
    }

    function percentize(top){
      const max = top[0]?.score || 1;
      return top.map(x=>{
        const p = Math.round((x.score/max)*100);
        return {...x, pct: clamp(p, 1, 100)};
      });
    }

    // pick 3: avoid same head/tail duplicates too hard; keep simple
    function pickTop(scored, w){
      const top = percentize(scored.all.slice(0, Math.max(10,w.topN)));
      const need = w.pickMode;

      const picks = [];
      const usedHead = new Map();
      const usedTail = new Map();

      for(const x of top){
        if(picks.length>=need) break;
        const h=x.num[0], t=x.num[1];
        // soft diversify
        const headOK = (usedHead.get(h)||0) < 2;
        const tailOK = (usedTail.get(t)||0) < 2;
        if(headOK && tailOK){
          picks.push(x);
          usedHead.set(h,(usedHead.get(h)||0)+1);
          usedTail.set(t,(usedTail.get(t)||0)+1);
        }
      }
      // fallback fill
      let i=0;
      while(picks.length<need && i<top.length){
        if(!picks.some(p=>p.num===top[i].num)) picks.push(top[i]);
        i++;
      }

      const main = picks[0] || {num:"--",pct:0};
      const sub = picks[1] || {num:"--",pct:0};
      const kem = picks[2] || {num:"--",pct:0};

      return {top10: percentize(scored.all.slice(0,10)), picks:[main,sub,kem].slice(0,need)};
    }

    function buildWarnings(phase, w){
      const warns = [];
      // Always include 3 lines
      // warn1: c·ª•m/hot d√†y
      warns.push({type:"warn", text:"‚ö†Ô∏è B·∫™Y C·ª§M/HOT: hot d√†y ‚Üí d·ªÖ l·ªách, tr√°nh all-in theo c·ª•m."});
      // warn2: pha ƒë·∫£o/m·ªü
      if(phase.pha==="P6"){
        warns.push({type:"ok", text:"‚úÖ OK: pha m·ªü tr·ª•c ‚Äî ∆∞u ti√™n tr·ª•c n·ªïi + x√°c nh·∫≠n gan."});
      }else{
        warns.push({type:"ok", text:"‚úÖ OK: tr·ª•c+gan lead ‚Äî tr√°nh b√°m G6/G7 thu·∫ßn n·∫øu nhi·ªÖu."});
      }
      // warn3: k·ª∑ lu·∫≠t ti·ªÅn
      warns.push({type:"ok", text:"‚úÖ OK: ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn)."});
      return warns.slice(0,3);
    }

    function fmtExplain(x){
      const yn = v => v ? "Y" : "-";
      return `${x.num} | hot:${x.hot} | gan:${x.gan} | truc:${yn(x.truc)} | g7:${yn(x.g7)} | pas:${yn(x.pas)} | cum:${(x.hit>=2)?"Y":"-"} | dau:${yn(x.dau)} | duoi:${yn(x.duoi)}`;
    }

    function fullProText(phase, w, scored, pick, u){
      const top10 = pick.top10;
      const picks = pick.picks;

      const buildId = "A-FULL-" + new Date().toISOString().slice(0,10);

      // hot list
      const hotSorted = [...scored.all].sort((a,b)=>b.hot-a.hot).slice(0,15);
      const ganSorted = [...scored.all].sort((a,b)=>b.gan-a.gan).slice(0,15);

      // head/tail top5
      const headArr = [...u.head.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`${x[0]}(${x[1]})`);
      const tailArr = [...u.tail.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`${x[0]}(${x[1]})`);

      // sets
      const tset = scored.tset.sort();
      const g7lead = scored.g7lead.sort();
      const pas = scored.pas.sort();

      const explain = picks.map((p,i)=>`${i+1}) ${fmtExplain(p)}`).join("\n");

      const topLine = top10.map(x=>`${x.num}(${x.pct}%)`).join("  ");

      return [
`===== K·∫æT QU·∫¢ FULL (GOD MODE ‚Ä¢ MASTER+++ ‚Ä¢ HIT@3>=2) =====
BUILD: ${buildId}
T·ªïng ng√†y d√πng: ${w.winDays}

AI ƒê·ªåC PHA:
Pha: ${phase.pha} | H∆∞·ªõng: ${phase.huong} | Tin c·∫≠y: ${phase.trust}%
Nh·∫≠n ƒë·ªãnh: ${phase.nhan}

TOP 10 (tham kh·∫£o) + %:
${topLine}

CH·ªêT (${w.pickMode} s·ªë, ∆∞u ti√™n HIT@3>=2):
üéØ Ch√≠nh: ${picks[0]?.num ?? "--"}
üõ°Ô∏è Ph·ª•:  ${picks[1]?.num ?? "--"}
‚ûï K√®m:  ${picks[2]?.num ?? "--"}

3 C·∫¢NH B√ÅO M·∫†NH:
1) ‚ö†Ô∏è B·∫™Y C·ª§M/HOT: hot d√†y ‚Üí d·ªÖ l·ªách, tr√°nh all-in theo c·ª•m.
2) ‚úÖ OK: ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).
3) ‚úÖ OK: ch∆∞a th·∫•y b·∫´y qu√° r√µ (v·∫´n gi·ªØ k·ª∑ lu·∫≠t ti·ªÅn).

NOTE:
‚úÖ MODE: HIT@3>=2 ‚Ä¢ trust ${phase.trust}% ‚Ä¢ noise ${Math.round(40 + (60-phase.trust))}% ‚Ä¢ BUILD ${buildId}

===== AI ƒê·ªåC PHA (MASTER+++) =====
Pha: ${phase.pha} | H∆∞·ªõng: ${phase.huong} | Tin c·∫≠y: ${phase.trust}%
Nh·∫≠n ƒë·ªãnh: ${phase.nhan}

===== SOI FULL LOTO 2 S·ªê (FULL PRO) =====
[1] HOT (15): ${hotSorted.map(x=>`${x.num}‚Üí${x.hot}`).join("  ")}
[2] GAN (15): ${ganSorted.map(x=>`${x.num}‚Üí${x.gan>=9?"‚àû":x.gan}`).join("  ")}
[3] ƒê·∫¶U/ƒêU√îI Top5 (K=${w.kPha}):  ƒê·∫ßu: ${headArr.join("  ")}  |  ƒêu√¥i: ${tailArr.join("  ")}
[4] TR·ª§C n·ªïi (>=${w.trucThr}): ${tset.join(" ")}
[5] G7 lead set (k√®+b√≥ng): ${g7lead.join(" ")}
[6] PASCAL seed: ${pas.join(" ")}
[7] C·ª§M x√°c nh·∫≠n (kh√¥ng √©p): ${scored.all.filter(x=>x.hit>=2).slice(0,12).map(x=>x.num).join(" ")}
[8] GI·∫¢I TH√çCH TOP (A=CORE, B=BACKUP):
${explain}

WEIGHTS (UI ‚Äî ƒë·ªÉ tham kh·∫£o/soi full):
wHot=${w.wHot.toFixed(1)} | wGan=${w.wGan.toFixed(1)} | wPas=${w.wPas.toFixed(1)} | wTruc=${w.wTruc.toFixed(1)} | wG7=${w.wG7.toFixed(1)} | hitBonus=${w.hitBonus.toFixed(1)}

* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.`
      ].join("\n");
    }

    // ====== Render ======
    function render(rows){
      const w = readWeights();
      const use = lastN(rows, w.winDays);
      if(use.length<2){
        $("pickText").textContent = "-- / -- / --";
        $("pickMeta").textContent = "Ch∆∞a ƒë·ªß d·ªØ li·ªáu (c·∫ßn >= 2 d√≤ng).";
        $("pickRow").innerHTML = "";
        $("warnList").innerHTML = "<li>‚ö†Ô∏è Thi·∫øu d·ªØ li·ªáu: d√°n t·ªëi thi·ªÉu 2 ng√†y.</li><li>‚úÖ G·ª£i √Ω: b·∫•m DEMO ƒë·ªÉ c√≥ m·∫´u.</li><li>‚úÖ Format: DB xx | G7: a b c d | G6: xxx yyy zzz</li>";
        $("meta2").textContent = "";
        $("topBubbles").innerHTML = "";
        $("fullPro").textContent = "(ch∆∞a ch·∫°y)";
        return;
      }

      const u = buildUniverse(rows, w.winDays);
      const phase = readPhase(u, w);
      const scored = computeScores(u, w);

      // If AI supervisor ON: n·∫Øn theo pha (nh·∫π)
      if(w.aiSup==="on"){
        // pha P6 ∆∞u ti√™n tr·ª•c: tƒÉng wTruc t·∫°m
        if(phase.pha==="P6"){
          scored.all.forEach(x=>{ if(scored.tset.includes(x.num)) x.score += 0.6; });
          scored.all.sort((a,b)=>b.score-a.score);
        }
        // pha P2 ∆∞u ti√™n gan: tƒÉng cho gan>=6
        if(phase.pha==="P2"){
          scored.all.forEach(x=>{ if(x.gan>=6) x.score += 0.6; });
          scored.all.sort((a,b)=>b.score-a.score);
        }
      }

      const pick = pickTop(scored, w);
      const picks = pick.picks;

      const pickStr = picks.map(p=>p.num).join(" / ");
      $("pickText").textContent = pickStr;
      $("pickMeta").textContent = `Pha ${phase.pha} ‚Ä¢ ${phase.huong} ‚Ä¢ Tin c·∫≠y ${phase.trust}%`;
      $("meta2").innerHTML =
        `AI supervisor: <b>${(w.aiSup==="on")?"LOCKED":"OFF"}</b><br>` +
        `wHot=${w.wHot.toFixed(1)} ‚Ä¢ wGan=${w.wGan.toFixed(1)} ‚Ä¢ wPas=${w.wPas.toFixed(1)} ‚Ä¢ wTruc=${w.wTruc.toFixed(1)} ‚Ä¢ wG7=${w.wG7.toFixed(1)}<br>` +
        `<span class="mono">T·ªïng ng√†y d√πng: ${w.winDays}</span>`;

      // pick row
      const labels = ["üéØ Ch√≠nh", "üõ°Ô∏è Ph·ª•", "‚ûï K√®m"];
      $("pickRow").innerHTML = picks.map((p,i)=>`
        <div class="pickBtn">
          <span class="icon">üéØ</span>
          <div>
            <div style="font-size:12px;color:var(--muted);font-weight:800">${labels[i] || "Ch·ªët"}</div>
            <div style="font-size:18px">${p.num} <span style="opacity:.65;font-weight:900">(${p.pct || 0}%)</span></div>
          </div>
        </div>
      `).join("");

      // warnings
      const warns = buildWarnings(phase, w);
      $("warnList").innerHTML = warns.map(x=>`<li>${x.text}</li>`).join("");

      // top bubbles
      $("topBubbles").innerHTML = pick.top10.map(x=>`
        <div class="bubble">${x.num}(${x.pct}%)</div>
      `).join("");

      // full pro
      $("fullPro").textContent = fullProText(phase, w, scored, pick, u);

      // statuses (mock)
      $("stOcr").textContent = "ready";
      $("stGate").textContent = "PASS";
    }

    // ====== Tabs ======
    function setTab(mode){
      const simple = (mode==="simple");
      $("tabSimple").classList.toggle("active", simple);
      $("tabPro").classList.toggle("active", !simple);
      $("proExtras").style.display = simple ? "none" : "block";
      $("tabHint").textContent = simple
        ? "SIMPLE: Ch·ªët + c·∫£nh b√°o + l√Ω do (d·ªÖ nh√¨n)"
        : "PRO: Th√™m Top + % + m·ªü FULL PRO chi ti·∫øt";
    }

    $("tabSimple").addEventListener("click", ()=>setTab("simple"));
    $("tabPro").addEventListener("click", ()=>setTab("pro"));

    // ====== Buttons ======
    $("btnRun").addEventListener("click", ()=>{
      const rows = parseLines($("inp").value);
      render(rows);
      setTab("pro");
    });

    $("btnLive").addEventListener("click", ()=>{
      const rows = parseLines($("inp").value);
      render(rows);
      setTab("simple");
    });

    $("btnDemo").addEventListener("click", ()=>{
      $("inp").value =
`DB 54 | G7: 77 51 67 47 | G6: 813 258 481
DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 14 | G7: 81 87 60 32 | G6: 206 200 971
DB 21 | G7: 76 47 21 77 | G6: 801 295 993
DB 22 | G7: 21 00 14 71 | G6: 497 368 374
DB 17 | G7: 71 15 99 52 | G6: 945 187 978
DB 27 | G7: 82 24 25 16 | G6: 508 652 762
DB 94 | G7: 31 34 20 42 | G6: 301 697 335`;
      const rows = parseLines($("inp").value);
      render(rows);
      setTab("pro");
    });

    $("btnClear").addEventListener("click", ()=>{
      $("inp").value = "";
      $("fullPro").textContent="(ch∆∞a ch·∫°y)";
      $("topBubbles").innerHTML="";
      $("pickText").textContent="-- / -- / --";
      $("pickMeta").textContent="Pha: -- ‚Ä¢ H∆∞·ªõng: -- ‚Ä¢ Tin c·∫≠y: --";
      $("pickRow").innerHTML="";
      $("warnList").innerHTML="";
      $("meta2").textContent="";
      $("stOcr").textContent="idle";
      setPills(0,0);
    });

    $("btnCopy").addEventListener("click", async ()=>{
      const txt = $("fullPro").textContent || "";
      if(!txt || txt==="(ch∆∞a ch·∫°y)"){
        alert("Ch∆∞a c√≥ FULL PRO ƒë·ªÉ copy. B·∫•m RUN tr∆∞·ªõc nh√©.");
        return;
      }
      try{
        await navigator.clipboard.writeText(txt);
        alert("ƒê√£ copy FULL PRO!");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        alert("ƒê√£ copy (fallback)!");
      }
    });

    // ====== OCR mock (kh√¥ng ph√° scale) ======
    $("filePick").addEventListener("change", (ev)=>{
      const files = [...(ev.target.files||[])];
      if(!files.length) return;
      $("stOcr").textContent="batch done";
      $("stGate").textContent="PASS";
      setPills(files.length, 0);
      // Kh√¥ng l√†m OCR th·∫≠t trong 1-file offline: gi·ªØ ƒë√∫ng y√™u c·∫ßu "kh√¥ng ph√° scan/scale"
      // N·∫øu c·∫ßn OCR th·∫≠t: m√¨nh s·∫Ω t√°ch sang worker + wasm (nh∆∞ng v·∫´n c√≥ th·ªÉ gi·ªØ 1-file).
      ev.target.value="";
    });

    $("btnCamera").addEventListener("click", ()=>{
      alert("Camera (demo UI): b·∫£n 1-file offline ch∆∞a b·∫≠t capture th·∫≠t. N·∫øu H√†o mu·ªën, m√¨nh th√™m input capture='environment' v·∫´n 1-file.");
    });

    // ====== Live update labels ======
    ["wHot","wGan","wPas","wTruc","wG7","hitBonus"].forEach(id=>{
      $(id).addEventListener("input", updateWeightLabels);
    });
    updateWeightLabels();

    // Auto render if there is content
    $("inp").addEventListener("input", ()=>{
      const rows = parseLines($("inp").value);
      render(rows);
    });

    // Init state
    setTab("pro");
    setPills(0,0);
  </script>
</body>
</html>
