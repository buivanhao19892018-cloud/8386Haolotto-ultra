<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>B√πi H√†o ‚Äî ULTRA MOBILE (OCR GATE)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b36; --card2:#0b1328;
      --text:#eaf1ff; --mut:#9fb2d0; --line:rgba(255,255,255,.08);
      --ok:#34d399; --bad:#fb7185; --warn:#ffb020;
      --blue:#2563eb; --gray:#223257; --red:#dc2626;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#070c16,#0b1220 35%,#071021); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .wrap{max-width:980px; margin:0 auto; padding:14px 12px 40px;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--r); padding:14px; margin:12px 0; box-shadow:var(--shadow);}
    h1{margin:0; font-size:20px; font-weight:900}
    .sub{margin:8px 0 0; color:var(--mut); line-height:1.35; font-size:13px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid var(--line); border-radius:16px; padding:14px 14px;
      font-weight:900; color:var(--text); cursor:pointer;
      background:rgba(255,255,255,.05);
    }
    .btn.blue{background:linear-gradient(180deg,rgba(37,99,235,.95),rgba(37,99,235,.75)); border-color:rgba(37,99,235,.35)}
    .btn.gray{background:rgba(255,255,255,.06)}
    .btn.red{background:linear-gradient(180deg,rgba(220,38,38,.95),rgba(220,38,38,.75)); border-color:rgba(220,38,38,.35)}
    .btn:active{transform:translateY(1px)}
    .chip{padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.20); color:var(--mut); font-size:12px; font-weight:800}
    .chip.ok{color:#d8ffe9; border-color:rgba(52,211,153,.35); background:rgba(52,211,153,.08)}
    .chip.bad{color:#ffe2e2; border-color:rgba(251,113,133,.35); background:rgba(251,113,133,.08)}
    .chip.warn{color:#fff0d6; border-color:rgba(255,176,32,.35); background:rgba(255,176,32,.08)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .k{padding:10px 12px; border-radius:16px; border:1px solid var(--line); background:rgba(0,0,0,.18)}
    .k .t{color:var(--mut); font-size:12px}
    .k .v{margin-top:4px; font-size:18px; font-weight:950}
    .mono{font-family:var(--mono)}
    textarea, input{
      width:100%; padding:12px; border-radius:14px; border:1px solid var(--line);
      background:rgba(0,0,0,.18); color:var(--text); outline:none; font-size:14px;
    }
    textarea{min-height:170px; font-family:var(--mono); font-size:13px; line-height:1.35; resize:vertical}
    img{width:100%; border-radius:14px; border:1px solid var(--line); background:#050a12}
    .small{font-size:12px; color:var(--mut); line-height:1.35}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .hide{display:none!important}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>B√πi H√†o ‚Äî ULTRA MOBILE (OCR GATE)</h1>
    <div class="sub">
      ∆Øu ti√™n ch·∫°y ·ªïn tr√™n <b>ƒëi·ªán tho·∫°i</b>: 2 n√∫t ri√™ng (Ch·ª•p/Th∆∞ vi·ªán) ‚Üí OCR ‚Üí Parse c·ª©ng DB/G6/G7 ‚Üí Gate 3 l·ªõp ‚Üí ch·ªâ PASS m·ªõi ƒë·ªï d·ªØ li·ªáu.
      <div class="small">M·∫πo: crop s√°t v√πng b·∫£ng t·ª´ ‚ÄúƒêB‚Äù t·ªõi h√†ng ‚Äú7‚Äù ƒë·ªÉ PASS nhi·ªÅu nh·∫•t.</div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <span id="chipHttps" class="chip">HTTPS: ‚Ä¶</span>
      <span id="chipTess" class="chip warn">Tesseract: loading‚Ä¶</span>
      <span id="chipBatch" class="chip">Batch: 0 ·∫£nh</span>
      <span id="chipGate" class="chip">Gate: ‚Äî</span>
    </div>

    <div class="sep"></div>

    <!-- MOBILE: 2 input ri√™ng -->
    <input id="inpCamera" class="hide" type="file" accept="image/*" capture="environment" multiple />
    <input id="inpGallery" class="hide" type="file" accept="image/*" multiple />

    <div class="row">
      <button id="btnCamera" class="btn blue">üì∏ Ch·ª•p ·∫£nh</button>
      <button id="btnGallery" class="btn blue">üñº Ch·ªçn t·ª´ th∆∞ vi·ªán</button>
      <button id="btnOCR" class="btn gray">üîé OCR + Gate + Th√™m d√≤ng</button>
      <button id="btnClear" class="btn red">üßπ X√≥a</button>
    </div>

    <div class="small" style="margin-top:10px">
      N·∫øu b·∫•m m√† kh√¥ng m·ªü ch·ªçn ·∫£nh: m·ªü b·∫±ng <b>Chrome</b> v√† URL l√† <b>https</b> (GitHub Pages). Tr√°nh m·ªü trong Facebook/Zalo in-app browser.
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:900">Preview ·∫£nh cu·ªëi</div>
        <div class="small mono" id="lastName">‚Äî</div>
      </div>
      <div class="sep"></div>
      <img id="preview" class="hide" alt="preview"/>
      <div id="previewEmpty" class="small">Ch∆∞a c√≥ ·∫£nh</div>

      <div class="sep"></div>

      <div style="font-weight:900; margin-bottom:8px">K·∫øt qu·∫£ parse (·∫£nh cu·ªëi)</div>
      <div class="kpi">
        <div class="k"><div class="t">ƒêB (2 s·ªë)</div><div class="v" id="kDB">‚Äî</div></div>
        <div class="k"><div class="t">G6 (3 s·ªë)</div><div class="v mono" id="kG6">‚Äî</div></div>
        <div class="k"><div class="t">G7 (4 s·ªë)</div><div class="v mono" id="kG7">‚Äî</div></div>
        <div class="k"><div class="t">Tr·∫°ng th√°i</div><div class="v" id="kST">‚Äî</div></div>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900; margin-bottom:8px">Manual (khi FAIL)</div>
      <div class="small">DB: 2 s·ªë ‚Ä¢ G7: 4 s·ªë (2 ch·ªØ) ‚Ä¢ G6: 3 s·ªë (3 ch·ªØ)</div>
      <div class="row" style="margin-top:8px">
        <input id="mDB" placeholder="DB (2 s·ªë) VD: 30" style="flex:1" />
        <input id="mG7" placeholder="G7 VD: 33 97 86 63" style="flex:2" />
      </div>
      <div style="height:8px"></div>
      <input id="mG6" placeholder="G6 VD: 489 940 371" />
      <div style="height:10px"></div>
      <button id="btnManual" class="btn blue">‚úÖ √Åp manual ‚Üí th√™m d√≤ng</button>

      <div class="sep"></div>

      <div style="font-weight:900; margin-bottom:8px">Debug OCR (r√∫t g·ªçn)</div>
      <textarea id="dbg" readonly></textarea>
    </div>

    <div class="card">
      <div style="font-weight:900">D·ªØ li·ªáu s·∫°ch (m·ªói d√≤ng = 1 ng√†y)</div>
      <div class="small">Format: <span class="mono">DB xx | G7: a b c d | G6: xxx yyy zzz</span></div>
      <div class="sep"></div>
      <textarea id="data" placeholder="Ch∆∞a c√≥ d·ªØ li·ªáu‚Ä¶"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="btnCopy" class="btn gray">üìã Copy</button>
        <button id="btnClearData" class="btn gray">üßΩ X√≥a d·ªØ li·ªáu</button>
      </div>

      <div class="sep"></div>

      <div style="font-weight:900">FULL th·ªëng k√™ nhanh (Hot + Gan)</div>
      <div class="row" style="margin-top:8px">
        <input id="winN" type="number" min="5" max="120" value="30" style="flex:1" />
        <input id="topK" type="number" min="5" max="50" value="15" style="flex:1" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="wHot" type="number" step="0.1" value="2" style="flex:1" />
        <input id="wGan" type="number" step="0.1" value="1.5" style="flex:1" />
      </div>
      <div style="height:10px"></div>
      <button id="btnRun" class="btn blue">üöÄ Ch·∫°y FULL</button>

      <div style="height:10px"></div>
      <textarea id="out" readonly style="min-height:220px">Ch∆∞a ch·∫°y.</textarea>

      <div class="small" style="margin-top:10px">¬© B√πi H√†o ‚Äî Tool h·ªó tr·ª£ nh·∫≠p li·ªáu/ th·ªëng k√™. Kh√¥ng ƒë·∫£m b·∫£o tr√∫ng.</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* =========================
   ULTRA MOBILE ‚Äî CORE
========================= */
const $ = (id)=>document.getElementById(id);

const chipHttps = $("chipHttps");
const chipTess  = $("chipTess");
const chipBatch = $("chipBatch");
const chipGate  = $("chipGate");

const inpCamera = $("inpCamera");
const inpGallery= $("inpGallery");
const btnCamera = $("btnCamera");
const btnGallery= $("btnGallery");
const btnOCR    = $("btnOCR");
const btnClear  = $("btnClear");

const preview = $("preview");
const previewEmpty = $("previewEmpty");
const lastName = $("lastName");

const kDB = $("kDB"), kG6=$("kG6"), kG7=$("kG7"), kST=$("kST");
const dbg = $("dbg");
const data = $("data");

const mDB = $("mDB"), mG6=$("mG6"), mG7=$("mG7");
const btnManual = $("btnManual");

const btnCopy = $("btnCopy"), btnClearData=$("btnClearData");
const btnRun = $("btnRun");
const winN = $("winN"), topK=$("topK"), wHot=$("wHot"), wGan=$("wGan");
const out = $("out");

let filesQueue = []; // File[]
let lastFile = null;

// HTTPS indicator
(function(){
  const ok = (location.protocol === "https:" || location.hostname === "localhost");
  chipHttps.textContent = "HTTPS: " + (ok ? "OK" : "FAIL");
  chipHttps.className = "chip " + (ok ? "ok" : "bad");
})();

function setChip(el, text, cls){
  el.textContent = text;
  el.className = "chip" + (cls ? (" " + cls) : "");
}

function setGate(status, cls){
  setChip(chipGate, "Gate: " + status, cls||"");
  kST.textContent = status;
  kST.style.color = status==="PASS" ? "var(--ok)" : (status==="FAIL" ? "var(--bad)" : "");
}

function showPreview(url, name){
  preview.src = url;
  preview.classList.remove("hide");
  previewEmpty.classList.add("hide");
  lastName.textContent = name || "‚Äî";
}

function resetUI(){
  setChip(chipBatch, "Batch: 0 ·∫£nh", "");
  setGate("‚Äî", "");
  kDB.textContent="‚Äî"; kG6.textContent="‚Äî"; kG7.textContent="‚Äî";
  dbg.value="";
  preview.classList.add("hide");
  previewEmpty.classList.remove("hide");
  lastName.textContent="‚Äî";
}

btnCamera.addEventListener("click", ()=>{ inpCamera.value=""; inpCamera.click(); });
btnGallery.addEventListener("click", ()=>{ inpGallery.value=""; inpGallery.click(); });

function addFiles(list){
  const arr = Array.from(list||[]);
  if(!arr.length) return;
  filesQueue.push(...arr);
  lastFile = arr[arr.length-1];
  setChip(chipBatch, `Batch: ${filesQueue.length} ·∫£nh`, "");
  // show last image preview
  const url = URL.createObjectURL(lastFile);
  showPreview(url, lastFile.name);
}

inpCamera.addEventListener("change", e=>addFiles(e.target.files));
inpGallery.addEventListener("change", e=>addFiles(e.target.files));

btnClear.addEventListener("click", ()=>{
  filesQueue = [];
  lastFile = null;
  resetUI();
});

btnClearData.addEventListener("click", ()=>{ data.value=""; out.value="Ch∆∞a ch·∫°y."; });

btnCopy.addEventListener("click", async()=>{
  try{
    await navigator.clipboard.writeText(data.value||"");
    alert("ƒê√£ copy d·ªØ li·ªáu.");
  }catch(e){
    alert("Tr√¨nh duy·ªát ch·∫∑n copy. H√†o b√¥i ƒëen r·ªìi copy th·ªß c√¥ng gi√∫p m√¨nh.");
  }
});

/* =========================
   TESSERACT INIT
========================= */
let worker = null;
let READY = false;

(async function initTess(){
  try{
    setChip(chipTess, "Tesseract: loading‚Ä¶", "warn");
    worker = await Tesseract.createWorker({
      logger: m=>{
        if(m.status && typeof m.progress==="number"){
          setChip(chipTess, `Tesseract: ${m.status} ${(m.progress*100).toFixed(0)}%`, "warn");
        }
      }
    });
    // ch·ªâ OCR s·ªë/DB + xu·ªëng d√≤ng (gi·∫£m nhi·ªÖu)
    await worker.loadLanguage("eng");
    await worker.initialize("eng");
    await worker.setParameters({
      tessedit_char_whitelist: "0123456789DBdbƒêƒë \n:/()-",
      preserve_interword_spaces: "1",
    });
    READY = true;
    setChip(chipTess, "Tesseract: ready", "ok");
  }catch(e){
    READY = false;
    setChip(chipTess, "Tesseract: FAIL", "bad");
    dbg.value = "L·ªói Tesseract: " + (e?.message || String(e));
  }
})();

/* =========================
   OCR + PARSE (ULTRA STRICT)
========================= */
function norm(raw){
  let t = raw || "";
  t = t.replace(/\u00A0/g," ");
  // unify variants: ƒêB -> DB
  t = t.replace(/√ê/g,"ƒê");
  t = t.replace(/ƒêB/gi,"DB");
  // common digit confusions (conservative: apply line-wise if many digits)
  const lines = t.split(/\r?\n/).map(line=>{
    const dc = (line.match(/\d/g)||[]).length;
    if(dc >= 6){
      return line
        .replace(/[Oo]/g,"0")
        .replace(/[Il|]/g,"1")
        .replace(/[Ss]/g,"5");
      // NOTE: kh√¥ng replace B->8 to√†n c·ª•c (ph√° DB), ch·ªâ ƒë·ªÉ nguy√™n.
    }
    return line;
  });
  t = lines.join("\n");
  t = t.replace(/[ \t]+/g," ").trim();
  return t;
}

function isDateNoiseLine(line){
  const L = line.toLowerCase();
  if (/[\/]/.test(line)) return true;          // 30/01/2026
  if (/\b20\d{2}\b/.test(line)) return true;   // 2026
  if (/\(\s*\d{1,2}\/\d{1,2}/.test(line)) return true; // (12/12
  if (L.includes("am lich") || L.includes("√¢m l·ªãch") || L.includes("chu nhat") || L.includes("th·ª©")) return true;
  if (L.includes("mien") || L.includes("mi·ªÅn") || L.includes("xo so") || L.includes("x·ªï s·ªë")) return true;
  return false;
}

function splitLines(text){
  return text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
}

function extractDigitsTokens(line){
  // keep digits & spaces only
  const pure = line.replace(/[^\d ]+/g," ").replace(/[ ]+/g," ").trim();
  return pure ? pure.split(" ").filter(Boolean) : [];
}

function findDB5(lines){
  // Strict: must see "DB" token and then a 5-digit near it (same line or next 2 lines)
  for(let i=0;i<lines.length;i++){
    const L = lines[i];
    if(isDateNoiseLine(L)) continue;
    if(/\bDB\b/i.test(L)){
      const scan = [lines[i], lines[i+1]||"", lines[i+2]||""].join(" ");
      const m = scan.match(/\b\d{5}\b/g);
      if(m && m.length) return m[0];
    }
  }
  // fallback: DB glued "DB08230"
  const all = lines.join(" ");
  const m2 = all.match(/DB\D{0,6}(\d{5})/i);
  if(m2) return m2[1];
  return null;
}

function findRowStrict(lines, rowDigit){
  // ONLY accept lines starting with rowDigit (or "rowDigit 1 ..." noise) and not date/noise lines
  const candidates = [];
  for(const L of lines){
    if(isDateNoiseLine(L)) continue;
    const r = String(rowDigit);
    if(!new RegExp(`^${r}(\\s+\\d)?\\s+`).test(L)) continue;

    const toks = extractDigitsTokens(L);
    if(rowDigit===7){
      const two = toks.filter(x=>/^\d{2}$/.test(x));
      if(two.length>=4) candidates.push(two.slice(-4));
    }else{
      const three = toks.filter(x=>/^\d{3}$/.test(x));
      if(three.length>=3) candidates.push(three.slice(-3));
    }
  }
  // choose last found (often correct row near bottom)
  return candidates.length ? candidates[candidates.length-1] : null;
}

function gate3(db2, g6, g7, lines){
  // layer 1: format
  const okDB = /^\d{2}$/.test(db2||"");
  const okG6 = Array.isArray(g6) && g6.length===3 && g6.every(x=>/^\d{3}$/.test(x));
  const okG7 = Array.isArray(g7) && g7.length===4 && g7.every(x=>/^\d{2}$/.test(x));
  if(!okDB || !okG6 || !okG7) return {pass:false, why:"Format FAIL"};

  // layer 2: must have real row lines starting with 6 and 7 somewhere
  const has6 = lines.some(L=>!isDateNoiseLine(L) && /^6(\s+\d)?\s+/.test(L));
  const has7 = lines.some(L=>!isDateNoiseLine(L) && /^7(\s+\d)?\s+/.test(L));
  if(!has6 || !has7) return {pass:false, why:"Missing row 6/7 label"};

  // layer 3: anti-trap ‚Äî block common trap (date tokens)
  // If any line is date noise and equals chosen g7 tokens (rare but safe)
  const trap = lines.some(L=>{
    if(!isDateNoiseLine(L)) return false;
    const toks = extractDigitsTokens(L).filter(x=>/^\d{2}$/.test(x));
    if(toks.length>=4){
      const last4 = toks.slice(-4);
      return last4.join(" ") === g7.join(" ");
    }
    return false;
  });
  if(trap) return {pass:false, why:"G7 matches date trap"};

  return {pass:true, why:"PASS"};
}

function setParseUI(parsed, gateInfo){
  kDB.textContent = parsed.db2 || "‚Äî";
  kG6.textContent = parsed.g6 ? parsed.g6.join(" ") : "‚Äî";
  kG7.textContent = parsed.g7 ? parsed.g7.join(" ") : "‚Äî";
  if(gateInfo.pass){
    setGate("PASS", "ok");
  }else{
    setGate("FAIL", "bad");
  }
}

function appendDataLine(line){
  const cur = (data.value||"").trim();
  data.value = cur ? (cur + "\n" + line) : line;
}

/* =========================
   RUN OCR BATCH
========================= */
btnOCR.addEventListener("click", async()=>{
  if(!READY || !worker){
    alert("Tesseract ch∆∞a s·∫µn s√†ng. ƒê·ª£i ch·ªØ 'ready' r·ªìi th·ª≠ l·∫°i.");
    return;
  }
  if(!filesQueue.length){
    alert("Ch∆∞a c√≥ ·∫£nh. B·∫•m 'Ch·ª•p ·∫£nh' ho·∫∑c 'Ch·ªçn t·ª´ th∆∞ vi·ªán'.");
    return;
  }

  let ok=0, fail=0;
  for(let i=0;i<filesQueue.length;i++){
    const f = filesQueue[i];
    lastFile = f;

    // preview
    const url = URL.createObjectURL(f);
    showPreview(url, f.name);

    // OCR
    setChip(chipTess, `Tesseract: OCR ${i+1}/${filesQueue.length}`, "warn");
    let raw = "";
    try{
      const r = await worker.recognize(f);
      raw = r?.data?.text || "";
    }catch(e){
      fail++;
      dbg.value = "OCR error: " + (e?.message || String(e));
      continue;
    }

    const text = norm(raw);
    const lines = splitLines(text);

    // Debug (r√∫t g·ªçn)
    const show = lines.slice(0, 120).join("\n");
    dbg.value = show;

    const db5 = findDB5(lines);
    const db2 = db5 ? db5.slice(-2) : null;
    const g6 = findRowStrict(lines, 6);
    const g7 = findRowStrict(lines, 7);

    const parsed = {db5, db2, g6, g7};
    const gateInfo = gate3(db2, g6, g7, lines);

    setParseUI(parsed, gateInfo);

    if(gateInfo.pass){
      ok++;
      const line = `DB ${db2} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`;
      appendDataLine(line);
    }else{
      fail++;
      // add why to debug
      dbg.value = dbg.value + "\n\n[GATE FAIL] " + gateInfo.why +
        `\nDB5=${db5||"‚Äî"} DB2=${db2||"‚Äî"}\nG7=${g7?g7.join(" "):"‚Äî"}\nG6=${g6?g6.join(" "):"‚Äî"}`;
    }
    setChip(chipBatch, `Batch: ${filesQueue.length} ·∫£nh | OK ${ok} | FAIL ${fail}`, fail ? "warn" : "ok");
  }

  setChip(chipTess, "Tesseract: ready", "ok");
});

/* =========================
   MANUAL ADD
========================= */
btnManual.addEventListener("click", ()=>{
  const db = (mDB.value||"").trim();
  const g6 = (mG6.value||"").trim().split(/\s+/).filter(Boolean);
  const g7 = (mG7.value||"").trim().split(/\s+/).filter(Boolean);

  const okDB = /^\d{2}$/.test(db);
  const okG6 = g6.length===3 && g6.every(x=>/^\d{3}$/.test(x));
  const okG7 = g7.length===4 && g7.every(x=>/^\d{2}$/.test(x));
  if(!okDB || !okG6 || !okG7){
    alert("Manual sai format.\nDB=2 s·ªë\nG7=4 s·ªë 2 ch·ªØ\nG6=3 s·ªë 3 ch·ªØ");
    return;
  }
  appendDataLine(`DB ${db} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`);
  setGate("PASS", "ok");
});

/* =========================
   FULL STATS (Hot + Gan)
========================= */
function clampInt(v, d){
  const n = parseInt(String(v||"").trim(),10);
  return Number.isFinite(n) ? n : d;
}
function clampFloat(v, d){
  const n = parseFloat(String(v||"").trim().replace(",","."));
  return Number.isFinite(n) ? n : d;
}

function parseRowsFromData(){
  const lines = (data.value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const N = Math.max(5, Math.min(120, clampInt(winN.value,30)));
  const use = lines.slice(-N);

  const rows = [];
  for(const L of use){
    const mDB = L.match(/\bDB\s+(\d{2})\b/i);
    const mG7 = L.match(/\bG7:\s*([0-9 ]+)/i);
    const mG6 = L.match(/\bG6:\s*([0-9 ]+)/i);
    if(!mDB || !mG7 || !mG6) continue;

    const db = mDB[1];
    const g7 = mG7[1].trim().split(/\s+/).filter(x=>/^\d{2}$/.test(x)).slice(0,4);
    const g6 = mG6[1].trim().split(/\s+/).filter(x=>/^\d{3}$/.test(x)).slice(0,3);
    if(g7.length!==4 || g6.length!==3) continue;

    const g6_2 = g6.map(x=>x.slice(-2));
    const set = new Set([db, ...g7, ...g6_2]);
    rows.push({db,g7,g6,g6_2,set});
  }
  return rows;
}

btnRun.addEventListener("click", ()=>{
  const rows = parseRowsFromData();
  if(rows.length < 5){
    out.value = `‚ùå Thi·∫øu d·ªØ li·ªáu h·ª£p l·ªá. C·∫ßn >= 5 d√≤ng.\nHi·ªán c√≥: ${rows.length}\n\nM·∫πo: OCR PASS v√†i ·∫£nh ho·∫∑c d√πng Manual.`;
    return;
  }

  const K = Math.max(5, Math.min(50, clampInt(topK.value,15)));
  const wH = clampFloat(wHot.value,2);
  const wG = clampFloat(wGan.value,1.5);

  // freq
  const freq = new Map();
  for(const r of rows){
    for(const n of r.set) freq.set(n, (freq.get(n)||0)+1);
  }

  // gan (days since last appearance)
  const nums = Array.from(freq.keys());
  const gan = new Map();
  for(const n of nums){
    let last = -1;
    for(let i=rows.length-1;i>=0;i--){
      if(rows[i].set.has(n)){ last=i; break; }
    }
    gan.set(n, last===-1 ? rows.length : (rows.length-1-last));
  }

  const scored = nums.map(n=>{
    const h = freq.get(n)||0;
    const g = gan.get(n)||0;
    const s = h*wH + g*wG;
    return {n,h,g,s};
  }).sort((a,b)=> b.s-a.s || b.h-a.h || b.g-a.g);

  const topHot = [...scored].sort((a,b)=> b.h-a.h).slice(0,K);
  const topScore = scored.slice(0,K);

  const pick1 = topScore[0]?.n || "‚Äî";
  const pick2 = topScore[1]?.n || "‚Äî";

  let txt = "";
  txt += `T·ªïng ng√†y d√πng: ${rows.length}\n\n`;
  txt += `TOP HOT:\n` + topHot.map(x=>`${x.n} -> ${x.h}`).join("\n") + "\n\n";
  txt += `TOP SCORE (hot*${wH} + gan*${wG}):\n` + topScore.map(x=>`${x.n} -> ${x.s.toFixed(2)} (hot:${x.h}, gan:${x.g})`).join("\n") + "\n\n";
  txt += `CH·ªêT G·ª¢I √ù:\nüéØ Ch√≠nh: ${pick1}\nüõ°Ô∏è Ph·ª•:  ${pick2}\n\n`;
  txt += `* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng.`;
  out.value = txt;
});
</script>
</body>
</html>
