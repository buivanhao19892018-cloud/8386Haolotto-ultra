<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER+++ (OCR Gate + GOD MODE)</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d;
      --card:#0b1730;
      --card2:#0a1427;
      --text:#e8f0ff;
      --muted:#a8b7d6;
      --line:rgba(255,255,255,.08);
      --good:#32d583;
      --warn:#fdb022;
      --bad:#ff4d4f;
      --btn:#1e5eff;
      --btn2:#1a3fa8;
      --chip:#0b1d3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 10% -20%, rgba(30,94,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(50,213,131,.18), transparent 55%),
        linear-gradient(180deg, #06101f, #050b16 45%, #050a13);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      margin-bottom:14px;
    }
    h1{margin:0 0 8px;font-size:22px;letter-spacing:.2px}
    .pillrow{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}
    .pill{
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{display:inline-block;width:8px;height:8px;border-radius:99px;margin-right:6px;vertical-align:middle}
    .g{background:var(--good)} .y{background:var(--warn)} .r{background:var(--bad)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px}
    .btn{
      appearance:none;border:0;cursor:pointer;
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:white;font-weight:800;
      padding:12px 14px;border-radius:14px;
      box-shadow:0 10px 18px rgba(30,94,255,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;
      color:var(--text);
      font-weight:700;
    }
    .btn.danger{
      background:linear-gradient(180deg,#ff4d4f,#b42318);
      box-shadow:0 10px 18px rgba(255,77,79,.18);
    }
    .hint{color:var(--muted);line-height:1.4;font-size:13px;margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    @media(min-width:860px){.grid{grid-template-columns:1.2fr .8fr}}
    .preview{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      background:#060b13;
      overflow:hidden;
    }
    canvas, img{display:block;width:100%;height:auto}
    .status{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .badge{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:800;font-size:12px
    }
    .badge.ok{color:var(--good)}
    .badge.fail{color:var(--bad)}
    .badge.warn{color:var(--warn)}
    .sectionTitle{font-size:18px;margin:0 0 6px;}
    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      color:#d7e2ff;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .inputs{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:700px){.inputs{grid-template-columns:1fr 1fr}}
    .field{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input, .field textarea, .field select{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      padding:6px 0;
    }
    textarea{min-height:150px;resize:vertical}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .split .field{flex:1;min-width:180px}
    .kpi{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:700px){.kpi{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .kpi .box{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      padding:10px;
    }
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:16px;font-weight:900;margin-top:4px}

    /* GOD MODE UI */
    .tabs{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .tab{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); font-weight:800;
      cursor:pointer; user-select:none;
    }
    .tab.active{
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      border-color:transparent;
      box-shadow:0 10px 18px rgba(30,94,255,.20);
    }
    .chiprow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-size:12px;
      font-weight:800;
    }
    .chip.good{border-color:rgba(50,213,131,.35); color:var(--good)}
    .chip.warn{border-color:rgba(253,176,34,.35); color:var(--warn)}
    .chip.bad{border-color:rgba(255,77,79,.35); color:var(--bad)}
    .hr{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>

<body>
<div class="wrap">

  <!-- ===========================================
       1) SCAN / OCR / GATE  (GI·ªÆ NGUY√äN LOGIC C≈®)
       =========================================== -->
  <div class="card">
    <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER+++ (OCR Gate)</h1>
    <div class="pillrow">
      <div class="pill"><span class="dot g"></span>OpenCV</div>
      <div class="pill"><span class="dot g"></span>Tesseract OCR</div>
      <div class="pill"><span class="dot y"></span>Gate c·ª©ng</div>
      <div class="pill"><span class="dot y"></span>Batch nhi·ªÅu ·∫£nh</div>
      <div class="pill"><span class="dot y"></span>DB theo nh√£n ‚ÄúƒêB/DB‚Äù + 5 s·ªë</div>
      <div class="pill"><span class="dot y"></span>G7/G6 theo pattern</div>
      <div class="pill"><span class="dot g"></span>KH√îNG ph√° SCAN/SCALE</div>
    </div>

    <div class="hint">
      Lu·ªìng chu·∫©n: <b>Upload nhi·ªÅu ·∫£nh</b> ‚Üí tool t·ª± c·∫Øt v√πng b·∫£ng ‚Üí <b>DB: t√¨m nh√£n ƒêB/DB + 5 s·ªë</b> ‚Üí
      <b>G7: d√≤ng g·∫ßn cu·ªëi c√≥ 4 s·ªë 2 ch·ªØ s·ªë</b> ‚Üí <b>G6: d√≤ng ph√≠a tr√™n c√≥ 3 s·ªë 3 ch·ªØ s·ªë</b> ‚Üí
      <b>Gate pass</b> m·ªõi ƒë·ªï v√†o d·ªØ li·ªáu ‚Üí ch·∫°y FULL. <br/>
      (*Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.)
    </div>

    <div class="row">
      <button class="btn" id="btnMulti">üì∏ Upload nhi·ªÅu ·∫£nh</button>
      <button class="btn ghost" id="btnCam">üì∑ Camera</button>
      <button class="btn ghost" id="btnSample">D√°n m·∫´u</button>
      <button class="btn danger" id="btnClear">X√≥a</button>
      <input id="fileMulti" type="file" accept="image/*" multiple hidden />
      <input id="fileCam" type="file" accept="image/*" capture="environment" hidden />
    </div>

    <div class="status">
      <div class="badge ok" id="stCv">‚óè OpenCV: loading‚Ä¶</div>
      <div class="badge ok" id="stOcr">‚óè OCR: idle</div>
      <div class="badge warn" id="stGate">‚óè Gate: waiting</div>
      <div class="badge warn" id="stBatch">‚óè Batch: 0</div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <h2 class="sectionTitle">·∫¢nh ‚Üí OCR ‚Üí Gate</h2>
        <div class="hint">
          M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) v√† header qu·∫£ng c√°o.
        </div>

        <div class="preview" style="margin-top:10px">
          <img id="imgPreview" alt="preview" />
          <canvas id="cvCanvas" style="display:none"></canvas>
        </div>

        <div class="kpi">
          <div class="box"><div class="t">DB (2 s·ªë)</div><div class="v" id="kDB">--</div></div>
          <div class="box"><div class="t">G6 (3 s·ªë)</div><div class="v" id="kG6">--</div></div>
          <div class="box"><div class="t">G7 (4 s·ªë)</div><div class="v" id="kG7">--</div></div>
          <div class="box"><div class="t">Gate</div><div class="v" id="kGate">--</div></div>
        </div>

        <div class="inputs">
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî DB (2 s·ªë)</label>
            <input id="manualDB" placeholder="VD: 45" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G6 (3 s·ªë 3 ch·ªØ s·ªë)</label>
            <input id="manualG6" placeholder="VD: 392 255 854" />
          </div>
          <div class="field">
            <label>S·ª≠a tay (ch·ªâ khi Gate fail) ‚Äî G7 (4 s·ªë 2 ch·ªØ s·ªë)</label>
            <input id="manualG7" placeholder="VD: 03 82 85 81" />
          </div>
          <div class="field">
            <label>H√†nh ƒë·ªông</label>
            <div class="split">
              <button class="btn ghost" id="btnApplyManual">√Åp manual ‚Üí th√™m d√≤ng</button>
              <button class="btn ghost" id="btnRetryLast">Th·ª≠ OCR l·∫°i ·∫£nh cu·ªëi</button>
            </div>
          </div>
        </div>

      </div>

      <div>
        <h2 class="sectionTitle">Debug OCR</h2>
        <div class="mono" id="dbg">Ch∆∞a c√≥ OCR.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 class="sectionTitle">D·ªØ li·ªáu ƒë·∫ßu v√†o (m·ªói d√≤ng = 1 ng√†y)</h2>
    <div class="hint">Format chu·∫©n auto: <b>DB xx | G7: a b c d | G6: xxx yyy zzz</b></div>
    <div class="field" style="margin-top:10px">
      <textarea id="inputData" placeholder="Sau batch scan, tool t·ª± ƒë·ªï v√†o ƒë√¢y..."></textarea>
    </div>

    <div class="split" style="margin-top:10px">
      <div class="field">
        <label>C·ª≠a s·ªï soi (ng√†y) ‚Äî g·ª£i √Ω: 20</label>
        <input id="winDays" type="number" value="20" min="5" />
      </div>
      <div class="field">
        <label>Top hi·ªÉn th·ªã</label>
        <input id="topN" type="number" value="15" min="5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Hot</label>
        <input id="wHot" type="number" value="2" step="0.5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Gan</label>
        <input id="wGan" type="number" value="1.5" step="0.5" />
      </div>
      <div class="field">
        <label>Tr·ªçng s·ªë Pascal (gi·ªØ s·∫µn)</label>
        <input id="wPas" type="number" value="2" step="0.5" />
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btnFull">üöÄ Ch·∫°y FULL</button>
    </div>
  </div>

  <div class="card">
    <h2 class="sectionTitle">K·∫æT QU·∫¢ FULL</h2>
    <div class="mono" id="out">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
  </div>

  <!-- ===========================================
       2) GOD MODE / FULL PRO SOI L√î 2 S·ªê (G·∫ÆN D∆Ø·ªöI KQ FULL)
       =========================================== -->
  <div class="card" id="godCard" style="display:none">
    <h2 class="sectionTitle">SOI C·∫¶U L√î 2 S·ªê ‚Äî ULTRA MASTER+++ (GOD MODE)</h2>
    <div class="hint">
      T·ªïng h·ª£p: Hot/Gan ‚Ä¢ ƒê·∫ßu/ƒêu√¥i ‚Ä¢ Ch·∫°m/K√©p/B√≥ng ‚Ä¢ Tr·ª•c ‚Ä¢ Pascal/Chu k·ª≥ ‚Ä¢ Nh·ªãp G6 vs G7 ‚Ä¢ Anti-b·∫´y ‚Ä¢ ƒê·ªçc pha (MASTER+++).
      <b>Output: 4 s·ªë + %</b> + c·∫£nh b√°o m·∫°nh.
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="sum">T·ªïng h·ª£p</div>
      <div class="tab" data-tab="hg">Hot/Gan</div>
      <div class="tab" data-tab="hd">ƒê·∫ßu/ƒêu√¥i</div>
      <div class="tab" data-tab="ckb">Ch·∫°m/K√©p/B√≥ng</div>
      <div class="tab" data-tab="truc">Tr·ª•c</div>
      <div class="tab" data-tab="pha">ƒê·ªçc pha</div>
      <div class="tab" data-tab="log">Nh·∫≠t k√Ω</div>
    </div>

    <div class="hr"></div>

    <div id="tab_sum" class="mono"></div>
    <div id="tab_hg" class="mono" style="display:none"></div>
    <div id="tab_hd" class="mono" style="display:none"></div>
    <div id="tab_ckb" class="mono" style="display:none"></div>
    <div id="tab_truc" class="mono" style="display:none"></div>
    <div id="tab_pha" class="mono" style="display:none"></div>

    <div id="tab_log_wrap" style="display:none">
      <div class="split">
        <div class="field">
          <label>Nh·∫≠p KQ DB h√¥m nay (2 s·ªë) ƒë·ªÉ ch·∫•m</label>
          <input id="log_db" placeholder="VD: 45" />
        </div>
        <div class="field">
          <label>H√†nh ƒë·ªông</label>
          <div class="split">
            <button class="btn ghost" id="btnLogSave">Ch·∫•m & l∆∞u</button>
            <button class="btn danger" id="btnLogClear">X√≥a nh·∫≠t k√Ω</button>
          </div>
        </div>
      </div>
      <div class="mono" id="tab_log" style="margin-top:10px"></div>
    </div>

    <div class="hr"></div>
    <div class="small">¬© B√πi H√†o ‚Äî Tool th·ªëng k√™ h·ªó tr·ª£ ph√¢n t√≠ch. Kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.</div>
  </div>

</div>

<!-- Load libs -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>

<script>
/* ==========================================================
   PH·∫¶N 1: SCAN/OCR/GATE  (GI·ªÆ NGUY√äN LOGIC NH∆Ø B·∫¢N C·ª¶A B·∫†N)
   ========================================================== */
let cvReady = false;
let lastImageBlob = null;
let batchOK = 0, batchFail = 0;

const el = (id)=>document.getElementById(id);

function setBadge(id, text, cls){
  const e = el(id);
  e.textContent = text;
  e.classList.remove("ok","warn","fail");
  e.classList.add(cls);
}
function setStatus(){
  setBadge("stCv", `‚óè OpenCV: ${cvReady ? "OK" : "loading‚Ä¶"}`, cvReady ? "ok" : "warn");
  setBadge("stBatch", `‚óè Batch: OK ${batchOK} | FAIL ${batchFail}`, (batchFail>0) ? "warn" : "ok");
}
function showKPI(db2, g6, g7, gate){
  el("kDB").textContent = db2 || "--";
  el("kG6").textContent = g6?.length ? g6.join(" ") : "--";
  el("kG7").textContent = g7?.length ? g7.join(" ") : "--";
  el("kGate").textContent = gate;
}
function onOpenCvReady(){
  cvReady = true;
  setStatus();
}
setStatus();

function pad2(n){ return String(n).padStart(2,"0"); }

function canvasFromMat(mat){
  const canvas = document.createElement("canvas");
  canvas.width = mat.cols;
  canvas.height = mat.rows;
  cv.imshow(canvas, mat);
  return canvas;
}
function preprocess(mat){
  const gray = new cv.Mat();
  cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY, 0);
  const blur = new cv.Mat();
  cv.GaussianBlur(gray, blur, new cv.Size(3,3), 0, 0, cv.BORDER_DEFAULT);
  const thr = new cv.Mat();
  cv.adaptiveThreshold(
    blur, thr, 255,
    cv.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv.THRESH_BINARY, 31, 8
  );
  gray.delete(); blur.delete();
  return thr;
}
async function ocrText(canvas){
  const res = await Tesseract.recognize(canvas, "eng", {
    logger: ()=>{},
    tessedit_char_whitelist: "0123456789",
    preserve_interword_spaces: "1",
  });
  return (res.data.text || "");
}
function cleanOCRDigits(txt){
  return String(txt)
    .replace(/[Oo]/g,"0")
    .replace(/[Il|]/g,"1")
    .replace(/S/g,"5")
    .replace(/B/g,"8")
    .replace(/[^\d\s\n]/g," ")
    .replace(/\s+\n/g,"\n")
    .replace(/\n\s+/g,"\n")
    .replace(/[ \t]+/g," ")
    .trim();
}
function extractDB5_fromLabel(text){
  const t = text.replace(/\s+/g," ");
  let m = t.match(/(?:ƒê\s*B|D\s*B)\s*(\d{5})/);
  if(m) return m[1];
  m = t.match(/\b\d{5}\b/);
  return m ? m[0] : "";
}
function findG7Line(lines){
  for(let i=lines.length-1;i>=0;i--){
    const nums2 = (lines[i].match(/\b\d{2}\b/g) || []);
    if(nums2.length >= 4){
      return {arr: nums2.slice(0,4), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}
function findG6Line(lines, g7Index){
  for(let i=g7Index-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  for(let i=lines.length-1;i>=0;i--){
    const nums3 = (lines[i].match(/\b\d{3}\b/g) || []);
    if(nums3.length >= 3){
      return {arr: nums3.slice(0,3), idx:i, line:lines[i]};
    }
  }
  return {arr:[], idx:-1, line:""};
}
function gateCheck(db5, g6_3, g7_4){
  if(!/^\d{5}$/.test(db5)) return {ok:false, reason:"DB kh√¥ng ƒë·ªß 5 s·ªë"};
  if(!g7_4 || g7_4.length!==4 || !g7_4.every(x=>/^\d{2}$/.test(x))) return {ok:false, reason:"G7 ph·∫£i ƒë√∫ng 4 s·ªë (2 ch·ªØ s·ªë)"};
  if(!g6_3 || g6_3.length!==3 || !g6_3.every(x=>/^\d{3}$/.test(x))) return {ok:false, reason:"G6 ph·∫£i ƒë√∫ng 3 s·ªë (3 ch·ªØ s·ªë)"};
  return {ok:true, reason:"OK"};
}
function addLineToInput(db5, g7, g6){
  const db2 = db5.slice(-2);
  const line = `DB ${db2} | G7: ${g7.join(" ")} | G6: ${g6.join(" ")}`;
  const cur = el("inputData").value.trim();
  el("inputData").value = (cur ? cur + "\n" : "") + line;
}

async function runOCRFromBlob(blob){
  if(!cvReady){
    alert("OpenCV ch∆∞a load xong. ƒê·ª£i 2‚Äì3 gi√¢y r·ªìi th·ª≠ l·∫°i.");
    return;
  }
  lastImageBlob = blob;

  setBadge("stOcr", "‚óè OCR: running‚Ä¶", "warn");
  setBadge("stGate", "‚óè Gate: checking‚Ä¶", "warn");
  showKPI("", [], [], "--");

  const url = URL.createObjectURL(blob);
  el("imgPreview").src = url;

  await new Promise(r=>{
    el("imgPreview").onload = ()=>r();
  });

  const img = el("imgPreview");
  const canvas = el("cvCanvas");
  canvas.style.display = "none";
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0);

  let src = cv.imread(canvas);
  const W = src.cols, H = src.rows;
  const crop = src.roi(new cv.Rect(
    Math.floor(W*0.02),
    Math.floor(H*0.02),
    Math.floor(W*0.96),
    Math.floor(H*0.96)
  ));
  src.delete(); src = crop;

  const upH = Math.floor(src.rows * 0.55);
  const upper = src.roi(new cv.Rect(0,0, src.cols, upH));
  const body  = src.roi(new cv.Rect(0, Math.floor(src.rows*0.35), src.cols, Math.floor(src.rows*0.65)));

  const upperBin = preprocess(upper);
  const upperCanvas = canvasFromMat(upperBin);
  const upperTxt1 = await ocrText(upperCanvas);

  const upperInv = new cv.Mat(); cv.bitwise_not(upperBin, upperInv);
  const upperCanvas2 = canvasFromMat(upperInv);
  const upperTxt2 = await ocrText(upperCanvas2);

  const upperTxt = cleanOCRDigits((upperTxt1||"") + "\n" + (upperTxt2||""));
  const db5 = extractDB5_fromLabel(upperTxt);

  upper.delete(); upperBin.delete(); upperInv.delete();

  const bodyBin = preprocess(body);
  const bodyCanvas = canvasFromMat(bodyBin);
  const bodyTxt1 = await ocrText(bodyCanvas);

  const bodyInv = new cv.Mat(); cv.bitwise_not(bodyBin, bodyInv);
  const bodyCanvas2 = canvasFromMat(bodyInv);
  const bodyTxt2 = await ocrText(bodyCanvas2);

  const bodyTxt = cleanOCRDigits((bodyTxt1||"") + "\n" + (bodyTxt2||""));
  const lines = bodyTxt.split("\n").map(s=>s.trim()).filter(Boolean);

  const g7Found = findG7Line(lines);
  const g6Found = findG6Line(lines, g7Found.idx);

  const g7 = g7Found.arr;
  const g6 = g6Found.arr;

  body.delete(); bodyBin.delete(); bodyInv.delete();
  src.delete();
  URL.revokeObjectURL(url);

  const gate = gateCheck(db5, g6, g7);
  const db2 = (/^\d{5}$/.test(db5)) ? db5.slice(-2) : "";

  el("dbg").textContent =
`[UPPER_OCR]
${upperTxt || "(empty)"}

[DB_5DIG]
${db5 || "(none)"}

[LOWER_OCR]
${bodyTxt || "(empty)"}

[G7_LINE]
${g7Found.line || "(none)"}

[G6_LINE]
${g6Found.line || "(none)"}
`;

  showKPI(db2, g6, g7, gate.ok ? "PASS" : "FAIL");
  setBadge("stOcr", "‚óè OCR: done", "ok");
  if(gate.ok){
    setBadge("stGate", "‚óè Gate: PASS", "ok");
    addLineToInput(db5, g7, g6);
    batchOK++;
  }else{
    setBadge("stGate", `‚óè Gate: FAIL ‚Äî ${gate.reason}`, "fail");
    batchFail++;
    el("manualDB").value = db2 || "";
    el("manualG6").value = g6.length ? g6.join(" ") : "";
    el("manualG7").value = g7.length ? g7.join(" ") : "";
  }
  setStatus();
}

function parseManual(){
  const db2 = (el("manualDB").value || "").replace(/\D/g,"").slice(-2);
  const g6 = (el("manualG6").value || "").match(/\b\d{3}\b/g) || [];
  const g7 = (el("manualG7").value || "").match(/\b\d{2}\b/g) || [];
  if(db2.length!==2) return {ok:false, msg:"DB manual ph·∫£i ƒë√∫ng 2 s·ªë"};
  if(g6.length<3) return {ok:false, msg:"G6 manual ph·∫£i ƒë·ªß 3 s·ªë (3 ch·ªØ s·ªë)"};
  if(g7.length<4) return {ok:false, msg:"G7 manual ph·∫£i ƒë·ªß 4 s·ªë (2 ch·ªØ s·ªë)"};
  const fakeDB5 = "000" + db2;
  return {ok:true, fakeDB5, g6:g6.slice(0,3), g7:g7.slice(0,4)};
}
el("btnApplyManual").onclick = ()=>{
  const r = parseManual();
  if(!r.ok){ alert(r.msg); return; }
  addLineToInput(r.fakeDB5, r.g7, r.g6);
  setBadge("stGate","‚óè Gate: MANUAL OK","ok");
};

el("btnMulti").onclick = ()=> el("fileMulti").click();
el("btnCam").onclick   = ()=> el("fileCam").click();

el("fileMulti").addEventListener("change", async (e)=>{
  const files = [...(e.target.files || [])];
  if(!files.length) return;
  setBadge("stOcr","‚óè OCR: batch running‚Ä¶","warn");
  batchOK = 0; batchFail = 0;
  setStatus();
  for(const f of files){
    await runOCRFromBlob(f);
    await new Promise(r=>setTimeout(r, 120));
  }
  setBadge("stOcr","‚óè OCR: batch done","ok");
});
el("fileCam").addEventListener("change", async (e)=>{
  const f = (e.target.files || [])[0];
  if(!f) return;
  await runOCRFromBlob(f);
});
el("btnRetryLast").onclick = async ()=>{
  if(!lastImageBlob){ alert("Ch∆∞a c√≥ ·∫£nh n√†o ƒë·ªÉ retry."); return; }
  await runOCRFromBlob(lastImageBlob);
};
el("btnClear").onclick = ()=>{
  el("inputData").value = "";
  el("out").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
  el("dbg").textContent = "Ch∆∞a c√≥ OCR.";
  batchOK=0; batchFail=0;
  setBadge("stOcr","‚óè OCR: idle","ok");
  setBadge("stGate","‚óè Gate: waiting","warn");
  setStatus();
  showKPI("", [], [], "--");
  // clear GOD panel
  el("godCard").style.display = "none";
};
el("btnSample").onclick = ()=>{
  el("inputData").value =
`DB 45 | G7: 03 82 85 81 | G6: 392 255 854
DB 21 | G7: 76 47 21 77 | G6: 801 295 993
DB 14 | G7: 81 87 60 32 | G6: 206 200 971
DB 80 | G7: 22 20 16 61 | G6: 733 014 672`;
};

/* ==========================================================
   PH·∫¶N 2: ENGINE SOI L√î 2 S·ªê + ƒê·ªåC PHA MASTER+++ + ANTI-B·∫™Y
   (CH·ªà G·∫ÆN TH√äM D∆Ø·ªöI K·∫æT QU·∫¢ FULL)
   ========================================================== */

/* ---------- core parse ---------- */
function parseLinesWithWin(win){
  const raw = el("inputData").value.trim().split("\n").map(s=>s.trim()).filter(Boolean);
  const slice = raw.slice(0, win); // newest ·ªü tr√™n
  const days = [];
  for(const line of slice){
    const dbm = line.match(/DB\s+(\d{2})/);
    const g7m = line.match(/G7:\s*([0-9 ]+)/);
    const g6m = line.match(/G6:\s*([0-9 ]+)/);
    if(!dbm || !g7m || !g6m) continue;

    const db2 = pad2(dbm[1]);
    const g7 = (g7m[1].match(/\b\d{2}\b/g)||[]).slice(0,4).map(pad2);
    const g6_3 = (g6m[1].match(/\b\d{3}\b/g)||[]).slice(0,3);
    const g6_2 = g6_3.map(x=>pad2(x.slice(-2)));

    const pool = [db2, ...g7, ...g6_2].map(pad2);
    days.push({db2, g7, g6_2, pool});
  }
  return days;
}

/* ---------- utils ---------- */
function head(n){ return n[0]; }
function tail(n){ return n[1]; }
function bong(n){
  // b√≥ng 0-9: (9 - digit)
  const a = 9 - parseInt(n[0],10);
  const b = 9 - parseInt(n[1],10);
  return ""+a+b;
}
function isKep(n){ return n[0]===n[1]; }
function scoreToPct(arrScores){
  // normalize top list -> %
  const vals = arrScores.map(x=>x.s);
  const max = Math.max(...vals);
  const min = Math.min(...vals);
  return arrScores.map(x=>{
    const pct = (max===min) ? 50 : Math.round( 40 + 60*( (x.s - min)/(max-min) ) );
    return {...x, pct};
  });
}

/* ---------- hot/gan ---------- */
function buildHotGan(days){
  const freq = {};
  days.forEach(d=>d.pool.forEach(n=>freq[n]=(freq[n]||0)+1));

  const lastSeen = {};
  days.forEach((d, idx)=>{
    d.pool.forEach(n=>{
      if(lastSeen[n]===undefined) lastSeen[n]=idx; // idx 0 newest
    });
  });

  const gan = {};
  for(let i=0;i<100;i++){
    const n = pad2(i);
    gan[n] = (lastSeen[n]===undefined) ? 999 : lastSeen[n];
  }
  return {freq, gan};
}

/* ---------- ‚Äútr·ª•c‚Äù (heuristic): c·∫∑p ƒë·∫ßu-ƒëu√¥i n·ªïi (ƒë·∫ßu m·∫°nh + ƒëu√¥i m·∫°nh giao nhau) ---------- */
function buildHeadTail(days){
  const h = Array(10).fill(0);
  const t = Array(10).fill(0);
  days.forEach(d=>{
    d.pool.forEach(n=>{
      h[parseInt(n[0],10)]++;
      t[parseInt(n[1],10)]++;
    });
  });
  const hSorted = [...h.entries()].sort((a,b)=>b[1]-a[1]);
  const tSorted = [...t.entries()].sort((a,b)=>b[1]-a[1]);
  return {h, t, hSorted, tSorted};
}

function buildTrucCandidates(hSorted, tSorted, take=3){
  const heads = hSorted.slice(0,take).map(([d])=>String(d));
  const tails = tSorted.slice(0,take).map(([d])=>String(d));
  const pairs = [];
  heads.forEach(a=>tails.forEach(b=>pairs.push(a+b)));
  // unique
  return [...new Set(pairs)];
}

/* ---------- ‚Äúnh·ªãp G6 vs G7‚Äù (lead) ---------- */
function calcG7Lead(days){
  // ƒëo: DB h√¥m nay c√≥ n·∫±m trong pool G7 c·ªßa h√¥m qua kh√¥ng?
  // days[0] newest; compare day0 db2 vs day1 g7
  if(days.length < 2) return {rate:0, hits:0, total:0};
  let hits=0,total=0;
  for(let i=0;i<days.length-1;i++){
    const today = days[i];
    const prev  = days[i+1];
    total++;
    if(prev.g7.includes(today.db2)) hits++;
  }
  return {rate: total? hits/total : 0, hits, total};
}

/* ---------- ‚Äúpascal/chu k·ª≥‚Äù (lightweight): ∆∞u ti√™n s·ªë xu·∫•t hi·ªán theo nh·ªãp l·∫∑p 2-3 ng√†y ---------- */
function pascalPulse(days, n){
  // heuristic: n·∫øu n xu·∫•t hi·ªán c√°ch qu√£ng 2-3 ng√†y l·∫∑p l·∫°i -> +1
  const idxs = [];
  days.forEach((d, idx)=>{ if(d.pool.includes(n)) idxs.push(idx); });
  if(idxs.length < 2) return 0;
  let bonus = 0;
  for(let i=0;i<idxs.length-1;i++){
    const gap = Math.abs(idxs[i]-idxs[i+1]);
    if(gap===2 || gap===3) bonus += 1;
  }
  return Math.min(2, bonus); // cap
}

/* ---------- Anti-b·∫´y ---------- */
function antiBay(days, freq, gan, top4){
  const warns = [];
  // b·∫´y gan: top to√†n gan qu√° l·ªõn ho·∫∑c gan=0 nhi·ªÅu
  const gan0 = top4.filter(x=>gan[x.n]===0).length;
  const gan999 = top4.filter(x=>gan[x.n]===999).length;
  if(gan0>=2) warns.push("‚ö†Ô∏è B·∫™Y GAN: C√≥ ‚â•2 s·ªë v·ª´a n·ªï h√¥m qua (gan=0) ‚Äî d·ªÖ l·ª´a.");
  if(gan999>=2) warns.push("‚ö†Ô∏è B·∫™Y GAN D√ÄI: C√≥ ‚â•2 s·ªë gan qu√° d√†i (999) ‚Äî d·ªÖ m∆° h·ªì.");

  // b·∫´y c·ª•m: top4 tr√πng ƒë·∫ßu ho·∫∑c tr√πng ƒëu√¥i qu√° nhi·ªÅu
  const headMap={}, tailMap={};
  top4.forEach(x=>{
    headMap[head(x.n)] = (headMap[head(x.n)]||0)+1;
    tailMap[tail(x.n)] = (tailMap[tail(x.n)]||0)+1;
  });
  const maxH = Math.max(...Object.values(headMap));
  const maxT = Math.max(...Object.values(tailMap));
  if(maxH>=3) warns.push("‚ö†Ô∏è B·∫™Y C·ª§M: 3/4 s·ªë tr√πng ƒê·∫¶U ‚Äî d·ªÖ b·ªã d·ªìn ·∫£o.");
  if(maxT>=3) warns.push("‚ö†Ô∏è B·∫™Y C·ª§M: 3/4 s·ªë tr√πng ƒêU√îI ‚Äî d·ªÖ b·ªã d·ªìn ·∫£o.");

  // ƒë·∫£o pha: n·∫øu G7 lead rate th·∫•p nh∆∞ng l·∫°i ch·ªët theo G7
  const g7Lead = calcG7Lead(days);
  if(g7Lead.rate < 0.25) warns.push("‚ö†Ô∏è ƒê·∫¢O PHA: G7 lead y·∫øu (√≠t k√©o DB) ‚Äî h·∫°n ch·∫ø b√°m G7.");

  // nhi·ªÖu: ph√¢n t√°n hot th·∫•p
  const hotVals = Object.values(freq);
  const maxHot = hotVals.length ? Math.max(...hotVals) : 0;
  if(maxHot <= 2) warns.push("‚ö†Ô∏è NG√ÄY NHI·ªÑU: hot ph√¢n t√°n (max hot ‚â§2) ‚Äî n√™n ƒë√°nh nh·∫π/n√©.");

  if(!warns.length) warns.push("OK (ch∆∞a th·∫•y b·∫´y r√µ).");
  return warns;
}

/* ---------- ƒê·ªçc PHA MASTER+++ ---------- */
function readPhase(days, freq, gan, headTail){
  // P1: G7 Lead m·∫°nh (DB hay n·∫±m trong G7 h√¥m tr∆∞·ªõc)
  // P2: Tr·ª•c Lead (ƒë·∫ßu/ƒëu√¥i t·∫≠p trung m·∫°nh)
  // P3: Giao thoa
  // P4: Nhi·ªÖu (ph√¢n t√°n)
  // P5: X·∫£ (gan=0 nhi·ªÅu, v·ª´a n·ªï d·ªìn)
  // P6: M·ªü (v·ª´a qua nhi·ªÖu/x·∫£ nh∆∞ng b·∫Øt ƒë·∫ßu c√≥ tr·ª•c n·ªïi)
  const g7Lead = calcG7Lead(days);
  const maxHead = headTail.hSorted[0]?.[1] || 0;
  const maxTail = headTail.tSorted[0]?.[1] || 0;

  // noise check
  const hotVals = Object.values(freq);
  const maxHot = hotVals.length ? Math.max(...hotVals) : 0;

  // x·∫£ check: ng√†y m·ªõi nh·∫•t (days[0]) pool tr√πng qu√° nhi·ªÅu v·ªõi day1?
  let overlap = 0;
  if(days.length>=2){
    const a = new Set(days[0].pool);
    const b = new Set(days[1].pool);
    a.forEach(x=>{ if(b.has(x)) overlap++; });
  }

  let pha="P3", name="Giao thoa", guide="Ch·ªçn l·ªçc 4 s·ªë, ∆∞u ti√™n s·ªë v·ª´a h·ª£p tr·ª•c v·ª´a h·ª£p hot/gan.";
  if(maxHot<=2 && maxHead<=4 && maxTail<=4){
    pha="P4"; name="Nhi·ªÖu"; guide="N√© ng√†y / ƒë√°nh nh·∫π. ∆Øu ti√™n 1‚Äì2 s·ªë ch·∫Øc, b·ªè d√†n r·ªông.";
  } else if(g7Lead.rate>=0.45){
    pha="P1"; name="G7 Lead"; guide="∆Øu ti√™n s·ªë b√°m G7 (k·ªÅ/b√≥ng/ch·∫°m) + l·ªçc anti-b·∫´y.";
  } else if(maxHead>=6 || maxTail>=6){
    pha="P2"; name="Tr·ª•c Lead"; guide="∆Øu ti√™n theo TR·ª§C (ƒë·∫ßu/ƒëu√¥i n·ªïi) + x√°c nh·∫≠n hot/gan.";
  } else if(overlap>=3){
    pha="P5"; name="X·∫£"; guide="H·∫°n ch·∫ø v√†o ti·ªÅn. D·ªÖ x·∫£ d·ªìn ‚Äî ch·ªçn 1 s·ªë th·ªß ho·∫∑c ngh·ªâ.";
  } else if(maxHot>=4 && (maxHead>=5 || maxTail>=5)){
    pha="P6"; name="M·ªü"; guide="C√≥ th·ªÉ ƒë√°nh m·∫°nh h∆°n (nh∆∞ng v·∫´n anti-b·∫´y). ∆Øu ti√™n tr·ª•c + hot.";
  }

  return {pha, name, guide, g7Lead};
}

/* ---------- FULL scoring (ch·ªâ loto 2 s·ªë) ---------- */
function buildScore(days, freq, gan, wHot, wGan, wPas){
  const score = {};
  for(let i=0;i<100;i++){
    const n = pad2(i);
    const hot = freq[n]||0;
    const g = gan[n];

    // ganScore: ∆∞u ti√™n 2..9, ph·∫°t 0 v√† 999
    const ganScore = (g===999) ? -2 : (g>=2 && g<=9 ? 2 : (g===0 ? -1 : 0));

    // pascal pulse bonus
    const p = pascalPulse(days, n);

    score[n] = hot*wHot + ganScore*wGan + p*wPas*0.35; // nh·∫π tay ƒë·ªÉ kh√¥ng ph√° "scal"
  }
  return score;
}

/* ---------- ch·∫°m/k√©p/b√≥ng + k·ªÅ ---------- */
function quickSupport(topCandidates, headTail){
  const headTop = headTail.hSorted.slice(0,3).map(([d])=>d);
  const tailTop = headTail.tSorted.slice(0,3).map(([d])=>d);

  const cham = [];
  headTop.forEach(d=>cham.push(d));
  tailTop.forEach(d=>cham.push(d));
  const chamUni = [...new Set(cham)].slice(0,3);

  const kepList = topCandidates.filter(x=>isKep(x)).slice(0,4);

  const bongMain = bong(topCandidates[0] || "00");

  // k·ªÅ: v·ªõi n = ab -> k·ªÅ (a(b¬±1)) v√† ((a¬±1)b) (c·∫Øt bi√™n)
  const main = topCandidates[0] || "00";
  const a = parseInt(main[0],10), b = parseInt(main[1],10);
  const ke = [];
  if(b-1>=0) ke.push(""+a+(b-1));
  if(b+1<=9) ke.push(""+a+(b+1));
  if(a-1>=0) ke.push(""+(a-1)+b);
  if(a+1<=9) ke.push(""+(a+1)+b);
  const ke2 = [...new Set(ke.map(pad2))].slice(0,4);

  return {
    headStrong: headTop,
    tailStrong: tailTop,
    chamStrong: chamUni,
    kepMain: kepList,
    bongMain,
    keMain: ke2
  };
}

/* ---------- GOD MODE output builders ---------- */
function buildGodReport(days, score, freq, gan, headTail){
  const topN = Math.max(5, parseInt(el("topN").value||"15",10));

  const scoreSorted = Object.entries(score)
    .sort((a,b)=>b[1]-a[1])
    .slice(0, Math.max(topN, 20))
    .map(([n,s])=>({n, s}));

  const scoreTop10 = scoreSorted.slice(0,10);
  const top4 = scoreSorted.slice(0,4);

  const top4Pct = scoreToPct(top4);

  const main4 = top4Pct.map(x=>`${x.n} (${x.pct}%)`);
  const anti = antiBay(days, freq, gan, top4Pct);

  const pha = readPhase(days, freq, gan, headTail);

  const trucCand = buildTrucCandidates(headTail.hSorted, headTail.tSorted, 3);
  const support = quickSupport(top4Pct.map(x=>x.n), headTail);

  // ‚ÄúTr·ª•c ch·∫°y‚Äù: ∆∞u ti√™n s·ªë n·∫±m trong giao ƒë·∫ßu m·∫°nh + ƒëu√¥i m·∫°nh
  const trucShown = trucCand.slice(0,9).join(" ");

  // block texts
  const tSum =
`=== ULTRA T·ªîNG H·ª¢P (GOD MODE) ===

1) TOP SCORE (Top 10):
${scoreTop10.map(x=>`${x.n} ‚Üí ${x.s.toFixed(2)}`).join("\n")}

2) CH·ªêT 4 S·ªê + %:
${main4.map((s,i)=>`${i+1}. ${s}`).join("\n")}

3) H·ªñ TR·ª¢ NHANH:
- ƒê·∫ßu m·∫°nh: ${support.headStrong.join(", ")}
- ƒêu√¥i m·∫°nh: ${support.tailStrong.join(", ")}
- Ch·∫°m m·∫°nh: ${support.chamStrong.join(", ")}
- K·ªÅ MAIN:  ${support.keMain.join(" ")}
- B√≥ng MAIN: ${support.bongMain}
- Tr·ª•c g·ª£i √Ω: ${trucShown}

4) ANTI-B·∫™Y:
${anti.map(x=>`- ${x}`).join("\n")}

5) ƒê·ªåC PHA (MASTER+++):
- ${pha.pha} ‚Äî ${pha.name}
- G7 lead: ${(pha.g7Lead.rate*100).toFixed(0)}% (hits ${pha.g7Lead.hits}/${pha.g7Lead.total})
- H∆∞·ªõng ƒë√°nh: ${pha.guide}

* Note: ch·ªâ l√† tool h·ªó tr·ª£ th·ªëng k√™.
`;

  const tHG =
`=== HOT / GAN (chu·∫©n) ===

HOT Top:
${Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,15).map(([n,c])=>`${n} ‚Üí ${c}`).join("\n")}

GAN (0=newest):
- Top 4 ƒë·ªÅ xu·∫•t:
${top4Pct.map(x=>`${x.n} ‚Üí gan ${gan[x.n]} | hot ${(freq[x.n]||0)}`).join("\n")}

G·ª£i √Ω:
- gan 2..9: ·ªïn ƒë·ªÉ v√†o
- gan 0: coi ch·ª´ng b·∫´y
- gan 999: tr√°nh ‚Äúm∆° h·ªì‚Äù n·∫øu kh√¥ng c√≥ tr·ª•c x√°c nh·∫≠n
`;

  const tHD =
`=== ƒê·∫¶U / ƒêU√îI ===

ƒê·∫ßu Top:
${headTail.hSorted.slice(0,10).map(([d,c])=>`${d} ‚Üí ${c}`).join("\n")}

ƒêu√¥i Top:
${headTail.tSorted.slice(0,10).map(([d,c])=>`${d} ‚Üí ${c}`).join("\n")}

Giao ƒë·∫ßu/ƒëu√¥i (tr·ª•c g·ª£i √Ω):
${trucShown}
`;

  const tCKB =
`=== CH·∫†M / K√âP / B√ìNG / K·ªÄ ===

Ch·∫°m m·∫°nh: ${support.chamStrong.join(", ")}
K√©p ∆∞u ti√™n (n·∫øu c√≥): ${support.kepMain.length ? support.kepMain.join(", ") : "(kh√¥ng n·ªïi)"}

B√≥ng MAIN: ${support.bongMain}
K·ªÅ MAIN:  ${support.keMain.join(" ")}

G·ª£i √Ω l·ªçc:
- N·∫øu pha P1 (G7 lead): ∆∞u ti√™n k·ªÅ/b√≥ng/ch·∫°m quanh G7
- N·∫øu pha P2 (Tr·ª•c lead): ∆∞u ti√™n s·ªë tr·ª•c giao ƒë·∫ßu/ƒëu√¥i
`;

  const tTruc =
`=== TR·ª§C (heuristic) ===

Tr·ª•c = giao (ƒê·∫ßu m·∫°nh √ó ƒêu√¥i m·∫°nh), d√πng ƒë·ªÉ ƒë·ªãnh h∆∞·ªõng ‚Äúd√≤ng ch·∫£y‚Äù.

Tr·ª•c g·ª£i √Ω (Top): ${trucShown}

C√°ch d√πng (ƒë√∫ng MASTER+++):
- ƒê·ªçc pha tr∆∞·ªõc
- N·∫øu P2/P6: tr·ª•c l√† ch·ªß l·ª±c
- N·∫øu P1: tr·ª•c ch·ªâ ƒë·ªÉ x√°c nh·∫≠n, kh√¥ng √©p
`;

  const tPha =
`=== AI ƒê·ªåC PHA ‚Äî MASTER+++ ===

B·∫£ng pha:
P1: G7 Lead  ‚Üí theo G7
P2: Tr·ª•c Lead ‚Üí theo tr·ª•c
P3: Giao thoa ‚Üí ch·ªçn l·ªçc
P4: Nhi·ªÖu     ‚Üí n√© ng√†y
P5: X·∫£        ‚Üí h·∫°n ch·∫ø
P6: M·ªü        ‚Üí c√≥ th·ªÉ ƒë√°nh m·∫°nh

K·∫øt lu·∫≠n h√¥m nay:
- ${pha.pha} ‚Äî ${pha.name}
- G7 lead: ${(pha.g7Lead.rate*100).toFixed(0)}%
- H∆∞·ªõng ƒë√°nh: ${pha.guide}

C·∫£nh b√°o:
${anti.map(x=>`- ${x}`).join("\n")}
`;

  return {tSum, tHG, tHD, tCKB, tTruc, tPha, top4: top4Pct, pha};
}

/* ---------- log module ---------- */
const LOG_KEY = "BH_ULTRA_MASTER_LOG_V1";

function loadLog(){
  try{
    return JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
  }catch(e){ return []; }
}
function saveLog(arr){
  localStorage.setItem(LOG_KEY, JSON.stringify(arr));
}
function renderLog(){
  const arr = loadLog();
  if(!arr.length){
    el("tab_log").textContent = "Ch∆∞a c√≥ nh·∫≠t k√Ω.";
    return;
  }
  // stats
  const total = arr.length;
  const hit = arr.filter(x=>x.hit===true).length;
  const rate = total ? (hit/total*100).toFixed(0) : "0";

  const byReason = {};
  arr.forEach(x=>{
    const r = x.reason || "unknown";
    byReason[r] = (byReason[r]||0)+1;
  });

  let s =
`=== NH·∫¨T K√ù APP (t·ª± ch·∫•m ƒëi·ªÉm) ===

T·ªïng ng√†y ƒë√£ ch·∫•m: ${total}
Tr√∫ng trong 4 s·ªë:  ${hit}
T·ªâ l·ªá:            ${rate}%

Ghi ch√∫ (th√¥):
${arr.slice(-20).reverse().map(x=>`- ${x.ts} | ch·ªët: ${x.pick.join(" ")} | DB: ${x.db} | ${x.hit?"TR√öNG":"TR∆Ø·ª¢T"} | pha ${x.pha}`).join("\n")}
`;
  el("tab_log").textContent = s;
}

function nowStamp(){
  const d = new Date();
  const z = (n)=>String(n).padStart(2,"0");
  return `${z(d.getDate())}/${z(d.getMonth()+1)} ${z(d.getHours())}:${z(d.getMinutes())}`;
}

/* ---------- tabs ---------- */
function setTab(name){
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(t=>t.classList.remove("active"));
  document.querySelector(`.tab[data-tab="${name}"]`)?.classList.add("active");

  const ids = ["sum","hg","hd","ckb","truc","pha"];
  ids.forEach(x=>{
    const e = el("tab_"+x);
    if(e) e.style.display = (x===name) ? "block" : "none";
  });

  el("tab_log_wrap").style.display = (name==="log") ? "block" : "none";
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});

/* ---------- FULL analysis (gi·ªØ output c≈© + th√™m GOD MODE) ---------- */
function runFULL(){
  const win = Math.max(5, parseInt(el("winDays").value||"20",10));
  const days = parseLinesWithWin(win);
  if(days.length < 5){
    el("out").textContent = "‚ùå Thi·∫øu d·ªØ li·ªáu: c·∫ßn √≠t nh·∫•t 5 d√≤ng (5 ng√†y).";
    el("godCard").style.display = "none";
    return;
  }

  const topN = Math.max(5, parseInt(el("topN").value||"15",10));
  const wHot = parseFloat(el("wHot").value||"2");
  const wGan = parseFloat(el("wGan").value||"1.5");
  const wPas = parseFloat(el("wPas").value||"2");

  const {freq, gan} = buildHotGan(days);
  const headTail = buildHeadTail(days);
  const score = buildScore(days, freq, gan, wHot, wGan, wPas);

  // base output (nh∆∞ b·∫°n ƒëang c√≥, kh√¥ng ph√°)
  const hotSorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,topN);
  const scoreSorted = Object.entries(score).sort((a,b)=>b[1]-a[1]).slice(0,topN);
  const main = scoreSorted[0]?.[0] || "--";
  const sub  = scoreSorted[1]?.[0] || "--";

  let out =
`T·ªïng ng√†y: ${days.length}

TOP HOT:
${hotSorted.map(([n,c])=>`${n} ‚Üí ${c}`).join("\n")}

TOP SCORE (hot+gan+pascal nh·∫π):
${scoreSorted.map(([n,s])=>`${n} ‚Üí ${s.toFixed(2)}`).join("\n")}

CH·ªêT G·ª¢I √ù (tham kh·∫£o):
üéØ Ch√≠nh: ${main}
üõ°Ô∏è Ph·ª•:  ${sub}

* Tool th·ªëng k√™ h·ªó tr·ª£, kh√¥ng ƒë·∫£m b·∫£o tr√∫ng
`;
  el("out").textContent = out;

  // GOD MODE report
  const rep = buildGodReport(days, score, freq, gan, headTail);

  el("godCard").style.display = "block";
  el("tab_sum").textContent = rep.tSum;
  el("tab_hg").textContent  = rep.tHG;
  el("tab_hd").textContent  = rep.tHD;
  el("tab_ckb").textContent = rep.tCKB;
  el("tab_truc").textContent= rep.tTruc;
  el("tab_pha").textContent = rep.tPha;

  // default tab
  setTab("sum");

  // log hint: update view
  renderLog();

  // store last pick to use when user ch·∫•m
  window.__LAST_PICK__ = rep.top4.map(x=>x.n);
  window.__LAST_PHA__  = rep.pha.pha;
}

/* ---------- log buttons ---------- */
el("btnLogSave").onclick = ()=>{
  const db = (el("log_db").value||"").replace(/\D/g,"").slice(-2);
  if(db.length!==2){ alert("Nh·∫≠p DB 2 s·ªë (vd: 45)"); return; }
  const pick = window.__LAST_PICK__ || [];
  if(!pick.length){ alert("Ch∆∞a ch·∫°y FULL ƒë·ªÉ c√≥ 4 s·ªë ch·ªët."); return; }
  const pha = window.__LAST_PHA__ || "--";
  const hit = pick.includes(pad2(db));
  const arr = loadLog();
  arr.push({
    ts: nowStamp(),
    db: pad2(db),
    pick,
    hit,
    pha,
    reason: "auto"
  });
  saveLog(arr);
  renderLog();
  alert(hit ? "‚úÖ TR√öNG (n·∫±m trong 4 s·ªë)" : "‚ùå TR∆Ø·ª¢T (kh√¥ng n·∫±m trong 4 s·ªë)");
};
el("btnLogClear").onclick = ()=>{
  if(confirm("X√≥a to√†n b·ªô nh·∫≠t k√Ω?")){
    saveLog([]);
    renderLog();
  }
};

/* bind */
el("btnFull").onclick = runFULL;
</script>
</body>
</html>
